---
uid: aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
title: OWIN OAuth 2.0 Servidor de Autorização | Microsoft Docs
author: hongyes
description: Este tutorial irá guiá-lo sobre como implementar um Servidor de Autorização OAuth 2.0 usando middleware OWIN OAuth. Este é um tutorial avançado que só outlin...
ms.author: riande
ms.date: 03/20/2014
ms.assetid: 20acee16-c70c-41e9-b38f-92bfcf9a4c1c
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
msc.type: authoredcontent
ms.openlocfilehash: d758fa2639d10e1b7be8d87c5d1f7adb7e292ac7
ms.sourcegitcommit: 022f79dbc1350e0c6ffaa1e7e7c6e850cdabf9af
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/17/2020
ms.locfileid: "81540374"
---
<a name="owin-oauth-20-authorization-server"></a><span data-ttu-id="d9a59-104">Servidor de autorização OAuth 2.0 de OWIN</span><span class="sxs-lookup"><span data-stu-id="d9a59-104">OWIN OAuth 2.0 Authorization Server</span></span>
====================
<span data-ttu-id="d9a59-105">por [Hongye Sun](https://github.com/hongyes) e [Praburaj Thiagarajan](https://github.com/Praburaj)</span><span class="sxs-lookup"><span data-stu-id="d9a59-105">by [Hongye Sun](https://github.com/hongyes) and [Praburaj Thiagarajan](https://github.com/Praburaj)</span></span>

> <span data-ttu-id="d9a59-106">Este tutorial irá guiá-lo sobre como implementar um Servidor de Autorização OAuth 2.0 usando middleware OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="d9a59-106">This tutorial will guide you on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span> <span data-ttu-id="d9a59-107">Este é um tutorial avançado que apenas descreve as etapas para criar um Servidor de Autorização OWIN OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="d9a59-107">This is an advanced tutorial that only outlines the steps to create an OWIN OAuth 2.0 Authorization Server.</span></span> <span data-ttu-id="d9a59-108">Este não é um tutorial passo a passo.</span><span class="sxs-lookup"><span data-stu-id="d9a59-108">This is not a step by step tutorial.</span></span> <span data-ttu-id="d9a59-109">[Baixe o código de amostra](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span><span class="sxs-lookup"><span data-stu-id="d9a59-109">[Download the sample code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span></span>
>
> > [!NOTE]
> > <span data-ttu-id="d9a59-110">Este esboço não deve ser usado para criar um aplicativo de produção seguro.</span><span class="sxs-lookup"><span data-stu-id="d9a59-110">This outline should not be intended to be used for creating a secure production app.</span></span> <span data-ttu-id="d9a59-111">Este tutorial destina-se a fornecer apenas um esboço sobre como implementar um Servidor de Autorização OAuth 2.0 usando middleware OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="d9a59-111">This tutorial is intended to provide only an outline on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span>
>
>
> ## <a name="software-versions"></a><span data-ttu-id="d9a59-112">Versões de software</span><span class="sxs-lookup"><span data-stu-id="d9a59-112">Software versions</span></span>
>
> | <span data-ttu-id="d9a59-113">**Mostrado no tutorial**</span><span class="sxs-lookup"><span data-stu-id="d9a59-113">**Shown in the tutorial**</span></span> | <span data-ttu-id="d9a59-114">**Também trabalha com**</span><span class="sxs-lookup"><span data-stu-id="d9a59-114">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="d9a59-115">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="d9a59-115">Windows 8.1</span></span> | <span data-ttu-id="d9a59-116">Windows 8, Windows 7</span><span class="sxs-lookup"><span data-stu-id="d9a59-116">Windows 8, Windows 7</span></span> |
> | [<span data-ttu-id="d9a59-117">Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="d9a59-117">Visual Studio 2013</span></span>](https://my.visualstudio.com/Downloads?q=visual%20studio%202013) | <span data-ttu-id="d9a59-118">[Visual Studio 2013 Express for Desktop](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express).</span><span class="sxs-lookup"><span data-stu-id="d9a59-118">[Visual Studio 2013 Express for Desktop](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express).</span></span> <span data-ttu-id="d9a59-119">Visual Studio 2012 com a última atualização deve funcionar, mas o tutorial não foi testado com ele, e algumas seleções de menu e caixas de diálogo são diferentes.</span><span class="sxs-lookup"><span data-stu-id="d9a59-119">Visual Studio 2012 with the latest update should work, but the tutorial has not been tested with it, and some menu selections and dialog boxes are different.</span></span> |
> | <span data-ttu-id="d9a59-120">.NET 4.5</span><span class="sxs-lookup"><span data-stu-id="d9a59-120">.NET 4.5</span></span> |  |
>
> ## <a name="questions-and-comments"></a><span data-ttu-id="d9a59-121">Perguntas e Comentários</span><span class="sxs-lookup"><span data-stu-id="d9a59-121">Questions and Comments</span></span>
>
> <span data-ttu-id="d9a59-122">Se você tiver perguntas que não estão diretamente relacionadas ao tutorial, você pode postá-las no [Katana Project no GitHub](https://github.com/aspnet/AspNetKatana/).</span><span class="sxs-lookup"><span data-stu-id="d9a59-122">If you have questions that are not directly related to the tutorial, you can post them at [Katana Project on GitHub](https://github.com/aspnet/AspNetKatana/).</span></span> <span data-ttu-id="d9a59-123">Para dúvidas e comentários sobre o tutorial em si, consulte a seção de comentários na parte inferior da página.</span><span class="sxs-lookup"><span data-stu-id="d9a59-123">For questions and comments regarding the tutorial itself, see the comments section at the bottom of the page.</span></span>


<span data-ttu-id="d9a59-124">A [estrutura OAuth 2.0](http://tools.ietf.org/html/rfc6749) permite que um aplicativo de terceiros obtenha acesso limitado a um serviço HTTP.</span><span class="sxs-lookup"><span data-stu-id="d9a59-124">The [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) enables a third-party app to obtain limited access to an HTTP service.</span></span> <span data-ttu-id="d9a59-125">Em vez de usar as credenciais do proprietário do recurso para acessar um recurso protegido, o cliente obtém um token de acesso (que é uma string que denota um escopo específico, vida útil e outros atributos de acesso).</span><span class="sxs-lookup"><span data-stu-id="d9a59-125">Instead of using the resource owner's credentials to access a protected resource, the client obtains an access token (which is a string denoting a specific scope, lifetime, and other access attributes).</span></span> <span data-ttu-id="d9a59-126">Os tokens de acesso são emitidos a clientes terceirizados por um servidor de autorização com a aprovação do proprietário do recurso.</span><span class="sxs-lookup"><span data-stu-id="d9a59-126">Access tokens are issued to third-party clients by an authorization server with the approval of the resource owner.</span></span>

<span data-ttu-id="d9a59-127">Este tutorial abordará:</span><span class="sxs-lookup"><span data-stu-id="d9a59-127">This tutorial will cover:</span></span>

- <span data-ttu-id="d9a59-128">Como criar um servidor de autorização para suportar quatro tipos de concessão de autorização e tokens de atualização:</span><span class="sxs-lookup"><span data-stu-id="d9a59-128">How to create an authorization server to support four authorization grant types and refresh tokens:</span></span>
    - <span data-ttu-id="d9a59-129">Concessão de código de autorização</span><span class="sxs-lookup"><span data-stu-id="d9a59-129">Authorization code grant</span></span>
    - <span data-ttu-id="d9a59-130">Concessão Implícita</span><span class="sxs-lookup"><span data-stu-id="d9a59-130">Implicit Grant</span></span>
    - <span data-ttu-id="d9a59-131">Concessão de credenciais de senha do proprietário de recursos</span><span class="sxs-lookup"><span data-stu-id="d9a59-131">Resource Owner Password Credentials Grant</span></span>
    - <span data-ttu-id="d9a59-132">Concessão de Credenciais do Cliente</span><span class="sxs-lookup"><span data-stu-id="d9a59-132">Client Credentials Grant</span></span>
- <span data-ttu-id="d9a59-133">Criando um servidor de recursos protegido por um token de acesso.</span><span class="sxs-lookup"><span data-stu-id="d9a59-133">Creating a resource server which is protected by an access token.</span></span>
- <span data-ttu-id="d9a59-134">Criando clientes OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="d9a59-134">Creating OAuth 2.0 clients.</span></span>

<a id="prerequisites"></a>
## <a name="prerequisites"></a><span data-ttu-id="d9a59-135">Pré-requisitos</span><span class="sxs-lookup"><span data-stu-id="d9a59-135">Prerequisites</span></span>

- <span data-ttu-id="d9a59-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) ou o [Visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express)gratuito, conforme indicado em **Versões de Software** no topo da página.</span><span class="sxs-lookup"><span data-stu-id="d9a59-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) or the free [Visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express), as indicated in **Software Versions** at the top of the page.</span></span>
- <span data-ttu-id="d9a59-137">Familiaridade com OWIN.</span><span class="sxs-lookup"><span data-stu-id="d9a59-137">Familiarity with OWIN.</span></span> <span data-ttu-id="d9a59-138">Veja [Getting Started com o Projeto Katana](https://msdn.microsoft.com/magazine/dn451439.aspx) e as [novidades da OWIN e katana](index.md).</span><span class="sxs-lookup"><span data-stu-id="d9a59-138">See [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx) and [What's new in OWIN and Katana](index.md).</span></span>
- <span data-ttu-id="d9a59-139">Familiaridade com a terminologia [OAuth,](http://tools.ietf.org/html/rfc6749) incluindo [Funções,](http://tools.ietf.org/html/rfc6749#section-1.1) [Fluxo de Protocolo](http://tools.ietf.org/html/rfc6749#section-1.2)e [Concessão de Autorização.](http://tools.ietf.org/html/rfc6749#section-1.3)</span><span class="sxs-lookup"><span data-stu-id="d9a59-139">Familiarity with [OAuth](http://tools.ietf.org/html/rfc6749) terminology, including [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), and [Authorization Grant](http://tools.ietf.org/html/rfc6749#section-1.3).</span></span> <span data-ttu-id="d9a59-140">[A introdução do OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-1) proporciona uma boa introdução.</span><span class="sxs-lookup"><span data-stu-id="d9a59-140">[OAuth 2.0 introduction](http://tools.ietf.org/html/rfc6749#section-1) provides a good introduction.</span></span>

## <a name="create-an-authorization-server"></a><span data-ttu-id="d9a59-141">Criar um servidor de autorização</span><span class="sxs-lookup"><span data-stu-id="d9a59-141">Create an Authorization Server</span></span>

<span data-ttu-id="d9a59-142">Neste tutorial, vamos esboçar como usar [o OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) e ASP.NET MVC para criar um servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="d9a59-142">In this tutorial, we will roughly sketch out how to use [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) and ASP.NET MVC to create an authorization server.</span></span> <span data-ttu-id="d9a59-143">Esperamos em breve fornecer um download para a amostra completa, já que este tutorial não inclui cada etapa.</span><span class="sxs-lookup"><span data-stu-id="d9a59-143">We hope to soon provide a download for the completed sample, as this tutorial does not include each step.</span></span> <span data-ttu-id="d9a59-144">Primeiro, crie um aplicativo web vazio chamado *AuthorizationServer* e instale os seguintes pacotes:</span><span class="sxs-lookup"><span data-stu-id="d9a59-144">First, create an empty web app named *AuthorizationServer* and install the following packages:</span></span>

- <span data-ttu-id="d9a59-145">Microsoft.AspNet.Mvc</span><span class="sxs-lookup"><span data-stu-id="d9a59-145">Microsoft.AspNet.Mvc</span></span>
- <span data-ttu-id="d9a59-146">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="d9a59-146">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="d9a59-147">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="d9a59-147">Microsoft.Owin.Security.OAuth</span></span>
- <span data-ttu-id="d9a59-148">Microsoft.Owin.Security</span><span class="sxs-lookup"><span data-stu-id="d9a59-148">Microsoft.Owin.Security.Cookies</span></span>
- <span data-ttu-id="d9a59-149">Microsoft.Owin.Security.Google (Ou qualquer outro pacote de login social, como Microsoft.Owin.Security.Facebook)</span><span class="sxs-lookup"><span data-stu-id="d9a59-149">Microsoft.Owin.Security.Google (Or any other social login package such as Microsoft.Owin.Security.Facebook)</span></span>

<span data-ttu-id="d9a59-150">Adicione uma [classe OWIN Startup](owin-startup-class-detection.md) sob a pasta raiz do projeto chamada *Inicialização*.</span><span class="sxs-lookup"><span data-stu-id="d9a59-150">Add an [OWIN Startup class](owin-startup-class-detection.md) under the project root folder named *Startup*.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample1.cs?highlight=8)]

<span data-ttu-id="d9a59-151">Crie uma pasta *Iniciar de aplicativos.\_*</span><span class="sxs-lookup"><span data-stu-id="d9a59-151">Create an *App\_Start* folder.</span></span> <span data-ttu-id="d9a59-152">Selecione a pasta Iniciar do *aplicativo\_* e use shift+Alt+A para adicionar a versão baixada do arquivo *AuthorizationServer\App\_Start\Startup.Auth.cs.*</span><span class="sxs-lookup"><span data-stu-id="d9a59-152">Select the *App\_Start* folder and use Shift+Alt+A to add the downloaded version of the *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample2.cs)]

<span data-ttu-id="d9a59-153">O código acima permite o login de aplicativos/externos em cookies e a autenticação do Google, que são usados pelo próprio servidor de autorização para gerenciar contas.</span><span class="sxs-lookup"><span data-stu-id="d9a59-153">The code above enables application/external sign in cookies and Google authentication, which are used by authorization server itself to manage accounts.</span></span>

<span data-ttu-id="d9a59-154">O `UseOAuthAuthorizationServer` método de extensão é configurar o servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="d9a59-154">The `UseOAuthAuthorizationServer` extension method is to setup the authorization server.</span></span> <span data-ttu-id="d9a59-155">As opções de configuração são:</span><span class="sxs-lookup"><span data-stu-id="d9a59-155">The setup options are:</span></span>

- <span data-ttu-id="d9a59-156">`AuthorizeEndpointPath`: O caminho de solicitação onde os aplicativos clientes redirecionarão o usuário-agente para obter o consentimento dos usuários para emitir um token ou código.</span><span class="sxs-lookup"><span data-stu-id="d9a59-156">`AuthorizeEndpointPath`: The request path where client applications will redirect the user-agent in order to obtain the users consent to issue a token or code.</span></span> <span data-ttu-id="d9a59-157">Deve começar com uma barra principal,`/Authorize`por exemplo, ".</span><span class="sxs-lookup"><span data-stu-id="d9a59-157">It must begin with a leading slash, for example, "`/Authorize`".</span></span>
- <span data-ttu-id="d9a59-158">`TokenEndpointPath`: Os aplicativos clientes do caminho de solicitação se comunicam diretamente para obter o token de acesso.</span><span class="sxs-lookup"><span data-stu-id="d9a59-158">`TokenEndpointPath`: The request path client applications directly communicate to obtain the access token.</span></span> <span data-ttu-id="d9a59-159">Deve começar com uma barra principal, como "/Token".</span><span class="sxs-lookup"><span data-stu-id="d9a59-159">It must begin with a leading slash, like "/Token".</span></span> <span data-ttu-id="d9a59-160">Se o cliente for emitido um [segredo de cliente,\_](http://tools.ietf.org/html/rfc6749#appendix-A.2)ele deve ser fornecido a este ponto final.</span><span class="sxs-lookup"><span data-stu-id="d9a59-160">If the client is issued a [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), it must be provided to this endpoint.</span></span>
- <span data-ttu-id="d9a59-161">`ApplicationCanDisplayErrors`: Defina para `true` se o aplicativo web quiser gerar uma `/Authorize` página de erro personalizada para os erros de validação do cliente no ponto final.</span><span class="sxs-lookup"><span data-stu-id="d9a59-161">`ApplicationCanDisplayErrors`: Set to `true` if the web application wants to generate a custom error page for the client validation errors on `/Authorize` endpoint.</span></span> <span data-ttu-id="d9a59-162">Isso só é necessário para casos em que o navegador não é `client_id` redirecionado de volta para o aplicativo cliente, por exemplo, quando o ou `redirect_uri` está incorreto.</span><span class="sxs-lookup"><span data-stu-id="d9a59-162">This is only needed for cases where the browser is not redirected back to the client application, for example, when the `client_id` or `redirect_uri` are incorrect.</span></span> <span data-ttu-id="d9a59-163">O `/Authorize` ponto final deve esperar para ver o "oauth. Erro", "oauth. ErroDescrição", e "oauth. As propriedades errorUri" são adicionadas ao ambiente OWIN.</span><span class="sxs-lookup"><span data-stu-id="d9a59-163">The `/Authorize` endpoint should expect to see the "oauth.Error", "oauth.ErrorDescription", and "oauth.ErrorUri" properties are added to the OWIN environment.</span></span>

    > [!NOTE]
    > <span data-ttu-id="d9a59-164">Se não for verdade, o servidor de autorização retornará uma página de erro padrão com os detalhes do erro.</span><span class="sxs-lookup"><span data-stu-id="d9a59-164">If not true, the authorization server will return a default error page with the error details.</span></span>
- <span data-ttu-id="d9a59-165">`AllowInsecureHttp`: É verdade permitir que solicitações de autorização e token `redirect_uri` cheguem em endereços HTTP URI e permitir que os parâmetros de solicitação de autorização de entrada tenham endereços HTTP URI.</span><span class="sxs-lookup"><span data-stu-id="d9a59-165">`AllowInsecureHttp`: True to allow authorize and token requests to arrive on HTTP URI addresses, and to allow incoming `redirect_uri` authorize request parameters to have HTTP URI addresses.</span></span>

    > [!WARNING]
    > <span data-ttu-id="d9a59-166">Segurança - Isso é apenas para desenvolvimento.</span><span class="sxs-lookup"><span data-stu-id="d9a59-166">Security - This is for development only.</span></span>
- <span data-ttu-id="d9a59-167">`Provider`: O objeto fornecido pelo aplicativo para processar eventos levantados pelo middleware do Servidor de Autorização.</span><span class="sxs-lookup"><span data-stu-id="d9a59-167">`Provider`: The object provided by the application to process events raised by the Authorization Server middleware.</span></span> <span data-ttu-id="d9a59-168">O aplicativo pode implementar a interface totalmente, `OAuthAuthorizationServerProvider` ou pode criar uma instância de e atribuir delegados necessários para os fluxos oAuth que este servidor suporta.</span><span class="sxs-lookup"><span data-stu-id="d9a59-168">The application may implement the interface fully, or it may create an instance of `OAuthAuthorizationServerProvider` and assign delegates necessary for the OAuth flows this server supports.</span></span>
- <span data-ttu-id="d9a59-169">`AuthorizationCodeProvider`: Produz um código de autorização de uso único para retornar ao aplicativo do cliente.</span><span class="sxs-lookup"><span data-stu-id="d9a59-169">`AuthorizationCodeProvider`: Produces a single-use authorization code to return to the client application.</span></span> <span data-ttu-id="d9a59-170">Para que o servidor OAuth **MUST** seja seguro, `AuthorizationCodeProvider` o aplicativo deve `OnCreate/OnCreateAsync` fornecer uma instância para onde `OnReceive/OnReceiveAsync`o token produzido pelo evento é considerado válido para apenas uma chamada para .</span><span class="sxs-lookup"><span data-stu-id="d9a59-170">For the OAuth server to be secure the application **MUST** provide an instance for `AuthorizationCodeProvider` where the token produced by the `OnCreate/OnCreateAsync` event is considered valid for only one call to `OnReceive/OnReceiveAsync`.</span></span>
- <span data-ttu-id="d9a59-171">`RefreshTokenProvider`: Produz um token de atualização que pode ser usado para produzir um novo token de acesso quando necessário.</span><span class="sxs-lookup"><span data-stu-id="d9a59-171">`RefreshTokenProvider`: Produces a refresh token which may be used to produce a new access token when needed.</span></span> <span data-ttu-id="d9a59-172">Se não for fornecido, o servidor de autorização `/Token` não retornará tokens de atualização do ponto final.</span><span class="sxs-lookup"><span data-stu-id="d9a59-172">If not provided the authorization server will not return refresh tokens from the `/Token` endpoint.</span></span>

## <a name="account-management"></a><span data-ttu-id="d9a59-173">Gerenciamento de Conta</span><span class="sxs-lookup"><span data-stu-id="d9a59-173">Account Management</span></span>

<span data-ttu-id="d9a59-174">OAuth não se importa onde ou como você gerencia as informações da sua conta de usuário.</span><span class="sxs-lookup"><span data-stu-id="d9a59-174">OAuth doesn't care where or how you manage your user account information.</span></span> <span data-ttu-id="d9a59-175">É [ASP.NET Identidade](../../../identity/index.md) que é responsável por isso.</span><span class="sxs-lookup"><span data-stu-id="d9a59-175">It's [ASP.NET Identity](../../../identity/index.md) which is responsible for it.</span></span> <span data-ttu-id="d9a59-176">Neste tutorial, vamos simplificar o código de gerenciamento da conta e apenas garantir que o usuário possa fazer login usando o middleware de cookies OWIN.</span><span class="sxs-lookup"><span data-stu-id="d9a59-176">In this tutorial, we will simplify the account management code and just make sure that user can login using OWIN cookie middleware.</span></span> <span data-ttu-id="d9a59-177">Aqui está o código de `AccountController`amostra simplificado para:</span><span class="sxs-lookup"><span data-stu-id="d9a59-177">Here is the simplified sample code for the `AccountController`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample3.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample4.cs?highlight=1)]

<span data-ttu-id="d9a59-178">`ValidateClientRedirectUri`é usado para validar o cliente com sua URL de redirecionamento registrada.</span><span class="sxs-lookup"><span data-stu-id="d9a59-178">`ValidateClientRedirectUri` is used to validate the client with its registered redirect URL.</span></span> <span data-ttu-id="d9a59-179">`ValidateClientAuthentication`verifica o cabeçalho do esquema básico e o corpo de formulário para obter as credenciais do cliente.</span><span class="sxs-lookup"><span data-stu-id="d9a59-179">`ValidateClientAuthentication` checks the basic scheme header and form body to get the client's credentials.</span></span>

<span data-ttu-id="d9a59-180">A página de login é mostrada abaixo:</span><span class="sxs-lookup"><span data-stu-id="d9a59-180">The login page is shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image1.png)

<span data-ttu-id="d9a59-181">Reveja agora a seção de [concessão](http://tools.ietf.org/html/rfc6749#section-4.1) de código de autorização OAuth 2 do IETF.</span><span class="sxs-lookup"><span data-stu-id="d9a59-181">Review the IETF's OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) section now.</span></span>

<span data-ttu-id="d9a59-182">**O provedor** (na tabela abaixo) é [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx). Provedor, que é `OAuthAuthorizationServerProvider`do tipo, que contém todos os eventos do servidor OAuth.</span><span class="sxs-lookup"><span data-stu-id="d9a59-182">**Provider** (in the table below) is [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx).Provider, which is of type `OAuthAuthorizationServerProvider`, which contains all OAuth server events.</span></span>

| <span data-ttu-id="d9a59-183">Passos de fluxo da seção Autorização Code Grant</span><span class="sxs-lookup"><span data-stu-id="d9a59-183">Flow steps from Authorization Code Grant section</span></span> | <span data-ttu-id="d9a59-184">O download da amostra executa essas etapas com:</span><span class="sxs-lookup"><span data-stu-id="d9a59-184">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="d9a59-185">(A) O cliente inicia o fluxo direcionando o usuário-agente do proprietário do recurso para o ponto final da autorização.</span><span class="sxs-lookup"><span data-stu-id="d9a59-185">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="d9a59-186">O cliente inclui seu identificador de cliente, escopo solicitado, estado local e um URI de redirecionamento para o qual o servidor de autorização enviará o usuário-agente de volta assim que o acesso for concedido (ou negado).</span><span class="sxs-lookup"><span data-stu-id="d9a59-186">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="d9a59-187">Provider.MatchEndpoint Provider.validateClientRedirectUri Provider.ValidateAuthorizeRequestProvider.AuthorizeEndPoint</span><span class="sxs-lookup"><span data-stu-id="d9a59-187">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="d9a59-188">(B) O servidor de autorização autentica o proprietário do recurso (através do usuário-agente) e estabelece se o proprietário do recurso concede ou nega a solicitação de acesso do cliente.</span><span class="sxs-lookup"><span data-stu-id="d9a59-188">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="d9a59-189">**Se o usuário conceder acesso&gt; &lt;** Provider.MatchEndpoint Provider.validateClientRedirectUri Provider.ValidateAuthorizeRequestRequestProvider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="d9a59-189">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="d9a59-190">(C) Supondo que o proprietário do recurso conceda acesso, o servidor de autorização redireciona o usuário-agente de volta para o cliente usando o URI de redirecionamento fornecido anteriormente (na solicitação ou durante o registro do cliente).</span><span class="sxs-lookup"><span data-stu-id="d9a59-190">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="d9a59-191">...</span><span class="sxs-lookup"><span data-stu-id="d9a59-191">...</span></span> |  |
|  |  |
| <span data-ttu-id="d9a59-192">(D) O cliente solicita um token de acesso do ponto final do token do servidor de autorização, incluindo o código de autorização recebido na etapa anterior.</span><span class="sxs-lookup"><span data-stu-id="d9a59-192">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="d9a59-193">Ao fazer a solicitação, o cliente autentica com o servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="d9a59-193">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="d9a59-194">O cliente inclui o URI de redirecionamento usado para obter o código de autorização para verificação.</span><span class="sxs-lookup"><span data-stu-id="d9a59-194">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> | <span data-ttu-id="d9a59-195">Provedor.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="d9a59-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |

<span data-ttu-id="d9a59-196">Uma implementação `AuthorizationCodeProvider.CreateAsync` `ReceiveAsync` amostral para e para controlar a criação e validação do código de autorização é mostrada abaixo.</span><span class="sxs-lookup"><span data-stu-id="d9a59-196">A sample implementation for `AuthorizationCodeProvider.CreateAsync` and `ReceiveAsync` to control the creation and validation of authorization code is shown below.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample5.cs)]

<span data-ttu-id="d9a59-197">O código acima usa um dicionário simultâneo na memória para armazenar o código e o ticket de identidade e restaurar a identidade após receber o código.</span><span class="sxs-lookup"><span data-stu-id="d9a59-197">The code above uses an in-memory concurrent dictionary to store the code and identity ticket and restore the identity after receiving the code.</span></span> <span data-ttu-id="d9a59-198">Em um aplicativo real, ele seria substituído por um armazenamento de dados persistente.</span><span class="sxs-lookup"><span data-stu-id="d9a59-198">In a real application, it would be replaced by a persistent data store.</span></span> <span data-ttu-id="d9a59-199">O ponto final da autorização é para que o proprietário do recurso conceda acesso ao cliente.</span><span class="sxs-lookup"><span data-stu-id="d9a59-199">The authorization endpoint is for the resource owner to grant access to the client.</span></span> <span data-ttu-id="d9a59-200">Normalmente, ele precisa de uma interface de usuário para permitir que o usuário clique em um botão e confirme a concessão.</span><span class="sxs-lookup"><span data-stu-id="d9a59-200">Usually, it needs a user interface to allow the user to click a button and confirm the grant.</span></span> <span data-ttu-id="d9a59-201">O middleware OWIN OAuth permite que o código do aplicativo manuseie o ponto final da autorização.</span><span class="sxs-lookup"><span data-stu-id="d9a59-201">OWIN OAuth middleware allows application code to handle the authorization endpoint.</span></span> <span data-ttu-id="d9a59-202">Em nosso aplicativo de exemplo, usamos `OAuthController` um controlador MVC chamado para lidar com isso.</span><span class="sxs-lookup"><span data-stu-id="d9a59-202">In our sample app, we use an MVC controller called `OAuthController` to handle it.</span></span> <span data-ttu-id="d9a59-203">Aqui está a implementação da amostra:</span><span class="sxs-lookup"><span data-stu-id="d9a59-203">Here is the sample implementation:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample6.cs?highlight=15)]

<span data-ttu-id="d9a59-204">A `Authorize` ação primeiro verificará se o usuário fez login no servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="d9a59-204">The `Authorize` action will first check if the user has logged in to the authorization server.</span></span> <span data-ttu-id="d9a59-205">Caso assim, o middleware de autenticação desafie o chamador a autenticar usando o cookie "Aplicativo" e redireciona para a página de login.</span><span class="sxs-lookup"><span data-stu-id="d9a59-205">If not, the authentication middleware challenges the caller to authenticate using the "Application" cookie and redirects to the login page.</span></span> <span data-ttu-id="d9a59-206">(Veja o código destacado acima.) Se o usuário tiver logado, ele renderizará a exibição Autorizar, conforme mostrado abaixo:</span><span class="sxs-lookup"><span data-stu-id="d9a59-206">(See highlighted code above.) If user has logged in, it will render the Authorize view, as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image2.png)

<span data-ttu-id="d9a59-207">Se o botão **Conceder** `Authorize` for selecionado, a ação criará uma nova identidade "Portador" e entrará com ele.</span><span class="sxs-lookup"><span data-stu-id="d9a59-207">If the **Grant** button is selected, the `Authorize` action will create a new "Bearer" identity and sign in with it.</span></span> <span data-ttu-id="d9a59-208">Ele acionará o servidor de autorização para gerar um token portador e enviá-lo de volta ao cliente com carga útil JSON.</span><span class="sxs-lookup"><span data-stu-id="d9a59-208">It will trigger the authorization server to generate a bearer token and send it back to the client with JSON payload.</span></span>

### <a name="implicit-grant"></a><span data-ttu-id="d9a59-209">Concessão Implícita</span><span class="sxs-lookup"><span data-stu-id="d9a59-209">Implicit Grant</span></span>

<span data-ttu-id="d9a59-210">Consulte a seção [Subvenção Implícita](http://tools.ietf.org/html/rfc6749#section-4.2) OAuth 2 do IETF agora.</span><span class="sxs-lookup"><span data-stu-id="d9a59-210">Refer to the IETF's OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section now.</span></span>

 <span data-ttu-id="d9a59-211">O fluxo [de subvenção implícito](http://tools.ietf.org/html/rfc6749#section-4.2) mostrado na Figura 4 é o fluxo e mapeamento que o middleware OWIN OAuth segue.</span><span class="sxs-lookup"><span data-stu-id="d9a59-211">The [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flow shown in Figure 4 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="d9a59-212">Passos de fluxo da seção Subvenção Implícita</span><span class="sxs-lookup"><span data-stu-id="d9a59-212">Flow steps from Implicit Grant section</span></span> | <span data-ttu-id="d9a59-213">O download da amostra executa essas etapas com:</span><span class="sxs-lookup"><span data-stu-id="d9a59-213">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="d9a59-214">(A) O cliente inicia o fluxo direcionando o usuário-agente do proprietário do recurso para o ponto final da autorização.</span><span class="sxs-lookup"><span data-stu-id="d9a59-214">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="d9a59-215">O cliente inclui seu identificador de cliente, escopo solicitado, estado local e um URI de redirecionamento para o qual o servidor de autorização enviará o usuário-agente de volta assim que o acesso for concedido (ou negado).</span><span class="sxs-lookup"><span data-stu-id="d9a59-215">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="d9a59-216">Provider.MatchEndpoint Provider.validateClientRedirectUri Provider.ValidateAuthorizeRequestProvider.AuthorizeEndPoint</span><span class="sxs-lookup"><span data-stu-id="d9a59-216">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="d9a59-217">(B) O servidor de autorização autentica o proprietário do recurso (através do usuário-agente) e estabelece se o proprietário do recurso concede ou nega a solicitação de acesso do cliente.</span><span class="sxs-lookup"><span data-stu-id="d9a59-217">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="d9a59-218">**Se o usuário conceder acesso&gt; &lt;** Provider.MatchEndpoint Provider.validateClientRedirectUri Provider.ValidateAuthorizeRequestRequestProvider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="d9a59-218">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="d9a59-219">(C) Supondo que o proprietário do recurso conceda acesso, o servidor de autorização redireciona o usuário-agente de volta para o cliente usando o URI de redirecionamento fornecido anteriormente (na solicitação ou durante o registro do cliente).</span><span class="sxs-lookup"><span data-stu-id="d9a59-219">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="d9a59-220">...</span><span class="sxs-lookup"><span data-stu-id="d9a59-220">...</span></span> |  |
|  |  |
| <span data-ttu-id="d9a59-221">(D) O cliente solicita um token de acesso do ponto final do token do servidor de autorização, incluindo o código de autorização recebido na etapa anterior.</span><span class="sxs-lookup"><span data-stu-id="d9a59-221">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="d9a59-222">Ao fazer a solicitação, o cliente autentica com o servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="d9a59-222">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="d9a59-223">O cliente inclui o URI de redirecionamento usado para obter o código de autorização para verificação.</span><span class="sxs-lookup"><span data-stu-id="d9a59-223">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> |  |

<span data-ttu-id="d9a59-224">Uma vez que já implementamos o endpoint de autorização (ação)`OAuthController.Authorize` para concessão de código de autorização, ele habilita automaticamente o fluxo implícito também.</span><span class="sxs-lookup"><span data-stu-id="d9a59-224">Since we already implemented the authorization endpoint (`OAuthController.Authorize` action) for authorization code grant, it automatically enables implicit flow as well.</span></span> <span data-ttu-id="d9a59-225">Nota: `Provider.ValidateClientRedirectUri` é usado para validar o ID do cliente com sua URL de redirecionamento, que protege o fluxo de subvenção implícito do envio do token de acesso a clientes mal-intencionados[(ataque man-in-the-middle).](https://www.owasp.org/index.php/Man-in-the-middle_attack)</span><span class="sxs-lookup"><span data-stu-id="d9a59-225">Note: `Provider.ValidateClientRedirectUri` is used to validate the client ID with its redirection URL, which protects the implicit grant flow from sending the access token to malicious clients ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span></span>

### <a name="resource-owner-password-credentials-grant"></a><span data-ttu-id="d9a59-226">Concessão de credenciais de senha do proprietário de recursos</span><span class="sxs-lookup"><span data-stu-id="d9a59-226">Resource Owner Password Credentials Grant</span></span>

<span data-ttu-id="d9a59-227">Consulte a seção [Desemao](http://tools.ietf.org/html/rfc6749#section-4.3) Centro de Concessão de Credenciais do Proprietário de Recursos OAuth 2.</span><span class="sxs-lookup"><span data-stu-id="d9a59-227">Refer to the IETF's OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) section now.</span></span>

 <span data-ttu-id="d9a59-228">O fluxo [de concessão de credenciais de senha do proprietário de recursos](http://tools.ietf.org/html/rfc6749#section-4.3) mostrado na Figura 5 é o fluxo e mapeamento que o middleware OWIN OAuth segue.</span><span class="sxs-lookup"><span data-stu-id="d9a59-228">The [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flow shown in Figure 5 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="d9a59-229">Passos de fluxo da seção de concessão de credenciais de senha do proprietário de recursos</span><span class="sxs-lookup"><span data-stu-id="d9a59-229">Flow steps from Resource Owner Password Credentials Grant section</span></span> | <span data-ttu-id="d9a59-230">O download da amostra executa essas etapas com:</span><span class="sxs-lookup"><span data-stu-id="d9a59-230">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="d9a59-231">(A) O proprietário do recurso fornece ao cliente seu nome de usuário e senha.</span><span class="sxs-lookup"><span data-stu-id="d9a59-231">(A) The resource owner provides the client with its username and password.</span></span> |  |
|  |  |
| <span data-ttu-id="d9a59-232">(B) O cliente solicita um token de acesso do ponto final do token do servidor de autorização, incluindo as credenciais recebidas do proprietário do recurso.</span><span class="sxs-lookup"><span data-stu-id="d9a59-232">(B) The client requests an access token from the authorization server's token endpoint by including the credentials received from the resource owner.</span></span> <span data-ttu-id="d9a59-233">Ao fazer a solicitação, o cliente autentica com o servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="d9a59-233">When making the request, the client authenticates with the authorization server.</span></span> | <span data-ttu-id="d9a59-234">Provider.MatchEndpoint Provider.ValidateClientClient.ValidateTokenRequestRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="d9a59-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="d9a59-235">(C) O servidor de autorização autentica o cliente e valida as credenciais do proprietário do recurso e, se válido, emite um token de acesso.</span><span class="sxs-lookup"><span data-stu-id="d9a59-235">(C) The authorization server authenticates the client and validates the resource owner credentials, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="d9a59-236">Aqui está a `Provider.GrantResourceOwnerCredentials`implementação da amostra para:</span><span class="sxs-lookup"><span data-stu-id="d9a59-236">Here is the sample implementation for `Provider.GrantResourceOwnerCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample7.cs)]

> [!NOTE]
> <span data-ttu-id="d9a59-237">O código acima destina-se a explicar esta seção do tutorial e não deve ser usado em aplicativos seguros ou de produção.</span><span class="sxs-lookup"><span data-stu-id="d9a59-237">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="d9a59-238">Ele não verifica as credenciais dos proprietários de recursos.</span><span class="sxs-lookup"><span data-stu-id="d9a59-238">It does not check the resource owners credentials.</span></span> <span data-ttu-id="d9a59-239">Ele assume que cada credencial é válida e cria uma nova identidade para ela.</span><span class="sxs-lookup"><span data-stu-id="d9a59-239">It assumes every credential is valid and creates a new identity for it.</span></span> <span data-ttu-id="d9a59-240">A nova identidade será usada para gerar o token de acesso e o token de atualização.</span><span class="sxs-lookup"><span data-stu-id="d9a59-240">The new identity will be used to generate the access token and refresh token.</span></span> <span data-ttu-id="d9a59-241">Por favor, substitua o código por seu próprio código de gerenciamento de conta segura.</span><span class="sxs-lookup"><span data-stu-id="d9a59-241">Please replace the code with your own secure account management code.</span></span>


### <a name="client-credentials-grant"></a><span data-ttu-id="d9a59-242">Concessão de Credenciais do Cliente</span><span class="sxs-lookup"><span data-stu-id="d9a59-242">Client Credentials Grant</span></span>

<span data-ttu-id="d9a59-243">Consulte a seção Subvenção de [Credenciais](http://tools.ietf.org/html/rfc6749#section-4.4) de Cliente OAuth 2 do IETF agora.</span><span class="sxs-lookup"><span data-stu-id="d9a59-243">Refer to the IETF's OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) section now.</span></span>

 <span data-ttu-id="d9a59-244">O fluxo [de concessão de credenciais do cliente](http://tools.ietf.org/html/rfc6749#section-4.4) mostrado na Figura 6 é o fluxo e mapeamento que o middleware OWIN OAuth segue.</span><span class="sxs-lookup"><span data-stu-id="d9a59-244">The [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) flow shown in Figure 6 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="d9a59-245">Passos de fluxo da seção subvenção de credenciais do cliente</span><span class="sxs-lookup"><span data-stu-id="d9a59-245">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="d9a59-246">O download da amostra executa essas etapas com:</span><span class="sxs-lookup"><span data-stu-id="d9a59-246">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="d9a59-247">(A) O cliente autentica com o servidor de autorização e solicita um token de acesso a partir do ponto final do token.</span><span class="sxs-lookup"><span data-stu-id="d9a59-247">(A) The client authenticates with the authorization server and requests an access token from the token endpoint.</span></span> | <span data-ttu-id="d9a59-248">Provider.MatchEndpoint Provider.ValidateClientClient.ValidateTokenRequestRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="d9a59-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="d9a59-249">(B) O servidor de autorização autentica o cliente e, se válido, emite um token de acesso.</span><span class="sxs-lookup"><span data-stu-id="d9a59-249">(B) The authorization server authenticates the client, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="d9a59-250">Aqui está a `Provider.GrantClientCredentials`implementação da amostra para:</span><span class="sxs-lookup"><span data-stu-id="d9a59-250">Here is the sample implementation for `Provider.GrantClientCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample8.cs)]

> [!NOTE]
> <span data-ttu-id="d9a59-251">O código acima destina-se a explicar esta seção do tutorial e não deve ser usado em aplicativos seguros ou de produção.</span><span class="sxs-lookup"><span data-stu-id="d9a59-251">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="d9a59-252">Por favor, substitua o código por seu próprio código de gerenciamento de clienteseguro.</span><span class="sxs-lookup"><span data-stu-id="d9a59-252">Please replace the code with your own secure client management code.</span></span>


### <a name="refresh-token"></a><span data-ttu-id="d9a59-253">Atualizar Token</span><span class="sxs-lookup"><span data-stu-id="d9a59-253">Refresh Token</span></span>

<span data-ttu-id="d9a59-254">Consulte a seção [Token](http://tools.ietf.org/html/rfc6749#section-1.5) de atualização OAuth 2 do IETF agora.</span><span class="sxs-lookup"><span data-stu-id="d9a59-254">Refer to the IETF's OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) section now.</span></span>

 <span data-ttu-id="d9a59-255">O fluxo [de token de atualização](http://tools.ietf.org/html/rfc6749#section-1.5) mostrado na Figura 2 é o fluxo e mapeamento que o middleware OWIN OAuth segue.</span><span class="sxs-lookup"><span data-stu-id="d9a59-255">The [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) flow shown in Figure 2 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="d9a59-256">Passos de fluxo da seção subvenção de credenciais do cliente</span><span class="sxs-lookup"><span data-stu-id="d9a59-256">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="d9a59-257">O download da amostra executa essas etapas com:</span><span class="sxs-lookup"><span data-stu-id="d9a59-257">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="d9a59-258">(G) O cliente solicita um novo token de acesso autenticando-se com o servidor de autorização e apresentando o token de atualização.</span><span class="sxs-lookup"><span data-stu-id="d9a59-258">(G) The client requests a new access token by authenticating with the authorization server and presenting the refresh token.</span></span> <span data-ttu-id="d9a59-259">Os requisitos de autenticação do cliente são baseados no tipo de cliente e nas políticas do servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="d9a59-259">The client authentication requirements are based on the client type and on the authorization server policies.</span></span> | <span data-ttu-id="d9a59-260">Provedor.MatchEndpoint Provider.ValidateClientAuthenticationRefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsyncRefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="d9a59-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="d9a59-261">(H) O servidor de autorização autentica o cliente e valida o token de atualização e, se válido, emite um novo token de acesso (e, opcionalmente, um novo token de atualização).</span><span class="sxs-lookup"><span data-stu-id="d9a59-261">(H) The authorization server authenticates the client and validates the refresh token, and if valid, issues a new access token (and, optionally, a new refresh token).</span></span> |  |

<span data-ttu-id="d9a59-262">Aqui está a `Provider.GrantRefreshToken`implementação da amostra para:</span><span class="sxs-lookup"><span data-stu-id="d9a59-262">Here is the sample implementation for `Provider.GrantRefreshToken`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample9.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample10.cs)]

## <a name="create-a-resource-server-which-is-protected-by-access-token"></a><span data-ttu-id="d9a59-263">Crie um servidor de recursos protegido pelo Access Token</span><span class="sxs-lookup"><span data-stu-id="d9a59-263">Create a Resource Server which is protected by Access Token</span></span>

<span data-ttu-id="d9a59-264">Crie um projeto de aplicativo web vazio e instale os seguintes pacotes no projeto:</span><span class="sxs-lookup"><span data-stu-id="d9a59-264">Create an empty web app project and install following packages in the project:</span></span>

- <span data-ttu-id="d9a59-265">Microsoft.AspNet.WebApi.Owin</span><span class="sxs-lookup"><span data-stu-id="d9a59-265">Microsoft.AspNet.WebApi.Owin</span></span>
- <span data-ttu-id="d9a59-266">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="d9a59-266">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="d9a59-267">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="d9a59-267">Microsoft.Owin.Security.OAuth</span></span>

<span data-ttu-id="d9a59-268">Crie uma classe de inicialização e configure autenticação e API da Web.</span><span class="sxs-lookup"><span data-stu-id="d9a59-268">Create a startup class and configure authentication and Web API.</span></span> <span data-ttu-id="d9a59-269">Consulte *AuthorizationServer\ResourceServer\Startup.cs* no download da amostra.</span><span class="sxs-lookup"><span data-stu-id="d9a59-269">See *AuthorizationServer\ResourceServer\Startup.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample11.cs)]

<span data-ttu-id="d9a59-270">Consulte *\_AuthorizationServer\ResourceServer\App Start\Startup.Auth.cs* no download da amostra.</span><span class="sxs-lookup"><span data-stu-id="d9a59-270">See *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample12.cs)]

<span data-ttu-id="d9a59-271">Consulte *\_AuthorizationServer\ResourceServer\App Start\Startup.WebApi.cs* no download da amostra.</span><span class="sxs-lookup"><span data-stu-id="d9a59-271">See *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample13.cs)]

- <span data-ttu-id="d9a59-272">`UseCors`método permite CORS para todos os domínios.</span><span class="sxs-lookup"><span data-stu-id="d9a59-272">`UseCors` method allows CORS for all domains.</span></span>
- <span data-ttu-id="d9a59-273">`UseOAuthBearerAuthentication`o método permite o meio termo de autenticação do token portador OAuth que receberá e validará o token do portador do cabeçalho de autorização na solicitação.</span><span class="sxs-lookup"><span data-stu-id="d9a59-273">`UseOAuthBearerAuthentication` method enables OAuth bearer token authentication middleware which will receive and validate bearer token from authorization header in the request.</span></span>
- <span data-ttu-id="d9a59-274">`Config.SuppressDefaultHostAuthenticaiton`suprime o principal autenticado do host padrão do aplicativo, portanto, todas as solicitações serão anônimas após esta chamada.</span><span class="sxs-lookup"><span data-stu-id="d9a59-274">`Config.SuppressDefaultHostAuthenticaiton` suppresses default host authenticated principal from the app, therefore all requests will be anonymous after this call.</span></span>
- <span data-ttu-id="d9a59-275">`HostAuthenticationFilter`permite a autenticação apenas para o tipo de autenticação especificado.</span><span class="sxs-lookup"><span data-stu-id="d9a59-275">`HostAuthenticationFilter` enables authentication just for the specified authentication type.</span></span> <span data-ttu-id="d9a59-276">Neste caso, é o tipo de autenticação do portador.</span><span class="sxs-lookup"><span data-stu-id="d9a59-276">In this case, it's bearer authentication type.</span></span>

<span data-ttu-id="d9a59-277">Para demonstrar a identidade autenticada, criamos um ApiController para produzir as reivindicações do usuário atual.</span><span class="sxs-lookup"><span data-stu-id="d9a59-277">In order to demonstrate the authenticated identity, we create an ApiController to output current user's claims.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample14.cs)]

<span data-ttu-id="d9a59-278">Se o servidor de autorização e o servidor de recursos não estiverem no mesmo computador, o middleware OAuth usará as diferentes chaves da máquina para criptografar e descriptografar o token de acesso ao portador.</span><span class="sxs-lookup"><span data-stu-id="d9a59-278">If the authorization server and the resource server are not on the same computer, the OAuth middleware will use the different machine keys to encrypt and decrypt bearer access token.</span></span> <span data-ttu-id="d9a59-279">Para compartilhar a mesma chave privada entre ambos `machinekey` os projetos, adicionamos a mesma configuração em ambos os arquivos *web.config.*</span><span class="sxs-lookup"><span data-stu-id="d9a59-279">In order to share the same private key between both projects, we add the same `machinekey` setting in both *web.config* files.</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample15.xml?highlight=8-10)]

## <a name="create-oauth-20-clients"></a><span data-ttu-id="d9a59-280">Criar clientes OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="d9a59-280">Create OAuth 2.0 Clients</span></span>

 <span data-ttu-id="d9a59-281">Usamos o pacote [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet para simplificar o código do cliente.</span><span class="sxs-lookup"><span data-stu-id="d9a59-281">We use the [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet package to simplify the client code.</span></span>

### <a name="authorization-code-grant-client"></a><span data-ttu-id="d9a59-282">Cliente de concessão de código de autorização</span><span class="sxs-lookup"><span data-stu-id="d9a59-282">Authorization Code Grant Client</span></span>

 <span data-ttu-id="d9a59-283">Este cliente é um aplicativo MVC.</span><span class="sxs-lookup"><span data-stu-id="d9a59-283">This client is an MVC application.</span></span> <span data-ttu-id="d9a59-284">Ele acionará um fluxo de concessão de código de autorização para obter o token de acesso do backend.</span><span class="sxs-lookup"><span data-stu-id="d9a59-284">It will trigger an authorization code grant flow to get the access token from backend.</span></span> <span data-ttu-id="d9a59-285">Ele tem uma única página como mostrado abaixo:</span><span class="sxs-lookup"><span data-stu-id="d9a59-285">It has a single page as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image3.png)

- <span data-ttu-id="d9a59-286">O botão **Autorizar** redirecionará o navegador para o servidor de autorização para notificar o proprietário do recurso para conceder acesso a esse cliente.</span><span class="sxs-lookup"><span data-stu-id="d9a59-286">The **Authorize** button will redirect browser to the authorization server to notify the resource owner to grant access to this client.</span></span>
- <span data-ttu-id="d9a59-287">O botão **Atualizar** receberá um novo token de acesso e token de atualização usando o token de atualização atual.</span><span class="sxs-lookup"><span data-stu-id="d9a59-287">The **Refresh** button will get a new access token and refresh token using the current refresh token.</span></span>
- <span data-ttu-id="d9a59-288">O botão **API de recursos protegidos** de acesso ligará para o servidor de recursos para obter os dados de sinistros do usuário atual e mostrá-los na página.</span><span class="sxs-lookup"><span data-stu-id="d9a59-288">The **Access Protected Resource API** button will call the resource server to get current user's claims data and show them on the page.</span></span>

<span data-ttu-id="d9a59-289">Aqui está o código `HomeController` amostral do cliente.</span><span class="sxs-lookup"><span data-stu-id="d9a59-289">Here is the sample code of the `HomeController` of the client.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample16.cs)]

<span data-ttu-id="d9a59-290">`DotNetOpenAuth`requer SSL por padrão.</span><span class="sxs-lookup"><span data-stu-id="d9a59-290">`DotNetOpenAuth` requires SSL by default.</span></span> <span data-ttu-id="d9a59-291">Uma vez que nossa demonstração está usando HTTP, você precisa adicionar a seguinte configuração no arquivo de configuração:</span><span class="sxs-lookup"><span data-stu-id="d9a59-291">Since our demo is using HTTP, you need to add following setting in the config file:</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample17.xml?highlight=4-6)]

> [!WARNING]
> <span data-ttu-id="d9a59-292">Segurança - Nunca desabilite o SSL em um aplicativo de produção.</span><span class="sxs-lookup"><span data-stu-id="d9a59-292">Security - Never disable SSL in a production app.</span></span> <span data-ttu-id="d9a59-293">Suas credenciais de login estão sendo enviadas agora em texto claro através do fio.</span><span class="sxs-lookup"><span data-stu-id="d9a59-293">Your login credentials are now being sent in clear-text across the wire.</span></span> <span data-ttu-id="d9a59-294">O código acima é apenas para depuração e exploração de amostras locais.</span><span class="sxs-lookup"><span data-stu-id="d9a59-294">The code above is just for local sample debugging and exploration.</span></span>


### <a name="implicit-grant-client"></a><span data-ttu-id="d9a59-295">Cliente de Subvenção Implícita</span><span class="sxs-lookup"><span data-stu-id="d9a59-295">Implicit Grant Client</span></span>

<span data-ttu-id="d9a59-296">Este cliente está usando JavaScript para:</span><span class="sxs-lookup"><span data-stu-id="d9a59-296">This client is using JavaScript to:</span></span>

1. <span data-ttu-id="d9a59-297">Abra uma nova janela e redirecione para o ponto final autorizado do Servidor de Autorização.</span><span class="sxs-lookup"><span data-stu-id="d9a59-297">Open a new window and redirect to the authorize endpoint of the Authorization Server.</span></span>
2. <span data-ttu-id="d9a59-298">Obtenha o token de acesso a partir de fragmentos de URL quando ele redirecionar de volta.</span><span class="sxs-lookup"><span data-stu-id="d9a59-298">Get the access token from URL fragments when it redirects back.</span></span>

<span data-ttu-id="d9a59-299">A seguinte imagem mostra esse processo:</span><span class="sxs-lookup"><span data-stu-id="d9a59-299">The following image shows this process:</span></span>

![](owin-oauth-20-authorization-server/_static/image4.png)

<span data-ttu-id="d9a59-300">O cliente deve ter duas páginas: uma para home page e outra para retorno de chamada. Aqui está a amostra de código JavaScript encontrada no arquivo *Index.cshtml:*</span><span class="sxs-lookup"><span data-stu-id="d9a59-300">The client should have two pages: one for home page and the other for callback.Here is the sample JavaScript code found in the *Index.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample18.cshtml)]

<span data-ttu-id="d9a59-301">Aqui está o código de tratamento de retorno de chamada no arquivo *SignIn.cshtml:*</span><span class="sxs-lookup"><span data-stu-id="d9a59-301">Here is the callback handling code in *SignIn.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample19.cshtml)]

> [!NOTE]
> <span data-ttu-id="d9a59-302">Uma prática recomendada é mover o JavaScript para um arquivo externo e não incorporá-lo com a marcação Razor.</span><span class="sxs-lookup"><span data-stu-id="d9a59-302">A best practice is to move the JavaScript to an external file and not embed it with the Razor markup.</span></span> <span data-ttu-id="d9a59-303">Para manter esta amostra simples, eles foram combinados.</span><span class="sxs-lookup"><span data-stu-id="d9a59-303">To keep this sample simple, they have been combined.</span></span>


### <a name="resource-owner-password-credentials-grant-client"></a><span data-ttu-id="d9a59-304">Credenciais de senha do proprietário de recursos concedem cliente</span><span class="sxs-lookup"><span data-stu-id="d9a59-304">Resource Owner Password Credentials Grant Client</span></span>

<span data-ttu-id="d9a59-305">Usamos um aplicativo de console para demo este cliente.</span><span class="sxs-lookup"><span data-stu-id="d9a59-305">We uses a console app to demo this client.</span></span> <span data-ttu-id="d9a59-306">Eis o código:</span><span class="sxs-lookup"><span data-stu-id="d9a59-306">Here is the code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample20.cs)]

### <a name="client-credentials-grant-client"></a><span data-ttu-id="d9a59-307">Cliente de concessão de credenciais do cliente</span><span class="sxs-lookup"><span data-stu-id="d9a59-307">Client Credentials Grant Client</span></span>

<span data-ttu-id="d9a59-308">Semelhante ao Concessão de Credenciais de Senha do Proprietário de Recursos, aqui está o código do aplicativo do console:</span><span class="sxs-lookup"><span data-stu-id="d9a59-308">Similar to the Resource Owner Password Credentials Grant, here is console app code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample21.cs)]
