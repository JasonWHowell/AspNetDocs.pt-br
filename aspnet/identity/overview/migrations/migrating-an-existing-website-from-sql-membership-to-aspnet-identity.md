---
uid: identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
title: Migrando um site existente da associação do SQL para o ASP.NET Identity-ASP.NET 4. x
author: Rick-Anderson
description: Este tutorial ilustra as etapas para migrar um aplicativo Web existente com dados de usuário e função criados usando a associação do SQL com o novo ASP.NET Identity s...
ms.author: riande
ms.date: 12/19/2014
ms.custom: seoapril2019
ms.assetid: 220d3d75-16b2-4240-beae-a5b534f06419
msc.legacyurl: /identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 633229cc4311d151121bf6a91b9fa8aeecca1197
ms.sourcegitcommit: 7709c0a091b8d55b7b33bad8849f7b66b23c3d72
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 02/19/2020
ms.locfileid: "77456147"
---
# <a name="migrating-an-existing-website-from-sql-membership-to-aspnet-identity"></a><span data-ttu-id="e87e9-103">Migração de um site existente da Associação do SQL para a Identidade do ASP.NET</span><span class="sxs-lookup"><span data-stu-id="e87e9-103">Migrating an Existing Website from SQL Membership to ASP.NET Identity</span></span>

<span data-ttu-id="e87e9-104">por [Rick Anderson](https://twitter.com/RickAndMSFT), [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="e87e9-104">by [Rick Anderson](https://twitter.com/RickAndMSFT), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="e87e9-105">Este tutorial ilustra as etapas para migrar um aplicativo Web existente com dados de usuário e função criados usando a associação do SQL para o novo sistema de ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="e87e9-105">This tutorial illustrates the steps to migrate an existing web application with user and role data created using SQL Membership to the new ASP.NET Identity system.</span></span> <span data-ttu-id="e87e9-106">Essa abordagem envolve alterar o esquema de banco de dados existente para aquele necessário pelo ASP.NET Identity e conectar as classes antigas/novas a ele.</span><span class="sxs-lookup"><span data-stu-id="e87e9-106">This approach involves changing the existing database schema to the one needed by the ASP.NET Identity and hook in the old/new classes to it.</span></span> <span data-ttu-id="e87e9-107">Depois de adotar essa abordagem, depois que o banco de dados for migrado, futuras atualizações de identidade serão manipuladas sem esforço.</span><span class="sxs-lookup"><span data-stu-id="e87e9-107">After you adopt this approach, once your database is migrated, future updates to Identity will be handled effortlessly.</span></span>

<span data-ttu-id="e87e9-108">Para este tutorial, usaremos um modelo de aplicativo Web (Web Forms) criado usando o Visual Studio 2010 para criar dados de usuário e função.</span><span class="sxs-lookup"><span data-stu-id="e87e9-108">For this tutorial, we will take a web application template (Web Forms) created using Visual Studio 2010 to create user and role data.</span></span> <span data-ttu-id="e87e9-109">Em seguida, usaremos scripts SQL para migrar o banco de dados existente para tabelas necessárias para o sistema de identidade.</span><span class="sxs-lookup"><span data-stu-id="e87e9-109">We will then use SQL scripts to migrate the existing database to tables needed by the Identity system.</span></span> <span data-ttu-id="e87e9-110">Em seguida, instalaremos os pacotes NuGet necessários e adicionaremos novas páginas de gerenciamento de conta que usam o sistema de identidade para o gerenciamento de associação.</span><span class="sxs-lookup"><span data-stu-id="e87e9-110">Next we'll install the necessary NuGet packages and add new account management pages which use the Identity system for membership management.</span></span> <span data-ttu-id="e87e9-111">Como um teste de migração, os usuários criados usando a associação do SQL devem ser capazes de fazer logon e novos usuários devem ser capazes de se registrar.</span><span class="sxs-lookup"><span data-stu-id="e87e9-111">As a test of migration, users created using SQL membership should be able to log in and new users should be able to register.</span></span> <span data-ttu-id="e87e9-112">Você pode encontrar o exemplo completo [aqui](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/).</span><span class="sxs-lookup"><span data-stu-id="e87e9-112">You can find the complete sample [here](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/).</span></span> <span data-ttu-id="e87e9-113">Consulte também [migrando da associação do ASP.net para ASP.net Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).</span><span class="sxs-lookup"><span data-stu-id="e87e9-113">See also [Migrating from ASP.NET Membership to ASP.NET Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).</span></span>

## <a name="getting-started"></a><span data-ttu-id="e87e9-114">Introdução</span><span class="sxs-lookup"><span data-stu-id="e87e9-114">Getting started</span></span>

### <a name="creating-an-application-with-sql-membership"></a><span data-ttu-id="e87e9-115">Criando um aplicativo com associação do SQL</span><span class="sxs-lookup"><span data-stu-id="e87e9-115">Creating an application with SQL Membership</span></span>

1. <span data-ttu-id="e87e9-116">Precisamos começar com um aplicativo existente que usa a associação do SQL e que tem dados de usuário e função.</span><span class="sxs-lookup"><span data-stu-id="e87e9-116">We need to start with an existing application that uses SQL membership and has user and role data.</span></span> <span data-ttu-id="e87e9-117">Para a finalidade deste artigo, vamos criar um aplicativo Web no Visual Studio 2010.</span><span class="sxs-lookup"><span data-stu-id="e87e9-117">For the purpose of this article, let's create a web application in Visual Studio 2010.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="e87e9-118">Usando a ferramenta de configuração do ASP.NET, crie dois usuários: **oldAdminUser** e **oldUser.**</span><span class="sxs-lookup"><span data-stu-id="e87e9-118">Using the ASP.NET Configuration tool, create 2 users: **oldAdminUser** and **oldUser.**</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.jpg)
3. <span data-ttu-id="e87e9-119">Crie uma função chamada admin e adicione ' oldAdminUser ' como um usuário nessa função.</span><span class="sxs-lookup"><span data-stu-id="e87e9-119">Create a role named Admin and add 'oldAdminUser' as a user in that role.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.png)
4. <span data-ttu-id="e87e9-120">Crie uma seção de administrador do site com um default. aspx.</span><span class="sxs-lookup"><span data-stu-id="e87e9-120">Create an Admin section of the site with a Default.aspx.</span></span> <span data-ttu-id="e87e9-121">Defina a marca Authorization no arquivo Web. config para habilitar o acesso somente aos usuários em funções de administrador.</span><span class="sxs-lookup"><span data-stu-id="e87e9-121">Set the authorization tag in the web.config file to enable access only to users in Admin roles.</span></span> <span data-ttu-id="e87e9-122">Mais informações podem ser encontradas aqui [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span><span class="sxs-lookup"><span data-stu-id="e87e9-122">More information can be found here [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.png)
5. <span data-ttu-id="e87e9-123">Exiba o banco de dados no Gerenciador de Servidores para entender as tabelas criadas pelo sistema de associação do SQL.</span><span class="sxs-lookup"><span data-stu-id="e87e9-123">View the database in Server Explorer to understand the tables created by the SQL membership system.</span></span> <span data-ttu-id="e87e9-124">Os dados de logon do usuário são armazenados no ASPNET\_usuários e nas tabelas de associação do ASPNET\_, enquanto os dados de função são armazenados na tabela de funções do ASPNET\_.</span><span class="sxs-lookup"><span data-stu-id="e87e9-124">The user login data is stored in the aspnet\_Users and aspnet\_Membership tables, while role data is stored in the aspnet\_Roles table.</span></span> <span data-ttu-id="e87e9-125">Informações sobre quais usuários estão em quais funções são armazenadas na tabela ASPNET\_UsersInRoles.</span><span class="sxs-lookup"><span data-stu-id="e87e9-125">Information about which users are in which roles is stored in the aspnet\_UsersInRoles table.</span></span> <span data-ttu-id="e87e9-126">Para o gerenciamento de associação básico, é suficiente para portar as informações nas tabelas acima para o sistema ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="e87e9-126">For basic membership management it is sufficient to port the information in the above tables to the ASP.NET Identity system.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.png)

### <a name="migrating-to-visual-studio-2013"></a><span data-ttu-id="e87e9-127">Migrando para o Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="e87e9-127">Migrating to Visual Studio 2013</span></span>

1. <span data-ttu-id="e87e9-128">Instale o Visual Studio Express 2013 para Web ou Visual Studio 2013 juntamente com as [atualizações mais recentes](https://www.microsoft.com/download/details.aspx?id=44921).</span><span class="sxs-lookup"><span data-stu-id="e87e9-128">Install Visual Studio Express 2013 for Web or Visual Studio 2013 along with the [latest updates](https://www.microsoft.com/download/details.aspx?id=44921).</span></span>
2. <span data-ttu-id="e87e9-129">Abra o projeto acima na versão instalada do Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="e87e9-129">Open the above project in your installed version of Visual Studio.</span></span> <span data-ttu-id="e87e9-130">Se o SQL Server Express não estiver instalado no computador, um prompt será exibido quando você abrir o projeto, já que a cadeia de conexão usa o SQL Express.</span><span class="sxs-lookup"><span data-stu-id="e87e9-130">If SQL Server Express is not installed on the machine, a prompt is displayed when you open the project, since the connection string uses SQL Express.</span></span> <span data-ttu-id="e87e9-131">Você pode optar por instalar o SQL Express ou como solução alternativa para alterar a cadeia de conexão para o LocalDb.</span><span class="sxs-lookup"><span data-stu-id="e87e9-131">You can either choose to install SQL Express or as work around change the connection string to LocalDb.</span></span> <span data-ttu-id="e87e9-132">Para este artigo, vamos alterá-lo para o LocalDb.</span><span class="sxs-lookup"><span data-stu-id="e87e9-132">For this article we'll change it to LocalDb.</span></span>
3. <span data-ttu-id="e87e9-133">Abra o Web. config e altere a cadeia de conexão de. SQLExpress para (LocalDb) v 11.0.</span><span class="sxs-lookup"><span data-stu-id="e87e9-133">Open web.config and change the connection string from .SQLExpress to (LocalDb)v11.0.</span></span> <span data-ttu-id="e87e9-134">Remova ' User Instance = true ' da cadeia de conexão.</span><span class="sxs-lookup"><span data-stu-id="e87e9-134">Remove 'User Instance=true' from the connection string.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.jpg)
4. <span data-ttu-id="e87e9-135">Abra Gerenciador de Servidores e verifique se o esquema de tabela e os dados podem ser observados.</span><span class="sxs-lookup"><span data-stu-id="e87e9-135">Open Server Explorer and verify that the table schema and data can be observed.</span></span>
5. <span data-ttu-id="e87e9-136">O sistema ASP.NET Identity funciona com a versão 4,5 ou superior da estrutura.</span><span class="sxs-lookup"><span data-stu-id="e87e9-136">The ASP.NET Identity system works with version 4.5 or higher of the framework.</span></span> <span data-ttu-id="e87e9-137">Redirecione o aplicativo para 4,5 ou superior.</span><span class="sxs-lookup"><span data-stu-id="e87e9-137">Retarget the application to 4.5 or higher.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image5.png)

    <span data-ttu-id="e87e9-138">Compile o projeto para verificar se não há erros.</span><span class="sxs-lookup"><span data-stu-id="e87e9-138">Build the project to verify that there are no errors.</span></span>

### <a name="installing-the-nuget-packages"></a><span data-ttu-id="e87e9-139">Instalando os pacotes NuGet</span><span class="sxs-lookup"><span data-stu-id="e87e9-139">Installing the Nuget packages</span></span>

1. <span data-ttu-id="e87e9-140">Em Gerenciador de Soluções, clique com o botão direito do mouse no projeto &gt; **gerenciar pacotes NuGet**.</span><span class="sxs-lookup"><span data-stu-id="e87e9-140">In Solution Explorer, right-click the project &gt; **Manage NuGet Packages**.</span></span> <span data-ttu-id="e87e9-141">Na caixa de pesquisa, digite "Asp.net Identity".</span><span class="sxs-lookup"><span data-stu-id="e87e9-141">In the search box, enter "Asp.net Identity".</span></span> <span data-ttu-id="e87e9-142">Selecione o pacote na lista de resultados e clique em instalar.</span><span class="sxs-lookup"><span data-stu-id="e87e9-142">Select the package in the list of results and click install.</span></span> <span data-ttu-id="e87e9-143">Aceite o contrato de licença clicando no botão "aceito".</span><span class="sxs-lookup"><span data-stu-id="e87e9-143">Accept the license agreement by clicking on "I Accept" button.</span></span> <span data-ttu-id="e87e9-144">Observe que esse pacote instalará os pacotes de dependência: EntityFramework e Microsoft ASP.NET Identity Core.</span><span class="sxs-lookup"><span data-stu-id="e87e9-144">Note that this package will install the dependency packages: EntityFramework and Microsoft ASP.NET Identity Core.</span></span> <span data-ttu-id="e87e9-145">Da mesma forma, instale os seguintes pacotes (ignore os quatro últimos pacotes OWIN se você não quiser habilitar o logon OAuth):</span><span class="sxs-lookup"><span data-stu-id="e87e9-145">Similarly install the following packages (skip the last 4 OWIN packages if you don't want to enable OAuth log-in):</span></span>

   - <span data-ttu-id="e87e9-146">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="e87e9-146">Microsoft.AspNet.Identity.Owin</span></span>
   - <span data-ttu-id="e87e9-147">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="e87e9-147">Microsoft.Owin.Host.SystemWeb</span></span>
   - <span data-ttu-id="e87e9-148">Microsoft.Owin.Security.Facebook</span><span class="sxs-lookup"><span data-stu-id="e87e9-148">Microsoft.Owin.Security.Facebook</span></span>
   - <span data-ttu-id="e87e9-149">Microsoft.Owin.Security.Google</span><span class="sxs-lookup"><span data-stu-id="e87e9-149">Microsoft.Owin.Security.Google</span></span>
   - <span data-ttu-id="e87e9-150">Microsoft.Owin.Security.MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="e87e9-150">Microsoft.Owin.Security.MicrosoftAccount</span></span>
   - <span data-ttu-id="e87e9-151">Microsoft.Owin.Security.Twitter</span><span class="sxs-lookup"><span data-stu-id="e87e9-151">Microsoft.Owin.Security.Twitter</span></span>

     ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image6.png)

### <a name="migrate-database-to-the-new-identity-system"></a><span data-ttu-id="e87e9-152">Migrar banco de dados para o novo sistema de identidade</span><span class="sxs-lookup"><span data-stu-id="e87e9-152">Migrate database to the new Identity system</span></span>

<span data-ttu-id="e87e9-153">A próxima etapa é migrar o banco de dados existente para um esquema exigido pelo sistema ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="e87e9-153">The next step is to migrate the existing database to a schema required by the ASP.NET Identity system.</span></span> <span data-ttu-id="e87e9-154">Para conseguir isso, executamos um script SQL que tem um conjunto de comandos para criar novas tabelas e migrar informações de usuário existentes para as novas tabelas.</span><span class="sxs-lookup"><span data-stu-id="e87e9-154">To achieve this we run a SQL script which has a set of commands to create new tables and migrate existing user information to the new tables.</span></span> <span data-ttu-id="e87e9-155">O arquivo de script pode ser encontrado [aqui](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span><span class="sxs-lookup"><span data-stu-id="e87e9-155">The script file can be found [here](https://github.com/aspnet/samples/blob/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span></span>

<span data-ttu-id="e87e9-156">Este arquivo de script é específico para este exemplo.</span><span class="sxs-lookup"><span data-stu-id="e87e9-156">This script file is specific to this sample.</span></span> <span data-ttu-id="e87e9-157">Se o esquema para as tabelas criadas usando a associação do SQL for personalizado ou modificado, os scripts precisarão ser alterados de acordo.</span><span class="sxs-lookup"><span data-stu-id="e87e9-157">If the schema for the tables created using SQL membership is customized or modified the scripts need to be changed accordingly.</span></span>

### <a name="how-to-generate-the-sql-script-for-schema-migration"></a><span data-ttu-id="e87e9-158">Como gerar o script SQL para a migração de esquema</span><span class="sxs-lookup"><span data-stu-id="e87e9-158">How to generate the SQL script for schema migration</span></span>

<span data-ttu-id="e87e9-159">Para que ASP.NET Identity classes funcionem prontamente com os dados dos usuários existentes, precisamos migrar o esquema de banco de dados para o que é necessário pelo ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="e87e9-159">For ASP.NET Identity classes to work out of the box with the data of existing users, we need to migrate the database schema to the one needed by ASP.NET Identity.</span></span> <span data-ttu-id="e87e9-160">Podemos fazer isso adicionando novas tabelas e copiando as informações existentes nessas tabelas.</span><span class="sxs-lookup"><span data-stu-id="e87e9-160">We can do this by adding new tables and copying the existing information to those tables.</span></span> <span data-ttu-id="e87e9-161">Por padrão ASP.NET Identity usa o EntityFramework para mapear as classes de modelo de identidade de volta para o banco de dados para armazenar/recuperar informações.</span><span class="sxs-lookup"><span data-stu-id="e87e9-161">By default ASP.NET Identity uses EntityFramework to map the Identity model classes back to the database to store/retrieve information.</span></span> <span data-ttu-id="e87e9-162">Essas classes de modelo implementam as principais interfaces de identidade que definem objetos de usuário e função.</span><span class="sxs-lookup"><span data-stu-id="e87e9-162">These model classes implement the core Identity interfaces defining user and role objects.</span></span> <span data-ttu-id="e87e9-163">As tabelas e as colunas no banco de dados baseiam-se nessas classes de modelo.</span><span class="sxs-lookup"><span data-stu-id="e87e9-163">The tables and the columns in the database are based on these model classes.</span></span> <span data-ttu-id="e87e9-164">As classes de modelo do EntityFramework no Identity v 2.1.0 e suas propriedades são conforme definido abaixo</span><span class="sxs-lookup"><span data-stu-id="e87e9-164">The EntityFramework model classes in Identity v2.1.0 and their properties are as defined below</span></span>

| <span data-ttu-id="e87e9-165">**IdentityUser**</span><span class="sxs-lookup"><span data-stu-id="e87e9-165">**IdentityUser**</span></span> | <span data-ttu-id="e87e9-166">**Tipo**</span><span class="sxs-lookup"><span data-stu-id="e87e9-166">**Type**</span></span> | <span data-ttu-id="e87e9-167">**IdentityRole**</span><span class="sxs-lookup"><span data-stu-id="e87e9-167">**IdentityRole**</span></span> | <span data-ttu-id="e87e9-168">**IdentityUserRole**</span><span class="sxs-lookup"><span data-stu-id="e87e9-168">**IdentityUserRole**</span></span> | <span data-ttu-id="e87e9-169">**IdentityUserLogin**</span><span class="sxs-lookup"><span data-stu-id="e87e9-169">**IdentityUserLogin**</span></span> | <span data-ttu-id="e87e9-170">**IdentityUserClaim**</span><span class="sxs-lookup"><span data-stu-id="e87e9-170">**IdentityUserClaim**</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="e87e9-171">Id</span><span class="sxs-lookup"><span data-stu-id="e87e9-171">Id</span></span> | <span data-ttu-id="e87e9-172">string</span><span class="sxs-lookup"><span data-stu-id="e87e9-172">string</span></span> | <span data-ttu-id="e87e9-173">Id</span><span class="sxs-lookup"><span data-stu-id="e87e9-173">Id</span></span> | <span data-ttu-id="e87e9-174">RoleId</span><span class="sxs-lookup"><span data-stu-id="e87e9-174">RoleId</span></span> | <span data-ttu-id="e87e9-175">ProviderKey</span><span class="sxs-lookup"><span data-stu-id="e87e9-175">ProviderKey</span></span> | <span data-ttu-id="e87e9-176">Id</span><span class="sxs-lookup"><span data-stu-id="e87e9-176">Id</span></span> |
| <span data-ttu-id="e87e9-177">Nome de Usuário</span><span class="sxs-lookup"><span data-stu-id="e87e9-177">Username</span></span> | <span data-ttu-id="e87e9-178">string</span><span class="sxs-lookup"><span data-stu-id="e87e9-178">string</span></span> | <span data-ttu-id="e87e9-179">{1&gt;Nome&lt;1}</span><span class="sxs-lookup"><span data-stu-id="e87e9-179">Name</span></span> | <span data-ttu-id="e87e9-180">UserId</span><span class="sxs-lookup"><span data-stu-id="e87e9-180">UserId</span></span> | <span data-ttu-id="e87e9-181">UserId</span><span class="sxs-lookup"><span data-stu-id="e87e9-181">UserId</span></span> | <span data-ttu-id="e87e9-182">ClaimType</span><span class="sxs-lookup"><span data-stu-id="e87e9-182">ClaimType</span></span> |
| <span data-ttu-id="e87e9-183">PasswordHash</span><span class="sxs-lookup"><span data-stu-id="e87e9-183">PasswordHash</span></span> | <span data-ttu-id="e87e9-184">string</span><span class="sxs-lookup"><span data-stu-id="e87e9-184">string</span></span> |  |  | <span data-ttu-id="e87e9-185">LoginProvider</span><span class="sxs-lookup"><span data-stu-id="e87e9-185">LoginProvider</span></span> | <span data-ttu-id="e87e9-186">ClaimValue</span><span class="sxs-lookup"><span data-stu-id="e87e9-186">ClaimValue</span></span> |
| <span data-ttu-id="e87e9-187">SecurityStamp</span><span class="sxs-lookup"><span data-stu-id="e87e9-187">SecurityStamp</span></span> | <span data-ttu-id="e87e9-188">string</span><span class="sxs-lookup"><span data-stu-id="e87e9-188">string</span></span> |  |  |  | <span data-ttu-id="e87e9-189">ID de\_de usuário</span><span class="sxs-lookup"><span data-stu-id="e87e9-189">User\_Id</span></span> |
| <span data-ttu-id="e87e9-190">Email</span><span class="sxs-lookup"><span data-stu-id="e87e9-190">Email</span></span> | <span data-ttu-id="e87e9-191">string</span><span class="sxs-lookup"><span data-stu-id="e87e9-191">string</span></span> |  |  |  |  |
| <span data-ttu-id="e87e9-192">EmailConfirmed</span><span class="sxs-lookup"><span data-stu-id="e87e9-192">EmailConfirmed</span></span> | <span data-ttu-id="e87e9-193">{1&gt;bool&lt;1}</span><span class="sxs-lookup"><span data-stu-id="e87e9-193">bool</span></span> |  |  |  |  |
| <span data-ttu-id="e87e9-194">PhoneNumber</span><span class="sxs-lookup"><span data-stu-id="e87e9-194">PhoneNumber</span></span> | <span data-ttu-id="e87e9-195">string</span><span class="sxs-lookup"><span data-stu-id="e87e9-195">string</span></span> |  |  |  |  |
| <span data-ttu-id="e87e9-196">PhoneNumberConfirmed</span><span class="sxs-lookup"><span data-stu-id="e87e9-196">PhoneNumberConfirmed</span></span> | <span data-ttu-id="e87e9-197">{1&gt;bool&lt;1}</span><span class="sxs-lookup"><span data-stu-id="e87e9-197">bool</span></span> |  |  |  |  |
| <span data-ttu-id="e87e9-198">LockoutEnabled</span><span class="sxs-lookup"><span data-stu-id="e87e9-198">LockoutEnabled</span></span> | <span data-ttu-id="e87e9-199">{1&gt;bool&lt;1}</span><span class="sxs-lookup"><span data-stu-id="e87e9-199">bool</span></span> |  |  |  |  |
| <span data-ttu-id="e87e9-200">LockoutEndDate</span><span class="sxs-lookup"><span data-stu-id="e87e9-200">LockoutEndDate</span></span> | <span data-ttu-id="e87e9-201">Datetime</span><span class="sxs-lookup"><span data-stu-id="e87e9-201">DateTime</span></span> |  |  |  |  |
| <span data-ttu-id="e87e9-202">AccessFailedCount</span><span class="sxs-lookup"><span data-stu-id="e87e9-202">AccessFailedCount</span></span> | <span data-ttu-id="e87e9-203">int</span><span class="sxs-lookup"><span data-stu-id="e87e9-203">int</span></span> |  |  |  |  |

<span data-ttu-id="e87e9-204">Precisamos ter tabelas para cada um desses modelos com colunas correspondentes às propriedades.</span><span class="sxs-lookup"><span data-stu-id="e87e9-204">We need to have tables for each of these models with columns corresponding to the properties.</span></span> <span data-ttu-id="e87e9-205">O mapeamento entre classes e tabelas é definido no método `OnModelCreating` da `IdentityDBContext`.</span><span class="sxs-lookup"><span data-stu-id="e87e9-205">The mapping between classes and tables is defined in the `OnModelCreating` method of the `IdentityDBContext`.</span></span> <span data-ttu-id="e87e9-206">Isso é conhecido como o método de API fluente de configuração e mais informações podem ser encontradas [aqui](https://msdn.microsoft.com/data/jj591617.aspx).</span><span class="sxs-lookup"><span data-stu-id="e87e9-206">This is known as the fluent API method of configuration and more information can be found [here](https://msdn.microsoft.com/data/jj591617.aspx).</span></span> <span data-ttu-id="e87e9-207">A configuração das classes é conforme mencionado abaixo</span><span class="sxs-lookup"><span data-stu-id="e87e9-207">The configuration for the classes is as mentioned below</span></span>

| <span data-ttu-id="e87e9-208">**Classe**</span><span class="sxs-lookup"><span data-stu-id="e87e9-208">**Class**</span></span> | <span data-ttu-id="e87e9-209">**Table**</span><span class="sxs-lookup"><span data-stu-id="e87e9-209">**Table**</span></span> | <span data-ttu-id="e87e9-210">**Chave primária**</span><span class="sxs-lookup"><span data-stu-id="e87e9-210">**Primary key**</span></span> | <span data-ttu-id="e87e9-211">**Chave estrangeira**</span><span class="sxs-lookup"><span data-stu-id="e87e9-211">**Foreign key**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="e87e9-212">IdentityUser</span><span class="sxs-lookup"><span data-stu-id="e87e9-212">IdentityUser</span></span> | <span data-ttu-id="e87e9-213">AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="e87e9-213">AspnetUsers</span></span> | <span data-ttu-id="e87e9-214">Id</span><span class="sxs-lookup"><span data-stu-id="e87e9-214">Id</span></span> |  |
| <span data-ttu-id="e87e9-215">IdentityRole</span><span class="sxs-lookup"><span data-stu-id="e87e9-215">IdentityRole</span></span> | <span data-ttu-id="e87e9-216">AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="e87e9-216">AspnetRoles</span></span> | <span data-ttu-id="e87e9-217">Id</span><span class="sxs-lookup"><span data-stu-id="e87e9-217">Id</span></span> |  |
| <span data-ttu-id="e87e9-218">IdentityUserRole</span><span class="sxs-lookup"><span data-stu-id="e87e9-218">IdentityUserRole</span></span> | <span data-ttu-id="e87e9-219">AspnetUserRole</span><span class="sxs-lookup"><span data-stu-id="e87e9-219">AspnetUserRole</span></span> | <span data-ttu-id="e87e9-220">UserId + RoleID</span><span class="sxs-lookup"><span data-stu-id="e87e9-220">UserId + RoleId</span></span> | <span data-ttu-id="e87e9-221">ID de\_de usuário-&gt;AspnetUsers RoleID-&gt;AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="e87e9-221">User\_Id-&gt;AspnetUsers RoleId-&gt;AspnetRoles</span></span> |
| <span data-ttu-id="e87e9-222">IdentityUserLogin</span><span class="sxs-lookup"><span data-stu-id="e87e9-222">IdentityUserLogin</span></span> | <span data-ttu-id="e87e9-223">AspnetUserLogins</span><span class="sxs-lookup"><span data-stu-id="e87e9-223">AspnetUserLogins</span></span> | <span data-ttu-id="e87e9-224">ProviderKey + UserId + Loginprovider</span><span class="sxs-lookup"><span data-stu-id="e87e9-224">ProviderKey+UserId + LoginProvider</span></span> | <span data-ttu-id="e87e9-225">UserId-&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="e87e9-225">UserId-&gt;AspnetUsers</span></span> |
| <span data-ttu-id="e87e9-226">IdentityUserClaim</span><span class="sxs-lookup"><span data-stu-id="e87e9-226">IdentityUserClaim</span></span> | <span data-ttu-id="e87e9-227">AspnetUserClaims</span><span class="sxs-lookup"><span data-stu-id="e87e9-227">AspnetUserClaims</span></span> | <span data-ttu-id="e87e9-228">Id</span><span class="sxs-lookup"><span data-stu-id="e87e9-228">Id</span></span> | <span data-ttu-id="e87e9-229">ID de\_de usuário-&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="e87e9-229">User\_Id-&gt;AspnetUsers</span></span> |

<span data-ttu-id="e87e9-230">Com essas informações, podemos criar instruções SQL para criar novas tabelas.</span><span class="sxs-lookup"><span data-stu-id="e87e9-230">With this information we can create SQL statements to create new tables.</span></span> <span data-ttu-id="e87e9-231">Podemos escrever cada instrução individualmente ou gerar o script inteiro usando os comandos do EntityFramework PowerShell, que podemos editar conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="e87e9-231">We can either write each statement individually or generate the entire script using EntityFramework PowerShell commands which we can then edit as required.</span></span> <span data-ttu-id="e87e9-232">Para fazer isso, no VS Abra o **console do Gerenciador de pacotes** no menu **Exibir** ou **ferramentas**</span><span class="sxs-lookup"><span data-stu-id="e87e9-232">To do this, in VS open the **Package Manager Console** from the **View** or **Tools** menu</span></span>

- <span data-ttu-id="e87e9-233">Execute o comando "Enable-Migrations" para habilitar as migrações do EntityFramework.</span><span class="sxs-lookup"><span data-stu-id="e87e9-233">Run command "Enable-Migrations" to enable EntityFramework migrations.</span></span>
- <span data-ttu-id="e87e9-234">Execute o comando "Add-Migration Initial", que cria o código inicial de instalação para C#criar o banco de dados no/VB.</span><span class="sxs-lookup"><span data-stu-id="e87e9-234">Run command "Add-migration initial" which creates the initial setup code to create the database in C#/VB.</span></span>
- <span data-ttu-id="e87e9-235">A etapa final é executar o comando "Update-Database-script" que gera o script SQL com base nas classes de modelo.</span><span class="sxs-lookup"><span data-stu-id="e87e9-235">The final step is to run "Update-Database –Script" command that generates the SQL script based on the model classes.</span></span>

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

<span data-ttu-id="e87e9-236">Esse script de geração de banco de dados pode ser usado como um início onde vamos fazer alterações adicionais para adicionar novas colunas e copiar dados.</span><span class="sxs-lookup"><span data-stu-id="e87e9-236">This database generation script can be used as a start where we'll be making additional changes to add new columns and copy data.</span></span> <span data-ttu-id="e87e9-237">A vantagem disso é que geramos a tabela de `_MigrationHistory` que é usada pelo EntityFramework para modificar o esquema de banco de dados quando as classes de modelo mudam para versões futuras de versões de identidade.</span><span class="sxs-lookup"><span data-stu-id="e87e9-237">The advantage of this is that we generate the `_MigrationHistory` table which is used by EntityFramework to modify the database schema when the model classes change for future versions of Identity releases.</span></span>

<span data-ttu-id="e87e9-238">As informações de usuário da associação do SQL tinham outras propriedades, além daquelas na classe de modelo de usuário de identidade, por email, tentativas de senha, última data de logon, data do último bloqueio, etc. Essas são informações úteis e gostaríamos que ela fosse transportada para o sistema de identidade.</span><span class="sxs-lookup"><span data-stu-id="e87e9-238">The SQL membership user information had other properties in addition to the ones in the Identity user model class namely email, password attempts, last login date, last lock-out date etc. This is useful information and we would like it to be carried over to the Identity system.</span></span> <span data-ttu-id="e87e9-239">Isso pode ser feito adicionando propriedades adicionais ao modelo de usuário e mapeando-as de volta para as colunas de tabela no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="e87e9-239">This can be done by adding additional properties to the user model and mapping them back to the table columns in the database.</span></span> <span data-ttu-id="e87e9-240">Podemos fazer isso adicionando uma classe que cria subclasses do modelo de `IdentityUser`.</span><span class="sxs-lookup"><span data-stu-id="e87e9-240">We can do this by adding a class that subclasses the `IdentityUser` model.</span></span> <span data-ttu-id="e87e9-241">Podemos adicionar as propriedades a essa classe personalizada e editar o script SQL para adicionar as colunas correspondentes ao criar a tabela.</span><span class="sxs-lookup"><span data-stu-id="e87e9-241">We can add the properties to this custom class and edit the SQL script to add the corresponding columns when creating the table.</span></span> <span data-ttu-id="e87e9-242">O código para essa classe é descrito mais adiante no artigo.</span><span class="sxs-lookup"><span data-stu-id="e87e9-242">The code for this class is described further in the article.</span></span> <span data-ttu-id="e87e9-243">O script SQL para criar a tabela de `AspnetUsers` depois de adicionar as novas propriedades seria</span><span class="sxs-lookup"><span data-stu-id="e87e9-243">The SQL script for creating the `AspnetUsers` table after adding the new properties would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample1.sql)]

<span data-ttu-id="e87e9-244">Em seguida, precisamos copiar as informações existentes do banco de dados de associação do SQL para as tabelas adicionadas recentemente para identidade.</span><span class="sxs-lookup"><span data-stu-id="e87e9-244">Next we need to copy the existing information from the SQL membership database to the newly added tables for Identity.</span></span> <span data-ttu-id="e87e9-245">Isso pode ser feito por meio do SQL copiando dados diretamente de uma tabela para outra.</span><span class="sxs-lookup"><span data-stu-id="e87e9-245">This can be done through SQL by copying data directly from one table to another.</span></span> <span data-ttu-id="e87e9-246">Para adicionar dados às linhas da tabela, usamos a construção `INSERT INTO [Table]`.</span><span class="sxs-lookup"><span data-stu-id="e87e9-246">To add data into the rows of table, we use the `INSERT INTO [Table]` construct.</span></span> <span data-ttu-id="e87e9-247">Para copiar de outra tabela, podemos usar a instrução `INSERT INTO` junto com a instrução `SELECT`.</span><span class="sxs-lookup"><span data-stu-id="e87e9-247">To copy from another table we can use the `INSERT INTO` statement along with the `SELECT` statement.</span></span> <span data-ttu-id="e87e9-248">Para obter todas as informações de usuário, precisamos consultar as tabelas *aspnet\_Users* e *ASPNET\_Membership* e copiar os dados para a tabela *AspNetUsers* .</span><span class="sxs-lookup"><span data-stu-id="e87e9-248">To get all the user information we need to query the *aspnet\_Users* and *aspnet\_Membership* tables and copy the data to the *AspNetUsers* table.</span></span> <span data-ttu-id="e87e9-249">Usamos o `INSERT INTO` e `SELECT` junto com as instruções `JOIN` e `LEFT OUTER JOIN`.</span><span class="sxs-lookup"><span data-stu-id="e87e9-249">We use the `INSERT INTO` and `SELECT` along with `JOIN` and `LEFT OUTER JOIN` statements.</span></span> <span data-ttu-id="e87e9-250">Para obter mais informações sobre como consultar e copiar dados entre tabelas, consulte [este](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) link.</span><span class="sxs-lookup"><span data-stu-id="e87e9-250">For more information about querying and copying data between tables, refer to [this](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) link.</span></span> <span data-ttu-id="e87e9-251">Além disso, as tabelas AspnetUserLogins e AspnetUserClaims estão vazias para começar, já que não há nenhuma informação na associação do SQL que é mapeada para isso por padrão.</span><span class="sxs-lookup"><span data-stu-id="e87e9-251">Additionally the AspnetUserLogins and AspnetUserClaims tables are empty to begin with since there is no information in SQL membership that maps to this by default.</span></span> <span data-ttu-id="e87e9-252">As únicas informações copiadas são para usuários e funções.</span><span class="sxs-lookup"><span data-stu-id="e87e9-252">The only information copied is for users and roles.</span></span> <span data-ttu-id="e87e9-253">Para o projeto criado nas etapas anteriores, a consulta SQL para copiar informações para a tabela usuários seria</span><span class="sxs-lookup"><span data-stu-id="e87e9-253">For the project created in the previous steps, the SQL query to copy information to the users table would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample2.sql)]

<span data-ttu-id="e87e9-254">Na instrução SQL acima, as informações sobre cada usuário do *aspnet\_usuários* e as tabelas de *associação do ASPNET\_* são copiadas para as colunas da tabela *AspnetUsers* .</span><span class="sxs-lookup"><span data-stu-id="e87e9-254">In the above SQL statement, information about each user from the *aspnet\_Users* and *aspnet\_Membership* tables is copied into the columns of the *AspnetUsers* table.</span></span> <span data-ttu-id="e87e9-255">A única modificação feita aqui é quando copiamos a senha.</span><span class="sxs-lookup"><span data-stu-id="e87e9-255">The only modification done here is when we copy the password.</span></span> <span data-ttu-id="e87e9-256">Como o algoritmo de criptografia para senhas na associação do SQL usou ' PasswordSalt ' e ' PasswordFormat ', copiamos isso também com a senha de hash para que ele possa ser usado para descriptografar a senha por identidade.</span><span class="sxs-lookup"><span data-stu-id="e87e9-256">Since the encryption algorithm for passwords in SQL membership used 'PasswordSalt' and 'PasswordFormat', we copy that too along with the hashed password so that it can be used to decrypt the password by Identity.</span></span> <span data-ttu-id="e87e9-257">Isso é explicado mais detalhadamente no artigo ao conectar um hash personalizado de senha.</span><span class="sxs-lookup"><span data-stu-id="e87e9-257">This is explained further in the article when hooking up a custom password hasher.</span></span>

<span data-ttu-id="e87e9-258">Este arquivo de script é específico para este exemplo.</span><span class="sxs-lookup"><span data-stu-id="e87e9-258">This script file is specific to this sample.</span></span> <span data-ttu-id="e87e9-259">Para aplicativos que têm tabelas adicionais, os desenvolvedores podem seguir uma abordagem semelhante para adicionar propriedades adicionais na classe de modelo de usuário e mapeá-las para colunas na tabela AspnetUsers.</span><span class="sxs-lookup"><span data-stu-id="e87e9-259">For applications which have additional tables, developers can follow a similar approach to add additional properties on the user model class and map them to columns in the AspnetUsers table.</span></span> <span data-ttu-id="e87e9-260">Para executar o script,</span><span class="sxs-lookup"><span data-stu-id="e87e9-260">To run the script,</span></span>

1. <span data-ttu-id="e87e9-261">Abra o Gerenciador de Servidores.</span><span class="sxs-lookup"><span data-stu-id="e87e9-261">Open Server Explorer.</span></span> <span data-ttu-id="e87e9-262">Expanda a conexão ' ApplicationServices ' para exibir as tabelas.</span><span class="sxs-lookup"><span data-stu-id="e87e9-262">Expand the 'ApplicationServices' connection to display the tables.</span></span> <span data-ttu-id="e87e9-263">Clique com o botão direito do mouse no nó tabelas e selecione a opção ' nova consulta '</span><span class="sxs-lookup"><span data-stu-id="e87e9-263">Right click on the Tables node and select the 'New Query' option</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image7.png)
2. <span data-ttu-id="e87e9-264">Na janela de consulta, copie e cole todo o script SQL do arquivo Migrations. Sql.</span><span class="sxs-lookup"><span data-stu-id="e87e9-264">In the query window, copy and paste the entire SQL script from the Migrations.sql file.</span></span> <span data-ttu-id="e87e9-265">Execute o arquivo de script pressionando o botão de seta ' Executar '.</span><span class="sxs-lookup"><span data-stu-id="e87e9-265">Run the script file by hitting the 'Execute' arrow button.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.jpg)

    <span data-ttu-id="e87e9-266">Atualize a janela de Gerenciador de Servidores.</span><span class="sxs-lookup"><span data-stu-id="e87e9-266">Refresh the Server Explorer window.</span></span> <span data-ttu-id="e87e9-267">Cinco novas tabelas são criadas no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="e87e9-267">Five new tables are created in the database.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image8.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image9.png)

    <span data-ttu-id="e87e9-268">Veja abaixo como as informações nas tabelas de associação do SQL são mapeadas para o novo sistema de identidade.</span><span class="sxs-lookup"><span data-stu-id="e87e9-268">Below is how the information in the SQL membership tables are mapped to the new Identity system.</span></span>

    <span data-ttu-id="e87e9-269">Funções de\_do ASPNET –&gt; AspNetRoles</span><span class="sxs-lookup"><span data-stu-id="e87e9-269">aspnet\_Roles --&gt; AspNetRoles</span></span>

    <span data-ttu-id="e87e9-270">ASP\_netusers e ASP\_netmembership--&gt; AspNetUsers</span><span class="sxs-lookup"><span data-stu-id="e87e9-270">asp\_netUsers and asp\_netMembership --&gt; AspNetUsers</span></span>

    <span data-ttu-id="e87e9-271">ASPNET\_UserInRoles--&gt; AspNetUserRoles</span><span class="sxs-lookup"><span data-stu-id="e87e9-271">aspnet\_UserInRoles --&gt; AspNetUserRoles</span></span>

    <span data-ttu-id="e87e9-272">Conforme explicado na seção acima, as tabelas AspNetUserClaims e AspNetUserLogins estão vazias.</span><span class="sxs-lookup"><span data-stu-id="e87e9-272">As explained in the above section, the AspNetUserClaims and AspNetUserLogins tables are empty.</span></span> <span data-ttu-id="e87e9-273">O campo ' discriminador ' na tabela AspNetUser deve corresponder ao nome da classe do modelo que é definido como uma próxima etapa.</span><span class="sxs-lookup"><span data-stu-id="e87e9-273">The 'Discriminator' field in the AspNetUser table should match the model class name which is defined as a next step.</span></span> <span data-ttu-id="e87e9-274">Além disso, a coluna PasswordHash está no formato "senha criptografada | sal de senha | formato de senha".</span><span class="sxs-lookup"><span data-stu-id="e87e9-274">Also the PasswordHash column is in the form 'encrypted password |password salt|password format'.</span></span> <span data-ttu-id="e87e9-275">Isso permite que você use uma lógica de criptografia de associação SQL especial para que você possa reutilizar senhas antigas.</span><span class="sxs-lookup"><span data-stu-id="e87e9-275">This enables you to use special SQL membership crypto logic so that you can reuse old passwords.</span></span> <span data-ttu-id="e87e9-276">Isso é explicado posteriormente neste artigo.</span><span class="sxs-lookup"><span data-stu-id="e87e9-276">That is explained in later in the article.</span></span>

### <a name="creating-models-and-membership-pages"></a><span data-ttu-id="e87e9-277">Criando modelos e páginas de associação</span><span class="sxs-lookup"><span data-stu-id="e87e9-277">Creating models and membership pages</span></span>

<span data-ttu-id="e87e9-278">Como mencionado anteriormente, o recurso de identidade usa Entity Framework para se comunicar com o banco de dados para armazenar informações de conta por padrão.</span><span class="sxs-lookup"><span data-stu-id="e87e9-278">As mentioned earlier, the Identity feature uses Entity Framework to talk to the database for storing account information by default.</span></span> <span data-ttu-id="e87e9-279">Para trabalhar com os dados existentes na tabela, precisamos criar classes de modelo que mapeiem de volta para as tabelas e conectá-las no sistema de identidade.</span><span class="sxs-lookup"><span data-stu-id="e87e9-279">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="e87e9-280">Como parte do contrato de identidade, as classes de modelo devem implementar as interfaces definidas na DLL Identity. Core ou podem estender a implementação existente dessas interfaces disponíveis em Microsoft. AspNet. Identity. EntityFramework.</span><span class="sxs-lookup"><span data-stu-id="e87e9-280">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span>

<span data-ttu-id="e87e9-281">Em nosso exemplo, as tabelas AspNetRoles, AspNetUserClaims, AspNetLogins e AspNetUserRole têm colunas semelhantes à implementação existente do sistema de identidade.</span><span class="sxs-lookup"><span data-stu-id="e87e9-281">In our sample, the AspNetRoles, AspNetUserClaims, AspNetLogins and AspNetUserRole tables have columns that are similar to the existing implementation of the Identity system.</span></span> <span data-ttu-id="e87e9-282">Portanto, podemos reutilizar as classes existentes para mapear para essas tabelas.</span><span class="sxs-lookup"><span data-stu-id="e87e9-282">Hence we can reuse the existing classes to map to these tables.</span></span> <span data-ttu-id="e87e9-283">A tabela AspNetUser tem algumas colunas adicionais que são usadas para armazenar informações adicionais das tabelas de associação do SQL.</span><span class="sxs-lookup"><span data-stu-id="e87e9-283">The AspNetUser table has some additional columns which are used to store additional information from the SQL membership tables.</span></span> <span data-ttu-id="e87e9-284">Isso pode ser mapeado pela criação de uma classe de modelo que estenda a implementação existente de ' IdentityUser ' e adicione as propriedades adicionais.</span><span class="sxs-lookup"><span data-stu-id="e87e9-284">This can be mapped by creating a model class that extend the existing implementation of 'IdentityUser' and add the additional properties.</span></span>

1. <span data-ttu-id="e87e9-285">Crie uma pasta modelos no projeto e adicione um usuário de classe.</span><span class="sxs-lookup"><span data-stu-id="e87e9-285">Create a Models folder in the project and add a class User.</span></span> <span data-ttu-id="e87e9-286">O nome da classe deve corresponder aos dados adicionados na coluna ' discriminador ' da tabela ' AspnetUsers '.</span><span class="sxs-lookup"><span data-stu-id="e87e9-286">The name of the class should match the data added in the 'Discriminator' column of 'AspnetUsers' table.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image10.png)

    <span data-ttu-id="e87e9-287">A classe de usuário deve estender a classe IdentityUser encontrada na dll *Microsoft. AspNet. Identity. EntityFramework* .</span><span class="sxs-lookup"><span data-stu-id="e87e9-287">The User class should extend the IdentityUser class found in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="e87e9-288">Declare as propriedades na classe que mapeia de volta para as colunas AspNetUser.</span><span class="sxs-lookup"><span data-stu-id="e87e9-288">Declare the properties in class that map back to the AspNetUser columns.</span></span> <span data-ttu-id="e87e9-289">As propriedades ID, username, PasswordHash e SecurityStamp são definidas no IdentityUser e, portanto, são omitidas.</span><span class="sxs-lookup"><span data-stu-id="e87e9-289">The properties ID, Username, PasswordHash and SecurityStamp are defined in the IdentityUser and so are omitted.</span></span> <span data-ttu-id="e87e9-290">Abaixo está o código para a classe de usuário que tem todas as propriedades</span><span class="sxs-lookup"><span data-stu-id="e87e9-290">Below is the code for the User class that has all the properties</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample3.cs)]
2. <span data-ttu-id="e87e9-291">Uma classe DbContext Entity Framework é necessária para persistir dados em modelos de volta para tabelas e recuperar dados de tabelas para popular os modelos.</span><span class="sxs-lookup"><span data-stu-id="e87e9-291">An Entity Framework DbContext class is required in order to persist data in models back to tables and retrieve data from tables to populate the models.</span></span> <span data-ttu-id="e87e9-292">A dll *Microsoft. AspNet. Identity. EntityFramework* define a classe IdentityDbContext que interage com as tabelas de identidade para recuperar e armazenar informações.</span><span class="sxs-lookup"><span data-stu-id="e87e9-292">*Microsoft.AspNet.Identity.EntityFramework* dll defines the IdentityDbContext class which interacts with the Identity tables to retrieve and store information.</span></span> <span data-ttu-id="e87e9-293">O IdentityDbContext&lt;tuser&gt; usa uma classe ' TUser ' que pode ser qualquer classe que estenda a classe IdentityUser.</span><span class="sxs-lookup"><span data-stu-id="e87e9-293">The IdentityDbContext&lt;tuser&gt; takes a 'TUser' class which can be any class that extends the IdentityUser class.</span></span>

    <span data-ttu-id="e87e9-294">Crie uma nova classe ApplicationDBContext que estenda IdentityDbContext na pasta ' Models ', passando a classe ' user ' criada na etapa 1</span><span class="sxs-lookup"><span data-stu-id="e87e9-294">Create a new class ApplicationDBContext that extends IdentityDbContext under the 'Models' folder, passing in the 'User' class created in step 1</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample4.cs)]
3. <span data-ttu-id="e87e9-295">O gerenciamento de usuários no novo sistema de identidade é feito usando a classe usermanager&lt;tuser&gt; definida na dll *Microsoft. AspNet. Identity. EntityFramework* .</span><span class="sxs-lookup"><span data-stu-id="e87e9-295">User management in the new Identity system is done using the UserManager&lt;tuser&gt; class defined in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="e87e9-296">Precisamos criar uma classe personalizada que estenda o usermanager, passando a classe ' user ' criada na etapa 1.</span><span class="sxs-lookup"><span data-stu-id="e87e9-296">We need to create a custom class that extends UserManager, passing in the 'User' class created in step 1.</span></span>

    <span data-ttu-id="e87e9-297">Na pasta modelos, crie uma nova classe usermanager que estenda usermanager&lt;usuário&gt;</span><span class="sxs-lookup"><span data-stu-id="e87e9-297">In the Models folder create a new class UserManager that extends UserManager&lt;user&gt;</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample5.cs)]
4. <span data-ttu-id="e87e9-298">As senhas dos usuários do aplicativo são criptografadas e armazenadas no banco de dados do.</span><span class="sxs-lookup"><span data-stu-id="e87e9-298">The passwords of the users of the application are encrypted and stored in the database.</span></span> <span data-ttu-id="e87e9-299">O algoritmo de criptografia usado na associação do SQL é diferente daquele no novo sistema de identidade.</span><span class="sxs-lookup"><span data-stu-id="e87e9-299">The crypto algorithm used in SQL membership is different from the one in the new Identity system.</span></span> <span data-ttu-id="e87e9-300">Para reutilizar senhas antigas, precisamos descriptografar as senhas seletivamente quando os usuários antigos fizerem logon usando o algoritmo associações do SQL ao usar o algoritmo de criptografia em identidade para os novos usuários.</span><span class="sxs-lookup"><span data-stu-id="e87e9-300">To reuse old passwords we need to selectively decrypt passwords when old users log in using the SQL memberships algorithm while using the crypto algorithm in Identity for the new users.</span></span>

    <span data-ttu-id="e87e9-301">A classe usermanager tem uma propriedade ' PasswordHasher ' que armazena uma instância de uma classe que implementa a interface ' IPasswordHasher '.</span><span class="sxs-lookup"><span data-stu-id="e87e9-301">The UserManager class has a property 'PasswordHasher' which stores an instance of a class that implements the 'IPasswordHasher' interface.</span></span> <span data-ttu-id="e87e9-302">Isso é usado para criptografar/descriptografar senhas durante transações de autenticação do usuário.</span><span class="sxs-lookup"><span data-stu-id="e87e9-302">This is used to encrypt/decrypt passwords during user authentication transactions.</span></span> <span data-ttu-id="e87e9-303">Na classe usermanager definida na etapa 3, crie uma nova classe SQLPasswordHasher e copie o código abaixo.</span><span class="sxs-lookup"><span data-stu-id="e87e9-303">In the UserManager class defined in step 3, create a new class SQLPasswordHasher and copy the below code.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample6.cs)]

    <span data-ttu-id="e87e9-304">Resolva os erros de compilação importando os namespaces de System. Text e System. Security. Cryptography.</span><span class="sxs-lookup"><span data-stu-id="e87e9-304">Resolve the compilation errors by importing the System.Text and System.Security.Cryptography namespaces.</span></span>

    <span data-ttu-id="e87e9-305">O método EncodePassword criptografa a senha de acordo com a implementação de criptografia de associação do SQL padrão.</span><span class="sxs-lookup"><span data-stu-id="e87e9-305">The EncodePassword method encrypts the password according to the default SQL membership crypto implementation.</span></span> <span data-ttu-id="e87e9-306">Isso é obtido da DLL System. Web.</span><span class="sxs-lookup"><span data-stu-id="e87e9-306">This is taken from the System.Web dll.</span></span> <span data-ttu-id="e87e9-307">Se o aplicativo antigo usava uma implementação personalizada, ele deve ser refletido aqui.</span><span class="sxs-lookup"><span data-stu-id="e87e9-307">If the old app used a custom implementation then it should be reflected here.</span></span> <span data-ttu-id="e87e9-308">Precisamos definir dois outros métodos *HashPassword* e *VerifyHashedPassword* que usam o método *EncodePassword* para aplicar hash a uma determinada senha ou verificar uma senha de texto sem formatação com aquela existente no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="e87e9-308">We need to define two other methods *HashPassword* and *VerifyHashedPassword* that use the *EncodePassword* method to hash a given password or verify a plain text password with the one existing in the database.</span></span>

    <span data-ttu-id="e87e9-309">O sistema de associação do SQL usou PasswordHash, PasswordSalt e PasswordFormat para fazer o hash da senha inserida pelos usuários quando eles registram ou alteram sua senha.</span><span class="sxs-lookup"><span data-stu-id="e87e9-309">The SQL membership system used PasswordHash, PasswordSalt and PasswordFormat to hash the password entered by users when they register or change their password.</span></span> <span data-ttu-id="e87e9-310">Durante a migração, todos os três campos são armazenados na coluna PasswordHash da tabela AspNetUser, separados pelo caractere ' | '.</span><span class="sxs-lookup"><span data-stu-id="e87e9-310">During the migration all the three fields are stored in the PasswordHash column in the AspNetUser table separated by the '|' character.</span></span> <span data-ttu-id="e87e9-311">Quando um usuário faz logon e a senha tem esses campos, usamos a criptografia de associação do SQL para verificar a senha; caso contrário, usamos a criptografia padrão do sistema de identidade para verificar a senha.</span><span class="sxs-lookup"><span data-stu-id="e87e9-311">When a user logs in and the password has these fields, we use the SQL membership crypto to check the password; otherwise we use the Identity system's default crypto to verify the password.</span></span> <span data-ttu-id="e87e9-312">Dessa forma, os usuários antigos não precisariam alterar suas senhas depois que o aplicativo for migrado.</span><span class="sxs-lookup"><span data-stu-id="e87e9-312">This way old users would not have to change their passwords once the app is migrated.</span></span>
5. <span data-ttu-id="e87e9-313">Declare o construtor para a classe usermanager e transmita-o como o SQLPasswordHasher para a propriedade no construtor.</span><span class="sxs-lookup"><span data-stu-id="e87e9-313">Declare the constructor for the UserManager class and pass this as the SQLPasswordHasher to the property in the constructor.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample7.cs)]

### <a name="create-new-account-management-pages"></a><span data-ttu-id="e87e9-314">Criar novas páginas de gerenciamento de conta</span><span class="sxs-lookup"><span data-stu-id="e87e9-314">Create new account management pages</span></span>

<span data-ttu-id="e87e9-315">A próxima etapa da migração é adicionar páginas de gerenciamento de conta que permitirão que um usuário se registre e faça logon.</span><span class="sxs-lookup"><span data-stu-id="e87e9-315">The next step in the migration is to add account management pages that will let a user register and log in.</span></span> <span data-ttu-id="e87e9-316">As páginas da conta antiga da associação do SQL usam controles que não funcionam com o novo sistema de identidade.</span><span class="sxs-lookup"><span data-stu-id="e87e9-316">The old account pages from SQL membership use controls that don't work with the new Identity system.</span></span> <span data-ttu-id="e87e9-317">Para adicionar as novas páginas de gerenciamento de usuário, siga o tutorial neste link [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) a partir da etapa ' adicionando Web Forms para registrar usuários no seu aplicativo ', pois já criamos o projeto e adicionamos os pacotes NuGet.</span><span class="sxs-lookup"><span data-stu-id="e87e9-317">To add the new user management pages follow the tutorial at this link [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) starting from the step 'Adding Web Forms for registering users to your application' since we have already created the project and added the NuGet packages.</span></span>

<span data-ttu-id="e87e9-318">Precisamos fazer algumas alterações para que o exemplo funcione com o projeto que temos aqui.</span><span class="sxs-lookup"><span data-stu-id="e87e9-318">We need to make some changes for the sample to work with the project we have here.</span></span>

- <span data-ttu-id="e87e9-319">As classes code-behind Register.aspx.cs e Login.aspx.cs usam o `UserManager` dos pacotes de identidade para criar um usuário.</span><span class="sxs-lookup"><span data-stu-id="e87e9-319">The Register.aspx.cs and Login.aspx.cs code behind classes use the `UserManager` from the Identity packages to create a User.</span></span> <span data-ttu-id="e87e9-320">Para este exemplo, use o usermanager adicionado na pasta modelos seguindo as etapas mencionadas anteriormente.</span><span class="sxs-lookup"><span data-stu-id="e87e9-320">For this example use the UserManager added in the Models folder by following the steps mentioned earlier.</span></span>
- <span data-ttu-id="e87e9-321">Use a classe de usuário criada em vez do IdentityUser em Register.aspx.cs e Login.aspx.cs Code-behind classes.</span><span class="sxs-lookup"><span data-stu-id="e87e9-321">Use the User class created instead of the IdentityUser in Register.aspx.cs and Login.aspx.cs code behind classes.</span></span> <span data-ttu-id="e87e9-322">Isso se conecta à nossa classe de usuário personalizada no sistema de identidade.</span><span class="sxs-lookup"><span data-stu-id="e87e9-322">This hooks in our custom user class into the Identity system.</span></span>
- <span data-ttu-id="e87e9-323">A parte para criar o banco de dados pode ser ignorada.</span><span class="sxs-lookup"><span data-stu-id="e87e9-323">The part to create the database can be skipped.</span></span>
- <span data-ttu-id="e87e9-324">O desenvolvedor precisa definir ApplicationId para que o novo usuário corresponda à ID do aplicativo atual.</span><span class="sxs-lookup"><span data-stu-id="e87e9-324">The developer needs to set the ApplicationId for the new user to match the current application ID.</span></span> <span data-ttu-id="e87e9-325">Isso pode ser feito consultando o ApplicationId deste aplicativo antes de um objeto de usuário ser criado na classe Register.aspx.cs e definindo-o antes de criar o usuário.</span><span class="sxs-lookup"><span data-stu-id="e87e9-325">This can be done by querying the ApplicationId for this application before a user object is created in the Register.aspx.cs class and setting it before creating user.</span></span>

    <span data-ttu-id="e87e9-326">Exemplo:</span><span class="sxs-lookup"><span data-stu-id="e87e9-326">Example:</span></span>

    <span data-ttu-id="e87e9-327">Defina um método na página Register.aspx.cs para consultar a tabela de aplicativos ASPNET\_e obter a ID do aplicativo de acordo com o nome do aplicativo</span><span class="sxs-lookup"><span data-stu-id="e87e9-327">Define a method in Register.aspx.cs page to query the aspnet\_Applications table and get the application Id according to application name</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample8.cs)]

    <span data-ttu-id="e87e9-328">Agora, defina isso no objeto de usuário</span><span class="sxs-lookup"><span data-stu-id="e87e9-328">Now get set this on the user object</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="e87e9-329">Use o nome de usuário e a senha antigos para fazer logon em um existente.</span><span class="sxs-lookup"><span data-stu-id="e87e9-329">Use the old username and password to login an existing user.</span></span> <span data-ttu-id="e87e9-330">Use a página registrar para criar um novo usuário.</span><span class="sxs-lookup"><span data-stu-id="e87e9-330">Use the Register page to create a new user.</span></span> <span data-ttu-id="e87e9-331">Verifique também se os usuários estão em funções como esperado.</span><span class="sxs-lookup"><span data-stu-id="e87e9-331">Also verify that the users are in roles as expected.</span></span>

<span data-ttu-id="e87e9-332">Portar para o sistema de identidade ajuda o usuário a adicionar o OAuth (autenticação aberta) ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="e87e9-332">Porting to the Identity system helps the user add Open Authentication (OAuth) to the application.</span></span> <span data-ttu-id="e87e9-333">Consulte o exemplo [aqui](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/) , que tem o OAuth habilitado.</span><span class="sxs-lookup"><span data-stu-id="e87e9-333">Please refer to the sample [here](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SQLMembership-Identity-OWIN/) which has OAuth enabled.</span></span>

## <a name="next-steps"></a><span data-ttu-id="e87e9-334">{1&gt;{2&gt;Próximas etapas&lt;2}&lt;1}</span><span class="sxs-lookup"><span data-stu-id="e87e9-334">Next Steps</span></span>

<span data-ttu-id="e87e9-335">Neste tutorial, mostramos como portar usuários da associação do SQL para ASP.NET Identity, mas não portamos dados de perfil.</span><span class="sxs-lookup"><span data-stu-id="e87e9-335">In this tutorial we showed how to port users from SQL membership to ASP.NET Identity, but we didn't port Profile data.</span></span> <span data-ttu-id="e87e9-336">No próximo tutorial, vamos examinar a porta de dados de perfil da associação do SQL para o novo sistema de identidade.</span><span class="sxs-lookup"><span data-stu-id="e87e9-336">In the next tutorial we'll look into porting Profile data from SQL membership to the new Identity system.</span></span>

<span data-ttu-id="e87e9-337">Você pode deixar comentários na parte inferior deste artigo.</span><span class="sxs-lookup"><span data-stu-id="e87e9-337">You can leave feedback at the bottom of this article.</span></span>

<span data-ttu-id="e87e9-338">*Graças a Tom Dykstra e Rick Anderson pela revisão do artigo.*</span><span class="sxs-lookup"><span data-stu-id="e87e9-338">*Thanks to Tom Dykstra and Rick Anderson for reviewing the article.*</span></span>
