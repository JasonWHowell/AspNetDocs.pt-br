---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
title: 'Tutorial: Usar migrações do EF em um aplicativo MVC ASP.NET e implantar no Azure'
author: tdykstra
description: Neste tutorial, você habilita Code First migrações e implanta o aplicativo na nuvem no Azure.
ms.author: riande
ms.date: 01/16/2019
ms.topic: tutorial
ms.assetid: d4dfc435-bda6-4621-9762-9ba270f8de4e
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 989dd0f0e18b338be057b9c5657586eff996d8ea
ms.sourcegitcommit: b95316530fa51087d6c400ff91814fe37e73f7e8
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/23/2019
ms.locfileid: "70000761"
---
# <a name="tutorial-use-ef-migrations-in-an-aspnet-mvc-app-and-deploy-to-azure"></a><span data-ttu-id="d22d4-103">Tutorial: Usar migrações do EF em um aplicativo MVC ASP.NET e implantar no Azure</span><span class="sxs-lookup"><span data-stu-id="d22d4-103">Tutorial: Use EF Migrations in an ASP.NET MVC app and deploy to Azure</span></span>

<span data-ttu-id="d22d4-104">Até agora, o aplicativo Web de exemplo da Contoso University está em execução localmente em IIS Express no seu computador de desenvolvimento.</span><span class="sxs-lookup"><span data-stu-id="d22d4-104">So far the Contoso University sample web application has been running locally in IIS Express on your development computer.</span></span> <span data-ttu-id="d22d4-105">Para tornar um aplicativo real disponível para outras pessoas usarem pela Internet, você precisa implantá-lo em um provedor de hospedagem na Web.</span><span class="sxs-lookup"><span data-stu-id="d22d4-105">To make a real application available for other people to use over the Internet, you have to deploy it to a web hosting provider.</span></span> <span data-ttu-id="d22d4-106">Neste tutorial, você habilita Code First migrações e implanta o aplicativo na nuvem no Azure:</span><span class="sxs-lookup"><span data-stu-id="d22d4-106">In this tutorial, you enable Code First migrations and deploy the application to the cloud in Azure:</span></span>

- <span data-ttu-id="d22d4-107">Habilitar Migrações do Code First.</span><span class="sxs-lookup"><span data-stu-id="d22d4-107">Enable Code First Migrations.</span></span> <span data-ttu-id="d22d4-108">O recurso de migrações permite que você altere o modelo de dados e implante suas alterações na produção atualizando o esquema de banco sem precisar remover e recriar o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-108">The Migrations feature enables you to change the data model and deploy your changes to production by updating the database schema without having to drop and re-create the database.</span></span>
- <span data-ttu-id="d22d4-109">Implante no Azure.</span><span class="sxs-lookup"><span data-stu-id="d22d4-109">Deploy to Azure.</span></span> <span data-ttu-id="d22d4-110">Esta etapa é opcional; Você pode continuar com os tutoriais restantes sem ter implantado o projeto.</span><span class="sxs-lookup"><span data-stu-id="d22d4-110">This step is optional; you can continue with the remaining tutorials without having deployed the project.</span></span>

<span data-ttu-id="d22d4-111">Recomendamos que você use um processo de integração contínua com controle do código-fonte para implantação, mas este tutorial não aborda esses tópicos.</span><span class="sxs-lookup"><span data-stu-id="d22d4-111">We recommend that you use a continuous integration process with source control for deployment, but this tutorial does not cover those topics.</span></span> <span data-ttu-id="d22d4-112">Para obter mais informações, consulte o [controle do código-fonte](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) e os capítulos de [integração contínua](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) da [criação de aplicativos de nuvem do mundo real com o Azure](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction).</span><span class="sxs-lookup"><span data-stu-id="d22d4-112">For more information, see the [source control](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) and [continuous integration](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) chapters of [Building Real-World Cloud Apps with Azure](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction).</span></span>

<span data-ttu-id="d22d4-113">Neste tutorial, você:</span><span class="sxs-lookup"><span data-stu-id="d22d4-113">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="d22d4-114">Habilitar migrações de Code First</span><span class="sxs-lookup"><span data-stu-id="d22d4-114">Enable Code First migrations</span></span>
> * <span data-ttu-id="d22d4-115">Implantar o aplicativo no Azure (opcional)</span><span class="sxs-lookup"><span data-stu-id="d22d4-115">Deploy the app in Azure (optional)</span></span>

## <a name="prerequisites"></a><span data-ttu-id="d22d4-116">Pré-requisitos</span><span class="sxs-lookup"><span data-stu-id="d22d4-116">Prerequisites</span></span>

- [<span data-ttu-id="d22d4-117">Resiliência de conexão e interceptação de comando</span><span class="sxs-lookup"><span data-stu-id="d22d4-117">Connection Resiliency and Command Interception</span></span>](connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application.md)

## <a name="enable-code-first-migrations"></a><span data-ttu-id="d22d4-118">Habilitar migrações de Code First</span><span class="sxs-lookup"><span data-stu-id="d22d4-118">Enable Code First migrations</span></span>

<span data-ttu-id="d22d4-119">Quando você desenvolve um novo aplicativo, o modelo de dados é alterado com frequência e, sempre que o modelo é alterado, ele fica fora de sincronia com o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-119">When you develop a new application, your data model changes frequently, and each time the model changes, it gets out of sync with the database.</span></span> <span data-ttu-id="d22d4-120">Você configurou o Entity Framework para descartar e recriar o banco de dados automaticamente sempre que alterar o modelo.</span><span class="sxs-lookup"><span data-stu-id="d22d4-120">You have configured the Entity Framework to automatically drop and re-create the database each time you change the data model.</span></span> <span data-ttu-id="d22d4-121">Quando você adiciona, remove ou altera classes de entidade ou altera sua `DbContext` classe, na próxima vez que você executar o aplicativo, ele excluirá automaticamente o banco de dados existente, criará um novo que corresponda ao modelo e propaga-o com os dado de teste.</span><span class="sxs-lookup"><span data-stu-id="d22d4-121">When you add, remove, or change entity classes or change your `DbContext` class, the next time you run the application it automatically deletes your existing database, creates a new one that matches the model, and seeds it with test data.</span></span>

<span data-ttu-id="d22d4-122">Esse método de manter o banco de dados em sincronia com o modelo de dados funciona bem até que você implante o aplicativo em produção.</span><span class="sxs-lookup"><span data-stu-id="d22d4-122">This method of keeping the database in sync with the data model works well until you deploy the application to production.</span></span> <span data-ttu-id="d22d4-123">Quando o aplicativo está em execução na produção, ele geralmente armazena os dados que você deseja manter e você não deseja perder tudo sempre que fizer uma alteração, como adicionar uma nova coluna.</span><span class="sxs-lookup"><span data-stu-id="d22d4-123">When the application is running in production, it is usually storing data that you want to keep, and you don't want to lose everything each time you make a change such as adding a new column.</span></span> <span data-ttu-id="d22d4-124">O recurso [migrações do Code First](https://msdn.microsoft.com/data/jj591621) resolve esse problema habilitando Code First para atualizar o esquema de banco de dados em vez de descartar e recriar o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-124">The [Code First Migrations](https://msdn.microsoft.com/data/jj591621) feature solves this problem by enabling Code First to update the database schema instead of dropping and re-creating the database.</span></span> <span data-ttu-id="d22d4-125">Neste tutorial, você implantará o aplicativo e para se preparar para que você habilite as migrações.</span><span class="sxs-lookup"><span data-stu-id="d22d4-125">In this tutorial, you'll deploy the application, and to prepare for that you'll enable Migrations.</span></span>

1. <span data-ttu-id="d22d4-126">Desabilite o inicializador que você configurou anteriormente comentando ou excluindo `contexts` o elemento que você adicionou ao arquivo Web. config do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d22d4-126">Disable the initializer that you set up earlier by commenting out or deleting the `contexts` element that you added to the application Web.config file.</span></span>

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample1.xml?highlight=2,6)]
2. <span data-ttu-id="d22d4-127">Também no arquivo *Web. config* do aplicativo, altere o nome do banco de dados na cadeia de conexão para ContosoUniversity2.</span><span class="sxs-lookup"><span data-stu-id="d22d4-127">Also in the application *Web.config* file, change the name of the database in the connection string to ContosoUniversity2.</span></span>

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample2.xml?highlight=2)]

    <span data-ttu-id="d22d4-128">Essa alteração configura o projeto para que a primeira migração crie um novo banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-128">This change sets up the project so that the first migration creates a new database.</span></span> <span data-ttu-id="d22d4-129">Isso não é necessário, mas você verá mais tarde por que é uma boa ideia.</span><span class="sxs-lookup"><span data-stu-id="d22d4-129">This isn't required but you'll see later why it's a good idea.</span></span>
3. <span data-ttu-id="d22d4-130">No menu **Ferramentas**, selecione **Gerenciador de pacotes NuGet** > **Console do Gerenciador de pacotes**.</span><span class="sxs-lookup"><span data-stu-id="d22d4-130">From the **Tools** menu, select **NuGet Package Manager** > **Package Manager Console**.</span></span>

1. <span data-ttu-id="d22d4-131">`PM>` No prompt, insira os seguintes comandos:</span><span class="sxs-lookup"><span data-stu-id="d22d4-131">At the `PM>` prompt enter the following commands:</span></span>

    ```text
    enable-migrations
    add-migration InitialCreate
    ```

    <span data-ttu-id="d22d4-132">O `enable-migrations` comando cria uma pasta Migrations no projeto ContosoUniversity e coloca essa pasta em um arquivo *Configuration.cs* que você pode editar para configurar as migrações.</span><span class="sxs-lookup"><span data-stu-id="d22d4-132">The `enable-migrations` command creates a *Migrations* folder in the ContosoUniversity project, and it puts in that folder a *Configuration.cs* file that you can edit to configure Migrations.</span></span>

    <span data-ttu-id="d22d4-133">(Se você perdeu a etapa acima que o instrui a alterar o nome do banco de dados, as migrações encontrarão o banco de dados `add-migration` existente e executarão automaticamente o comando.</span><span class="sxs-lookup"><span data-stu-id="d22d4-133">(If you missed the step above that directs you to change the database name, Migrations will find the existing database and automatically do the `add-migration` command.</span></span> <span data-ttu-id="d22d4-134">Tudo bem, isso só significa que você não executará um teste do código de migrações antes de implantar o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-134">That's okay, it just means you won't run a test of the migrations code before you deploy the database.</span></span> <span data-ttu-id="d22d4-135">Posteriormente, quando você executar `update-database` o comando, nada acontecerá porque o banco de dados já existe.)</span><span class="sxs-lookup"><span data-stu-id="d22d4-135">Later when you run the `update-database` command nothing will happen because the database already exists.)</span></span>

    <span data-ttu-id="d22d4-136">Abra o arquivo *ContosoUniversity\Migrations\Configuration.cs* .</span><span class="sxs-lookup"><span data-stu-id="d22d4-136">Open the *ContosoUniversity\Migrations\Configuration.cs* file.</span></span> <span data-ttu-id="d22d4-137">Assim como a classe do inicializador que você viu `Configuration` anteriormente, a `Seed` classe inclui um método.</span><span class="sxs-lookup"><span data-stu-id="d22d4-137">Like the initializer class that you saw earlier, the `Configuration` class includes a `Seed` method.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample3.cs)]

    <span data-ttu-id="d22d4-138">A finalidade do método de [semente](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) é permitir que você insira ou atualize dados de teste depois que Code First criar ou atualizar o banco de dado.</span><span class="sxs-lookup"><span data-stu-id="d22d4-138">The purpose of the [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method is to enable you to insert or update test data after Code First creates or updates the database.</span></span> <span data-ttu-id="d22d4-139">O método é chamado quando o banco de dados é criado e toda vez que o esquema de banco de dado é atualizado após uma alteração no modelo.</span><span class="sxs-lookup"><span data-stu-id="d22d4-139">The method is called when the database is created and every time the database schema is updated after a data model change.</span></span>

### <a name="set-up-the-seed-method"></a><span data-ttu-id="d22d4-140">Configurar o método semente</span><span class="sxs-lookup"><span data-stu-id="d22d4-140">Set up the Seed method</span></span>

<span data-ttu-id="d22d4-141">Quando você remove e recria o banco de dados para todas as alterações de modelo, você usa o método da `Seed` classe inicializador para inserir dados de teste, pois depois que cada modelo é alterado, o banco de dados é Descartado e todos os dado de teste são perdidos.</span><span class="sxs-lookup"><span data-stu-id="d22d4-141">When you drop and re-create the database for every data model change, you use the initializer class's `Seed` method to insert test data, because after every model change the database is dropped and all the test data is lost.</span></span> <span data-ttu-id="d22d4-142">Com o Migrações do Code First, os dados de teste são retidos após as alterações do banco de dados, de modo que, inclusive, o método de [semente](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) não é necessário normalmente.</span><span class="sxs-lookup"><span data-stu-id="d22d4-142">With Code First Migrations, test data is retained after database changes, so including test data in the [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method is typically not necessary.</span></span> <span data-ttu-id="d22d4-143">Na verdade, você não quer que `Seed` o método insira dados de teste se você estiver usando migrações para implantar o Database para produção, pois o `Seed` método será executado em produção.</span><span class="sxs-lookup"><span data-stu-id="d22d4-143">In fact, you don't want the `Seed` method to insert test data if you'll be using Migrations to deploy the database to production, because the `Seed` method will run in production.</span></span> <span data-ttu-id="d22d4-144">Nesse caso, você deseja que o `Seed` método seja inserido no banco de dados somente os dados necessários na produção.</span><span class="sxs-lookup"><span data-stu-id="d22d4-144">In that case, you want the `Seed` method to insert into the database only the data that you need in production.</span></span> <span data-ttu-id="d22d4-145">Por exemplo, talvez você queira que o banco de dados inclua nomes de departamento `Department` reais na tabela quando o aplicativo se tornar disponível em produção.</span><span class="sxs-lookup"><span data-stu-id="d22d4-145">For example, you might want the database to include actual department names in the `Department` table when the application becomes available in production.</span></span>

<span data-ttu-id="d22d4-146">Para este tutorial, você usará migrações para implantação, mas o `Seed` método inserirá dados de teste de qualquer forma para facilitar a visualização de como a funcionalidade do aplicativo funciona sem a necessidade de inserir manualmente muitos dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-146">For this tutorial, you'll be using Migrations for deployment, but your `Seed` method will insert test data anyway in order to make it easier to see how application functionality works without having to manually insert a lot of data.</span></span>

1. <span data-ttu-id="d22d4-147">Substitua o conteúdo do arquivo *Configuration.cs* pelo código a seguir, que carrega os dados de teste para o novo banco de dado.</span><span class="sxs-lookup"><span data-stu-id="d22d4-147">Replace the contents of the *Configuration.cs* file with the following code, which loads test data into the new database.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample4.cs)]

    <span data-ttu-id="d22d4-148">O método [semente](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) usa o objeto de contexto de banco de dados como um parâmetro de entrada, e o código no método usa esse objeto para adicionar novas entidades ao banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-148">The [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method takes the database context object as an input parameter, and the code in the method uses that object to add new entities to the database.</span></span> <span data-ttu-id="d22d4-149">Para cada tipo de entidade, o código cria uma coleção de novas entidades, adiciona-as à propriedade [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) apropriada e salva as alterações no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-149">For each entity type, the code creates a collection of new entities, adds them to the appropriate [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) property, and then saves the changes to the database.</span></span> <span data-ttu-id="d22d4-150">Não é necessário chamar o método [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) depois de cada grupo de entidades, como é feito aqui, mas fazer isso ajuda a localizar a origem de um problema se ocorrer uma exceção enquanto o código estiver gravando no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-150">It isn't necessary to call the [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method after each group of entities, as is done here, but doing that helps you locate the source of a problem if an exception occurs while the code is writing to the database.</span></span>

    <span data-ttu-id="d22d4-151">Algumas das instruções que inserem dados usam o método [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) para executar uma operação "Upsert".</span><span class="sxs-lookup"><span data-stu-id="d22d4-151">Some of the statements that insert data use the [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) method to perform an "upsert" operation.</span></span> <span data-ttu-id="d22d4-152">Como o `Seed` método é executado toda vez que você `update-database` executa o comando, normalmente após cada migração, não é possível apenas inserir dados, pois as linhas que você está tentando adicionar já estarão lá após a primeira migração que cria o banco de dado.</span><span class="sxs-lookup"><span data-stu-id="d22d4-152">Because the `Seed` method runs every time you execute the `update-database` command, typically after each migration, you can't just insert data, because the rows you are trying to add will already be there after the first migration that creates the database.</span></span> <span data-ttu-id="d22d4-153">A operação "Upsert" impede erros que ocorrerão se você tentar inserir uma linha que já existe, mas ela ***substitui*** quaisquer alterações nos dados que você tenha feito durante o teste do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d22d4-153">The "upsert" operation prevents errors that would happen if you try to insert a row that already exists, but it ***overrides*** any changes to data that you may have made while testing the application.</span></span> <span data-ttu-id="d22d4-154">Com os dados de teste em algumas tabelas, talvez você não queira que isso aconteça: em alguns casos, ao alterar os dados durante o teste, você deseja que as alterações permaneçam após as atualizações do banco.</span><span class="sxs-lookup"><span data-stu-id="d22d4-154">With test data in some tables you might not want that to happen: in some cases when you change data while testing you want your changes to remain after database updates.</span></span> <span data-ttu-id="d22d4-155">Nesse caso, você deseja fazer uma operação de inserção condicional: Insira uma linha somente se ela ainda não existir.</span><span class="sxs-lookup"><span data-stu-id="d22d4-155">In that case you want to do a conditional insert operation: insert a row only if it doesn't already exist.</span></span> <span data-ttu-id="d22d4-156">O método semente usa ambas as abordagens.</span><span class="sxs-lookup"><span data-stu-id="d22d4-156">The Seed method uses both approaches.</span></span>

    <span data-ttu-id="d22d4-157">O primeiro parâmetro passado para o método [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) especifica a propriedade a ser usada para verificar se já existe uma linha.</span><span class="sxs-lookup"><span data-stu-id="d22d4-157">The first parameter passed to the [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) method specifies the property to use to check if a row already exists.</span></span> <span data-ttu-id="d22d4-158">Para os dados de aluno de teste que você está fornecendo `LastName` , a propriedade pode ser usada para essa finalidade, pois cada sobrenome na lista é exclusivo:</span><span class="sxs-lookup"><span data-stu-id="d22d4-158">For the test student data that you are providing, the `LastName` property can be used for this purpose since each last name in the list is unique:</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample5.cs)]

    <span data-ttu-id="d22d4-159">Esse código pressupõe que os últimos nomes são exclusivos.</span><span class="sxs-lookup"><span data-stu-id="d22d4-159">This code assumes that last names are unique.</span></span> <span data-ttu-id="d22d4-160">Se você adicionar manualmente um aluno com um sobrenome duplicado, obterá a seguinte exceção na próxima vez que executar uma migração:</span><span class="sxs-lookup"><span data-stu-id="d22d4-160">If you manually add a student with a duplicate last name, you'll get the following exception the next time you perform a migration:</span></span>

    <span data-ttu-id="d22d4-161">**A sequência contém mais de um elemento**</span><span class="sxs-lookup"><span data-stu-id="d22d4-161">**Sequence contains more than one element**</span></span>

    <span data-ttu-id="d22d4-162">Para obter informações sobre como lidar com dados redundantes, como dois alunos nomeados como "Alexander Carson", consulte o de [FE (propagação e Entity Framework depuração) do EF](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) no blog de Rick Anderson.</span><span class="sxs-lookup"><span data-stu-id="d22d4-162">For information about how to handle redundant data such as two students named "Alexander Carson", see [Seeding and Debugging Entity Framework (EF) DBs](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) on Rick Anderson's blog.</span></span> <span data-ttu-id="d22d4-163">Para obter mais informações sobre `AddOrUpdate` o método, consulte [tome cuidado com o método EF 4,3 AddOrUpdate](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) no blog de Julie Lerman.</span><span class="sxs-lookup"><span data-stu-id="d22d4-163">For more information about the `AddOrUpdate` method, see [Take care with EF 4.3 AddOrUpdate Method](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) on Julie Lerman's blog.</span></span>

    <span data-ttu-id="d22d4-164">O código que cria `Enrollment` entidades pressupõe que você tenha `ID` o valor `students` nas entidades na coleção, embora não tenha definido essa propriedade no código que cria a coleção.</span><span class="sxs-lookup"><span data-stu-id="d22d4-164">The code that creates `Enrollment` entities assumes you have the `ID` value in the entities in the `students` collection, although you didn't set that property in the code that creates the collection.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample6.cs?highlight=2)]

    <span data-ttu-id="d22d4-165">Você pode usar a `ID` Propriedade aqui porque o `ID` valor é definido quando você chama `SaveChanges` para a `students` coleção.</span><span class="sxs-lookup"><span data-stu-id="d22d4-165">You can use the `ID` property here because the `ID` value is set when you call `SaveChanges` for the `students` collection.</span></span> <span data-ttu-id="d22d4-166">O EF obtém automaticamente o valor de chave primária quando insere uma entidade no banco de dados e atualiza a `ID` propriedade da entidade na memória.</span><span class="sxs-lookup"><span data-stu-id="d22d4-166">EF automatically gets the primary key value when it inserts an entity into the database, and it updates the `ID` property of the entity in memory.</span></span>

    <span data-ttu-id="d22d4-167">O código que adiciona cada `Enrollment` entidade `Enrollments` ao conjunto de entidades não usa o `AddOrUpdate` método.</span><span class="sxs-lookup"><span data-stu-id="d22d4-167">The code that adds each `Enrollment` entity to the `Enrollments` entity set doesn't use the `AddOrUpdate` method.</span></span> <span data-ttu-id="d22d4-168">Ele verifica se uma entidade já existe e insere a entidade, caso ela não exista.</span><span class="sxs-lookup"><span data-stu-id="d22d4-168">It checks if an entity already exists and inserts the entity if it doesn't exist.</span></span> <span data-ttu-id="d22d4-169">Essa abordagem preservará as alterações feitas em uma classificação de registro usando a interface do usuário do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d22d4-169">This approach will preserve changes you make to an enrollment grade by using the application UI.</span></span> <span data-ttu-id="d22d4-170">O código percorre cada membro da `Enrollment` [lista](https://msdn.microsoft.com/library/6sh2ey19.aspx) e, se o registro não for encontrado no banco de dados, ele adicionará o registro ao banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-170">The code loops through each member of the `Enrollment`[List](https://msdn.microsoft.com/library/6sh2ey19.aspx) and if the enrollment is not found in the database, it adds the enrollment to the database.</span></span> <span data-ttu-id="d22d4-171">Na primeira vez que você atualizar o banco de dados, o banco de dados estará vazio, portanto, ele adicionará cada registro.</span><span class="sxs-lookup"><span data-stu-id="d22d4-171">The first time you update the database, the database will be empty, so it will add each enrollment.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample7.cs)]

2. <span data-ttu-id="d22d4-172">Compile o projeto.</span><span class="sxs-lookup"><span data-stu-id="d22d4-172">Build the project.</span></span>

### <a name="execute-the-first-migration"></a><span data-ttu-id="d22d4-173">Executar a primeira migração</span><span class="sxs-lookup"><span data-stu-id="d22d4-173">Execute the first migration</span></span>

<span data-ttu-id="d22d4-174">Quando você executou `add-migration` o comando, as migrações geraram o código que criaria o banco de dados do zero.</span><span class="sxs-lookup"><span data-stu-id="d22d4-174">When you executed the `add-migration` command, Migrations generated the code that would create the database from scratch.</span></span> <span data-ttu-id="d22d4-175">Esse código também está na pasta *migrações* , no arquivo chamado  *&lt;timestamp&gt;\_InitialCreate.cs*.</span><span class="sxs-lookup"><span data-stu-id="d22d4-175">This code is also in the *Migrations* folder, in the file named *&lt;timestamp&gt;\_InitialCreate.cs*.</span></span> <span data-ttu-id="d22d4-176">O `Up` método `Down` da classe cria as tabelas de banco de dados que correspondem aos conjuntos de entidades de modelo de dado e o método os exclui. `InitialCreate`</span><span class="sxs-lookup"><span data-stu-id="d22d4-176">The `Up` method of the `InitialCreate` class creates the database tables that correspond to the data model entity sets, and the `Down` method deletes them.</span></span>

[!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample8.cs)]

<span data-ttu-id="d22d4-177">As migrações chamam o método `Up` para implementar as alterações do modelo de dados para uma migração.</span><span class="sxs-lookup"><span data-stu-id="d22d4-177">Migrations calls the `Up` method to implement the data model changes for a migration.</span></span> <span data-ttu-id="d22d4-178">Quando você insere um comando para reverter a atualização, as Migrações chamam o método `Down`.</span><span class="sxs-lookup"><span data-stu-id="d22d4-178">When you enter a command to roll back the update, Migrations calls the `Down` method.</span></span>

<span data-ttu-id="d22d4-179">Essa é a migração inicial que foi criada quando você inseriu `add-migration InitialCreate` o comando.</span><span class="sxs-lookup"><span data-stu-id="d22d4-179">This is the initial migration that was created when you entered the `add-migration InitialCreate` command.</span></span> <span data-ttu-id="d22d4-180">O parâmetro (`InitialCreate` no exemplo) é usado para o nome do arquivo e pode ser o que você desejar. normalmente, você escolhe uma palavra ou frase que resume o que está sendo feito na migração.</span><span class="sxs-lookup"><span data-stu-id="d22d4-180">The parameter (`InitialCreate` in the example) is used for the file name and can be whatever you want; you typically choose a word or phrase that summarizes what is being done in the migration.</span></span> <span data-ttu-id="d22d4-181">Por exemplo, você pode nomear uma migração &quot;mais tarde como&quot;adddepartmenttable.</span><span class="sxs-lookup"><span data-stu-id="d22d4-181">For example, you might name a later migration &quot;AddDepartmentTable&quot;.</span></span>

<span data-ttu-id="d22d4-182">Se você criou a migração inicial quando o banco de dados já existia, o código de criação de banco de dados é gerado, mas ele não precisa ser executado porque o banco de dados já corresponde ao modelo de dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-182">If you created the initial migration when the database already exists, the database creation code is generated but it doesn't have to run because the database already matches the data model.</span></span> <span data-ttu-id="d22d4-183">Quando você implantar o aplicativo em outro ambiente no qual o banco de dados ainda não existe, esse código será executado para criar o banco de dados; portanto, é uma boa ideia testá-lo primeiro.</span><span class="sxs-lookup"><span data-stu-id="d22d4-183">When you deploy the app to another environment where the database doesn't exist yet, this code will run to create your database, so it's a good idea to test it first.</span></span> <span data-ttu-id="d22d4-184">É por isso que você alterou o nome do banco de dados na cadeia&mdash;de conexão anterior para que as migrações possam criar um novo a partir do zero.</span><span class="sxs-lookup"><span data-stu-id="d22d4-184">That's why you changed the name of the database in the connection string earlier&mdash;so that migrations can create a new one from scratch.</span></span>

1. <span data-ttu-id="d22d4-185">Na janela do **console do Gerenciador de pacotes** , digite o seguinte comando:</span><span class="sxs-lookup"><span data-stu-id="d22d4-185">In the **Package Manager Console** window, enter the following command:</span></span>

    `update-database`

    <span data-ttu-id="d22d4-186">O `update-database` comando executa o `Up` método para criar o banco de dados e, em `Seed` seguida, executa o método para preencher o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-186">The `update-database` command runs the `Up` method to create the database and then it runs the `Seed` method to populate the database.</span></span> <span data-ttu-id="d22d4-187">O mesmo processo será executado automaticamente na produção após a implantação do aplicativo, como você verá na seção a seguir.</span><span class="sxs-lookup"><span data-stu-id="d22d4-187">The same process will run automatically in production after you deploy the application, as you'll see in the following section.</span></span>
2. <span data-ttu-id="d22d4-188">Use **Gerenciador de servidores** para inspecionar o banco de dados como você fez no primeiro tutorial e execute o aplicativo para verificar se tudo ainda funciona da mesma forma que antes.</span><span class="sxs-lookup"><span data-stu-id="d22d4-188">Use **Server Explorer** to inspect the database as you did in the first tutorial, and run the application to verify that everything still works the same as before.</span></span>

## <a name="deploy-to-azure"></a><span data-ttu-id="d22d4-189">Implantar no Azure</span><span class="sxs-lookup"><span data-stu-id="d22d4-189">Deploy to Azure</span></span>

<span data-ttu-id="d22d4-190">Até agora, o aplicativo está em execução localmente em IIS Express no seu computador de desenvolvimento.</span><span class="sxs-lookup"><span data-stu-id="d22d4-190">So far the application has been running locally in IIS Express on your development computer.</span></span> <span data-ttu-id="d22d4-191">Para torná-lo disponível para outras pessoas usarem pela Internet, você precisa implantá-lo em um provedor de hospedagem na Web.</span><span class="sxs-lookup"><span data-stu-id="d22d4-191">To make it available for other people to use over the Internet, you have to deploy it to a web hosting provider.</span></span> <span data-ttu-id="d22d4-192">Nesta seção do tutorial, você o implantará no Azure.</span><span class="sxs-lookup"><span data-stu-id="d22d4-192">In this section of the tutorial, you'll deploy it to Azure.</span></span> <span data-ttu-id="d22d4-193">Esta seção é opcional; Você pode ignorar isso e continuar com o tutorial a seguir ou pode adaptar as instruções nesta seção para um provedor de hospedagem diferente de sua escolha.</span><span class="sxs-lookup"><span data-stu-id="d22d4-193">This section is optional; you can skip this and continue with the following tutorial, or you can adapt the instructions in this section for a different hosting provider of your choice.</span></span>

### <a name="use-code-first-migrations-to-deploy-the-database"></a><span data-ttu-id="d22d4-194">Usar Code First migrações para implantar o banco de dados</span><span class="sxs-lookup"><span data-stu-id="d22d4-194">Use Code First migrations to deploy the database</span></span>

<span data-ttu-id="d22d4-195">Para implantar o banco de dados, você usará Migrações do Code First.</span><span class="sxs-lookup"><span data-stu-id="d22d4-195">To deploy the database, you'll use Code First Migrations.</span></span> <span data-ttu-id="d22d4-196">Ao criar o perfil de publicação que você usa para definir as configurações de implantação do Visual Studio, você marcará uma caixa de seleção rotulada **Atualizar banco de dados**.</span><span class="sxs-lookup"><span data-stu-id="d22d4-196">When you create the publish profile that you use to configure settings for deploying from Visual Studio, you'll select a check box labeled **Update Database**.</span></span> <span data-ttu-id="d22d4-197">Essa configuração faz com que o processo de implantação configure automaticamente o arquivo *Web. config* do aplicativo no servidor de destino para que `MigrateDatabaseToLatestVersion` Code First use a classe do inicializador.</span><span class="sxs-lookup"><span data-stu-id="d22d4-197">This setting causes the deployment process to automatically configure the application *Web.config* file on the destination server so that Code First uses the `MigrateDatabaseToLatestVersion` initializer class.</span></span>

<span data-ttu-id="d22d4-198">O Visual Studio não faz nada com o banco de dados durante o processo de implantação enquanto copia seu projeto para o servidor de destino.</span><span class="sxs-lookup"><span data-stu-id="d22d4-198">Visual Studio doesn't do anything with the database during the deployment process while it is copying your project to the destination server.</span></span> <span data-ttu-id="d22d4-199">Quando você executa o aplicativo implantado e acessa o banco de dados pela primeira vez após a implantação, o Code First verifica se o banco de dados corresponde ao modelo de dado.</span><span class="sxs-lookup"><span data-stu-id="d22d4-199">When you run the deployed application and it accesses the database for the first time after deployment, Code First checks if the database matches the data model.</span></span> <span data-ttu-id="d22d4-200">Se houver uma incompatibilidade, Code First criará automaticamente o banco de dados (se ele ainda não existir) ou atualizará o esquema de banco de dados para a versão mais recente (se existir um banco de dados, mas não corresponder ao modelo).</span><span class="sxs-lookup"><span data-stu-id="d22d4-200">If there's a mismatch, Code First automatically creates the database (if it doesn't exist yet) or updates the database schema to the latest version (if a database exists but doesn't match the model).</span></span> <span data-ttu-id="d22d4-201">Se o aplicativo implementar um `Seed` método de migrações, o método será executado depois que o banco de dados for criado ou o esquema for atualizado.</span><span class="sxs-lookup"><span data-stu-id="d22d4-201">If the application implements a Migrations `Seed` method, the method runs after the database is created or the schema is updated.</span></span>

<span data-ttu-id="d22d4-202">O `Seed` método Migrations insere dados de teste.</span><span class="sxs-lookup"><span data-stu-id="d22d4-202">Your Migrations `Seed` method inserts test data.</span></span> <span data-ttu-id="d22d4-203">Se você estivesse implantando em um ambiente de produção, precisaria alterar o `Seed` método para que ele apenas insira dados que você deseja inserir em seu banco de dados de produção.</span><span class="sxs-lookup"><span data-stu-id="d22d4-203">If you were deploying to a production environment, you would have to change the `Seed` method so that it only inserts data that you want to be inserted into your production database.</span></span> <span data-ttu-id="d22d4-204">Por exemplo, em seu modelo de dados atual, talvez você queira ter cursos reais, mas os alunos fictícios no banco de dado de desenvolvimento.</span><span class="sxs-lookup"><span data-stu-id="d22d4-204">For example, in your current data model you might want to have real courses but fictional students in the development database.</span></span> <span data-ttu-id="d22d4-205">Você pode escrever um `Seed` método para carregar ambos no desenvolvimento e, em seguida, comentar os alunos fictícios antes de implantá-los na produção.</span><span class="sxs-lookup"><span data-stu-id="d22d4-205">You can write a `Seed` method to load both in development, and then comment out the fictional students before you deploy to production.</span></span> <span data-ttu-id="d22d4-206">Ou você pode escrever um `Seed` método para carregar apenas cursos e inserir os alunos fictícios no banco de dados de teste manualmente usando a interface do usuário do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d22d4-206">Or you can write a `Seed` method to load only courses, and enter the fictional students in the test database manually by using the application's UI.</span></span>

### <a name="get-an-azure-account"></a><span data-ttu-id="d22d4-207">Obter uma conta do Azure</span><span class="sxs-lookup"><span data-stu-id="d22d4-207">Get an Azure account</span></span>

<span data-ttu-id="d22d4-208">Você precisará de uma conta do Azure.</span><span class="sxs-lookup"><span data-stu-id="d22d4-208">You'll need an Azure account.</span></span> <span data-ttu-id="d22d4-209">Se você ainda não tiver uma, mas tiver uma assinatura do Visual Studio, poderá [ativar os benefícios](https://azure.microsoft.com/pricing/member-offers/credit-for-visual-studio-subscribers/
)da sua assinatura.</span><span class="sxs-lookup"><span data-stu-id="d22d4-209">If you don't already have one, but you do have a Visual Studio subscription, you can [activate your subscription benefits](https://azure.microsoft.com/pricing/member-offers/credit-for-visual-studio-subscribers/
).</span></span> <span data-ttu-id="d22d4-210">Caso contrário, você pode criar uma conta de avaliação gratuita em apenas alguns minutos.</span><span class="sxs-lookup"><span data-stu-id="d22d4-210">Otherwise, you can create a free trial account in just a couple of minutes.</span></span> <span data-ttu-id="d22d4-211">Para obter detalhes, consulte [avaliação gratuita do Azure](https://azure.microsoft.com/free/).</span><span class="sxs-lookup"><span data-stu-id="d22d4-211">For details, see [Azure Free Trial](https://azure.microsoft.com/free/).</span></span>

### <a name="create-a-web-site-and-a-sql-database-in-azure"></a><span data-ttu-id="d22d4-212">Criar um site da Web e um banco de dados SQL no Azure</span><span class="sxs-lookup"><span data-stu-id="d22d4-212">Create a web site and a SQL database in Azure</span></span>

<span data-ttu-id="d22d4-213">Seu aplicativo Web no Azure será executado em um ambiente de hospedagem compartilhado, o que significa que ele é executado em máquinas virtuais (VMs) que são compartilhadas com outros clientes do Azure.</span><span class="sxs-lookup"><span data-stu-id="d22d4-213">Your web app in Azure will run in a shared hosting environment, which means it runs on virtual machines (VMs) that are shared with other Azure clients.</span></span> <span data-ttu-id="d22d4-214">Um ambiente de hospedagem compartilhado é uma maneira econômica de começar a usar a nuvem.</span><span class="sxs-lookup"><span data-stu-id="d22d4-214">A shared hosting environment is a low-cost way to get started in the cloud.</span></span> <span data-ttu-id="d22d4-215">Posteriormente, se o tráfego da Web aumentar, o aplicativo poderá ser dimensionado para atender à necessidade executando em VMs dedicadas.</span><span class="sxs-lookup"><span data-stu-id="d22d4-215">Later, if your web traffic increases, the application can scale to meet the need by running on dedicated VMs.</span></span> <span data-ttu-id="d22d4-216">Para saber mais sobre as opções de preço para Azure App serviço, leia [preços do serviço de aplicativo](https://azure.microsoft.com/pricing/details/app-service/).</span><span class="sxs-lookup"><span data-stu-id="d22d4-216">To learn more about Pricing Options for Azure App Service, read [App Service pricing](https://azure.microsoft.com/pricing/details/app-service/).</span></span>

<span data-ttu-id="d22d4-217">Você implantará o banco de dados no banco de dados SQL do Azure.</span><span class="sxs-lookup"><span data-stu-id="d22d4-217">You'll deploy the database to Azure SQL database.</span></span> <span data-ttu-id="d22d4-218">O banco de dados SQL é um serviço de banco de dados relacional baseado em nuvem criado em tecnologias de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="d22d4-218">SQL database is a cloud-based relational database service that is built on SQL Server technologies.</span></span> <span data-ttu-id="d22d4-219">Ferramentas e aplicativos que funcionam com o SQL Server também funcionam com o banco de dados SQL.</span><span class="sxs-lookup"><span data-stu-id="d22d4-219">Tools and applications that work with SQL Server also work with SQL database.</span></span>

1. <span data-ttu-id="d22d4-220">Na [portal de gerenciamento do Azure](https://portal.azure.com), escolha **criar um recurso** na guia à esquerda e, em seguida, escolha **ver tudo** no **novo** painel (ou *folha*) para ver todos os recursos disponíveis.</span><span class="sxs-lookup"><span data-stu-id="d22d4-220">In the [Azure Management Portal](https://portal.azure.com), choose **Create a resource** in the left tab and then choose **See all** on the **New** pane (or *blade*) to see all available resources.</span></span> <span data-ttu-id="d22d4-221">Escolha **aplicativo Web + SQL** na seção **da Web** da folha **tudo** .</span><span class="sxs-lookup"><span data-stu-id="d22d4-221">Choose **Web App + SQL** in the **Web** section of the **Everything** blade.</span></span> <span data-ttu-id="d22d4-222">Por fim, escolha **criar**.</span><span class="sxs-lookup"><span data-stu-id="d22d4-222">Finally, choose **Create**.</span></span>

    ![Criar um recurso no Portal do Azure](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/create-azure-resource.png)

   <span data-ttu-id="d22d4-224">O formulário para criar um novo **aplicativo Web + novo recurso SQL** é aberto.</span><span class="sxs-lookup"><span data-stu-id="d22d4-224">The form to create a new **New Web App + SQL** resource opens.</span></span>

2. <span data-ttu-id="d22d4-225">Insira uma cadeia de caracteres na caixa **nome do aplicativo** para usar como a URL exclusiva para seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d22d4-225">Enter a string in the **App name** box to use as the unique URL for your application.</span></span> <span data-ttu-id="d22d4-226">A URL completa consistirá no que você inserir aqui mais o domínio padrão dos serviços de Azure App (. azurewebsites.net).</span><span class="sxs-lookup"><span data-stu-id="d22d4-226">The complete URL will consist of what you enter here plus the default domain of Azure App Services (.azurewebsites.net).</span></span> <span data-ttu-id="d22d4-227">Se o **nome do aplicativo** já estiver em uso, o assistente o notificará com um vermelho *a mensagem o nome do aplicativo não está disponível* .</span><span class="sxs-lookup"><span data-stu-id="d22d4-227">If the **App name** is already taken, the Wizard notifies you with a red *The app name is not available* message.</span></span> <span data-ttu-id="d22d4-228">Se o **nome do aplicativo** estiver disponível, você verá uma marca de seleção verde.</span><span class="sxs-lookup"><span data-stu-id="d22d4-228">If the **App name** is available, you see a green checkmark.</span></span>

3. <span data-ttu-id="d22d4-229">Na caixa **assinatura** , escolha a assinatura do Azure na qual você deseja que o **serviço de aplicativo** resida.</span><span class="sxs-lookup"><span data-stu-id="d22d4-229">In the **Subscription** box, choose the Azure Subscription in which you want the **App Service** to reside.</span></span>

4. <span data-ttu-id="d22d4-230">Na caixa de texto **grupo de recursos** , escolha um grupo de recursos ou crie um novo.</span><span class="sxs-lookup"><span data-stu-id="d22d4-230">In the **Resource Group** text box, choose a Resource Group or create a new one.</span></span> <span data-ttu-id="d22d4-231">Essa configuração especifica em qual data center seu site será executado.</span><span class="sxs-lookup"><span data-stu-id="d22d4-231">This setting specifies which data center your web site will run in.</span></span> <span data-ttu-id="d22d4-232">Para obter mais informações sobre grupos de recursos, consulte [grupos de recursos](/azure/azure-resource-manager/resource-group-overview#resource-groups).</span><span class="sxs-lookup"><span data-stu-id="d22d4-232">For more information about Resource Groups, see [Resource groups](/azure/azure-resource-manager/resource-group-overview#resource-groups).</span></span>

5. <span data-ttu-id="d22d4-233">Crie um novo **plano do serviço de aplicativo** clicando na *seção serviço de aplicativo*, **criar novo**e preencher o plano do serviço de **aplicativo** (pode ser o mesmo nome que o serviço de aplicativo), o **local**e o **tipo de preço** (há uma opção gratuita).</span><span class="sxs-lookup"><span data-stu-id="d22d4-233">Create a new **App Service Plan** by clicking the *App Service section*, **Create New**, and fill in **App Service plan** (can be same name as App Service), **Location**, and **Pricing tier** (there is a free option).</span></span>

6. <span data-ttu-id="d22d4-234">Clique em **banco de dados SQL**e escolha **criar um novo banco de dados** ou selecione um banco de dados existente.</span><span class="sxs-lookup"><span data-stu-id="d22d4-234">Click **SQL Database**, and then choose **Create a new database** or select an existing database.</span></span>

7. <span data-ttu-id="d22d4-235">Na caixa **nome** , insira um nome para o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-235">In the **Name** box, enter a name for your database.</span></span>
8. <span data-ttu-id="d22d4-236">Clique na caixa **servidor de destino** e selecione **criar um novo servidor**.</span><span class="sxs-lookup"><span data-stu-id="d22d4-236">Click the **Target Server** box, and then select **Create a new server**.</span></span> <span data-ttu-id="d22d4-237">Como alternativa, se você tiver criado anteriormente um servidor, poderá selecionar esse servidor na lista de servidores disponíveis.</span><span class="sxs-lookup"><span data-stu-id="d22d4-237">Alternatively, if you previously created a server, you can select that server from list of available servers.</span></span>
9. <span data-ttu-id="d22d4-238">Escolha a seção **tipo de preço** , escolha *gratuito*.</span><span class="sxs-lookup"><span data-stu-id="d22d4-238">Choose **Pricing tier** section, choose *Free*.</span></span> <span data-ttu-id="d22d4-239">Se forem necessários recursos adicionais, o banco de dados poderá ser escalado verticalmente a qualquer momento.</span><span class="sxs-lookup"><span data-stu-id="d22d4-239">If additional resources are needed, the database can be scaled up at any time.</span></span> <span data-ttu-id="d22d4-240">Para saber mais sobre os preços do SQL Azure, confira [preços do banco de dados SQL do Azure](https://azure.microsoft.com/pricing/details/sql-database/managed/).</span><span class="sxs-lookup"><span data-stu-id="d22d4-240">To learn more on Azure SQL Pricing, see [Azure SQL Database pricing](https://azure.microsoft.com/pricing/details/sql-database/managed/).</span></span>
10. <span data-ttu-id="d22d4-241">Modifique o [agrupamento](/sql/relational-databases/collations/collation-and-unicode-support) conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="d22d4-241">Modify [collation](/sql/relational-databases/collations/collation-and-unicode-support) as needed.</span></span>
11. <span data-ttu-id="d22d4-242">Insira um administrador **SQL admin nome de usuário** e uma **senha de administrador do SQL**.</span><span class="sxs-lookup"><span data-stu-id="d22d4-242">Enter an administrator **SQL Admin Username** and **SQL Admin Password**.</span></span>

    - <span data-ttu-id="d22d4-243">Se você selecionou **novo servidor de banco de dados SQL**, defina um novo nome e senha que você usará mais tarde ao acessar o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-243">If you selected **New SQL Database server**, define a new name and password that you'll use later when you access the database.</span></span>
    - <span data-ttu-id="d22d4-244">Se você selecionou um servidor que você criou anteriormente, insira as credenciais para esse servidor.</span><span class="sxs-lookup"><span data-stu-id="d22d4-244">If you selected a server that you created previously, enter credentials for that server.</span></span>

12. <span data-ttu-id="d22d4-245">A coleção de telemetria pode ser habilitada para o serviço de aplicativo usando Application Insights.</span><span class="sxs-lookup"><span data-stu-id="d22d4-245">Telemetry collection can be enabled for App Service using Application Insights.</span></span> <span data-ttu-id="d22d4-246">Com pouca configuração, Application Insights coleta informações valiosas de evento, exceção, dependência, solicitação e rastreamento.</span><span class="sxs-lookup"><span data-stu-id="d22d4-246">With little configuration, Application Insights collects valuable event, exception, dependency, request, and trace information.</span></span> <span data-ttu-id="d22d4-247">Para saber mais sobre Application Insights, consulte [Azure monitor](https://azure.microsoft.com/services/monitor/).</span><span class="sxs-lookup"><span data-stu-id="d22d4-247">To learn more about Application Insights, see [Azure Monitor](https://azure.microsoft.com/services/monitor/).</span></span>
13. <span data-ttu-id="d22d4-248">Clique em **criar** na parte inferior para indicar que você terminou.</span><span class="sxs-lookup"><span data-stu-id="d22d4-248">Click **Create** at the bottom to indicate that you're finished.</span></span>

    <span data-ttu-id="d22d4-249">O Portal de Gerenciamento retorna à página do painel e a área de **notificações** na parte superior da página mostra que o site está sendo criado.</span><span class="sxs-lookup"><span data-stu-id="d22d4-249">The Management Portal returns to the Dashboard page, and the **Notifications** area at the top of the page shows that the site is being created.</span></span> <span data-ttu-id="d22d4-250">Após um tempo (normalmente menos de um minuto), há uma notificação de que a implantação foi bem-sucedida.</span><span class="sxs-lookup"><span data-stu-id="d22d4-250">After a while (typically less than a minute), there's a notification that the Deployment succeeded.</span></span> <span data-ttu-id="d22d4-251">Na barra de navegação à esquerda, o novo serviço de aplicativo é exibido na seção **serviços de aplicativos** e o novo banco de dados SQL é exibido na seção SQL databases.</span><span class="sxs-lookup"><span data-stu-id="d22d4-251">In the navigation bar at the left, the new App Service appears in the **App Services** section and the new SQL database appears in the **SQL databases** section.</span></span>

### <a name="deploy-the-app-to-azure"></a><span data-ttu-id="d22d4-252">Implantar o aplicativo no Azure</span><span class="sxs-lookup"><span data-stu-id="d22d4-252">Deploy the app to Azure</span></span>

1. <span data-ttu-id="d22d4-253">No Visual Studio, clique com o botão direito do mouse no projeto em **Gerenciador de soluções** e selecione **publicar** no menu de contexto.</span><span class="sxs-lookup"><span data-stu-id="d22d4-253">In Visual Studio, right-click the project in **Solution Explorer** and select **Publish** from the context menu.</span></span>

2. <span data-ttu-id="d22d4-254">Na página **escolher um destino de publicação** , escolha **serviço de aplicativo** e, em seguida, **selecione existente**e, em seguida, escolha **publicar**.</span><span class="sxs-lookup"><span data-stu-id="d22d4-254">On the **Pick a publish target** page, choose **App Service** and then **Select Existing**, and then choose **Publish**.</span></span>

    ![Escolha uma página de destino de publicação](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/publish-select-existing-azure-app-service.png)

3. <span data-ttu-id="d22d4-256">Se você ainda não adicionou sua assinatura do Azure no Visual Studio, execute as etapas na tela.</span><span class="sxs-lookup"><span data-stu-id="d22d4-256">If you haven't previously added your Azure subscription in Visual Studio, perform the steps on the screen.</span></span> <span data-ttu-id="d22d4-257">Essas etapas permitem que o Visual Studio se conecte à sua assinatura do Azure para que a lista de **serviços de aplicativos** inclua seu site.</span><span class="sxs-lookup"><span data-stu-id="d22d4-257">These steps enable Visual Studio to connect to your Azure subscription so that the list of **App Services** will include your web site.</span></span>

4. <span data-ttu-id="d22d4-258">Na página **serviço de aplicativo** , selecione a **assinatura** à qual você adicionou o serviço de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d22d4-258">On the **App Service** page, select the **Subscription** you added the App Service to.</span></span> <span data-ttu-id="d22d4-259">Em **Exibir**, selecione **grupo de recursos**.</span><span class="sxs-lookup"><span data-stu-id="d22d4-259">Under **View**, select **Resource Group**.</span></span> <span data-ttu-id="d22d4-260">Expanda o grupo de recursos ao qual você adicionou o serviço de aplicativo e, em seguida, selecione o serviço de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d22d4-260">Expand the resource group you added the App Service to, and then select the App Service.</span></span> <span data-ttu-id="d22d4-261">Escolha **OK** para publicar o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d22d4-261">Choose **OK** to publish the app.</span></span>

5. <span data-ttu-id="d22d4-262">A janela **saída** mostra quais ações de implantação foram executadas e relata a conclusão bem-sucedida da implantação.</span><span class="sxs-lookup"><span data-stu-id="d22d4-262">The **Output** window shows what deployment actions were taken and reports successful completion of the deployment.</span></span>

6. <span data-ttu-id="d22d4-263">Após a implantação bem-sucedida, o navegador padrão será aberto automaticamente na URL do site implantado.</span><span class="sxs-lookup"><span data-stu-id="d22d4-263">Upon successful deployment, the default browser automatically opens to the URL of the deployed web site.</span></span>

    ![Students_index_page_with_paging](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/cloud-app-browser.png)

    <span data-ttu-id="d22d4-265">Seu aplicativo agora está em execução na nuvem.</span><span class="sxs-lookup"><span data-stu-id="d22d4-265">Your app is now running in the cloud.</span></span>

<span data-ttu-id="d22d4-266">Neste ponto, o banco de dados *SchoolContext* foi criado no banco de dados SQL do Azure porque você selecionou **executar migrações do Code First (é executado no início do aplicativo)** .</span><span class="sxs-lookup"><span data-stu-id="d22d4-266">At this point, the *SchoolContext* database has been created in the Azure SQL database because you selected **Execute Code First Migrations (runs on app start)**.</span></span> <span data-ttu-id="d22d4-267">O arquivo *Web. config* no site implantado foi alterado para que o inicializador [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) seja executado na primeira vez em que seu código lê ou grava dados no banco de dado (o que aconteceu quando você selecionou a guia **alunos** ):</span><span class="sxs-lookup"><span data-stu-id="d22d4-267">The *Web.config* file in the deployed web site has been changed so that the [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) initializer runs the first time your code reads or writes data in the database (which happened when you selected the **Students** tab):</span></span>

![Trecho do arquivo Web. config](https://asp.net/media/4367421/mig.png)

<span data-ttu-id="d22d4-269">O processo de implantação também criou uma nova cadeia de conexão *\_(SchoolContext DatabasePublish*) para migrações do Code First usar para atualizar o esquema de banco de dados e propagar o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-269">The deployment process also created a new connection string *(SchoolContext\_DatabasePublish*) for Code First Migrations to use for updating the database schema and seeding the database.</span></span>

![Cadeia de conexão no arquivo Web. config](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image26.png)

<span data-ttu-id="d22d4-271">Você pode encontrar a versão implantada do arquivo Web. config em seu próprio computador no *ContosoUniversity\obj\Release\Package\PackageTmp\Web.config*. Você pode acessar o próprio arquivo *Web. config* implantado usando FTP.</span><span class="sxs-lookup"><span data-stu-id="d22d4-271">You can find the deployed version of the Web.config file on your own computer in *ContosoUniversity\obj\Release\Package\PackageTmp\Web.config*. You can access the deployed *Web.config* file itself by using FTP.</span></span> <span data-ttu-id="d22d4-272">Para obter instruções, [consulte implantação da Web do ASP.NET usando o Visual Studio: Implantando uma atualização](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update)de código.</span><span class="sxs-lookup"><span data-stu-id="d22d4-272">For instructions, see [ASP.NET Web Deployment using Visual Studio: Deploying a Code Update](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update).</span></span> <span data-ttu-id="d22d4-273">Siga as instruções que começam com "para usar uma ferramenta de FTP, você precisa de três coisas: a URL de FTP, o nome de usuário e a senha".</span><span class="sxs-lookup"><span data-stu-id="d22d4-273">Follow the instructions that start with "To use an FTP tool, you need three things: the FTP URL, the user name, and the password."</span></span>

> [!NOTE]
> <span data-ttu-id="d22d4-274">O aplicativo Web não implementa a segurança, para que qualquer pessoa que encontre a URL possa alterar os dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-274">The web app doesn't implement security, so anyone who finds the URL can change the data.</span></span> <span data-ttu-id="d22d4-275">Para obter instruções sobre como proteger o site da Web, consulte [implantar um aplicativo MVC do secure ASP.NET com associação, OAuth e banco de dados SQL no Azure](/aspnet/core/security/authorization/secure-data).</span><span class="sxs-lookup"><span data-stu-id="d22d4-275">For instructions on how to secure the web site, see [Deploy a Secure ASP.NET MVC app with Membership, OAuth, and SQL database to Azure](/aspnet/core/security/authorization/secure-data).</span></span> <span data-ttu-id="d22d4-276">Você pode impedir que outras pessoas usem o site parando o serviço usando o Portal de Gerenciamento ou o **Gerenciador de servidores** do Azure no Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="d22d4-276">You can prevent other people from using the site by stopping the service using the Azure Management Portal or **Server Explorer** in Visual Studio.</span></span>

![Parar o item de menu do serviço de aplicativo](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/server-explorer-stop-app-service.png)

## <a name="advanced-migrations-scenarios"></a><span data-ttu-id="d22d4-278">Cenários de migrações avançadas</span><span class="sxs-lookup"><span data-stu-id="d22d4-278">Advanced migrations scenarios</span></span>

<span data-ttu-id="d22d4-279">Se você implantar um banco de dados executando migrações automaticamente, conforme mostrado neste tutorial, e estiver implantando em um site que é executado em vários servidores, poderá obter vários servidores tentando executar migrações ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="d22d4-279">If you deploy a database by running migrations automatically as shown in this tutorial, and you are deploying to a web site that runs on multiple servers, you could get multiple servers trying to run migrations at the same time.</span></span> <span data-ttu-id="d22d4-280">As migrações são atômicas, portanto, se dois servidores tentarem executar a mesma migração, um será bem sucedido e o outro falhará (supondo que as operações não possam ser feitas duas vezes).</span><span class="sxs-lookup"><span data-stu-id="d22d4-280">Migrations are atomic, so if two servers try to run the same migration, one will succeed and the other will fail (assuming the operations can't be done twice).</span></span> <span data-ttu-id="d22d4-281">Nesse cenário, se você quiser evitar esses problemas, poderá chamar as migrações manualmente e configurar seu próprio código para que isso ocorra apenas uma vez.</span><span class="sxs-lookup"><span data-stu-id="d22d4-281">In that scenario if you want to avoid those issues, you can call migrations manually and set up your own code so that it only happens once.</span></span> <span data-ttu-id="d22d4-282">Para obter mais informações, consulte [executando e realizando migrações de scripts do código](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/) no blog de Rowan Miller e [Migrate. exe](/ef/ef6/modeling/code-first/migrations/migrate-exe) (para executar migrações na linha de comando).</span><span class="sxs-lookup"><span data-stu-id="d22d4-282">For more information, see [Running and Scripting Migrations from Code](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/) on Rowan Miller's blog and [Migrate.exe](/ef/ef6/modeling/code-first/migrations/migrate-exe) (for executing migrations from the command line).</span></span>

<span data-ttu-id="d22d4-283">Para obter informações sobre outros cenários de migração, consulte [Migrations screencast Series](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx).</span><span class="sxs-lookup"><span data-stu-id="d22d4-283">For information about other migrations scenarios, see [Migrations Screencast Series](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx).</span></span>

## <a name="update-specific-migration"></a><span data-ttu-id="d22d4-284">Atualizar migração específica</span><span class="sxs-lookup"><span data-stu-id="d22d4-284">Update specific migration</span></span>

`update-database -target MigrationName`

<span data-ttu-id="d22d4-285">O `update-database -target MigrationName` comando executa a migração de destino.</span><span class="sxs-lookup"><span data-stu-id="d22d4-285">The `update-database -target MigrationName` command runs the targeted migration.</span></span>

## <a name="ignore-migration-changes-to-database"></a><span data-ttu-id="d22d4-286">Ignorar alterações de migração no banco de dados</span><span class="sxs-lookup"><span data-stu-id="d22d4-286">Ignore migration changes to database</span></span>

`Add-migration MigrationName -ignoreChanges`

<span data-ttu-id="d22d4-287">`ignoreChanges`Cria uma migração vazia com o modelo atual como um instantâneo.</span><span class="sxs-lookup"><span data-stu-id="d22d4-287">`ignoreChanges` creates an empty migration with the current model as a snapshot.</span></span>

## <a name="code-first-initializers"></a><span data-ttu-id="d22d4-288">Inicializadores de Code First</span><span class="sxs-lookup"><span data-stu-id="d22d4-288">Code First initializers</span></span>

<span data-ttu-id="d22d4-289">Na seção de implantação, você viu o inicializador [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) que está sendo usado.</span><span class="sxs-lookup"><span data-stu-id="d22d4-289">In the deployment section, you saw the [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) initializer being used.</span></span> <span data-ttu-id="d22d4-290">Code First também fornece outros inicializadores, incluindo [CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) (o padrão), [DropCreateDatabaseIfModelChanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) (que você usou anteriormente) e [DropCreateDatabaseAlways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx).</span><span class="sxs-lookup"><span data-stu-id="d22d4-290">Code First also provides other initializers, including [CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) (the default), [DropCreateDatabaseIfModelChanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) (which you used earlier) and [DropCreateDatabaseAlways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx).</span></span> <span data-ttu-id="d22d4-291">O `DropCreateAlways` inicializador pode ser útil para configurar condições para testes de unidade.</span><span class="sxs-lookup"><span data-stu-id="d22d4-291">The `DropCreateAlways` initializer can be useful for setting up conditions for unit tests.</span></span> <span data-ttu-id="d22d4-292">Você também pode escrever seus próprios inicializadores e pode chamar um inicializador explicitamente se não quiser esperar até que o aplicativo leia ou grave no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d22d4-292">You can also write your own initializers, and you can call an initializer explicitly if you don't want to wait until the application reads from or writes to the database.</span></span>

<span data-ttu-id="d22d4-293">Para obter mais informações sobre inicializadores, consulte [noções básicas sobre inicializadores de banco de dados no Entity Framework Code First](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm) e o capítulo 6 da Entity Framework de programação de livros [: Code First](http://shop.oreilly.com/product/0636920022220.do) por Julie Lerman e Rowan Miller.</span><span class="sxs-lookup"><span data-stu-id="d22d4-293">For more information about initializers, see [Understanding Database Initializers in Entity Framework Code First](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm) and chapter 6 of the book [Programming Entity Framework: Code First](http://shop.oreilly.com/product/0636920022220.do) by Julie Lerman and Rowan Miller.</span></span>

## <a name="get-the-code"></a><span data-ttu-id="d22d4-294">Obter o código</span><span class="sxs-lookup"><span data-stu-id="d22d4-294">Get the code</span></span>

[<span data-ttu-id="d22d4-295">Baixar o projeto concluído</span><span class="sxs-lookup"><span data-stu-id="d22d4-295">Download the Completed Project</span></span>](https://webpifeed.blob.core.windows.net/webpifeed/Partners/ASP.NET%20MVC%20Application%20Using%20Entity%20Framework%20Code%20First.zip)

## <a name="additional-resources"></a><span data-ttu-id="d22d4-296">Recursos adicionais</span><span class="sxs-lookup"><span data-stu-id="d22d4-296">Additional resources</span></span>

<span data-ttu-id="d22d4-297">Links para outros recursos de Entity Framework podem ser encontrados em [recursos de acesso a dados ASP.net-recomendado](xref:whitepapers/aspnet-data-access-content-map).</span><span class="sxs-lookup"><span data-stu-id="d22d4-297">Links to other Entity Framework resources can be found in [ASP.NET Data Access - Recommended Resources](xref:whitepapers/aspnet-data-access-content-map).</span></span>

## <a name="next-steps"></a><span data-ttu-id="d22d4-298">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="d22d4-298">Next steps</span></span>

<span data-ttu-id="d22d4-299">Neste tutorial, você:</span><span class="sxs-lookup"><span data-stu-id="d22d4-299">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="d22d4-300">Migrações Code First habilitadas</span><span class="sxs-lookup"><span data-stu-id="d22d4-300">Enabled Code First migrations</span></span>
> * <span data-ttu-id="d22d4-301">Implantou o aplicativo no Azure (opcional)</span><span class="sxs-lookup"><span data-stu-id="d22d4-301">Deployed the app in Azure (optional)</span></span>

<span data-ttu-id="d22d4-302">Avance para o próximo artigo para saber como criar um modelo de dados mais complexo para um aplicativo MVC ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="d22d4-302">Advance to the next article to learn how to create a more complex data model for an ASP.NET MVC Application.</span></span>
> [!div class="nextstepaction"]
> [<span data-ttu-id="d22d4-303">Criar um modelo de dados mais complexo</span><span class="sxs-lookup"><span data-stu-id="d22d4-303">Create a more complex data model</span></span>](creating-a-more-complex-data-model-for-an-asp-net-mvc-application.md)
