---
uid: mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application
title: Implementando o repositório e os padrões de unidade de trabalho em um aplicativo MVC ASP.NET (9 de 10) | Microsoft Docs
author: tdykstra
description: O aplicativo Web de exemplo da Contoso University demonstra como criar aplicativos ASP.NET MVC 4 usando o Entity Framework 5 Code First e o Visual Studio...
ms.author: riande
ms.date: 07/30/2013
ms.assetid: 44761193-04ba-4990-9f90-145d3c10a716
msc.legacyurl: /mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 18de9b125ee5d10795b9ce1a366918dadf4fc4e3
ms.sourcegitcommit: 22fbd8863672c4ad6693b8388ad5c8e753fb41a2
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 11/28/2019
ms.locfileid: "74595238"
---
# <a name="implementing-the-repository-and-unit-of-work-patterns-in-an-aspnet-mvc-application-9-of-10"></a><span data-ttu-id="5b1f9-103">Implementando o repositório e os padrões de unidade de trabalho em um aplicativo MVC ASP.NET (9 de 10)</span><span class="sxs-lookup"><span data-stu-id="5b1f9-103">Implementing the Repository and Unit of Work Patterns in an ASP.NET MVC Application (9 of 10)</span></span>

<span data-ttu-id="5b1f9-104">por [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="5b1f9-104">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

[<span data-ttu-id="5b1f9-105">Baixar projeto concluído</span><span class="sxs-lookup"><span data-stu-id="5b1f9-105">Download Completed Project</span></span>](https://code.msdn.microsoft.com/Getting-Started-with-dd0e2ed8)

> <span data-ttu-id="5b1f9-106">O aplicativo Web de exemplo da Contoso University demonstra como criar aplicativos ASP.NET MVC 4 usando o Entity Framework 5 Code First e o Visual Studio 2012.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-106">The Contoso University sample web application demonstrates how to create ASP.NET MVC 4 applications using the Entity Framework 5 Code First and Visual Studio 2012.</span></span> <span data-ttu-id="5b1f9-107">Para obter informações sobre a série de tutoriais, consulte [primeiro tutorial na série](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span><span class="sxs-lookup"><span data-stu-id="5b1f9-107">For information about the tutorial series, see [the first tutorial in the series](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span></span> <span data-ttu-id="5b1f9-108">Você pode iniciar a série de tutoriais desde o início ou [baixar um projeto inicial para este capítulo](building-the-ef5-mvc4-chapter-downloads.md) e começar aqui.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-108">You can start the tutorial series from the beginning or [download a starter project for this chapter](building-the-ef5-mvc4-chapter-downloads.md) and start here.</span></span>
> 
> > [!NOTE] 
> > 
> > <span data-ttu-id="5b1f9-109">Se você encontrar um problema que não possa resolver, [Baixe o capítulo concluído](building-the-ef5-mvc4-chapter-downloads.md) e tente reproduzir o problema.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-109">If you run into a problem you can't resolve, [download the completed chapter](building-the-ef5-mvc4-chapter-downloads.md) and try to reproduce your problem.</span></span> <span data-ttu-id="5b1f9-110">Em geral, você pode encontrar a solução para o problema comparando seu código com o código concluído.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-110">You can generally find the solution to the problem by comparing your code to the completed code.</span></span> <span data-ttu-id="5b1f9-111">Para alguns erros comuns e como resolvê-los, consulte [erros e soluções alternativas.](advanced-entity-framework-scenarios-for-an-mvc-web-application.md#errors)</span><span class="sxs-lookup"><span data-stu-id="5b1f9-111">For some common errors and how to solve them, see [Errors and Workarounds.](advanced-entity-framework-scenarios-for-an-mvc-web-application.md#errors)</span></span>

<span data-ttu-id="5b1f9-112">No tutorial anterior, você usou a herança para reduzir o código redundante nas classes de entidade `Student` e `Instructor`.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-112">In the previous tutorial you used inheritance to reduce redundant code in the `Student` and `Instructor` entity classes.</span></span> <span data-ttu-id="5b1f9-113">Neste tutorial, você verá algumas maneiras de usar o repositório e os padrões de unidade de trabalho para operações CRUD.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-113">In this tutorial you'll see some ways to use the repository and unit of work patterns for CRUD operations.</span></span> <span data-ttu-id="5b1f9-114">Como no tutorial anterior, neste, você alterará a maneira como seu código funciona com páginas que você já criou, em vez de criar novas páginas.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-114">As in the previous tutorial, in this one you'll change the way your code works with pages you already created rather than creating new pages.</span></span>

## <a name="the-repository-and-unit-of-work-patterns"></a><span data-ttu-id="5b1f9-115">O repositório e os padrões de unidade de trabalho</span><span class="sxs-lookup"><span data-stu-id="5b1f9-115">The Repository and Unit of Work Patterns</span></span>

<span data-ttu-id="5b1f9-116">O repositório e os padrões de unidade de trabalho destinam-se a criar uma camada de abstração entre a camada de acesso a dados e a camada de lógica de negócios de um aplicativo.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-116">The repository and unit of work patterns are intended to create an abstraction layer between the data access layer and the business logic layer of an application.</span></span> <span data-ttu-id="5b1f9-117">A implementação desses padrões pode ajudar a isolar o aplicativo de alterações no armazenamento de dados e pode facilitar o teste de unidade automatizado ou TDD (desenvolvimento orientado por testes).</span><span class="sxs-lookup"><span data-stu-id="5b1f9-117">Implementing these patterns can help insulate your application from changes in the data store and can facilitate automated unit testing or test-driven development (TDD).</span></span>

<span data-ttu-id="5b1f9-118">Neste tutorial, você implementará uma classe de repositório para cada tipo de entidade.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-118">In this tutorial you'll implement a repository class for each entity type.</span></span> <span data-ttu-id="5b1f9-119">Para o tipo de entidade `Student`, você criará uma interface de repositório e uma classe de repositório.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-119">For the `Student` entity type you'll create a repository interface and a repository class.</span></span> <span data-ttu-id="5b1f9-120">Ao criar uma instância do repositório em seu controlador, você usará a interface para que o controlador aceite uma referência a qualquer objeto que implemente a interface do repositório.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-120">When you instantiate the repository in your controller, you'll use the interface so that the controller will accept a reference to any object that implements the repository interface.</span></span> <span data-ttu-id="5b1f9-121">Quando o controlador é executado em um servidor Web, ele recebe um repositório que funciona com o Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-121">When the controller runs under a web server, it receives a repository that works with the Entity Framework.</span></span> <span data-ttu-id="5b1f9-122">Quando o controlador é executado sob uma classe de teste de unidade, ele recebe um repositório que funciona com dados armazenados de forma que você possa manipular facilmente para teste, como uma coleção na memória.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-122">When the controller runs under a unit test class, it receives a repository that works with data stored in a way that you can easily manipulate for testing, such as an in-memory collection.</span></span>

<span data-ttu-id="5b1f9-123">Posteriormente no tutorial, você usará vários repositórios e uma classe de unidade de trabalho para os tipos de entidade `Course` e `Department` no controlador de `Course`.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-123">Later in the tutorial you'll use multiple repositories and a unit of work class for the `Course` and `Department` entity types in the `Course` controller.</span></span> <span data-ttu-id="5b1f9-124">A classe de unidade de trabalho coordena o trabalho de vários repositórios criando uma única classe de contexto de banco de dados compartilhada por todos eles.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-124">The unit of work class coordinates the work of multiple repositories by creating a single database context class shared by all of them.</span></span> <span data-ttu-id="5b1f9-125">Se você quisesse ser capaz de executar testes de unidade automatizados, você criaria e usará interfaces para essas classes da mesma maneira que fazia para o repositório de `Student`.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-125">If you wanted to be able to perform automated unit testing, you'd create and use interfaces for these classes in the same way you did for the `Student` repository.</span></span> <span data-ttu-id="5b1f9-126">No entanto, para manter o tutorial simples, você criará e usará essas classes sem interfaces.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-126">However, to keep the tutorial simple, you'll create and use these classes without interfaces.</span></span>

<span data-ttu-id="5b1f9-127">A ilustração a seguir mostra uma maneira de conceituar as relações entre o controlador e as classes de contexto em comparação com não usar o repositório ou o padrão de unidade de trabalho.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-127">The following illustration shows one way to conceptualize the relationships between the controller and context classes compared to not using the repository or unit of work pattern at all.</span></span>

![Repository_pattern_diagram](https://asp.net/media/2578149/Windows-Live-Writer_8c4963ba1fa3_CE3B_Repository_pattern_diagram_1df790d3-bdf2-4c11-9098-946ddd9cd884.png)

<span data-ttu-id="5b1f9-129">Você não criará testes de unidade nesta série de tutoriais.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-129">You won't create unit tests in this tutorial series.</span></span> <span data-ttu-id="5b1f9-130">Para obter uma introdução ao TDD com um aplicativo MVC que usa o padrão de repositório, confira [Walkthrough: usando TDD com ASP.NET MVC](https://msdn.microsoft.com/library/ff847525.aspx).</span><span class="sxs-lookup"><span data-stu-id="5b1f9-130">For an introduction to TDD with an MVC application that uses the repository pattern, see [Walkthrough: Using TDD with ASP.NET MVC](https://msdn.microsoft.com/library/ff847525.aspx).</span></span> <span data-ttu-id="5b1f9-131">Para obter mais informações sobre o padrão de repositório, consulte os seguintes recursos:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-131">For more information about the repository pattern, see the following resources:</span></span>

- <span data-ttu-id="5b1f9-132">[O padrão de repositório](https://msdn.microsoft.com/library/ff649690.aspx) no msdn.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-132">[The Repository Pattern](https://msdn.microsoft.com/library/ff649690.aspx) on MSDN.</span></span>
- <span data-ttu-id="5b1f9-133">[Usando o repositório e os padrões de unidade de trabalho com o Entity Framework 4,0](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) no blog da equipe do Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-133">[Using Repository and Unit of Work patterns with Entity Framework 4.0](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) on the Entity Framework team blog.</span></span>
- <span data-ttu-id="5b1f9-134">A série de postagens do [Agile Entity Framework 4 do repositório](http://thedatafarm.com/blog/data-access/agile-entity-framework-4-repository-part-1-model-and-poco-classes/) no blog de Julie Lerman.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-134">[Agile Entity Framework 4 Repository](http://thedatafarm.com/blog/data-access/agile-entity-framework-4-repository-part-1-model-and-poco-classes/) series of posts on Julie Lerman's blog.</span></span>
- <span data-ttu-id="5b1f9-135">[Criando a conta em um aplicativo HTML5/jQuery resumido](https://weblogs.asp.net/dwahlin/archive/2011/08/15/building-the-account-at-a-glance-html5-jquery-application.aspx) no blog de Dan Wahlin.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-135">[Building the Account at a Glance HTML5/jQuery Application](https://weblogs.asp.net/dwahlin/archive/2011/08/15/building-the-account-at-a-glance-html5-jquery-application.aspx) on Dan Wahlin's blog.</span></span>

> [!NOTE]
> <span data-ttu-id="5b1f9-136">Há várias maneiras de implementar o repositório e os padrões de unidade de trabalho.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-136">There are many ways to implement the repository and unit of work patterns.</span></span> <span data-ttu-id="5b1f9-137">Você pode usar classes de repositório com ou sem uma classe de unidade de trabalho.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-137">You can use repository classes with or without a unit of work class.</span></span> <span data-ttu-id="5b1f9-138">Você pode implementar um único repositório para todos os tipos de entidade ou um para cada tipo.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-138">You can implement a single repository for all entity types, or one for each type.</span></span> <span data-ttu-id="5b1f9-139">Se você implementar um para cada tipo, poderá usar classes separadas, uma classe base genérica e classes derivadas, ou uma classe base abstrata e classes derivadas.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-139">If you implement one for each type, you can use separate classes, a generic base class and derived classes, or an abstract base class and derived classes.</span></span> <span data-ttu-id="5b1f9-140">Você pode incluir lógica de negócios em seu repositório ou restringi-la à lógica de acesso a dados.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-140">You can include business logic in your repository or restrict it to data access logic.</span></span> <span data-ttu-id="5b1f9-141">Você também pode criar uma camada de abstração na sua classe de contexto de banco de dados usando interfaces [IDbSet](https://msdn.microsoft.com/library/gg679233(v=vs.103).aspx) em vez de tipos [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) para seus conjuntos de entidades.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-141">You can also build an abstraction layer into your database context class by using [IDbSet](https://msdn.microsoft.com/library/gg679233(v=vs.103).aspx) interfaces there instead of [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) types for your entity sets.</span></span> <span data-ttu-id="5b1f9-142">A abordagem para implementar uma camada de abstração mostrada neste tutorial é uma opção a ser considerada, não uma recomendação para todos os cenários e ambientes.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-142">The approach to implementing an abstraction layer shown in this tutorial is one option for you to consider, not a recommendation for all scenarios and environments.</span></span>

## <a name="creating-the-student-repository-class"></a><span data-ttu-id="5b1f9-143">Criando a classe de repositório Student</span><span class="sxs-lookup"><span data-stu-id="5b1f9-143">Creating the Student Repository Class</span></span>

<span data-ttu-id="5b1f9-144">Na pasta *Dal* , crie um arquivo de classe chamado *IStudentRepository.cs* e substitua o código existente pelo código a seguir:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-144">In the *DAL* folder, create a class file named *IStudentRepository.cs* and replace the existing code with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample1.cs)]

<span data-ttu-id="5b1f9-145">Esse código declara um conjunto típico de métodos CRUD, incluindo dois métodos de leitura — um que retorna todas as entidades de `Student` e outro que localiza uma única entidade de `Student` por ID.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-145">This code declares a typical set of CRUD methods, including two read methods — one that returns all `Student` entities, and one that finds a single `Student` entity by ID.</span></span>

<span data-ttu-id="5b1f9-146">Na pasta *Dal* , crie um arquivo de classe chamado *StudentRepository.cs* File.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-146">In the *DAL* folder, create a class file named *StudentRepository.cs* file.</span></span> <span data-ttu-id="5b1f9-147">Substitua o código existente pelo código a seguir, que implementa a interface `IStudentRepository`:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-147">Replace the existing code with the following code, which implements the `IStudentRepository` interface:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample2.cs)]

<span data-ttu-id="5b1f9-148">O contexto do banco de dados é definido em uma variável de classe e o construtor espera que o objeto de chamada passe em uma instância do contexto:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-148">The database context is defined in a class variable, and the constructor expects the calling object to pass in an instance of the context:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample3.cs)]

<span data-ttu-id="5b1f9-149">Você pode criar uma instância de um novo contexto no repositório, mas, se você tiver usado vários repositórios em um controlador, cada um acabaria com um contexto separado.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-149">You could instantiate a new context in the repository, but then if you used multiple repositories in one controller, each would end up with a separate context.</span></span> <span data-ttu-id="5b1f9-150">Posteriormente, você usará vários repositórios no controlador de `Course` e verá como uma classe de unidade de trabalho pode garantir que todos os repositórios usem o mesmo contexto.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-150">Later you'll use multiple repositories in the `Course` controller, and you'll see how a unit of work class can ensure that all repositories use the same context.</span></span>

<span data-ttu-id="5b1f9-151">O repositório implementa [IDisposable](https://msdn.microsoft.com/library/system.idisposable.aspx) e descarta o contexto do banco de dados como vimos anteriormente no controlador, e seus métodos CRUD fazem chamadas ao contexto do banco de dados da mesma maneira que vimos anteriormente.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-151">The repository implements [IDisposable](https://msdn.microsoft.com/library/system.idisposable.aspx) and disposes the database context as you saw earlier in the controller, and its CRUD methods make calls to the database context in the same way that you saw earlier.</span></span>

## <a name="change-the-student-controller-to-use-the-repository"></a><span data-ttu-id="5b1f9-152">Alterar o controlador do aluno para usar o repositório</span><span class="sxs-lookup"><span data-stu-id="5b1f9-152">Change the Student Controller to Use the Repository</span></span>

<span data-ttu-id="5b1f9-153">No *StudentController.cs*, substitua o código atualmente na classe pelo código a seguir.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-153">In *StudentController.cs*, replace the code currently in the class with the following code.</span></span> <span data-ttu-id="5b1f9-154">As alterações são realçadas.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-154">The changes are highlighted.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample4.cs?highlight=13-18,44,75,77,102-103,120,137-138,159,172-174,186)]

<span data-ttu-id="5b1f9-155">O controlador agora declara uma variável de classe para um objeto que implementa a interface `IStudentRepository` em vez da classe de contexto:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-155">The controller now declares a class variable for an object that implements the `IStudentRepository` interface instead of the context class:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample5.cs)]

<span data-ttu-id="5b1f9-156">O construtor padrão (sem parâmetros) cria uma nova instância de contexto e um Construtor opcional permite que o chamador transmita uma instância de contexto.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-156">The default (parameterless) constructor creates a new context instance, and an optional constructor allows the caller to pass in a context instance.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample6.cs)]

<span data-ttu-id="5b1f9-157">(Se você estivesse usando *injeção de dependência*, ou di, não precisaria do construtor padrão porque o software di garantiria que o objeto de repositório correto sempre seria fornecido.)</span><span class="sxs-lookup"><span data-stu-id="5b1f9-157">(If you were using *dependency injection*, or DI, you wouldn't need the default constructor because the DI software would ensure that the correct repository object would always be provided.)</span></span>

<span data-ttu-id="5b1f9-158">Nos métodos CRUD, o repositório agora é chamado em vez do contexto:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-158">In the CRUD methods, the repository is now called instead of the context:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample7.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample8.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample9.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample10.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample11.cs)]

<span data-ttu-id="5b1f9-159">E o método `Dispose` agora descarta o repositório em vez do contexto:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-159">And the `Dispose` method now disposes the repository instead of the context:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample12.cs)]

<span data-ttu-id="5b1f9-160">Execute o site e clique na guia **alunos** .</span><span class="sxs-lookup"><span data-stu-id="5b1f9-160">Run the site and click the **Students** tab.</span></span>

![Students_Index_page](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image1.png)

<span data-ttu-id="5b1f9-162">A página parece e funciona da mesma maneira que antes você alterou o código para usar o repositório, e as outras páginas de aluno também funcionam da mesma forma.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-162">The page looks and works the same as it did before you changed the code to use the repository, and the other Student pages also work the same.</span></span> <span data-ttu-id="5b1f9-163">No entanto, há uma diferença importante na maneira como o método `Index` do controlador faz a filtragem e a ordenação.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-163">However, there's an important difference in the way the `Index` method of the controller does filtering and ordering.</span></span> <span data-ttu-id="5b1f9-164">A versão original desse método continha o seguinte código:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-164">The original version of this method contained the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample13.cs?highlight=1)]

<span data-ttu-id="5b1f9-165">O método `Index` atualizado contém o seguinte código:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-165">The updated `Index` method contains the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample14.cs?highlight=1)]

<span data-ttu-id="5b1f9-166">Somente o código realçado foi alterado.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-166">Only the highlighted code has changed.</span></span>

<span data-ttu-id="5b1f9-167">Na versão original do código, `students` é tipada como um objeto `IQueryable`.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-167">In the original version of the code, `students` is typed as an `IQueryable` object.</span></span> <span data-ttu-id="5b1f9-168">A consulta não é enviada ao banco de dados até ser convertida em uma coleção usando um método como `ToList`, o que não ocorrerá até que a exibição de índice acesse o modelo de aluno.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-168">The query isn't sent to the database until it's converted into a collection using a method such as `ToList`, which doesn't occur until the Index view accesses the student model.</span></span> <span data-ttu-id="5b1f9-169">O método `Where` no código original acima se torna uma cláusula `WHERE` na consulta SQL que é enviada ao banco de dados.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-169">The `Where` method in the original code above becomes a `WHERE` clause in the SQL query that is sent to the database.</span></span> <span data-ttu-id="5b1f9-170">Isso, por sua vez, significa que apenas as entidades selecionadas são retornadas pelo banco de dados.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-170">That in turn means that only the selected entities are returned by the database.</span></span> <span data-ttu-id="5b1f9-171">No entanto, como resultado da alteração de `context.Students` para `studentRepository.GetStudents()`, a variável `students` após essa instrução é uma coleção de `IEnumerable` que inclui todos os alunos do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-171">However, as a result of changing `context.Students` to `studentRepository.GetStudents()`, the `students` variable after this statement is an `IEnumerable` collection that includes all students in the database.</span></span> <span data-ttu-id="5b1f9-172">O resultado final da aplicação do método de `Where` é o mesmo, mas agora o trabalho é feito na memória no servidor Web e não no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-172">The end result of applying the `Where` method is the same, but now the work is done in memory on the web server and not by the database.</span></span> <span data-ttu-id="5b1f9-173">Para consultas que retornam grandes volumes de dados, isso pode ser ineficiente.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-173">For queries that return large volumes of data, this can be inefficient.</span></span>

> [!TIP]
> 
> <span data-ttu-id="5b1f9-174">**IQueryable versus IEnumerable**</span><span class="sxs-lookup"><span data-stu-id="5b1f9-174">**IQueryable vs. IEnumerable**</span></span>
> 
> <span data-ttu-id="5b1f9-175">Depois de implementar o repositório, conforme mostrado aqui, mesmo se você inserir algo na caixa de **pesquisa** , a consulta enviada para SQL Server retornará todas as linhas de aluno porque não inclui seus critérios de pesquisa:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-175">After you implement the repository as shown here, even if you enter something in the **Search** box the query sent to SQL Server returns all Student rows because it doesn't include your search criteria:</span></span>
> 
> ![](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image2.png)
> 
> [!code-sql[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample15.sql)]
> 
> <span data-ttu-id="5b1f9-176">Essa consulta retorna todos os dados do aluno porque o repositório executou a consulta sem saber mais sobre os critérios de pesquisa.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-176">This query returns all of the student data because the repository executed the query without knowing about the search criteria.</span></span> <span data-ttu-id="5b1f9-177">O processo de classificação, aplicação de critérios de pesquisa e seleção de um subconjunto dos dados para paginação (mostrando apenas três linhas nesse caso) é feito na memória mais tarde quando o método de `ToPagedList` é chamado na coleção de `IEnumerable`.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-177">The process of sorting, applying search criteria, and selecting a subset of the data for paging (showing only 3 rows in this case) is done in memory later when the `ToPagedList` method is called on the `IEnumerable` collection.</span></span>
> 
> <span data-ttu-id="5b1f9-178">Na versão anterior do código (antes de você implementar o repositório), a consulta não será enviada ao banco de dados até que você aplique os critérios de pesquisa quando `ToPagedList` for chamado no objeto `IQueryable`.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-178">In the previous version of the code (before you implemented the repository), the query is not sent to the database until after you apply the search criteria, when `ToPagedList` is called on the `IQueryable` object.</span></span>
> 
> ![](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image3.png)
> 
> <span data-ttu-id="5b1f9-179">Quando ToPagedList é chamado em um objeto `IQueryable`, a consulta enviada para SQL Server especifica a cadeia de caracteres de pesquisa e, como resultado, somente as linhas que atendem aos critérios de pesquisa são retornadas e nenhuma filtragem precisa ser feita na memória.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-179">When ToPagedList is called on an `IQueryable` object, the query sent to SQL Server specifies the search string, and as a result only rows that meet the search criteria are returned, and no filtering needs to be done in memory.</span></span>
> 
> [!code-sql[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample16.sql)]
> 
> <span data-ttu-id="5b1f9-180">(O tutorial a seguir explica como examinar as consultas enviadas para SQL Server.)</span><span class="sxs-lookup"><span data-stu-id="5b1f9-180">(The following tutorial explains how to examine queries sent to SQL Server.)</span></span>

<span data-ttu-id="5b1f9-181">A seção a seguir mostra como implementar métodos de repositório que permitem especificar que esse trabalho deve ser feito pelo banco de dados.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-181">The following section shows how to implement repository methods that enable you to specify that this work should be done by the database.</span></span>

<span data-ttu-id="5b1f9-182">Agora você criou uma camada de abstração entre o controlador e o contexto do banco de dados Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-182">You've now created an abstraction layer between the controller and the Entity Framework database context.</span></span> <span data-ttu-id="5b1f9-183">Se você for executar testes de unidade automatizados com esse aplicativo, poderá criar uma classe de repositório alternativa em um projeto de teste de unidade que implementa `IStudentRepository` *.*</span><span class="sxs-lookup"><span data-stu-id="5b1f9-183">If you were going to perform automated unit testing with this application, you could create an alternative repository class in a unit test project that implements `IStudentRepository`*.*</span></span> <span data-ttu-id="5b1f9-184">Em vez de chamar o contexto para ler e gravar dados, essa classe de repositório fictício poderia manipular as coleções na memória para testar as funções do controlador.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-184">Instead of calling the context to read and write data, this mock repository class could manipulate in-memory collections in order to test controller functions.</span></span>

## <a name="implement-a-generic-repository-and-a-unit-of-work-class"></a><span data-ttu-id="5b1f9-185">Implementar um repositório genérico e uma unidade de classe de trabalho</span><span class="sxs-lookup"><span data-stu-id="5b1f9-185">Implement a Generic Repository and a Unit of Work Class</span></span>

<span data-ttu-id="5b1f9-186">A criação de uma classe de repositório para cada tipo de entidade pode resultar em muitos códigos redundantes e pode resultar em atualizações parciais.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-186">Creating a repository class for each entity type could result in a lot of redundant code, and it could result in partial updates.</span></span> <span data-ttu-id="5b1f9-187">Por exemplo, suponha que você tenha que atualizar dois tipos de entidade diferentes como parte da mesma transação.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-187">For example, suppose you have to update two different entity types as part of the same transaction.</span></span> <span data-ttu-id="5b1f9-188">Se cada uma delas usar uma instância de contexto de banco de dados separada, uma delas poderá ser bem-sucedida e a outra poderá falhar.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-188">If each uses a separate database context instance, one might succeed and the other might fail.</span></span> <span data-ttu-id="5b1f9-189">Uma maneira de minimizar o código redundante é usar um repositório genérico e uma maneira de garantir que todos os repositórios usem o mesmo contexto de banco de dados (e, portanto, coordenar todas as atualizações) é usar uma classe de unidade de trabalho.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-189">One way to minimize redundant code is to use a generic repository, and one way to ensure that all repositories use the same database context (and thus coordinate all updates) is to use a unit of work class.</span></span>

<span data-ttu-id="5b1f9-190">Nesta seção do tutorial, você criará uma classe de `GenericRepository` e uma classe de `UnitOfWork` e as usará no controlador de `Course` para acessar os conjuntos de entidades `Department` e `Course`.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-190">In this section of the tutorial, you'll create a `GenericRepository` class and a `UnitOfWork` class, and use them in the `Course` controller to access both the `Department` and the `Course` entity sets.</span></span> <span data-ttu-id="5b1f9-191">Conforme explicado anteriormente, para manter essa parte do tutorial simples, você não está criando interfaces para essas classes.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-191">As explained earlier, to keep this part of the tutorial simple, you aren't creating interfaces for these classes.</span></span> <span data-ttu-id="5b1f9-192">Mas se você pretende usá-los para facilitar o TDD, normalmente os implementaria com interfaces da mesma maneira que fez no repositório de `Student`.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-192">But if you were going to use them to facilitate TDD, you'd typically implement them with interfaces the same way you did the `Student` repository.</span></span>

### <a name="create-a-generic-repository"></a><span data-ttu-id="5b1f9-193">Criar um repositório genérico</span><span class="sxs-lookup"><span data-stu-id="5b1f9-193">Create a Generic Repository</span></span>

<span data-ttu-id="5b1f9-194">Na pasta *Dal* , crie *GenericRepository.cs* e substitua o código existente pelo código a seguir:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-194">In the *DAL* folder, create *GenericRepository.cs* and replace the existing code with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample17.cs)]

<span data-ttu-id="5b1f9-195">As variáveis de classe são declaradas para o contexto do banco de dados e para o conjunto de entidades para o qual o repositório é instanciado:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-195">Class variables are declared for the database context and for the entity set that the repository is instantiated for:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample18.cs)]

<span data-ttu-id="5b1f9-196">O construtor aceita uma instância de contexto de banco de dados e inicializa a variável de conjunto de entidades:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-196">The constructor accepts a database context instance and initializes the entity set variable:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample19.cs)]

<span data-ttu-id="5b1f9-197">O método `Get` usa expressões lambda para permitir que o código de chamada especifique uma condição de filtro e uma coluna para ordenar os resultados por, e um parâmetro de cadeia de caracteres permite que o chamador forneça uma lista delimitada por vírgulas de propriedades de navegação para carregamento adiantado:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-197">The `Get` method uses lambda expressions to allow the calling code to specify a filter condition and a column to order the results by, and a string parameter lets the caller provide a comma-delimited list of navigation properties for eager loading:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample20.cs)]

<span data-ttu-id="5b1f9-198">O `Expression<Func<TEntity, bool>> filter` de código significa que o chamador fornecerá uma expressão lambda com base no tipo de `TEntity`, e essa expressão retornará um valor booliano.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-198">The code `Expression<Func<TEntity, bool>> filter` means the caller will provide a lambda expression based on the `TEntity` type, and this expression will return a Boolean value.</span></span> <span data-ttu-id="5b1f9-199">Por exemplo, se o repositório for instanciado para o tipo de entidade `Student`, o código no método de chamada poderá especificar `student => student.LastName == "Smith`&quot; para o parâmetro `filter`.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-199">For example, if the repository is instantiated for the `Student` entity type, the code in the calling method might specify `student => student.LastName == "Smith`&quot; for the `filter` parameter.</span></span>

<span data-ttu-id="5b1f9-200">O código `Func<IQueryable<TEntity>, IOrderedQueryable<TEntity>> orderBy` também significa que o chamador fornecerá uma expressão lambda.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-200">The code `Func<IQueryable<TEntity>, IOrderedQueryable<TEntity>> orderBy` also means the caller will provide a lambda expression.</span></span> <span data-ttu-id="5b1f9-201">Mas, nesse caso, a entrada para a expressão é um objeto `IQueryable` para o tipo `TEntity`.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-201">But in this case, the input to the expression is an `IQueryable` object for the `TEntity` type.</span></span> <span data-ttu-id="5b1f9-202">A expressão retornará uma versão ordenada do objeto `IQueryable`.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-202">The expression will return an ordered version of that `IQueryable` object.</span></span> <span data-ttu-id="5b1f9-203">Por exemplo, se o repositório for instanciado para o tipo de entidade `Student`, o código no método de chamada poderá especificar `q => q.OrderBy(s => s.LastName)` para o parâmetro `orderBy`.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-203">For example, if the repository is instantiated for the `Student` entity type, the code in the calling method might specify `q => q.OrderBy(s => s.LastName)` for the `orderBy` parameter.</span></span>

<span data-ttu-id="5b1f9-204">O código no método `Get` cria um objeto `IQueryable` e, em seguida, aplica a expressão de filtro se houver um:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-204">The code in the `Get` method creates an `IQueryable` object and then applies the filter expression if there is one:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample21.cs)]

<span data-ttu-id="5b1f9-205">Em seguida, ele aplica as expressões de carregamento adiantado após a análise da lista delimitada por vírgulas:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-205">Next it applies the eager-loading expressions after parsing the comma-delimited list:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample22.cs)]

<span data-ttu-id="5b1f9-206">Por fim, ele aplica a expressão `orderBy` se houver um e retorna os resultados; caso contrário, ele retorna os resultados da consulta não ordenada:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-206">Finally, it applies the `orderBy` expression if there is one and returns the results; otherwise it returns the results from the unordered query:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample23.cs)]

<span data-ttu-id="5b1f9-207">Ao chamar o método `Get`, você pode filtrar e classificar na coleção de `IEnumerable` retornada pelo método, em vez de fornecer parâmetros para essas funções.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-207">When you call the `Get` method, you could do filtering and sorting on the `IEnumerable` collection returned by the method instead of providing parameters for these functions.</span></span> <span data-ttu-id="5b1f9-208">Mas o trabalho de classificação e filtragem seria feito na memória no servidor Web.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-208">But the sorting and filtering work would then be done in memory on the web server.</span></span> <span data-ttu-id="5b1f9-209">Usando esses parâmetros, você garante que o trabalho seja feito pelo banco de dados em vez do servidor Web.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-209">By using these parameters, you ensure that the work is done by the database rather than the web server.</span></span> <span data-ttu-id="5b1f9-210">Uma alternativa é criar classes derivadas para tipos de entidade específicos e adicionar métodos de `Get` especializados, como `GetStudentsInNameOrder` ou `GetStudentsByName`.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-210">An alternative is to create derived classes for specific entity types and add specialized `Get` methods, such as `GetStudentsInNameOrder` or `GetStudentsByName`.</span></span> <span data-ttu-id="5b1f9-211">No entanto, em um aplicativo complexo, isso pode resultar em um grande número de classes derivadas e de métodos especializados, o que pode ser mais trabalho a ser mantido.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-211">However, in a complex application, this can result in a large number of such derived classes and specialized methods, which could be more work to maintain.</span></span>

<span data-ttu-id="5b1f9-212">O código nos métodos `GetByID`, `Insert`e `Update` é semelhante ao que você viu no repositório não genérico.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-212">The code in the `GetByID`, `Insert`, and `Update` methods is similar to what you saw in the non-generic repository.</span></span> <span data-ttu-id="5b1f9-213">(Você não está fornecendo um parâmetro de carregamento adiantado na assinatura `GetByID`, porque não pode fazer o carregamento adiantado com o método `Find`.)</span><span class="sxs-lookup"><span data-stu-id="5b1f9-213">(You aren't providing an eager loading parameter in the `GetByID` signature, because you can't do eager loading with the `Find` method.)</span></span>

<span data-ttu-id="5b1f9-214">Duas sobrecargas são fornecidas para o método de `Delete`:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-214">Two overloads are provided for the `Delete` method:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample24.cs)]

<span data-ttu-id="5b1f9-215">Um deles permite que você passe apenas a ID da entidade a ser excluída e uma instância de entidade.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-215">One of these lets you pass in just the ID of the entity to be deleted, and one takes an entity instance.</span></span> <span data-ttu-id="5b1f9-216">Como vimos no tutorial sobre a [simultaneidade de manipulação](../../getting-started/getting-started-with-ef-using-mvc/handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md) , para manipulação de simultaneidade, você precisa de um `Delete` método que usa uma instância de entidade que inclui o valor original de uma propriedade de rastreamento.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-216">As you saw in the [Handling Concurrency](../../getting-started/getting-started-with-ef-using-mvc/handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md) tutorial, for concurrency handling you need a `Delete` method that takes an entity instance that includes the original value of a tracking property.</span></span>

<span data-ttu-id="5b1f9-217">Esse repositório genérico tratará os requisitos CRUD típicos.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-217">This generic repository will handle typical CRUD requirements.</span></span> <span data-ttu-id="5b1f9-218">Quando um determinado tipo de entidade tem requisitos especiais, como filtragem ou ordenação mais complexa, você pode criar uma classe derivada que tenha métodos adicionais para esse tipo.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-218">When a particular entity type has special requirements, such as more complex filtering or ordering, you can create a derived class that has additional methods for that type.</span></span>

## <a name="creating-the-unit-of-work-class"></a><span data-ttu-id="5b1f9-219">Criando a classe de unidade de trabalho</span><span class="sxs-lookup"><span data-stu-id="5b1f9-219">Creating the Unit of Work Class</span></span>

<span data-ttu-id="5b1f9-220">A classe da unidade de trabalho atende a uma finalidade: para garantir que, quando você usar vários repositórios, eles compartilhem um único contexto de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-220">The unit of work class serves one purpose: to make sure that when you use multiple repositories, they share a single database context.</span></span> <span data-ttu-id="5b1f9-221">Dessa forma, quando uma unidade de trabalho for concluída, você poderá chamar o método `SaveChanges` nessa instância do contexto e ter certeza de que todas as alterações relacionadas serão coordenadas.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-221">That way, when a unit of work is complete you can call the `SaveChanges` method on that instance of the context and be assured that all related changes will be coordinated.</span></span> <span data-ttu-id="5b1f9-222">Tudo o que a classe precisa é um método `Save` e uma propriedade para cada repositório.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-222">All that the class needs is a `Save` method and a property for each repository.</span></span> <span data-ttu-id="5b1f9-223">Cada propriedade Repository retorna uma instância de repositório que foi instanciada usando a mesma instância de contexto de banco de dados que as outras instâncias de repositório.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-223">Each repository property returns a repository instance that has been instantiated using the same database context instance as the other repository instances.</span></span>

<span data-ttu-id="5b1f9-224">Na pasta *Dal* , crie um arquivo de classe chamado *UnitOfWork.cs* e substitua o código do modelo pelo código a seguir:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-224">In the *DAL* folder, create a class file named *UnitOfWork.cs* and replace the template code with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample25.cs)]

<span data-ttu-id="5b1f9-225">O código cria variáveis de classe para o contexto do banco de dados e para cada repositório.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-225">The code creates class variables for the database context and each repository.</span></span> <span data-ttu-id="5b1f9-226">Para a variável `context`, um novo contexto é instanciado:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-226">For the `context` variable, a new context is instantiated:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample26.cs)]

<span data-ttu-id="5b1f9-227">Cada propriedade de repositório verifica se o repositório já existe.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-227">Each repository property checks whether the repository already exists.</span></span> <span data-ttu-id="5b1f9-228">Caso contrário, ele instancia o repositório, passando a instância de contexto.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-228">If not, it instantiates the repository, passing in the context instance.</span></span> <span data-ttu-id="5b1f9-229">Como resultado, todos os repositórios compartilham a mesma instância de contexto.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-229">As a result, all repositories share the same context instance.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample27.cs)]

<span data-ttu-id="5b1f9-230">O método `Save` chama `SaveChanges` no contexto do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-230">The `Save` method calls `SaveChanges` on the database context.</span></span>

<span data-ttu-id="5b1f9-231">Como qualquer classe que instancia um contexto de banco de dados em uma variável de classe, a classe `UnitOfWork` implementa `IDisposable` e descarta o contexto.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-231">Like any class that instantiates a database context in a class variable, the `UnitOfWork` class implements `IDisposable` and disposes the context.</span></span>

### <a name="changing-the-course-controller-to-use-the-unitofwork-class-and-repositories"></a><span data-ttu-id="5b1f9-232">Alterando o controlador do curso para usar a classe e os repositórios UnitOfWork</span><span class="sxs-lookup"><span data-stu-id="5b1f9-232">Changing the Course Controller to use the UnitOfWork Class and Repositories</span></span>

<span data-ttu-id="5b1f9-233">Substitua o código que você tem atualmente em *CourseController.cs* com o seguinte código:</span><span class="sxs-lookup"><span data-stu-id="5b1f9-233">Replace the code you currently have in *CourseController.cs* with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample28.cs?highlight=15,20,22,31,54-55,70,85-86,101-102,122-124,130)]

<span data-ttu-id="5b1f9-234">Esse código adiciona uma variável de classe para a classe `UnitOfWork`.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-234">This code adds a class variable for the `UnitOfWork` class.</span></span> <span data-ttu-id="5b1f9-235">(Se você estivesse usando interfaces aqui, não inicializaria a variável aqui; em vez disso, você implementaria um padrão de dois construtores da mesma forma que fazia para o repositório de `Student`.)</span><span class="sxs-lookup"><span data-stu-id="5b1f9-235">(If you were using interfaces here, you wouldn't initialize the variable here; instead, you'd implement a pattern of two constructors just as you did for the `Student` repository.)</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample29.cs)]

<span data-ttu-id="5b1f9-236">No restante da classe, todas as referências ao contexto do banco de dados são substituídas por referências ao repositório apropriado, usando `UnitOfWork` Propriedades para acessar o repositório.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-236">In the rest of the class, all references to the database context are replaced by references to the appropriate repository, using `UnitOfWork` properties to access the repository.</span></span> <span data-ttu-id="5b1f9-237">O método `Dispose` descarta a instância de `UnitOfWork`.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-237">The `Dispose` method disposes the `UnitOfWork` instance.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample30.cs)]

<span data-ttu-id="5b1f9-238">Execute o site e clique na guia **cursos** .</span><span class="sxs-lookup"><span data-stu-id="5b1f9-238">Run the site and click the **Courses** tab.</span></span>

![Courses_Index_page](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image4.png)

<span data-ttu-id="5b1f9-240">A página parece e funciona da mesma maneira que antes das alterações, e as outras páginas do curso também funcionam da mesma forma.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-240">The page looks and works the same as it did before your changes, and the other Course pages also work the same.</span></span>

## <a name="summary"></a><span data-ttu-id="5b1f9-241">Resumo</span><span class="sxs-lookup"><span data-stu-id="5b1f9-241">Summary</span></span>

<span data-ttu-id="5b1f9-242">Agora você implementou o repositório e os padrões de unidade de trabalho.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-242">You have now implemented both the repository and unit of work patterns.</span></span> <span data-ttu-id="5b1f9-243">Você usou expressões lambda como parâmetros de método no repositório genérico.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-243">You have used lambda expressions as method parameters in the generic repository.</span></span> <span data-ttu-id="5b1f9-244">Para obter mais informações sobre como usar essas expressões com um objeto `IQueryable`, consulte [interface IQueryable (t) (System. Linq)](https://msdn.microsoft.com/library/bb351562.aspx) na biblioteca MSDN.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-244">For more information about how to use these expressions with an `IQueryable` object, see [IQueryable(T) Interface (System.Linq)](https://msdn.microsoft.com/library/bb351562.aspx) in the MSDN Library.</span></span> <span data-ttu-id="5b1f9-245">No próximo tutorial, você aprenderá a lidar com alguns cenários avançados.</span><span class="sxs-lookup"><span data-stu-id="5b1f9-245">In the next tutorial you'll learn how to handle some advanced scenarios.</span></span>

<span data-ttu-id="5b1f9-246">Links para outros recursos de Entity Framework podem ser encontrados no [mapa de conteúdo de acesso a dados do ASP.net](../../../../whitepapers/aspnet-data-access-content-map.md).</span><span class="sxs-lookup"><span data-stu-id="5b1f9-246">Links to other Entity Framework resources can be found in the [ASP.NET Data Access Content Map](../../../../whitepapers/aspnet-data-access-content-map.md).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="5b1f9-247">[Anterior](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application.md)
> [Próximo](advanced-entity-framework-scenarios-for-an-mvc-web-application.md)</span><span class="sxs-lookup"><span data-stu-id="5b1f9-247">[Previous](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application.md)
[Next](advanced-entity-framework-scenarios-for-an-mvc-web-application.md)</span></span>
