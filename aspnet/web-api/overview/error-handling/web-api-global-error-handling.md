---
uid: web-api/overview/error-handling/web-api-global-error-handling
title: Manipulação global de erros na API 2 da Web ASP.NET - ASP.NET 4.x
author: davidmatson
description: Uma visão geral do tratamento global de erros na API 2 ASP.NET web para ASP.NET 4.x.
ms.author: riande
ms.date: 02/03/2014
ms.custom: seoapril2019
ms.assetid: bffd7863-f63b-4b23-a13c-372b5492e9fb
msc.legacyurl: /web-api/overview/error-handling/web-api-global-error-handling
msc.type: authoredcontent
ms.openlocfilehash: 5ff54d2e4ed881ce927d0a401fb79d9b8bc5b8a1
ms.sourcegitcommit: ce28244209db8615bc9bdd576a2e2c88174d318d
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/06/2020
ms.locfileid: "80675422"
---
# <a name="global-error-handling-in-aspnet-web-api-2"></a><span data-ttu-id="3c56f-103">Manipulação global de erros na API 2 da Web ASP.NET</span><span class="sxs-lookup"><span data-stu-id="3c56f-103">Global Error Handling in ASP.NET Web API 2</span></span>

<span data-ttu-id="3c56f-104">por [David Matson](https://github.com/davidmatson), [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="3c56f-104">by [David Matson](https://github.com/davidmatson), [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="3c56f-105">Este tópico fornece uma visão geral do tratamento global de erros em ASP.NET API 2 da Web para ASP.NET 4.x.</span><span class="sxs-lookup"><span data-stu-id="3c56f-105">This topic provides an overview of global error handling in ASP.NET Web API 2 for ASP.NET 4.x.</span></span> <span data-ttu-id="3c56f-106">Hoje não há uma maneira fácil na API da Web de registrar ou lidar com erros globalmente.</span><span class="sxs-lookup"><span data-stu-id="3c56f-106">Today there's no easy way in Web API to log or handle errors globally.</span></span> <span data-ttu-id="3c56f-107">Algumas exceções não tratadas podem ser processadas através de filtros de [exceção,](exception-handling.md)mas há vários casos em que filtros de exceção não conseguem lidar.</span><span class="sxs-lookup"><span data-stu-id="3c56f-107">Some unhandled exceptions can be processed via [exception filters](exception-handling.md), but there are a number of cases that exception filters can't handle.</span></span> <span data-ttu-id="3c56f-108">Por exemplo:</span><span class="sxs-lookup"><span data-stu-id="3c56f-108">For example:</span></span>

1. <span data-ttu-id="3c56f-109">Exceções geradas por construtores de controlador.</span><span class="sxs-lookup"><span data-stu-id="3c56f-109">Exceptions thrown from controller constructors.</span></span>
2. <span data-ttu-id="3c56f-110">Exceções geradas por manipuladores de mensagens.</span><span class="sxs-lookup"><span data-stu-id="3c56f-110">Exceptions thrown from message handlers.</span></span>
3. <span data-ttu-id="3c56f-111">Exceções geradas durante o roteamento.</span><span class="sxs-lookup"><span data-stu-id="3c56f-111">Exceptions thrown during routing.</span></span>
4. <span data-ttu-id="3c56f-112">Exceções geradas durante a serialização de conteúdo da resposta.</span><span class="sxs-lookup"><span data-stu-id="3c56f-112">Exceptions thrown during response content serialization.</span></span>

<span data-ttu-id="3c56f-113">Queremos fornecer uma maneira simples e consistente de registrar e lidar (sempre que possível) essas exceções.</span><span class="sxs-lookup"><span data-stu-id="3c56f-113">We want to provide a simple, consistent way to log and handle (where possible) these exceptions.</span></span> 

<span data-ttu-id="3c56f-114">Existem dois casos importantes para lidar com exceções, o caso em que somos capazes de enviar uma resposta de erro e o caso em que tudo o que podemos fazer é registrar a exceção.</span><span class="sxs-lookup"><span data-stu-id="3c56f-114">There are two major cases for handling exceptions, the case where we are able to send an error response and the case where all we can do is log the exception.</span></span> <span data-ttu-id="3c56f-115">Um exemplo para este último caso é quando uma exceção é lançada no meio do conteúdo de resposta ao streaming; nesse caso, é tarde demais para enviar uma nova mensagem de resposta, uma vez que o código de status, cabeçalhos e conteúdo parcial já passaram pelo fio, então simplesmente abortamos a conexão.</span><span class="sxs-lookup"><span data-stu-id="3c56f-115">An example for the latter case is when an exception is thrown in the middle of streaming response content; in that case it is too late to send a new response message since the status code, headers, and partial content have already gone across the wire, so we simply abort the connection.</span></span> <span data-ttu-id="3c56f-116">Mesmo que a exceção não possa ser tratada para produzir uma nova mensagem de resposta, ainda apoiamos o registro da exceção.</span><span class="sxs-lookup"><span data-stu-id="3c56f-116">Even though the exception can't be handled to produce a new response message, we still support logging the exception.</span></span> <span data-ttu-id="3c56f-117">Nos casos em que podemos detectar um erro, podemos retornar uma resposta de erro apropriada, conforme mostrado no seguinte:</span><span class="sxs-lookup"><span data-stu-id="3c56f-117">In cases where we can detect an error, we can return an appropriate error response as shown in the following:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample1.cs?highlight=6)]

### <a name="existing-options"></a><span data-ttu-id="3c56f-118">Opções existentes</span><span class="sxs-lookup"><span data-stu-id="3c56f-118">Existing Options</span></span>

<span data-ttu-id="3c56f-119">Além dos filtros de [exceção,](exception-handling.md) [os manipuladores de mensagens](../advanced/http-message-handlers.md) podem ser usados hoje para observar todas as respostas de 500 níveis, mas agir sobre essas respostas é difícil, pois eles não têm contexto sobre o erro original.</span><span class="sxs-lookup"><span data-stu-id="3c56f-119">In addition to [exception filters](exception-handling.md), [message handlers](../advanced/http-message-handlers.md) can be used today to observe all 500-level responses, but acting on those responses is difficult, as they lack context about the original error.</span></span> <span data-ttu-id="3c56f-120">Os manipuladores de mensagens também têm algumas das mesmas limitações que filtros de exceção em relação aos casos que podem lidar.</span><span class="sxs-lookup"><span data-stu-id="3c56f-120">Message handlers also have some of the same limitations as exception filters regarding the cases they can handle.</span></span> <span data-ttu-id="3c56f-121">Embora a API da Web tenha infra-estrutura de rastreamento que captura condições de erro, a infra-estrutura de rastreamento é para fins diagnósticos e não é projetada ou adequada para funcionar em ambientes de produção.</span><span class="sxs-lookup"><span data-stu-id="3c56f-121">While Web API does have tracing infrastructure that captures error conditions the tracing infrastructure is for diagnostics purposes and is not designed or suited for running in production environments.</span></span> <span data-ttu-id="3c56f-122">O tratamento e o registro de exceções globais devem ser serviços que podem ser executados durante a produção e conectados às soluções de monitoramento existentes (por exemplo, [ELMAH](https://code.google.com/p/elmah/)).</span><span class="sxs-lookup"><span data-stu-id="3c56f-122">Global exception handling and logging should be services that can run during production and be plugged into existing monitoring solutions (for example, [ELMAH](https://code.google.com/p/elmah/)).</span></span>

### <a name="solution-overview"></a><span data-ttu-id="3c56f-123">Visão geral da solução</span><span class="sxs-lookup"><span data-stu-id="3c56f-123">Solution Overview</span></span>

 <span data-ttu-id="3c56f-124">Fornecemos dois novos serviços substituíveis pelo usuário, [IExceptionLogger](../releases/whats-new-in-aspnet-web-api-21.md) e IExceptionHandler, para registrar e lidar com exceções não tratadas.</span><span class="sxs-lookup"><span data-stu-id="3c56f-124">We provide two new user-replaceable services, [IExceptionLogger](../releases/whats-new-in-aspnet-web-api-21.md) and IExceptionHandler, to log and handle unhandled exceptions.</span></span> <span data-ttu-id="3c56f-125">Os serviços são muito semelhantes, com duas principais diferenças:</span><span class="sxs-lookup"><span data-stu-id="3c56f-125">The services are very similar, with two main differences:</span></span>

1. <span data-ttu-id="3c56f-126">Nós suportamos o registro de vários loggers de exceção, mas apenas um único manipulador de exceção.</span><span class="sxs-lookup"><span data-stu-id="3c56f-126">We support registering multiple exception loggers but only a single exception handler.</span></span>
2. <span data-ttu-id="3c56f-127">Os madeireiros de exceção sempre são chamados, mesmo que estamos prestes a abortar a conexão.</span><span class="sxs-lookup"><span data-stu-id="3c56f-127">Exception loggers always get called, even if we're about to abort the connection.</span></span> <span data-ttu-id="3c56f-128">Os manipuladores de exceção só são chamados quando ainda podemos escolher qual mensagem de resposta enviar.</span><span class="sxs-lookup"><span data-stu-id="3c56f-128">Exception handlers only get called when we're still able to choose which response message to send.</span></span>

<span data-ttu-id="3c56f-129">Ambos os serviços fornecem acesso a um contexto de exceção contendo informações relevantes a partir do ponto em que a exceção foi detectada, particularmente o [HttpRequestMessage](https://msdn.microsoft.com/library/system.net.http.httprequestmessage(v=vs.110).aspx), o [HttpRequestContext](https://msdn.microsoft.com/library/system.web.http.controllers.httprequestcontext(v=vs.118).aspx), a exceção lançada e a fonte de exceção (detalhes abaixo).</span><span class="sxs-lookup"><span data-stu-id="3c56f-129">Both services provide access to an exception context containing relevant information from the point where the exception was detected, particularly the [HttpRequestMessage](https://msdn.microsoft.com/library/system.net.http.httprequestmessage(v=vs.110).aspx), the [HttpRequestContext](https://msdn.microsoft.com/library/system.web.http.controllers.httprequestcontext(v=vs.118).aspx), the thrown exception and the exception source (details below).</span></span>

### <a name="design-principles"></a><span data-ttu-id="3c56f-130">Princípios de design</span><span class="sxs-lookup"><span data-stu-id="3c56f-130">Design Principles</span></span>

1. <span data-ttu-id="3c56f-131">**Sem mudanças de quebra** Como essa funcionalidade está sendo adicionada em uma versão menor, uma restrição importante que afeta a solução é que não há alterações de quebra, seja para tipos de contratos ou para o comportamento.</span><span class="sxs-lookup"><span data-stu-id="3c56f-131">**No breaking changes** Because this functionality is being added in a minor release, one important constraint impacting the solution is that there be no breaking changes, either to type contracts or to behavior.</span></span> <span data-ttu-id="3c56f-132">Esta restrição excluiu alguma limpeza que gostaríamos de ter feito em termos de blocos de captura existentes transformando exceções em 500 respostas.</span><span class="sxs-lookup"><span data-stu-id="3c56f-132">This constraint ruled out some cleanup we would like to have done in terms of existing catch blocks turning exceptions into 500 responses.</span></span> <span data-ttu-id="3c56f-133">Esta limpeza adicional é algo que podemos considerar para um lançamento importante subsequente.</span><span class="sxs-lookup"><span data-stu-id="3c56f-133">This additional cleanup is something we might consider for a subsequent major release.</span></span> <span data-ttu-id="3c56f-134">Se isso é importante para você, por favor, vote nele em [ASP.NET voz de usuário da Web API](http://aspnet.uservoice.com/forums/147201-asp-net-web-api/suggestions/5451321-add-flag-to-enable-iexceptionlogger-and-iexception).</span><span class="sxs-lookup"><span data-stu-id="3c56f-134">If this is important to you please vote on it at [ASP.NET Web API user voice](http://aspnet.uservoice.com/forums/147201-asp-net-web-api/suggestions/5451321-add-flag-to-enable-iexceptionlogger-and-iexception).</span></span>
2. <span data-ttu-id="3c56f-135">**Mantendo a consistência com os construtos da Web API** O pipeline de filtros da Web API é uma ótima maneira de lidar com preocupações transversais com a flexibilidade de aplicar a lógica em um escopo específico de ação, específico do controlador ou global.</span><span class="sxs-lookup"><span data-stu-id="3c56f-135">**Maintaining consistency with Web API constructs** Web API's filter pipeline is a great way to handle cross-cutting concerns with the flexibility of applying the logic at an action-specific, controller-specific or global scope.</span></span> <span data-ttu-id="3c56f-136">Os filtros, incluindo filtros de exceção, sempre possuem contextos de ação e controlador, mesmo quando registrados no âmbito global.</span><span class="sxs-lookup"><span data-stu-id="3c56f-136">Filters, including exception filters, always have action and controller contexts, even when registered at the global scope.</span></span> <span data-ttu-id="3c56f-137">Esse contrato faz sentido para filtros, mas significa que os filtros de exceção, mesmo os de escopo global, não são adequados para alguns casos de tratamento de exceções, como exceções de manipuladores de mensagens, onde não existe nenhuma ação ou contexto de controlador.</span><span class="sxs-lookup"><span data-stu-id="3c56f-137">That contract makes sense for filters, but it means that exception filters, even globally scoped ones, aren't a good fit for some exception handling cases, such as exceptions from message handlers, where no action or controller context exists.</span></span> <span data-ttu-id="3c56f-138">Se quisermos usar o escopo flexível oferecido pelos filtros para o manuseio de exceções, ainda precisamos de filtros de exceção.</span><span class="sxs-lookup"><span data-stu-id="3c56f-138">If we want to use the flexible scoping afforded by filters for exception handling, we still need exception filters.</span></span> <span data-ttu-id="3c56f-139">Mas se precisamos lidar com exceção fora de um contexto controlador, também precisamos de um construto separado para o manuseio total de erros globais (algo sem as restrições de contexto de ação e contexto do controlador).</span><span class="sxs-lookup"><span data-stu-id="3c56f-139">But if we need to handle exception outside of a controller context, we also need a separate construct for full global error handling (something without the controller context and action context constraints).</span></span>

### <a name="when-to-use"></a><span data-ttu-id="3c56f-140">Quando usar</span><span class="sxs-lookup"><span data-stu-id="3c56f-140">When to Use</span></span>

- <span data-ttu-id="3c56f-141">Os loggers de exceção são a solução para ver todas as exceções não tratadas capturadas pela API da Web.</span><span class="sxs-lookup"><span data-stu-id="3c56f-141">Exception loggers are the solution to seeing all unhandled exception caught by Web API.</span></span>
- <span data-ttu-id="3c56f-142">Os manipuladores de exceção são a solução para personalizar todas as respostas possíveis a exceções não tratadas capturadas pela API da Web.</span><span class="sxs-lookup"><span data-stu-id="3c56f-142">Exception handlers are the solution for customizing all possible responses to unhandled exceptions caught by Web API.</span></span>
- <span data-ttu-id="3c56f-143">Os filtros de exceção são a solução mais fácil para processar as exceções não manuseadas do subconjunto relacionadas a uma ação ou controlador específico.</span><span class="sxs-lookup"><span data-stu-id="3c56f-143">Exception filters are the easiest solution for processing the subset unhandled exceptions related to a specific action or controller.</span></span>

### <a name="service-details"></a><span data-ttu-id="3c56f-144">Detalhes do serviço</span><span class="sxs-lookup"><span data-stu-id="3c56f-144">Service Details</span></span>

 <span data-ttu-id="3c56f-145">As interfaces de serviço de logger e handler de exceção são métodos simples de sincronia que tomam os respectivos contextos:</span><span class="sxs-lookup"><span data-stu-id="3c56f-145">The exception logger and handler service interfaces are simple async methods taking the respective contexts:</span></span> 

[!code-csharp[Main](web-api-global-error-handling/samples/sample2.cs)]

 <span data-ttu-id="3c56f-146">Também fornecemos classes básicas para ambas as interfaces.</span><span class="sxs-lookup"><span data-stu-id="3c56f-146">We also provide base classes for both of these interfaces.</span></span> <span data-ttu-id="3c56f-147">Sobrepor os métodos de núcleo (sincronização ou assincronização) é tudo o que é necessário para registrar ou manusear nos horários recomendados.</span><span class="sxs-lookup"><span data-stu-id="3c56f-147">Overriding the core (sync or async) methods is all that is required to log or handle at the recommended times.</span></span> <span data-ttu-id="3c56f-148">Para o `ExceptionLogger` registro, a classe base garantirá que o método de registro de núcleo seja chamado apenas uma vez para cada exceção (mesmo que mais tarde se propague mais acima da pilha de chamadas e seja pego novamente).</span><span class="sxs-lookup"><span data-stu-id="3c56f-148">For logging, the `ExceptionLogger` base class will ensure that the core logging method is only called once for each exception (even if it later propagates further up the call stack and is caught again).</span></span> <span data-ttu-id="3c56f-149">A `ExceptionHandler` classe base chamará o método de manuseio principal apenas para exceções na parte superior da pilha de chamadas, ignorando blocos de captura aninhados legados.</span><span class="sxs-lookup"><span data-stu-id="3c56f-149">The `ExceptionHandler` base class will call the core handling method only for exceptions at the top of the call stack, ignoring legacy nested catch blocks.</span></span> <span data-ttu-id="3c56f-150">(As versões simplificadas dessas classes base estão no apêndice abaixo.) Ambos `IExceptionLogger` `IExceptionHandler` e receber informações sobre `ExceptionContext`a exceção através de um .</span><span class="sxs-lookup"><span data-stu-id="3c56f-150">(Simplified versions of these base classes are in the appendix below.) Both `IExceptionLogger` and `IExceptionHandler` receive information about the exception via an `ExceptionContext`.</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample3.cs)]

<span data-ttu-id="3c56f-151">Quando o framework chama um logger de exceção `Exception` ou `Request`um manipulador de exceção, ele sempre fornecerá um e um .</span><span class="sxs-lookup"><span data-stu-id="3c56f-151">When the framework calls an exception logger or an exception handler, it will always provide an `Exception` and a `Request`.</span></span> <span data-ttu-id="3c56f-152">Com exceção dos testes unitários, ele também sempre fornecerá um `RequestContext`.</span><span class="sxs-lookup"><span data-stu-id="3c56f-152">Except for unit testing, it will also always provide a `RequestContext`.</span></span> <span data-ttu-id="3c56f-153">Ele raramente fornecerá um `ControllerContext` e `ActionContext` (somente quando ligar do bloco de captura para filtros de exceção).</span><span class="sxs-lookup"><span data-stu-id="3c56f-153">It will rarely provide a `ControllerContext` and `ActionContext` (only when calling from the catch block for exception filters).</span></span> <span data-ttu-id="3c56f-154">Ele raramente fornecerá `Response`um (apenas em certos casos de IIS quando no meio de tentar escrever a resposta).</span><span class="sxs-lookup"><span data-stu-id="3c56f-154">It will very rarely provide a `Response`(only in certain IIS cases when in the middle of trying to write the response).</span></span> <span data-ttu-id="3c56f-155">Observe que, como algumas `null` dessas propriedades podem ser, `null` cabe ao consumidor verificar antes de acessar os membros da classe de exceção.`CatchBlock`</span><span class="sxs-lookup"><span data-stu-id="3c56f-155">Note that because some of these properties may be `null` it is up to the consumer to check for `null` before accessing members of the exception class.`CatchBlock`</span></span> <span data-ttu-id="3c56f-156">é uma string indicando qual bloco de captura viu a exceção.</span><span class="sxs-lookup"><span data-stu-id="3c56f-156">is a string indicating which catch block saw the exception.</span></span> <span data-ttu-id="3c56f-157">As strings do bloco de captura são as seguintes:</span><span class="sxs-lookup"><span data-stu-id="3c56f-157">The catch block strings are as follows:</span></span>

- <span data-ttu-id="3c56f-158">HttpServer (método SendAsync)</span><span class="sxs-lookup"><span data-stu-id="3c56f-158">HttpServer (SendAsync method)</span></span>
- <span data-ttu-id="3c56f-159">HttpControllerDispatcher (método SendAsync)</span><span class="sxs-lookup"><span data-stu-id="3c56f-159">HttpControllerDispatcher (SendAsync method)</span></span>
- <span data-ttu-id="3c56f-160">HttpBatchHandler (método SendAsync)</span><span class="sxs-lookup"><span data-stu-id="3c56f-160">HttpBatchHandler (SendAsync method)</span></span>
- <span data-ttu-id="3c56f-161">IExceptionFilter (processamento do apiController do pipeline de filtro de exceção no ExecuteAsync)</span><span class="sxs-lookup"><span data-stu-id="3c56f-161">IExceptionFilter (ApiController's processing of the exception filter pipeline in ExecuteAsync)</span></span>
- <span data-ttu-id="3c56f-162">Anfitrião OWIN:</span><span class="sxs-lookup"><span data-stu-id="3c56f-162">OWIN host:</span></span>

    - <span data-ttu-id="3c56f-163">HttpMessageHandlerAdapter.BufferResponseContentAsync (para saída de buffer)</span><span class="sxs-lookup"><span data-stu-id="3c56f-163">HttpMessageHandlerAdapter.BufferResponseContentAsync (for buffering output)</span></span>
    - <span data-ttu-id="3c56f-164">HttpMessageHandlerAdapter.CopyResponseContentAsync (para saída de streaming)</span><span class="sxs-lookup"><span data-stu-id="3c56f-164">HttpMessageHandlerAdapter.CopyResponseContentAsync (for streaming output)</span></span>
- <span data-ttu-id="3c56f-165">Host web:</span><span class="sxs-lookup"><span data-stu-id="3c56f-165">Web host:</span></span>

    - <span data-ttu-id="3c56f-166">HttpControllerHandler.WriteBufferedResponseContentAsync (para saída de buffer)</span><span class="sxs-lookup"><span data-stu-id="3c56f-166">HttpControllerHandler.WriteBufferedResponseContentAsync (for buffering output)</span></span>
    - <span data-ttu-id="3c56f-167">HttpControllerHandler.WriteStreamedResponseContentAsync (para saída de streaming)</span><span class="sxs-lookup"><span data-stu-id="3c56f-167">HttpControllerHandler.WriteStreamedResponseContentAsync (for streaming output)</span></span>
    - <span data-ttu-id="3c56f-168">HttpControllerHandler.WriteErrorResponseContentAsync (para falhas na recuperação de erros no modo de saída tamponado)</span><span class="sxs-lookup"><span data-stu-id="3c56f-168">HttpControllerHandler.WriteErrorResponseContentAsync (for failures in error recovery under buffered output mode)</span></span>

<span data-ttu-id="3c56f-169">A lista de strings de bloco de captura também está disponível através de propriedades estáticas somente leitura.</span><span class="sxs-lookup"><span data-stu-id="3c56f-169">The list of catch block strings is also available via static readonly properties.</span></span> <span data-ttu-id="3c56f-170">(A seqüência de blocos de captura do núcleo está na estático ExceptionCatchBlocks; o restante aparece em uma classe estática cada para OWIN e web host).`IsTopLevelCatchBlock`</span><span class="sxs-lookup"><span data-stu-id="3c56f-170">(The core catch block string are on the static ExceptionCatchBlocks; the remainder appear on one static class each for OWIN and web host).`IsTopLevelCatchBlock`</span></span> <span data-ttu-id="3c56f-171">é útil para seguir o padrão recomendado de exceções de manuseio apenas na parte superior da pilha de chamadas.</span><span class="sxs-lookup"><span data-stu-id="3c56f-171">is helpful for following the recommended pattern of handling exceptions only at the top of the call stack.</span></span> <span data-ttu-id="3c56f-172">Em vez de transformar exceções em 500 respostas em qualquer lugar que ocorra um bloco de captura aninhado, um manipulador de exceção pode deixar as exceções se propagarem até que elas estejam prestes a ser vistas pelo host.</span><span class="sxs-lookup"><span data-stu-id="3c56f-172">Rather than turning exceptions into 500 responses anywhere a nested catch block occurs, an exception handler can let exceptions propagate until they are about to be seen by the host.</span></span>

<span data-ttu-id="3c56f-173">Além do `ExceptionContext`, um logger recebe mais uma `ExceptionLoggerContext`informação através da íntegra :</span><span class="sxs-lookup"><span data-stu-id="3c56f-173">In addition to the `ExceptionContext`, a logger gets one more piece of information via the full `ExceptionLoggerContext`:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample4.cs)]

<span data-ttu-id="3c56f-174">A segunda `CanBeHandled`propriedade, permite que um madeireiro identifique uma exceção que não pode ser tratada.</span><span class="sxs-lookup"><span data-stu-id="3c56f-174">The second property, `CanBeHandled`, allows a logger to identify an exception that cannot be handled.</span></span> <span data-ttu-id="3c56f-175">Quando a conexão estiver prestes a ser abortada e nenhuma nova mensagem de resposta puder ser enviada, os madeireiros serão chamados, mas o manipulador ***não*** será chamado, e os madeireiros podem identificar esse cenário a partir desta propriedade.</span><span class="sxs-lookup"><span data-stu-id="3c56f-175">When the connection is about to be aborted and no new response message can be sent, the loggers will be called but the handler will ***not*** be called, and the loggers can identify this scenario from this property.</span></span>

<span data-ttu-id="3c56f-176">Além do `ExceptionContext`, um manipulador obtém mais uma `ExceptionHandlerContext` propriedade que pode definir na íntegra para lidar com a exceção:</span><span class="sxs-lookup"><span data-stu-id="3c56f-176">In additional to the `ExceptionContext`, a handler gets one more property it can set on the full `ExceptionHandlerContext` to handle the exception:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample5.cs)]

<span data-ttu-id="3c56f-177">Um manipulador de exceção indica que ele `Result` lidou com uma exceção definindo a propriedade como um resultado de ação (por exemplo, um [Resultado de Exceção,](https://msdn.microsoft.com/library/system.web.http.results.exceptionresult(v=vs.118).aspx) [InternalServerErrorResult,](https://msdn.microsoft.com/library/system.web.http.results.internalservererrorresult(v=vs.118).aspx) [StatusCodeResult](https://msdn.microsoft.com/library/system.web.http.results.statuscoderesult(v=vs.118).aspx)ou um resultado personalizado).</span><span class="sxs-lookup"><span data-stu-id="3c56f-177">An exception handler indicates that it has handled an exception by setting the `Result` property to an action result (for example, an [ExceptionResult](https://msdn.microsoft.com/library/system.web.http.results.exceptionresult(v=vs.118).aspx), [InternalServerErrorResult](https://msdn.microsoft.com/library/system.web.http.results.internalservererrorresult(v=vs.118).aspx), [StatusCodeResult](https://msdn.microsoft.com/library/system.web.http.results.statuscoderesult(v=vs.118).aspx), or a custom result).</span></span> <span data-ttu-id="3c56f-178">Se `Result` a propriedade for nula, a exceção não será tratada e a exceção original será relançada.</span><span class="sxs-lookup"><span data-stu-id="3c56f-178">If the `Result` property is null, the exception is unhandled and the original exception will be re-thrown.</span></span>

<span data-ttu-id="3c56f-179">Para exceções na parte superior da pilha de chamadas, demos um passo extra para garantir que a resposta seja apropriada para os chamadores de API.</span><span class="sxs-lookup"><span data-stu-id="3c56f-179">For exceptions at the top of the call stack, we took an extra step to ensure the response is appropriate for API callers.</span></span> <span data-ttu-id="3c56f-180">Se a exceção se propagar até o host, o chamador verá a tela amarela da morte ou algum outro host forneceu resposta que é tipicamente HTML e normalmente não é uma resposta de erro de API apropriada.</span><span class="sxs-lookup"><span data-stu-id="3c56f-180">If the exception propagates up to the host, the caller would see the yellow screen of death or some other host provided response which is typically HTML and not usually an appropriate API error response.</span></span> <span data-ttu-id="3c56f-181">Nestes casos, o Resultado começa sem nulidade, e somente se `null` um manipulador de exceção personalizado o definir explicitamente para (não manipulado) a exceção se propagará para o host.</span><span class="sxs-lookup"><span data-stu-id="3c56f-181">In these cases, the Result starts out non-null, and only if a custom exception handler explicitly sets it back to `null` (unhandled) will the exception propagate to the host.</span></span> <span data-ttu-id="3c56f-182">A `Result` `null` definição nesses casos pode ser útil para dois cenários:</span><span class="sxs-lookup"><span data-stu-id="3c56f-182">Setting `Result` to `null` in such cases can be useful for two scenarios:</span></span>

1. <span data-ttu-id="3c56f-183">OOWIN hospedou a API da Web com middleware de tratamento de exceção personalizado registrado antes/fora da API da Web.</span><span class="sxs-lookup"><span data-stu-id="3c56f-183">OWIN hosted Web API with custom exception handling middleware registered before/outside Web API.</span></span>
2. <span data-ttu-id="3c56f-184">Depuração local através de um navegador, onde a tela amarela da morte é na verdade uma resposta útil para uma exceção não tratada.</span><span class="sxs-lookup"><span data-stu-id="3c56f-184">Local debugging via a browser, where the yellow screen of death is actually a helpful response for an unhandled exception.</span></span>

<span data-ttu-id="3c56f-185">Para ambos os loggers exceção e manipuladores de exceção, não fazemos nada para recuperar se o logger ou o próprio manipulador lançar uma exceção.</span><span class="sxs-lookup"><span data-stu-id="3c56f-185">For both exception loggers and exception handlers, we don't do anything to recover if the logger or handler itself throws an exception.</span></span> <span data-ttu-id="3c56f-186">(Além de deixar a exceção se propagar, deixe feedback no final desta página se você tiver uma abordagem melhor.) O contrato para madeireiros e manipuladores de exceção é que eles não devem deixar que exceções se propagarem para seus chamadores; caso contrário, a exceção apenas se propagará, muitas vezes até o host, resultando em um erro HTML (como ASP. A tela amarela da NET) sendo enviada de volta ao cliente (que geralmente não é a opção preferida para chamadores de API que esperam JSON ou XML).</span><span class="sxs-lookup"><span data-stu-id="3c56f-186">(Other than letting the exception propagate, leave feedback at the bottom of this page if you have a better approach.) The contract for exception loggers and handlers is that they should not let exceptions propagate up to their callers; otherwise, the exception will just propagate, often all the way to the host resulting in an HTML error (like ASP.NET's yellow screen) being sent back to the client (which usually isn't the preferred option for API callers that expect JSON or XML).</span></span>

## <a name="examples"></a><span data-ttu-id="3c56f-187">Exemplos</span><span class="sxs-lookup"><span data-stu-id="3c56f-187">Examples</span></span>

### <a name="tracing-exception-logger"></a><span data-ttu-id="3c56f-188">Registro de exceção de rastreamento</span><span class="sxs-lookup"><span data-stu-id="3c56f-188">Tracing Exception Logger</span></span>

<span data-ttu-id="3c56f-189">O logger de exceção abaixo envia dados de exceção para fontes de rastreamento configuradas (incluindo a janela de saída Debug no Visual Studio).</span><span class="sxs-lookup"><span data-stu-id="3c56f-189">The exception logger below sends exception data to configured Trace sources (including the Debug output window in Visual Studio).</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample6.cs)]

### <a name="custom-error-message-exception-handler"></a><span data-ttu-id="3c56f-190">Manipulador de exceção de mensagens de erro personalizado</span><span class="sxs-lookup"><span data-stu-id="3c56f-190">Custom Error Message Exception Handler</span></span>

<span data-ttu-id="3c56f-191">O manipulador de exceção abaixo produz uma resposta de erro personalizada aos clientes, incluindo um endereço de e-mail para o suporte de contato.</span><span class="sxs-lookup"><span data-stu-id="3c56f-191">The exception handler below produces a custom error response to clients, including an email address for contacting support.</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample7.cs)]

## <a name="registering-exception-filters"></a><span data-ttu-id="3c56f-192">Registrando filtros de exceção</span><span class="sxs-lookup"><span data-stu-id="3c56f-192">Registering Exception Filters</span></span>

<span data-ttu-id="3c56f-193">Se você usar o modelo de projeto "ASP.NET MVC 4 Web Application" para `WebApiConfig` criar seu projeto, coloque o código de configuração da API da Web dentro da classe, na pasta *App_Start:*</span><span class="sxs-lookup"><span data-stu-id="3c56f-193">If you use the "ASP.NET MVC 4 Web Application" project template to create your project, put your Web API configuration code inside the `WebApiConfig` class, in the *App_Start* folder:</span></span>

[!code-csharp[Main](exception-handling/samples/sample7.cs?highlight=5)]

## <a name="appendix-base-class-details"></a><span data-ttu-id="3c56f-194">Apêndice: Detalhes da classe base</span><span class="sxs-lookup"><span data-stu-id="3c56f-194">Appendix: Base Class Details</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample8.cs)]
