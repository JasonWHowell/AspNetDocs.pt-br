---
uid: web-forms/overview/data-access/editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb
title: Implementando simultaneidade otimista (VB) | Microsoft Docs
author: rick-anderson
description: Para um aplicativo Web que permite que vários usuários editem dados, há o risco de que dois usuários possam estar editando os mesmos dados ao mesmo tempo. Neste tutorial...
ms.author: riande
ms.date: 07/17/2006
ms.assetid: 2646968c-2826-4418-b1d0-62610ed177e3
msc.legacyurl: /web-forms/overview/data-access/editing-inserting-and-deleting-data/implementing-optimistic-concurrency-vb
msc.type: authoredcontent
ms.openlocfilehash: 28c39fe2a290cc3a5b093fdd09de341630606137
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78607908"
---
# <a name="implementing-optimistic-concurrency-vb"></a><span data-ttu-id="9ece6-104">Implementar a simultaneidade otimista (VB)</span><span class="sxs-lookup"><span data-stu-id="9ece6-104">Implementing Optimistic Concurrency (VB)</span></span>

<span data-ttu-id="9ece6-105">por [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="9ece6-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="9ece6-106">[Baixar o aplicativo de exemplo](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_21_VB.exe) ou [baixar PDF](implementing-optimistic-concurrency-vb/_static/datatutorial21vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="9ece6-106">[Download Sample App](https://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_21_VB.exe) or [Download PDF](implementing-optimistic-concurrency-vb/_static/datatutorial21vb1.pdf)</span></span>

> <span data-ttu-id="9ece6-107">Para um aplicativo Web que permite que vários usuários editem dados, há o risco de que dois usuários possam estar editando os mesmos dados ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="9ece6-107">For a web application that allows multiple users to edit data, there is the risk that two users may be editing the same data at the same time.</span></span> <span data-ttu-id="9ece6-108">Neste tutorial, implementaremos o controle de simultaneidade otimista para lidar com esse risco.</span><span class="sxs-lookup"><span data-stu-id="9ece6-108">In this tutorial we'll implement optimistic concurrency control to handle this risk.</span></span>

## <a name="introduction"></a><span data-ttu-id="9ece6-109">Introdução</span><span class="sxs-lookup"><span data-stu-id="9ece6-109">Introduction</span></span>

<span data-ttu-id="9ece6-110">Para aplicativos Web que só permitem que os usuários exibam dados ou para aqueles que incluem apenas um único usuário que pode modificar dados, não há nenhuma ameaça de dois usuários simultâneos substituindo as alterações mais uma vez.</span><span class="sxs-lookup"><span data-stu-id="9ece6-110">For web applications that only allow users to view data, or for those that include only a single user who can modify data, there's no threat of two concurrent users accidentally overwriting one another's changes.</span></span> <span data-ttu-id="9ece6-111">No entanto, para aplicativos Web que permitem que vários usuários atualizem ou excluam dados, no entanto, há o potencial para que as modificações de um usuário entrem em conflito com outros usuários simultâneos.</span><span class="sxs-lookup"><span data-stu-id="9ece6-111">For web applications that allow multiple users to update or delete data, however, there's the potential for one user's modifications to clash with another concurrent user's.</span></span> <span data-ttu-id="9ece6-112">Sem nenhuma política de simultaneidade em vigor, quando dois usuários estão editando um único registro ao mesmo tempo, o usuário que confirma suas alterações por último substituirá as alterações feitas pelo primeiro.</span><span class="sxs-lookup"><span data-stu-id="9ece6-112">Without any concurrency policy in place, when two users are simultaneously editing a single record, the user who commits her changes last will override the changes made by the first.</span></span>

<span data-ttu-id="9ece6-113">Por exemplo, imagine que dois usuários, Jisun e Sam, estavam visitando uma página em nosso aplicativo que permitia que os visitantes atualizassem e excluíssem os produtos por meio de um controle GridView.</span><span class="sxs-lookup"><span data-stu-id="9ece6-113">For example, imagine that two users, Jisun and Sam, were both visiting a page in our application that allowed visitors to update and delete the products through a GridView control.</span></span> <span data-ttu-id="9ece6-114">Ambos clicam no botão Editar no GridView ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="9ece6-114">Both click the Edit button in the GridView around the same time.</span></span> <span data-ttu-id="9ece6-115">Jisun altera o nome do produto para "Chai chá" e clica no botão atualizar.</span><span class="sxs-lookup"><span data-stu-id="9ece6-115">Jisun changes the product name to "Chai Tea" and clicks the Update button.</span></span> <span data-ttu-id="9ece6-116">O resultado líquido é uma instrução `UPDATE` que é enviada ao banco de dados, que define *todos* os campos atualizáveis do produto (mesmo que Jisun tenha atualizado apenas um campo, `ProductName`).</span><span class="sxs-lookup"><span data-stu-id="9ece6-116">The net result is an `UPDATE` statement that is sent to the database, which sets *all* of the product's updateable fields (even though Jisun only updated one field, `ProductName`).</span></span> <span data-ttu-id="9ece6-117">Nesse momento, o banco de dados tem os valores "Chai chá", as bebidas da categoria, o fornecedor exóticas liquids e assim por diante para esse produto específico.</span><span class="sxs-lookup"><span data-stu-id="9ece6-117">At this point in time, the database has the values "Chai Tea," the category Beverages, the supplier Exotic Liquids, and so on for this particular product.</span></span> <span data-ttu-id="9ece6-118">No entanto, o GridView na tela do Sam ainda mostra o nome do produto na linha GridView editável como "Chai".</span><span class="sxs-lookup"><span data-stu-id="9ece6-118">However, the GridView on Sam's screen still shows the product name in the editable GridView row as "Chai".</span></span> <span data-ttu-id="9ece6-119">Alguns segundos depois que as alterações de Jisun tiverem sido confirmadas, o Sam atualizará a categoria para condiments e clicará em atualizar.</span><span class="sxs-lookup"><span data-stu-id="9ece6-119">A few seconds after Jisun's changes have been committed, Sam updates the category to Condiments and clicks Update.</span></span> <span data-ttu-id="9ece6-120">Isso resulta em uma instrução de `UPDATE` enviada ao banco de dados que define o nome do produto como "Chai", a `CategoryID` para a ID da categoria de bebidas correspondente e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="9ece6-120">This results in an `UPDATE` statement sent to the database that sets the product name to "Chai," the `CategoryID` to the corresponding Beverages category ID, and so on.</span></span> <span data-ttu-id="9ece6-121">As alterações do Jisun para o nome do produto foram substituídas.</span><span class="sxs-lookup"><span data-stu-id="9ece6-121">Jisun's changes to the product name have been overwritten.</span></span> <span data-ttu-id="9ece6-122">A Figura 1 descreve graficamente esta série de eventos.</span><span class="sxs-lookup"><span data-stu-id="9ece6-122">Figure 1 graphically depicts this series of events.</span></span>

<span data-ttu-id="9ece6-123">[![quando dois usuários atualizam simultaneamente um registro com potencial para as alterações de um usuário para substituir o outro](implementing-optimistic-concurrency-vb/_static/image2.png)](implementing-optimistic-concurrency-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-123">[![When Two Users Simultaneously Update a Record There s Potential for One User 's Changes to Overwrite the Other 's](implementing-optimistic-concurrency-vb/_static/image2.png)](implementing-optimistic-concurrency-vb/_static/image1.png)</span></span>

<span data-ttu-id="9ece6-124">**Figura 1**: quando dois usuários atualizam simultaneamente um registro, há um potencial para as alterações de um usuário para substituir o outro ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-124">**Figure 1**: When Two Users Simultaneously Update a Record There s Potential for One User 's Changes to Overwrite the Other 's ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image3.png))</span></span>

<span data-ttu-id="9ece6-125">Da mesma forma, quando dois usuários estão visitando uma página, um usuário pode estar no meio da atualização de um registro quando ele é excluído por outro usuário.</span><span class="sxs-lookup"><span data-stu-id="9ece6-125">Similarly, when two users are visiting a page, one user might be in the midst of updating a record when it is deleted by another user.</span></span> <span data-ttu-id="9ece6-126">Ou, entre quando um usuário carrega uma página e quando clica no botão excluir, outro usuário pode ter modificado o conteúdo desse registro.</span><span class="sxs-lookup"><span data-stu-id="9ece6-126">Or, between when a user loads a page and when they click the Delete button, another user may have modified the contents of that record.</span></span>

<span data-ttu-id="9ece6-127">Há três estratégias de [controle de simultaneidade](http://en.wikipedia.org/wiki/Concurrency_control) disponíveis:</span><span class="sxs-lookup"><span data-stu-id="9ece6-127">There are three [concurrency control](http://en.wikipedia.org/wiki/Concurrency_control) strategies available:</span></span>

- <span data-ttu-id="9ece6-128">**Não fazer nada** -se usuários simultâneos estiverem modificando o mesmo registro, deixe a última confirmação vencer (o comportamento padrão)</span><span class="sxs-lookup"><span data-stu-id="9ece6-128">**Do Nothing** -if concurrent users are modifying the same record, let the last commit win (the default behavior)</span></span>
- <span data-ttu-id="9ece6-129">[**Simultaneidade otimista**](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) -suponha que, embora possa haver conflitos de simultaneidade a cada momento e, em seguida, a grande maioria do tempo que esses conflitos não surgirão; Portanto, se ocorrer um conflito, basta informar ao usuário que suas alterações não podem ser salvas porque outro usuário modificou os mesmos dados</span><span class="sxs-lookup"><span data-stu-id="9ece6-129">[**Optimistic Concurrency**](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) - assume that while there may be concurrency conflicts every now and then, the vast majority of the time such conflicts won't arise; therefore, if a conflict does arise, simply inform the user that their changes can't be saved because another user has modified the same data</span></span>
- <span data-ttu-id="9ece6-130">**Simultaneidade pessimista** -assuma que os conflitos de simultaneidade são comuns e que os usuários não toleram que suas alterações não tenham sido salvas devido à atividade simultânea de outro usuário; Portanto, quando um usuário inicia a atualização de um registro, o bloqueia, impedindo que outros usuários editem ou excluam esse registro até que o usuário confirme suas modificações</span><span class="sxs-lookup"><span data-stu-id="9ece6-130">**Pessimistic Concurrency** - assume that concurrency conflicts are commonplace and that users won't tolerate being told their changes weren't saved due to another user's concurrent activity; therefore, when one user starts updating a record, lock it, thereby preventing any other users from editing or deleting that record until the user commits their modifications</span></span>

<span data-ttu-id="9ece6-131">Todos os nossos tutoriais, até agora, usaram a estratégia de resolução de simultaneidade padrão, ou seja, deixamos o último ganho de gravação.</span><span class="sxs-lookup"><span data-stu-id="9ece6-131">All of our tutorials thus far have used the default concurrency resolution strategy - namely, we've let the last write win.</span></span> <span data-ttu-id="9ece6-132">Neste tutorial, examinaremos como implementar o controle de simultaneidade otimista.</span><span class="sxs-lookup"><span data-stu-id="9ece6-132">In this tutorial we'll examine how to implement optimistic concurrency control.</span></span>

> [!NOTE]
> <span data-ttu-id="9ece6-133">Não veremos exemplos de simultaneidade pessimista nesta série de tutoriais.</span><span class="sxs-lookup"><span data-stu-id="9ece6-133">We won't look at pessimistic concurrency examples in this tutorial series.</span></span> <span data-ttu-id="9ece6-134">A simultaneidade pessimista raramente é usada porque esses bloqueios, se não forem corretamente desalocados, podem impedir que outros usuários atualizem dados.</span><span class="sxs-lookup"><span data-stu-id="9ece6-134">Pessimistic concurrency is rarely used because such locks, if not properly relinquished, can prevent other users from updating data.</span></span> <span data-ttu-id="9ece6-135">Por exemplo, se um usuário bloquear um registro para edição e, em seguida, sair para o dia antes de desbloqueá-lo, nenhum outro usuário poderá atualizar esse registro até que o usuário original retorne e conclua sua atualização.</span><span class="sxs-lookup"><span data-stu-id="9ece6-135">For example, if a user locks a record for editing and then leaves for the day before unlocking it, no other user will be able to update that record until the original user returns and completes his update.</span></span> <span data-ttu-id="9ece6-136">Portanto, em situações em que a simultaneidade pessimista é usada, normalmente há um tempo limite que, se atingido, cancela o bloqueio.</span><span class="sxs-lookup"><span data-stu-id="9ece6-136">Therefore, in situations where pessimistic concurrency is used, there's typically a timeout that, if reached, cancels the lock.</span></span> <span data-ttu-id="9ece6-137">Sites de vendas de tíquetes, que bloqueiam um local de assentos específico por um curto período, enquanto o usuário conclui o processo de pedido, é um exemplo de controle de simultaneidade pessimista.</span><span class="sxs-lookup"><span data-stu-id="9ece6-137">Ticket sales websites, which lock a particular seating location for short period while the user completes the order process, is an example of pessimistic concurrency control.</span></span>

## <a name="step-1-looking-at-how-optimistic-concurrency-is-implemented"></a><span data-ttu-id="9ece6-138">Etapa 1: examinando como a simultaneidade otimista é implementada</span><span class="sxs-lookup"><span data-stu-id="9ece6-138">Step 1: Looking at How Optimistic Concurrency is Implemented</span></span>

<span data-ttu-id="9ece6-139">O controle de simultaneidade otimista funciona garantindo que o registro que está sendo atualizado ou excluído tenha os mesmos valores que faziam quando o processo de atualização ou exclusão foi iniciado.</span><span class="sxs-lookup"><span data-stu-id="9ece6-139">Optimistic concurrency control works by ensuring that the record being updated or deleted has the same values as it did when the updating or deleting process started.</span></span> <span data-ttu-id="9ece6-140">Por exemplo, ao clicar no botão Editar em um GridView editável, os valores do registro são lidos do banco de dados e exibidos em caixas de Texte outros controles da Web.</span><span class="sxs-lookup"><span data-stu-id="9ece6-140">For example, when clicking the Edit button in an editable GridView, the record's values are read from the database and displayed in TextBoxes and other Web controls.</span></span> <span data-ttu-id="9ece6-141">Esses valores originais são salvos pelo GridView.</span><span class="sxs-lookup"><span data-stu-id="9ece6-141">These original values are saved by the GridView.</span></span> <span data-ttu-id="9ece6-142">Posteriormente, depois que o usuário fizer alterações e clicar no botão atualizar, os valores originais mais os novos valores serão enviados para a camada lógica de negócios e, em seguida, para a camada de acesso a dados.</span><span class="sxs-lookup"><span data-stu-id="9ece6-142">Later, after the user makes her changes and clicks the Update button, the original values plus the new values are sent to the Business Logic Layer, and then down to the Data Access Layer.</span></span> <span data-ttu-id="9ece6-143">A camada de acesso a dados deve emitir uma instrução SQL que só atualizará o registro se os valores originais que o usuário iniciou a edição forem idênticos aos valores que ainda estão no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="9ece6-143">The Data Access Layer must issue a SQL statement that will only update the record if the original values that the user started editing are identical to the values still in the database.</span></span> <span data-ttu-id="9ece6-144">A Figura 2 descreve essa sequência de eventos.</span><span class="sxs-lookup"><span data-stu-id="9ece6-144">Figure 2 depicts this sequence of events.</span></span>

<span data-ttu-id="9ece6-145">[![para que a atualização ou exclusão seja realizada com sucesso, os valores originais devem ser iguais aos valores do banco de dados atual](implementing-optimistic-concurrency-vb/_static/image5.png)](implementing-optimistic-concurrency-vb/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-145">[![For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values](implementing-optimistic-concurrency-vb/_static/image5.png)](implementing-optimistic-concurrency-vb/_static/image4.png)</span></span>

<span data-ttu-id="9ece6-146">**Figura 2**: para que a atualização ou exclusão seja realizada com sucesso, os valores originais devem ser iguais aos valores do banco de dados atual ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-146">**Figure 2**: For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image6.png))</span></span>

<span data-ttu-id="9ece6-147">Há várias abordagens para implementar a simultaneidade otimista (consulte a [lógica de atualização de simultaneidade otimista](http://www.eggheadcafe.com/articles/20050719.asp) de [Peter A. Bromberg](http://peterbromberg.net/)para obter uma breve visão de várias opções).</span><span class="sxs-lookup"><span data-stu-id="9ece6-147">There are various approaches to implementing optimistic concurrency (see [Peter A. Bromberg](http://peterbromberg.net/)'s [Optimistic Concurrency Updating Logic](http://www.eggheadcafe.com/articles/20050719.asp) for a brief look at a number of options).</span></span> <span data-ttu-id="9ece6-148">O conjunto de ADO.NET digitado fornece uma implementação que pode ser configurada apenas com o tique de uma caixa de seleção.</span><span class="sxs-lookup"><span data-stu-id="9ece6-148">The ADO.NET Typed DataSet provides one implementation that can be configured with just the tick of a checkbox.</span></span> <span data-ttu-id="9ece6-149">Habilitar a simultaneidade otimista para um TableAdapter no DataSet tipado aumenta as instruções `UPDATE` e `DELETE` do TableAdapter para incluir uma comparação de todos os valores originais na cláusula `WHERE`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-149">Enabling optimistic concurrency for a TableAdapter in the Typed DataSet augments the TableAdapter's `UPDATE` and `DELETE` statements to include a comparison of all of the original values in the `WHERE` clause.</span></span> <span data-ttu-id="9ece6-150">A instrução `UPDATE` a seguir, por exemplo, atualiza o nome e o preço de um produto somente se os valores do banco de dados atual forem iguais aos valores que foram originalmente recuperados ao atualizar o registro no GridView.</span><span class="sxs-lookup"><span data-stu-id="9ece6-150">The following `UPDATE` statement, for example, updates the name and price of a product only if the current database values are equal to the values that were originally retrieved when updating the record in the GridView.</span></span> <span data-ttu-id="9ece6-151">Os parâmetros `@ProductName` e `@UnitPrice` contêm os novos valores inseridos pelo usuário, enquanto `@original_ProductName` e `@original_UnitPrice` contêm os valores que foram carregados originalmente no GridView quando o botão Editar foi clicado:</span><span class="sxs-lookup"><span data-stu-id="9ece6-151">The `@ProductName` and `@UnitPrice` parameters contain the new values entered by the user, whereas `@original_ProductName` and `@original_UnitPrice` contain the values that were originally loaded into the GridView when the Edit button was clicked:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample1.sql)]

> [!NOTE]
> <span data-ttu-id="9ece6-152">Esta instrução de `UPDATE` foi simplificada para facilitar a leitura.</span><span class="sxs-lookup"><span data-stu-id="9ece6-152">This `UPDATE` statement has been simplified for readability.</span></span> <span data-ttu-id="9ece6-153">Na prática, a `UnitPrice` verificação na cláusula `WHERE` seria mais envolvida, já que `UnitPrice` pode conter `NULL` s e verificar se `NULL = NULL` sempre retorna false (em vez disso, você deve usar `IS NULL`).</span><span class="sxs-lookup"><span data-stu-id="9ece6-153">In practice, the `UnitPrice` check in the `WHERE` clause would be more involved since `UnitPrice` can contain `NULL` s and checking if `NULL = NULL` always returns False (instead you must use `IS NULL`).</span></span>

<span data-ttu-id="9ece6-154">Além de usar uma instrução de `UPDATE` subjacente diferente, configurar um TableAdapter para usar a simultaneidade otimista também modifica a assinatura de seus métodos diretos de banco de BD.</span><span class="sxs-lookup"><span data-stu-id="9ece6-154">In addition to using a different underlying `UPDATE` statement, configuring a TableAdapter to use optimistic concurrency also modifies the signature of its DB direct methods.</span></span> <span data-ttu-id="9ece6-155">Lembre-se do nosso primeiro tutorial, [*criando uma camada de acesso a dados*](../introduction/creating-a-data-access-layer-cs.md), que os métodos diretos do DB eram aqueles que aceitam uma lista de valores escalares como parâmetros de entrada (em vez de uma instância de DataRow ou DataTable fortemente tipada).</span><span class="sxs-lookup"><span data-stu-id="9ece6-155">Recall from our first tutorial, [*Creating a Data Access Layer*](../introduction/creating-a-data-access-layer-cs.md), that DB direct methods were those that accepts a list of scalar values as input parameters (rather than a strongly-typed DataRow or DataTable instance).</span></span> <span data-ttu-id="9ece6-156">Ao usar a simultaneidade otimista, o `Update()` do DB Direct e os métodos de `Delete()` também incluem parâmetros de entrada para os valores originais.</span><span class="sxs-lookup"><span data-stu-id="9ece6-156">When using optimistic concurrency, the DB direct `Update()` and `Delete()` methods include input parameters for the original values as well.</span></span> <span data-ttu-id="9ece6-157">Além disso, o código na BLL para usar o padrão de atualização do lote (o `Update()` sobrecargas de método que aceitam DataRows e DataTables em vez de valores escalares) também deve ser alterado.</span><span class="sxs-lookup"><span data-stu-id="9ece6-157">Moreover, the code in the BLL for using the batch update pattern (the `Update()` method overloads that accept DataRows and DataTables rather than scalar values) must be changed as well.</span></span>

<span data-ttu-id="9ece6-158">Em vez de estender os TableAdapters de DAL existentes para usar a simultaneidade otimista (o que precisaria alterar a BLL para acomodar), vamos criar um novo conjunto de um DataSet com tipo chamado `NorthwindOptimisticConcurrency`, ao qual adicionaremos um TableAdapter de `Products` que usa simultaneidade otimista.</span><span class="sxs-lookup"><span data-stu-id="9ece6-158">Rather than extend our existing DAL's TableAdapters to use optimistic concurrency (which would necessitate changing the BLL to accommodate), let's instead create a new Typed DataSet named `NorthwindOptimisticConcurrency`, to which we'll add a `Products` TableAdapter that uses optimistic concurrency.</span></span> <span data-ttu-id="9ece6-159">Depois disso, criaremos uma classe de camada de lógica de negócios `ProductsOptimisticConcurrencyBLL` que tem as modificações apropriadas para dar suporte à DAL de simultaneidade otimista.</span><span class="sxs-lookup"><span data-stu-id="9ece6-159">Following that, we'll create a `ProductsOptimisticConcurrencyBLL` Business Logic Layer class that has the appropriate modifications to support the optimistic concurrency DAL.</span></span> <span data-ttu-id="9ece6-160">Depois que essa base tiver sido disposta, estaremos prontos para criar a página ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="9ece6-160">Once this groundwork has been laid, we'll be ready to create the ASP.NET page.</span></span>

## <a name="step-2-creating-a-data-access-layer-that-supports-optimistic-concurrency"></a><span data-ttu-id="9ece6-161">Etapa 2: criando uma camada de acesso a dados que dá suporte à simultaneidade otimista</span><span class="sxs-lookup"><span data-stu-id="9ece6-161">Step 2: Creating a Data Access Layer That Supports Optimistic Concurrency</span></span>

<span data-ttu-id="9ece6-162">Para criar um novo DataSet tipado, clique com o botão direito do mouse na pasta `DAL` dentro da pasta `App_Code` e adicione um novo conjunto de novos conjuntos de um nome `NorthwindOptimisticConcurrency`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-162">To create a new Typed DataSet, right-click on the `DAL` folder within the `App_Code` folder and add a new DataSet named `NorthwindOptimisticConcurrency`.</span></span> <span data-ttu-id="9ece6-163">Como vimos no primeiro tutorial, isso irá adicionar um novo TableAdapter ao DataSet tipado, iniciando automaticamente o assistente de configuração do TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="9ece6-163">As we saw in the first tutorial, doing so will add a new TableAdapter to the Typed DataSet, automatically launching the TableAdapter Configuration Wizard.</span></span> <span data-ttu-id="9ece6-164">Na primeira tela, é solicitado que você especifique o banco de dados para conectar-se ao mesmo banco de dados Northwind usando a configuração de `NORTHWNDConnectionString` de `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-164">In the first screen, we're prompted to specify the database to connect to - connect to the same Northwind database using the `NORTHWNDConnectionString` setting from `Web.config`.</span></span>

<span data-ttu-id="9ece6-165">[![conectar-se ao mesmo banco de dados Northwind](implementing-optimistic-concurrency-vb/_static/image8.png)](implementing-optimistic-concurrency-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-165">[![Connect to the Same Northwind Database](implementing-optimistic-concurrency-vb/_static/image8.png)](implementing-optimistic-concurrency-vb/_static/image7.png)</span></span>

<span data-ttu-id="9ece6-166">**Figura 3**: conectar-se ao mesmo banco de dados Northwind ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-166">**Figure 3**: Connect to the Same Northwind Database ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image9.png))</span></span>

<span data-ttu-id="9ece6-167">Em seguida, é solicitado que você veja como consultar os dados: por meio de uma instrução SQL ad hoc, um novo procedimento armazenado ou um procedimento armazenado existente.</span><span class="sxs-lookup"><span data-stu-id="9ece6-167">Next, we are prompted as to how to query the data: through an ad-hoc SQL statement, a new stored procedure, or an existing stored procedure.</span></span> <span data-ttu-id="9ece6-168">Como usamos consultas SQL ad hoc em nossa DAL original, use essa opção aqui também.</span><span class="sxs-lookup"><span data-stu-id="9ece6-168">Since we used ad-hoc SQL queries in our original DAL, use this option here as well.</span></span>

<span data-ttu-id="9ece6-169">[![especificar os dados a serem recuperados usando uma instrução SQL ad hoc](implementing-optimistic-concurrency-vb/_static/image11.png)](implementing-optimistic-concurrency-vb/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-169">[![Specify the Data to Retrieve Using an Ad-Hoc SQL Statement](implementing-optimistic-concurrency-vb/_static/image11.png)](implementing-optimistic-concurrency-vb/_static/image10.png)</span></span>

<span data-ttu-id="9ece6-170">**Figura 4**: especificar os dados a serem recuperados usando uma instrução SQL ad hoc ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-170">**Figure 4**: Specify the Data to Retrieve Using an Ad-Hoc SQL Statement ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image12.png))</span></span>

<span data-ttu-id="9ece6-171">Na tela a seguir, insira a consulta SQL a ser usada para recuperar as informações do produto.</span><span class="sxs-lookup"><span data-stu-id="9ece6-171">On the following screen, enter the SQL query to use to retrieve the product information.</span></span> <span data-ttu-id="9ece6-172">Vamos usar exatamente a mesma consulta SQL usada para o `Products` TableAdapter de nossa DAL original, que retorna todas as colunas de `Product` junto com os nomes de fornecedores e categorias do produto:</span><span class="sxs-lookup"><span data-stu-id="9ece6-172">Let's use the exact same SQL query used for the `Products` TableAdapter from our original DAL, which returns all of the `Product` columns along with the product's supplier and category names:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample2.sql)]

<span data-ttu-id="9ece6-173">[![usar a mesma consulta SQL do TableAdapter de produtos na DAL original](implementing-optimistic-concurrency-vb/_static/image14.png)](implementing-optimistic-concurrency-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-173">[![Use the Same SQL Query from the Products TableAdapter in the Original DAL](implementing-optimistic-concurrency-vb/_static/image14.png)](implementing-optimistic-concurrency-vb/_static/image13.png)</span></span>

<span data-ttu-id="9ece6-174">**Figura 5**: usar a mesma consulta SQL do `Products` TABLEADAPTER na Dal original ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-174">**Figure 5**: Use the Same SQL Query from the `Products` TableAdapter in the Original DAL ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image15.png))</span></span>

<span data-ttu-id="9ece6-175">Antes de passar para a próxima tela, clique no botão Opções avançadas.</span><span class="sxs-lookup"><span data-stu-id="9ece6-175">Before moving onto the next screen, click the Advanced Options button.</span></span> <span data-ttu-id="9ece6-176">Para que esse TableAdapter empregue o controle de simultaneidade otimista, basta marcar a caixa de seleção "usar simultaneidade otimista".</span><span class="sxs-lookup"><span data-stu-id="9ece6-176">To have this TableAdapter employ optimistic concurrency control, simply check the "Use optimistic concurrency" checkbox.</span></span>

<span data-ttu-id="9ece6-177">[![habilitar o controle de simultaneidade otimista marcando a caixa de seleção &quot;usar a simultaneidade otimista&quot;](implementing-optimistic-concurrency-vb/_static/image17.png)](implementing-optimistic-concurrency-vb/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-177">[![Enable Optimistic Concurrency Control by Checking the &quot;Use optimistic concurrency&quot; CheckBox](implementing-optimistic-concurrency-vb/_static/image17.png)](implementing-optimistic-concurrency-vb/_static/image16.png)</span></span>

<span data-ttu-id="9ece6-178">**Figura 6**: habilitar o controle de simultaneidade otimista marcando a caixa de seleção "usar simultaneidade otimista" ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-178">**Figure 6**: Enable Optimistic Concurrency Control by Checking the "Use optimistic concurrency" CheckBox ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image18.png))</span></span>

<span data-ttu-id="9ece6-179">Por fim, indique que o TableAdapter deve usar os padrões de acesso a dados que preenchem uma DataTable e retornam uma DataTable; Além disso, indique que os métodos diretos do banco de forma devem ser criados.</span><span class="sxs-lookup"><span data-stu-id="9ece6-179">Lastly, indicate that the TableAdapter should use the data access patterns that both fill a DataTable and return a DataTable; also indicate that the DB direct methods should be created.</span></span> <span data-ttu-id="9ece6-180">Altere o nome do método para o padrão Return a DataTable de GetData para GetProducts, para espelhar as convenções de nomenclatura que usamos em nossa DAL original.</span><span class="sxs-lookup"><span data-stu-id="9ece6-180">Change the method name for the Return a DataTable pattern from GetData to GetProducts, so as to mirror the naming conventions we used in our original DAL.</span></span>

<span data-ttu-id="9ece6-181">[![fazer com que o TableAdapter utilize todos os padrões de acesso a dados](implementing-optimistic-concurrency-vb/_static/image20.png)](implementing-optimistic-concurrency-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-181">[![Have the TableAdapter Utilize All Data Access Patterns](implementing-optimistic-concurrency-vb/_static/image20.png)](implementing-optimistic-concurrency-vb/_static/image19.png)</span></span>

<span data-ttu-id="9ece6-182">**Figura 7**: fazer com que o TableAdapter utilize todos os padrões de acesso a dados ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-182">**Figure 7**: Have the TableAdapter Utilize All Data Access Patterns ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image21.png))</span></span>

<span data-ttu-id="9ece6-183">Depois de concluir o assistente, o designer de conjunto de os incluirá uma DataTable de `Products` fortemente tipada e o TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="9ece6-183">After completing the wizard, the DataSet Designer will include a strongly-typed `Products` DataTable and TableAdapter.</span></span> <span data-ttu-id="9ece6-184">Reserve um tempo para renomear a DataTable de `Products` para `ProductsOptimisticConcurrency`, que você pode fazer clicando com o botão direito do mouse na barra de título da DataTable e escolhendo renomear no menu de contexto.</span><span class="sxs-lookup"><span data-stu-id="9ece6-184">Take a moment to rename the DataTable from `Products` to `ProductsOptimisticConcurrency`, which you can do by right-clicking on the DataTable's title bar and choosing Rename from the context menu.</span></span>

<span data-ttu-id="9ece6-185">[![uma DataTable e um TableAdapter foram adicionados ao DataSet tipado](implementing-optimistic-concurrency-vb/_static/image23.png)](implementing-optimistic-concurrency-vb/_static/image22.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-185">[![A DataTable and TableAdapter Have Been Added to the Typed DataSet](implementing-optimistic-concurrency-vb/_static/image23.png)](implementing-optimistic-concurrency-vb/_static/image22.png)</span></span>

<span data-ttu-id="9ece6-186">**Figura 8**: uma DataTable e um TableAdapter foram adicionados ao dataset tipado ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image24.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-186">**Figure 8**: A DataTable and TableAdapter Have Been Added to the Typed DataSet ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image24.png))</span></span>

<span data-ttu-id="9ece6-187">Para ver as diferenças entre as consultas `UPDATE` e `DELETE` entre o `ProductsOptimisticConcurrency` TableAdapter (que usa simultaneidade otimista) e o TableAdapter Products (que não é), clique no TableAdapter e vá para a janela Propriedades.</span><span class="sxs-lookup"><span data-stu-id="9ece6-187">To see the differences between the `UPDATE` and `DELETE` queries between the `ProductsOptimisticConcurrency` TableAdapter (which uses optimistic concurrency) and the Products TableAdapter (which doesn't), click on the TableAdapter and go to the Properties window.</span></span> <span data-ttu-id="9ece6-188">Nas propriedades `DeleteCommand` e `UpdateCommand` ' `CommandText` subpropriedades, você pode ver a sintaxe SQL real que é enviada ao banco de dados quando os métodos relacionados à atualização ou à exclusão da DAL são invocados.</span><span class="sxs-lookup"><span data-stu-id="9ece6-188">In the `DeleteCommand` and `UpdateCommand` properties' `CommandText` subproperties you can see the actual SQL syntax that is sent to the database when the DAL's update or delete-related methods are invoked.</span></span> <span data-ttu-id="9ece6-189">Para o `ProductsOptimisticConcurrency` TableAdapter, a instrução `DELETE` usada é:</span><span class="sxs-lookup"><span data-stu-id="9ece6-189">For the `ProductsOptimisticConcurrency` TableAdapter the `DELETE` statement used is:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample3.sql)]

<span data-ttu-id="9ece6-190">Enquanto a instrução de `DELETE` para o TableAdapter do produto em nossa DAL original é a mais simples:</span><span class="sxs-lookup"><span data-stu-id="9ece6-190">Whereas the `DELETE` statement for the Product TableAdapter in our original DAL is the much simpler:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-vb/samples/sample4.sql)]

<span data-ttu-id="9ece6-191">Como você pode ver, a cláusula `WHERE` na instrução `DELETE` do TableAdapter que usa a simultaneidade otimista inclui uma comparação entre cada um dos valores de coluna existentes da tabela `Product` e os valores originais no momento em que o GridView (ou DetailsView ou FormView) foi preenchido pela última vez.</span><span class="sxs-lookup"><span data-stu-id="9ece6-191">As you can see, the `WHERE` clause in the `DELETE` statement for the TableAdapter that uses optimistic concurrency includes a comparison between each of the `Product` table's existing column values and the original values at the time the GridView (or DetailsView or FormView) was last populated.</span></span> <span data-ttu-id="9ece6-192">Como todos os campos diferentes de `ProductID`, `ProductName`e `Discontinued` podem ter valores de `NULL`, parâmetros e verificações adicionais são incluídos para comparar corretamente os valores de `NULL` na cláusula `WHERE`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-192">Since all fields other than `ProductID`, `ProductName`, and `Discontinued` can have `NULL` values, additional parameters and checks are included to correctly compare `NULL` values in the `WHERE` clause.</span></span>

<span data-ttu-id="9ece6-193">Não adicionaremos nenhuma tabela adicional ao conjunto de dados habilitado para simultaneidade otimista para este tutorial, pois nossa página ASP.NET fornecerá apenas a atualização e a exclusão de informações do produto.</span><span class="sxs-lookup"><span data-stu-id="9ece6-193">We won't be adding any additional DataTables to the optimistic concurrency-enabled DataSet for this tutorial, as our ASP.NET page will only provide updating and deleting product information.</span></span> <span data-ttu-id="9ece6-194">No entanto, ainda precisamos adicionar o método `GetProductByProductID(productID)` ao TableAdapter do `ProductsOptimisticConcurrency`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-194">However, we do still need to add the `GetProductByProductID(productID)` method to the `ProductsOptimisticConcurrency` TableAdapter.</span></span>

<span data-ttu-id="9ece6-195">Para fazer isso, clique com o botão direito do mouse na barra de título do TableAdapter (a área à direita acima do `Fill` e `GetProducts` nomes de método) e escolha Adicionar consulta no menu de contexto.</span><span class="sxs-lookup"><span data-stu-id="9ece6-195">To accomplish this, right-click on the TableAdapter's title bar (the area right above the `Fill` and `GetProducts` method names) and choose Add Query from the context menu.</span></span> <span data-ttu-id="9ece6-196">Isso iniciará o assistente de configuração de consulta do TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="9ece6-196">This will launch the TableAdapter Query Configuration Wizard.</span></span> <span data-ttu-id="9ece6-197">Assim como na configuração inicial do TableAdapter, opte por criar o método de `GetProductByProductID(productID)` usando uma instrução SQL ad hoc (consulte a Figura 4).</span><span class="sxs-lookup"><span data-stu-id="9ece6-197">As with our TableAdapter's initial configuration, opt to create the `GetProductByProductID(productID)` method using an ad-hoc SQL statement (see Figure 4).</span></span> <span data-ttu-id="9ece6-198">Como o método `GetProductByProductID(productID)` retorna informações sobre um produto específico, indique que essa consulta é um tipo de consulta `SELECT` que retorna linhas.</span><span class="sxs-lookup"><span data-stu-id="9ece6-198">Since the `GetProductByProductID(productID)` method returns information about a particular product, indicate that this query is a `SELECT` query type that returns rows.</span></span>

<span data-ttu-id="9ece6-199">[![marcar o tipo de consulta como um &quot;selecione que retorna linhas&quot;](implementing-optimistic-concurrency-vb/_static/image26.png)](implementing-optimistic-concurrency-vb/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-199">[![Mark the Query Type as a &quot;SELECT which returns rows&quot;](implementing-optimistic-concurrency-vb/_static/image26.png)](implementing-optimistic-concurrency-vb/_static/image25.png)</span></span>

<span data-ttu-id="9ece6-200">**Figura 9**: marcar o tipo de consulta como um "`SELECT` que retorna linhas" ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image27.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-200">**Figure 9**: Mark the Query Type as a "`SELECT` which returns rows" ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image27.png))</span></span>

<span data-ttu-id="9ece6-201">Na próxima tela, é solicitado que a consulta SQL use, com a consulta padrão do TableAdapter carregada previamente.</span><span class="sxs-lookup"><span data-stu-id="9ece6-201">On the next screen we're prompted for the SQL query to use, with the TableAdapter's default query pre-loaded.</span></span> <span data-ttu-id="9ece6-202">Aumente a consulta existente para incluir a cláusula `WHERE ProductID = @ProductID`, conforme mostrado na Figura 10.</span><span class="sxs-lookup"><span data-stu-id="9ece6-202">Augment the existing query to include the clause `WHERE ProductID = @ProductID`, as shown in Figure 10.</span></span>

<span data-ttu-id="9ece6-203">[![adicionar uma cláusula WHERE à consulta pré-carregada para retornar um registro de produto específico](implementing-optimistic-concurrency-vb/_static/image29.png)](implementing-optimistic-concurrency-vb/_static/image28.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-203">[![Add a WHERE Clause to the Pre-Loaded Query to Return a Specific Product Record](implementing-optimistic-concurrency-vb/_static/image29.png)](implementing-optimistic-concurrency-vb/_static/image28.png)</span></span>

<span data-ttu-id="9ece6-204">**Figura 10**: adicionar uma cláusula `WHERE` à consulta pré-carregada para retornar um registro de produto específico ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image30.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-204">**Figure 10**: Add a `WHERE` Clause to the Pre-Loaded Query to Return a Specific Product Record ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image30.png))</span></span>

<span data-ttu-id="9ece6-205">Por fim, altere os nomes de métodos gerados para `FillByProductID` e `GetProductByProductID`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-205">Finally, change the generated method names to `FillByProductID` and `GetProductByProductID`.</span></span>

<span data-ttu-id="9ece6-206">[![renomear os métodos como FillByProductID e GetProductByProductID](implementing-optimistic-concurrency-vb/_static/image32.png)](implementing-optimistic-concurrency-vb/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-206">[![Rename the Methods to FillByProductID and GetProductByProductID](implementing-optimistic-concurrency-vb/_static/image32.png)](implementing-optimistic-concurrency-vb/_static/image31.png)</span></span>

<span data-ttu-id="9ece6-207">**Figura 11**: renomear os métodos para `FillByProductID` e `GetProductByProductID` ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image33.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-207">**Figure 11**: Rename the Methods to `FillByProductID` and `GetProductByProductID` ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image33.png))</span></span>

<span data-ttu-id="9ece6-208">Com esse assistente concluído, o TableAdapter agora contém dois métodos para recuperar dados: `GetProducts()`, que retorna *todos os* produtos; e `GetProductByProductID(productID)`, que retorna o produto especificado.</span><span class="sxs-lookup"><span data-stu-id="9ece6-208">With this wizard complete, the TableAdapter now contains two methods for retrieving data: `GetProducts()`, which returns *all* products; and `GetProductByProductID(productID)`, which returns the specified product.</span></span>

## <a name="step-3-creating-a-business-logic-layer-for-the-optimistic-concurrency-enabled-dal"></a><span data-ttu-id="9ece6-209">Etapa 3: criando uma camada de lógica de negócios para a DAL otimista habilitada para simultaneidade</span><span class="sxs-lookup"><span data-stu-id="9ece6-209">Step 3: Creating a Business Logic Layer for the Optimistic Concurrency-Enabled DAL</span></span>

<span data-ttu-id="9ece6-210">Nossa classe de `ProductsBLL` existente tem exemplos de como usar os padrões de atualização do lote e do BD Direct.</span><span class="sxs-lookup"><span data-stu-id="9ece6-210">Our existing `ProductsBLL` class has examples of using both the batch update and DB direct patterns.</span></span> <span data-ttu-id="9ece6-211">O método `AddProduct` e `UpdateProduct` sobrecargas usam o padrão de atualização do lote, passando uma instância `ProductRow` para o método Update do TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="9ece6-211">The `AddProduct` method and `UpdateProduct` overloads both use the batch update pattern, passing in a `ProductRow` instance to the TableAdapter's Update method.</span></span> <span data-ttu-id="9ece6-212">O método `DeleteProduct`, por outro lado, usa o padrão DB Direct, chamando o método `Delete(productID)` do TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="9ece6-212">The `DeleteProduct` method, on the other hand, uses the DB direct pattern, calling the TableAdapter's `Delete(productID)` method.</span></span>

<span data-ttu-id="9ece6-213">Com o novo `ProductsOptimisticConcurrency` TableAdapter, os métodos do DB Direct agora exigem que os valores originais também sejam passados.</span><span class="sxs-lookup"><span data-stu-id="9ece6-213">With the new `ProductsOptimisticConcurrency` TableAdapter, the DB direct methods now require that the original values also be passed in.</span></span> <span data-ttu-id="9ece6-214">Por exemplo, o método `Delete` agora espera dez parâmetros de entrada: o `ProductID`original, `ProductName`, `SupplierID`, `CategoryID`, `QuantityPerUnit`, `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, `ReorderLevel`e `Discontinued`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-214">For example, the `Delete` method now expects ten input parameters: the original `ProductID`, `ProductName`, `SupplierID`, `CategoryID`, `QuantityPerUnit`, `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, `ReorderLevel`, and `Discontinued`.</span></span> <span data-ttu-id="9ece6-215">Ele usa esses valores de parâmetros de entrada adicionais na cláusula `WHERE` da instrução `DELETE` enviada ao banco de dados, excluindo apenas o registro especificado se os valores atuais do banco de dados forem mapeados para os originais.</span><span class="sxs-lookup"><span data-stu-id="9ece6-215">It uses these additional input parameters' values in `WHERE` clause of the `DELETE` statement sent to the database, only deleting the specified record if the database's current values map up to the original ones.</span></span>

<span data-ttu-id="9ece6-216">Embora a assinatura do método para o método `Update` do TableAdapter usado no padrão de atualização do lote não tenha sido alterada, o código necessário para registrar os valores originais e novos tem.</span><span class="sxs-lookup"><span data-stu-id="9ece6-216">While the method signature for the TableAdapter's `Update` method used in the batch update pattern hasn't changed, the code needed to record the original and new values has.</span></span> <span data-ttu-id="9ece6-217">Portanto, em vez de tentar usar a DAL otimista habilitada para simultaneidade com nossa classe de `ProductsBLL` existente, vamos criar uma nova classe de camada de lógica de negócios para trabalhar com nossa nova DAL.</span><span class="sxs-lookup"><span data-stu-id="9ece6-217">Therefore, rather than attempt to use the optimistic concurrency-enabled DAL with our existing `ProductsBLL` class, let's create a new Business Logic Layer class for working with our new DAL.</span></span>

<span data-ttu-id="9ece6-218">Adicione uma classe chamada `ProductsOptimisticConcurrencyBLL` à pasta `BLL` dentro da pasta `App_Code`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-218">Add a class named `ProductsOptimisticConcurrencyBLL` to the `BLL` folder within the `App_Code` folder.</span></span>

![Adicionar a classe ProductsOptimisticConcurrencyBLL à pasta BLL](implementing-optimistic-concurrency-vb/_static/image34.png)

<span data-ttu-id="9ece6-220">**Figura 12**: adicionar a classe `ProductsOptimisticConcurrencyBLL` à pasta BLL</span><span class="sxs-lookup"><span data-stu-id="9ece6-220">**Figure 12**: Add the `ProductsOptimisticConcurrencyBLL` Class to the BLL Folder</span></span>

<span data-ttu-id="9ece6-221">Em seguida, adicione o seguinte código à classe `ProductsOptimisticConcurrencyBLL`:</span><span class="sxs-lookup"><span data-stu-id="9ece6-221">Next, add the following code to the `ProductsOptimisticConcurrencyBLL` class:</span></span>

[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample5.vb)]

<span data-ttu-id="9ece6-222">Observe a instrução using `NorthwindOptimisticConcurrencyTableAdapters` acima do início da declaração de classe.</span><span class="sxs-lookup"><span data-stu-id="9ece6-222">Note the using `NorthwindOptimisticConcurrencyTableAdapters` statement above the start of the class declaration.</span></span> <span data-ttu-id="9ece6-223">O namespace `NorthwindOptimisticConcurrencyTableAdapters` contém a classe `ProductsOptimisticConcurrencyTableAdapter`, que fornece os métodos da DAL.</span><span class="sxs-lookup"><span data-stu-id="9ece6-223">The `NorthwindOptimisticConcurrencyTableAdapters` namespace contains the `ProductsOptimisticConcurrencyTableAdapter` class, which provides the DAL's methods.</span></span> <span data-ttu-id="9ece6-224">Além disso, antes da declaração de classe, você encontrará o atributo `System.ComponentModel.DataObject`, que instrui o Visual Studio a incluir essa classe na lista suspensa do assistente ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="9ece6-224">Also before the class declaration you'll find the `System.ComponentModel.DataObject` attribute, which instructs Visual Studio to include this class in the ObjectDataSource wizard's drop-down list.</span></span>

<span data-ttu-id="9ece6-225">A propriedade `Adapter` do `ProductsOptimisticConcurrencyBLL`fornece acesso rápido a uma instância da classe `ProductsOptimisticConcurrencyTableAdapter` e segue o padrão usado em nossas classes BLL originais (`ProductsBLL`, `CategoriesBLL`e assim por diante).</span><span class="sxs-lookup"><span data-stu-id="9ece6-225">The `ProductsOptimisticConcurrencyBLL`'s `Adapter` property provides quick access to an instance of the `ProductsOptimisticConcurrencyTableAdapter` class, and follows the pattern used in our original BLL classes (`ProductsBLL`, `CategoriesBLL`, and so on).</span></span> <span data-ttu-id="9ece6-226">Finalmente, o método `GetProducts()` simplesmente chama o método `GetProducts()` da DAL e retorna um objeto `ProductsOptimisticConcurrencyDataTable` populado com uma instância `ProductsOptimisticConcurrencyRow` para cada registro de produto no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="9ece6-226">Finally, the `GetProducts()` method simply calls down into the DAL's `GetProducts()` method and returns a `ProductsOptimisticConcurrencyDataTable` object populated with a `ProductsOptimisticConcurrencyRow` instance for each product record in the database.</span></span>

## <a name="deleting-a-product-using-the-db-direct-pattern-with-optimistic-concurrency"></a><span data-ttu-id="9ece6-227">Excluindo um produto usando o padrão de BD direto com simultaneidade otimista</span><span class="sxs-lookup"><span data-stu-id="9ece6-227">Deleting a Product Using the DB Direct Pattern with Optimistic Concurrency</span></span>

<span data-ttu-id="9ece6-228">Ao usar o padrão de BD direto em uma DAL que usa simultaneidade otimista, os métodos devem ser passados para os valores novos e originais.</span><span class="sxs-lookup"><span data-stu-id="9ece6-228">When using the DB direct pattern against a DAL that uses optimistic concurrency, the methods must be passed the new and original values.</span></span> <span data-ttu-id="9ece6-229">Para excluir, não há nenhum novo valor, portanto, somente os valores originais precisam ser passados.</span><span class="sxs-lookup"><span data-stu-id="9ece6-229">For deleting, there are no new values, so only the original values need be passed in.</span></span> <span data-ttu-id="9ece6-230">Em nossa BLL, devemos aceitar todos os parâmetros originais como parâmetros de entrada.</span><span class="sxs-lookup"><span data-stu-id="9ece6-230">In our BLL, then, we must accept all of the original parameters as input parameters.</span></span> <span data-ttu-id="9ece6-231">Vamos ter o método `DeleteProduct` na classe `ProductsOptimisticConcurrencyBLL` usar o método DB Direct.</span><span class="sxs-lookup"><span data-stu-id="9ece6-231">Let's have the `DeleteProduct` method in the `ProductsOptimisticConcurrencyBLL` class use the DB direct method.</span></span> <span data-ttu-id="9ece6-232">Isso significa que esse método precisa executar todos os dez campos de dados de produto como parâmetros de entrada e passá-los para a DAL, conforme mostrado no código a seguir:</span><span class="sxs-lookup"><span data-stu-id="9ece6-232">This means that this method needs to take in all ten product data fields as input parameters, and pass these to the DAL, as shown in the following code:</span></span>

[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample6.vb)]

<span data-ttu-id="9ece6-233">Se os valores originais-os valores que foram carregados pela última vez no GridView (ou DetailsView ou FormView)-forem diferentes dos valores no banco de dados quando o usuário clicar no botão excluir, a cláusula `WHERE` não corresponderá a nenhum registro de banco de dados e os registros não serão afetados.</span><span class="sxs-lookup"><span data-stu-id="9ece6-233">If the original values - those values that were last loaded into the GridView (or DetailsView or FormView) - differ from the values in the database when the user clicks the Delete button the `WHERE` clause won't match up with any database record and no records will be affected.</span></span> <span data-ttu-id="9ece6-234">Portanto, o método `Delete` do TableAdapter retornará `0` e o método `DeleteProduct` da BLL retornará `false`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-234">Hence, the TableAdapter's `Delete` method will return `0` and the BLL's `DeleteProduct` method will return `false`.</span></span>

## <a name="updating-a-product-using-the-batch-update-pattern-with-optimistic-concurrency"></a><span data-ttu-id="9ece6-235">Atualizando um produto usando o padrão de atualização do lote com simultaneidade otimista</span><span class="sxs-lookup"><span data-stu-id="9ece6-235">Updating a Product Using the Batch Update Pattern with Optimistic Concurrency</span></span>

<span data-ttu-id="9ece6-236">Conforme observado anteriormente, o método `Update` do TableAdapter para o padrão de atualização do lote tem a mesma assinatura de método, independentemente de a simultaneidade otimista ser empregada ou não.</span><span class="sxs-lookup"><span data-stu-id="9ece6-236">As noted earlier, the TableAdapter's `Update` method for the batch update pattern has the same method signature regardless of whether or not optimistic concurrency is employed.</span></span> <span data-ttu-id="9ece6-237">Ou seja, o método `Update` espera uma DataRow, uma matriz de DataRows, uma DataTable ou um DataSet tipado.</span><span class="sxs-lookup"><span data-stu-id="9ece6-237">Namely, the `Update` method expects a DataRow, an array of DataRows, a DataTable, or a Typed DataSet.</span></span> <span data-ttu-id="9ece6-238">Não há parâmetros de entrada adicionais para especificar os valores originais.</span><span class="sxs-lookup"><span data-stu-id="9ece6-238">There are no additional input parameters for specifying the original values.</span></span> <span data-ttu-id="9ece6-239">Isso é possível porque a DataTable controla os valores originais e modificados para suas DataRows.</span><span class="sxs-lookup"><span data-stu-id="9ece6-239">This is possible because the DataTable keeps track of the original and modified values for its DataRow(s).</span></span> <span data-ttu-id="9ece6-240">Quando a DAL emite sua instrução `UPDATE`, os parâmetros `@original_ColumnName` são populados com os valores originais da DataRow, enquanto os parâmetros `@ColumnName` são populados com os valores modificados da DataRow.</span><span class="sxs-lookup"><span data-stu-id="9ece6-240">When the DAL issues its `UPDATE` statement, the `@original_ColumnName` parameters are populated with the DataRow's original values, whereas the `@ColumnName` parameters are populated with the DataRow's modified values.</span></span>

<span data-ttu-id="9ece6-241">Na classe `ProductsBLL` (que usa nossa DAL de simultaneidade original e não otimista), ao usar o padrão de atualização do lote para atualizar as informações do produto, nosso código executa a seguinte sequência de eventos:</span><span class="sxs-lookup"><span data-stu-id="9ece6-241">In the `ProductsBLL` class (which uses our original, non-optimistic concurrency DAL), when using the batch update pattern to update product information our code performs the following sequence of events:</span></span>

1. <span data-ttu-id="9ece6-242">Ler as informações do produto do banco de dados atual em uma instância `ProductRow` usando o método `GetProductByProductID(productID)` do TableAdapter</span><span class="sxs-lookup"><span data-stu-id="9ece6-242">Read the current database product information into a `ProductRow` instance using the TableAdapter's `GetProductByProductID(productID)` method</span></span>
2. <span data-ttu-id="9ece6-243">Atribua os novos valores à instância de `ProductRow` da etapa 1</span><span class="sxs-lookup"><span data-stu-id="9ece6-243">Assign the new values to the `ProductRow` instance from Step 1</span></span>
3. <span data-ttu-id="9ece6-244">Chame o método `Update` do TableAdapter, passando a instância `ProductRow`</span><span class="sxs-lookup"><span data-stu-id="9ece6-244">Call the TableAdapter's `Update` method, passing in the `ProductRow` instance</span></span>

<span data-ttu-id="9ece6-245">Essa sequência de etapas, no entanto, não dará suporte corretamente à simultaneidade otimista porque a `ProductRow` populada na etapa 1 é preenchida diretamente do banco de dados, o que significa que os valores originais usados pela DataRow são aqueles que existem atualmente no banco de dados, e não aqueles que foram associados ao GridView no início do processo de edição.</span><span class="sxs-lookup"><span data-stu-id="9ece6-245">This sequence of steps, however, won't correctly support optimistic concurrency because the `ProductRow` populated in Step 1 is populated directly from the database, meaning that the original values used by the DataRow are those that currently exist in the database, and not those that were bound to the GridView at the start of the editing process.</span></span> <span data-ttu-id="9ece6-246">Em vez disso, ao usar uma DAL otimista habilitada para simultaneidade, precisamos alterar o `UpdateProduct` sobrecargas do método para usar as seguintes etapas:</span><span class="sxs-lookup"><span data-stu-id="9ece6-246">Instead, when using an optimistic concurrency-enabled DAL, we need to alter the `UpdateProduct` method overloads to use the following steps:</span></span>

1. <span data-ttu-id="9ece6-247">Ler as informações do produto do banco de dados atual em uma instância `ProductsOptimisticConcurrencyRow` usando o método `GetProductByProductID(productID)` do TableAdapter</span><span class="sxs-lookup"><span data-stu-id="9ece6-247">Read the current database product information into a `ProductsOptimisticConcurrencyRow` instance using the TableAdapter's `GetProductByProductID(productID)` method</span></span>
2. <span data-ttu-id="9ece6-248">Atribua os valores *originais* à instância de `ProductsOptimisticConcurrencyRow` da etapa 1</span><span class="sxs-lookup"><span data-stu-id="9ece6-248">Assign the *original* values to the `ProductsOptimisticConcurrencyRow` instance from Step 1</span></span>
3. <span data-ttu-id="9ece6-249">Chame o método `AcceptChanges()` da instância de `ProductsOptimisticConcurrencyRow`, que instrui a DataRow de que seus valores atuais são os "originais"</span><span class="sxs-lookup"><span data-stu-id="9ece6-249">Call the `ProductsOptimisticConcurrencyRow` instance's `AcceptChanges()` method, which instructs the DataRow that its current values are the "original" ones</span></span>
4. <span data-ttu-id="9ece6-250">Atribuir os *novos* valores à instância de `ProductsOptimisticConcurrencyRow`</span><span class="sxs-lookup"><span data-stu-id="9ece6-250">Assign the *new* values to the `ProductsOptimisticConcurrencyRow` instance</span></span>
5. <span data-ttu-id="9ece6-251">Chame o método `Update` do TableAdapter, passando a instância `ProductsOptimisticConcurrencyRow`</span><span class="sxs-lookup"><span data-stu-id="9ece6-251">Call the TableAdapter's `Update` method, passing in the `ProductsOptimisticConcurrencyRow` instance</span></span>

<span data-ttu-id="9ece6-252">A etapa 1 lê todos os valores de banco de dados atuais para o registro de produto especificado.</span><span class="sxs-lookup"><span data-stu-id="9ece6-252">Step 1 reads in all of the current database values for the specified product record.</span></span> <span data-ttu-id="9ece6-253">Essa etapa é supérflua na sobrecarga de `UpdateProduct` que atualiza *todas* as colunas de produto (pois esses valores são substituídos na etapa 2), mas é essencial para essas sobrecargas em que apenas um subconjunto dos valores de coluna é passado como parâmetros de entrada.</span><span class="sxs-lookup"><span data-stu-id="9ece6-253">This step is superfluous in the `UpdateProduct` overload that updates *all* of the product columns (as these values are overwritten in Step 2), but is essential for those overloads where only a subset of the column values are passed in as input parameters.</span></span> <span data-ttu-id="9ece6-254">Depois que os valores originais tiverem sido atribuídos à instância de `ProductsOptimisticConcurrencyRow`, o método `AcceptChanges()` será chamado, que marca os valores de DataRow atuais como os valores originais a serem usados nos parâmetros de `@original_ColumnName` na instrução `UPDATE`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-254">Once the original values have been assigned to the `ProductsOptimisticConcurrencyRow` instance, the `AcceptChanges()` method is called, which marks the current DataRow values as the original values to be used in the `@original_ColumnName` parameters in the `UPDATE` statement.</span></span> <span data-ttu-id="9ece6-255">Em seguida, os novos valores de parâmetro são atribuídos à `ProductsOptimisticConcurrencyRow` e, finalmente, o método `Update` é invocado, passando o DataRow.</span><span class="sxs-lookup"><span data-stu-id="9ece6-255">Next, the new parameter values are assigned to the `ProductsOptimisticConcurrencyRow` and, finally, the `Update` method is invoked, passing in the DataRow.</span></span>

<span data-ttu-id="9ece6-256">O código a seguir mostra a sobrecarga de `UpdateProduct` que aceita todos os campos de dados de produto como parâmetros de entrada.</span><span class="sxs-lookup"><span data-stu-id="9ece6-256">The following code shows the `UpdateProduct` overload that accepts all product data fields as input parameters.</span></span> <span data-ttu-id="9ece6-257">Embora não seja mostrado aqui, a classe `ProductsOptimisticConcurrencyBLL` incluída no download para este tutorial também contém uma sobrecarga `UpdateProduct` que aceita apenas o nome e o preço do produto como parâmetros de entrada.</span><span class="sxs-lookup"><span data-stu-id="9ece6-257">While not shown here, the `ProductsOptimisticConcurrencyBLL` class included in the download for this tutorial also contains an `UpdateProduct` overload that accepts just the product's name and price as input parameters.</span></span>

[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample7.vb)]

## <a name="step-4-passing-the-original-and-new-values-from-the-aspnet-page-to-the-bll-methods"></a><span data-ttu-id="9ece6-258">Etapa 4: passando os valores originais e novos da página ASP.NET para os métodos de BLL</span><span class="sxs-lookup"><span data-stu-id="9ece6-258">Step 4: Passing the Original and New Values From the ASP.NET Page to the BLL Methods</span></span>

<span data-ttu-id="9ece6-259">Com a DAL e a BLL concluídas, tudo o que resta é criar uma página ASP.NET que possa utilizar a lógica de simultaneidade otimista interna no sistema.</span><span class="sxs-lookup"><span data-stu-id="9ece6-259">With the DAL and BLL complete, all that remains is to create an ASP.NET page that can utilize the optimistic concurrency logic built in to the system.</span></span> <span data-ttu-id="9ece6-260">Especificamente, o controle da Web de dados (GridView, DetailsView ou FormView) deve se lembrar de seus valores originais e o ObjectDataSource deve passar os dois conjuntos de valores para a camada de lógica de negócios.</span><span class="sxs-lookup"><span data-stu-id="9ece6-260">Specifically, the data Web control (the GridView, DetailsView, or FormView) must remember its original values and the ObjectDataSource must pass both sets of values to the Business Logic Layer.</span></span> <span data-ttu-id="9ece6-261">Além disso, a página ASP.NET deve ser configurada para lidar normalmente com violações de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="9ece6-261">Furthermore, the ASP.NET page must be configured to gracefully handle concurrency violations.</span></span>

<span data-ttu-id="9ece6-262">Comece abrindo a página de `OptimisticConcurrency.aspx` na pasta `EditInsertDelete` e adicionando um GridView ao designer, definindo sua propriedade `ID` como `ProductsGrid`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-262">Start by opening the `OptimisticConcurrency.aspx` page in the `EditInsertDelete` folder and adding a GridView to the Designer, setting its `ID` property to `ProductsGrid`.</span></span> <span data-ttu-id="9ece6-263">Na marca inteligente do GridView, opte por criar um novo ObjectDataSource chamado `ProductsOptimisticConcurrencyDataSource`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-263">From the GridView's smart tag, opt to create a new ObjectDataSource named `ProductsOptimisticConcurrencyDataSource`.</span></span> <span data-ttu-id="9ece6-264">Como queremos que esse ObjectDataSource use a DAL que dá suporte à simultaneidade otimista, configure-a para usar o objeto `ProductsOptimisticConcurrencyBLL`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-264">Since we want this ObjectDataSource to use the DAL that supports optimistic concurrency, configure it to use the `ProductsOptimisticConcurrencyBLL` object.</span></span>

<span data-ttu-id="9ece6-265">[![fazer com que o ObjectDataSource use o objeto ProductsOptimisticConcurrencyBLL](implementing-optimistic-concurrency-vb/_static/image36.png)](implementing-optimistic-concurrency-vb/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-265">[![Have the ObjectDataSource Use the ProductsOptimisticConcurrencyBLL Object](implementing-optimistic-concurrency-vb/_static/image36.png)](implementing-optimistic-concurrency-vb/_static/image35.png)</span></span>

<span data-ttu-id="9ece6-266">**Figura 13**: fazer com que o ObjectDataSource use o objeto `ProductsOptimisticConcurrencyBLL` ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image37.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-266">**Figure 13**: Have the ObjectDataSource Use the `ProductsOptimisticConcurrencyBLL` Object ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image37.png))</span></span>

<span data-ttu-id="9ece6-267">Escolha os métodos `GetProducts`, `UpdateProduct`e `DeleteProduct` nas listas suspensas no assistente.</span><span class="sxs-lookup"><span data-stu-id="9ece6-267">Choose the `GetProducts`, `UpdateProduct`, and `DeleteProduct` methods from drop-down lists in the wizard.</span></span> <span data-ttu-id="9ece6-268">Para o método UpdateProduct, use a sobrecarga que aceita todos os campos de dados do produto.</span><span class="sxs-lookup"><span data-stu-id="9ece6-268">For the UpdateProduct method, use the overload that accepts all of the product's data fields.</span></span>

## <a name="configuring-the-objectdatasource-controls-properties"></a><span data-ttu-id="9ece6-269">Configurando as propriedades do controle ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="9ece6-269">Configuring the ObjectDataSource Control's Properties</span></span>

<span data-ttu-id="9ece6-270">Depois de concluir o assistente, a marcação declarativa do ObjectDataSource deve ser semelhante ao seguinte:</span><span class="sxs-lookup"><span data-stu-id="9ece6-270">After completing the wizard, the ObjectDataSource's declarative markup should look like the following:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample8.aspx)]

<span data-ttu-id="9ece6-271">Como você pode ver, a coleção de `DeleteParameters` contém uma instância de `Parameter` para cada um dos dez parâmetros de entrada no método `DeleteProduct` da classe `ProductsOptimisticConcurrencyBLL`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-271">As you can see, the `DeleteParameters` collection contains a `Parameter` instance for each of the ten input parameters in the `ProductsOptimisticConcurrencyBLL` class's `DeleteProduct` method.</span></span> <span data-ttu-id="9ece6-272">Da mesma forma, a coleção de `UpdateParameters` contém uma instância de `Parameter` para cada um dos parâmetros de entrada no `UpdateProduct`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-272">Likewise, the `UpdateParameters` collection contains a `Parameter` instance for each of the input parameters in `UpdateProduct`.</span></span>

<span data-ttu-id="9ece6-273">Para os tutoriais anteriores que envolvevam a modificação de dados, removemos a propriedade de `OldValuesParameterFormatString` do ObjectDataSource neste ponto, pois essa propriedade indica que o método BLL espera que os valores antigos (ou originais) sejam passados, bem como os novos valores.</span><span class="sxs-lookup"><span data-stu-id="9ece6-273">For those previous tutorials that involved data modification, we'd remove the ObjectDataSource's `OldValuesParameterFormatString` property at this point, since this property indicates that the BLL method expects the old (or original) values to be passed in as well as the new values.</span></span> <span data-ttu-id="9ece6-274">Além disso, esse valor de propriedade indica os nomes de parâmetro de entrada para os valores originais.</span><span class="sxs-lookup"><span data-stu-id="9ece6-274">Furthermore, this property value indicates the input parameter names for the original values.</span></span> <span data-ttu-id="9ece6-275">Como estamos passando os valores originais para a BLL, *não* remova essa propriedade.</span><span class="sxs-lookup"><span data-stu-id="9ece6-275">Since we are passing in the original values into the BLL, do *not* remove this property.</span></span>

> [!NOTE]
> <span data-ttu-id="9ece6-276">O valor da propriedade `OldValuesParameterFormatString` deve mapear para os nomes de parâmetro de entrada na BLL que esperam os valores originais.</span><span class="sxs-lookup"><span data-stu-id="9ece6-276">The value of the `OldValuesParameterFormatString` property must map to the input parameter names in the BLL that expect the original values.</span></span> <span data-ttu-id="9ece6-277">Como nomeamos esses parâmetros `original_productName`, `original_supplierID`e assim por diante, você pode deixar o valor da propriedade `OldValuesParameterFormatString` como `original_{0}`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-277">Since we named these parameters `original_productName`, `original_supplierID`, and so on, you can leave the `OldValuesParameterFormatString` property value as `original_{0}`.</span></span> <span data-ttu-id="9ece6-278">No entanto, se os parâmetros de entrada dos métodos de BLL tivessem nomes como `old_productName`, `old_supplierID`e assim por diante, você precisará atualizar a propriedade `OldValuesParameterFormatString` para `old_{0}`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-278">If, however, the BLL methods' input parameters had names like `old_productName`, `old_supplierID`, and so on, you'd need to update the `OldValuesParameterFormatString` property to `old_{0}`.</span></span>

<span data-ttu-id="9ece6-279">Há uma configuração de propriedade final que precisa ser feita para que o ObjectDataSource passe corretamente os valores originais para os métodos de BLL.</span><span class="sxs-lookup"><span data-stu-id="9ece6-279">There's one final property setting that needs to be made in order for the ObjectDataSource to correctly pass the original values to the BLL methods.</span></span> <span data-ttu-id="9ece6-280">O ObjectDataSource tem uma [propriedade ConflictDetection](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.conflictdetection.aspx) que pode ser atribuída a [um dos dois valores](https://msdn.microsoft.com/library/system.web.ui.conflictoptions.aspx):</span><span class="sxs-lookup"><span data-stu-id="9ece6-280">The ObjectDataSource has a [ConflictDetection property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.conflictdetection.aspx) that can be assigned to [one of two values](https://msdn.microsoft.com/library/system.web.ui.conflictoptions.aspx):</span></span>

- <span data-ttu-id="9ece6-281">`OverwriteChanges`-o valor padrão; não envia os valores originais para os parâmetros de entrada originais dos métodos de BLL</span><span class="sxs-lookup"><span data-stu-id="9ece6-281">`OverwriteChanges` - the default value; does not send the original values to the BLL methods' original input parameters</span></span>
- <span data-ttu-id="9ece6-282">`CompareAllValues`-envia os valores originais para os métodos de BLL; Escolha esta opção ao usar a simultaneidade otimista</span><span class="sxs-lookup"><span data-stu-id="9ece6-282">`CompareAllValues` - does send the original values to the BLL methods; choose this option when using optimistic concurrency</span></span>

<span data-ttu-id="9ece6-283">Reserve um momento para definir a propriedade `ConflictDetection` como `CompareAllValues`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-283">Take a moment to set the `ConflictDetection` property to `CompareAllValues`.</span></span>

## <a name="configuring-the-gridviews-properties-and-fields"></a><span data-ttu-id="9ece6-284">Configurando as propriedades e os campos de GridView</span><span class="sxs-lookup"><span data-stu-id="9ece6-284">Configuring the GridView's Properties and Fields</span></span>

<span data-ttu-id="9ece6-285">Com as propriedades do ObjectDataSource configuradas corretamente, vamos voltar nossa atenção para configurar o GridView.</span><span class="sxs-lookup"><span data-stu-id="9ece6-285">With the ObjectDataSource's properties properly configured, let's turn our attention to setting up the GridView.</span></span> <span data-ttu-id="9ece6-286">Primeiro, como queremos que o GridView dê suporte à edição e exclusão, clique nas caixas de seleção Habilitar edição e habilitar exclusão na marca inteligente do GridView.</span><span class="sxs-lookup"><span data-stu-id="9ece6-286">First, since we want the GridView to support editing and deleting, click the Enable Editing and Enable Deleting checkboxes from the GridView's smart tag.</span></span> <span data-ttu-id="9ece6-287">Isso adicionará um CommandField cujos `ShowEditButton` e `ShowDeleteButton` estão definidos como `true`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-287">This will add a CommandField whose `ShowEditButton` and `ShowDeleteButton` are both set to `true`.</span></span>

<span data-ttu-id="9ece6-288">Quando associado ao `ProductsOptimisticConcurrencyDataSource` ObjectDataSource, o GridView contém um campo para cada um dos campos de dados do produto.</span><span class="sxs-lookup"><span data-stu-id="9ece6-288">When bound to the `ProductsOptimisticConcurrencyDataSource` ObjectDataSource, the GridView contains a field for each of the product's data fields.</span></span> <span data-ttu-id="9ece6-289">Embora tal GridView possa ser editada, a experiência do usuário é qualquer coisa, mas aceitável.</span><span class="sxs-lookup"><span data-stu-id="9ece6-289">While such a GridView can be edited, the user experience is anything but acceptable.</span></span> <span data-ttu-id="9ece6-290">O `CategoryID` e o `SupplierID` BoundFields serão renderizados como caixas de Text, exigindo que o usuário insira a categoria e o fornecedor apropriados como números de identificação.</span><span class="sxs-lookup"><span data-stu-id="9ece6-290">The `CategoryID` and `SupplierID` BoundFields will render as TextBoxes, requiring the user to enter the appropriate category and supplier as ID numbers.</span></span> <span data-ttu-id="9ece6-291">Não haverá formatação para os campos numéricos e nenhum controle de validação para garantir que o nome do produto tenha sido fornecido e que o preço unitário, as unidades em estoque, as unidades em ordem e os valores de nível de reordenação sejam valores numéricos adequados e sejam maiores ou iguais para zero.</span><span class="sxs-lookup"><span data-stu-id="9ece6-291">There will be no formatting for the numeric fields and no validation controls to ensure that the product's name has been supplied and that the unit price, units in stock, units on order, and reorder level values are both proper numeric values and are greater than or equal to zero.</span></span>

<span data-ttu-id="9ece6-292">Como discutimos na *adição de controles de validação para as interfaces de edição e inserção* e *personalização dos tutoriais da interface de modificação de dados* , a interface do usuário pode ser personalizada por meio da substituição de boundfields por TemplateFields.</span><span class="sxs-lookup"><span data-stu-id="9ece6-292">As we discussed in the *Adding Validation Controls to the Editing and Inserting Interfaces* and *Customizing the Data Modification Interface* tutorials, the user interface can be customized by replacing the BoundFields with TemplateFields.</span></span> <span data-ttu-id="9ece6-293">Modifiquei este GridView e sua interface de edição das seguintes maneiras:</span><span class="sxs-lookup"><span data-stu-id="9ece6-293">I've modified this GridView and its editing interface in the following ways:</span></span>

- <span data-ttu-id="9ece6-294">Removidas as `ProductID`, `SupplierName`e `CategoryName` BoundFields</span><span class="sxs-lookup"><span data-stu-id="9ece6-294">Removed the `ProductID`, `SupplierName`, and `CategoryName` BoundFields</span></span>
- <span data-ttu-id="9ece6-295">Convertemos o `ProductName` BoundField em um TemplateField e adicionamos um controle RequiredFieldValidation.</span><span class="sxs-lookup"><span data-stu-id="9ece6-295">Converted the `ProductName` BoundField to a TemplateField and added a RequiredFieldValidation control.</span></span>
- <span data-ttu-id="9ece6-296">Convertemos o `CategoryID` e `SupplierID` BoundFields em TemplateFields e ajustamos a interface de edição para usar DropDownLists em vez de TextBoxes.</span><span class="sxs-lookup"><span data-stu-id="9ece6-296">Converted the `CategoryID` and `SupplierID` BoundFields to TemplateFields, and adjusted the editing interface to use DropDownLists rather than TextBoxes.</span></span> <span data-ttu-id="9ece6-297">Nesses TemplateFields ' `ItemTemplates`, os campos de dados `CategoryName` e `SupplierName` são exibidos.</span><span class="sxs-lookup"><span data-stu-id="9ece6-297">In these TemplateFields' `ItemTemplates`, the `CategoryName` and `SupplierName` data fields are displayed.</span></span>
- <span data-ttu-id="9ece6-298">Converteu os `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`e `ReorderLevel` BoundFields em TemplateFields e adicionou controles CompareValidator.</span><span class="sxs-lookup"><span data-stu-id="9ece6-298">Converted the `UnitPrice`, `UnitsInStock`, `UnitsOnOrder`, and `ReorderLevel` BoundFields to TemplateFields and added CompareValidator controls.</span></span>

<span data-ttu-id="9ece6-299">Como já examinamos como realizar essas tarefas nos tutoriais anteriores, apenas listarei a sintaxe declarativa final aqui e deixarei a implementação como prática.</span><span class="sxs-lookup"><span data-stu-id="9ece6-299">Since we've already examined how to accomplish these tasks in previous tutorials, I'll just list the final declarative syntax here and leave the implementation as practice.</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample9.aspx)]

<span data-ttu-id="9ece6-300">Estamos muito próximos de ter um exemplo totalmente funcional.</span><span class="sxs-lookup"><span data-stu-id="9ece6-300">We're very close to having a fully-working example.</span></span> <span data-ttu-id="9ece6-301">No entanto, há algumas sutilezas que serão acumuladas e causarão problemas.</span><span class="sxs-lookup"><span data-stu-id="9ece6-301">However, there are a few subtleties that will creep up and cause us problems.</span></span> <span data-ttu-id="9ece6-302">Além disso, ainda precisamos de uma interface que alerta o usuário quando ocorreu uma violação de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="9ece6-302">Additionally, we still need some interface that alerts the user when a concurrency violation has occurred.</span></span>

> [!NOTE]
> <span data-ttu-id="9ece6-303">Para que um controle da Web de dados passe corretamente os valores originais para o ObjectDataSource (que são passados para a BLL), é vital que a propriedade `EnableViewState` do GridView seja definida como `true` (o padrão).</span><span class="sxs-lookup"><span data-stu-id="9ece6-303">In order for a data Web control to correctly pass the original values to the ObjectDataSource (which are then passed to the BLL), it's vital that the GridView's `EnableViewState` property is set to `true` (the default).</span></span> <span data-ttu-id="9ece6-304">Se você desabilitar o estado de exibição, os valores originais serão perdidos no postback.</span><span class="sxs-lookup"><span data-stu-id="9ece6-304">If you disable view state, the original values are lost on postback.</span></span>

## <a name="passing-the-correct-original-values-to-the-objectdatasource"></a><span data-ttu-id="9ece6-305">Passando os valores originais corretos para o ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="9ece6-305">Passing the Correct Original Values to the ObjectDataSource</span></span>

<span data-ttu-id="9ece6-306">Há alguns problemas com a maneira como o GridView foi configurado.</span><span class="sxs-lookup"><span data-stu-id="9ece6-306">There are a couple of problems with the way the GridView has been configured.</span></span> <span data-ttu-id="9ece6-307">Se a propriedade `ConflictDetection` do ObjectDataSource for definida como `CompareAllValues` (como a nossa), quando os métodos `Update()` ou `Delete()` do ObjectDataSource forem invocados pelo GridView (ou DetailsView ou FormView), o ObjectDataSource tentará copiar os valores originais do GridView em suas instâncias de `Parameter` apropriadas.</span><span class="sxs-lookup"><span data-stu-id="9ece6-307">If the ObjectDataSource's `ConflictDetection` property is set to `CompareAllValues` (as is ours), when the ObjectDataSource's `Update()` or `Delete()` methods are invoked by the GridView (or DetailsView or FormView), the ObjectDataSource attempts to copy the GridView's original values into its appropriate `Parameter` instances.</span></span> <span data-ttu-id="9ece6-308">Consulte novamente a Figura 2 para uma representação gráfica desse processo.</span><span class="sxs-lookup"><span data-stu-id="9ece6-308">Refer back to Figure 2 for a graphical representation of this process.</span></span>

<span data-ttu-id="9ece6-309">Especificamente, os valores originais do GridView são atribuídos aos valores nas instruções de ligação de dados bidirecionais cada vez que os dados são associados ao GridView.</span><span class="sxs-lookup"><span data-stu-id="9ece6-309">Specifically, the GridView's original values are assigned the values in the two-way databinding statements each time the data is bound to the GridView.</span></span> <span data-ttu-id="9ece6-310">Portanto, é essencial que todos os valores originais necessários sejam capturados por meio de ligação de dados bidirecional e que eles sejam fornecidos em um formato conversível.</span><span class="sxs-lookup"><span data-stu-id="9ece6-310">Therefore, it's essential that the required original values all are captured via two-way databinding and that they are provided in a convertible format.</span></span>

<span data-ttu-id="9ece6-311">Para ver por que isso é importante, Reserve um tempo para visitar nossa página em um navegador.</span><span class="sxs-lookup"><span data-stu-id="9ece6-311">To see why this is important, take a moment to visit our page in a browser.</span></span> <span data-ttu-id="9ece6-312">Como esperado, o GridView lista cada produto com um botão Editar e excluir na coluna mais à esquerda.</span><span class="sxs-lookup"><span data-stu-id="9ece6-312">As expected, the GridView lists each product with an Edit and Delete button in the leftmost column.</span></span>

<span data-ttu-id="9ece6-313">[![os produtos estão listados em um GridView](implementing-optimistic-concurrency-vb/_static/image39.png)](implementing-optimistic-concurrency-vb/_static/image38.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-313">[![The Products are Listed in a GridView](implementing-optimistic-concurrency-vb/_static/image39.png)](implementing-optimistic-concurrency-vb/_static/image38.png)</span></span>

<span data-ttu-id="9ece6-314">**Figura 14**: os produtos são listados em um GridView ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image40.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-314">**Figure 14**: The Products are Listed in a GridView ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image40.png))</span></span>

<span data-ttu-id="9ece6-315">Se você clicar no botão excluir de qualquer produto, um `FormatException` será lançado.</span><span class="sxs-lookup"><span data-stu-id="9ece6-315">If you click the Delete button for any product, a `FormatException` is thrown.</span></span>

<span data-ttu-id="9ece6-316">[![tentar excluir qualquer resultado de produto em um FormatException](implementing-optimistic-concurrency-vb/_static/image42.png)](implementing-optimistic-concurrency-vb/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-316">[![Attempting to Delete Any Product Results in a FormatException](implementing-optimistic-concurrency-vb/_static/image42.png)](implementing-optimistic-concurrency-vb/_static/image41.png)</span></span>

<span data-ttu-id="9ece6-317">**Figura 15**: tentando excluir qualquer resultado de produto em um `FormatException` ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image43.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-317">**Figure 15**: Attempting to Delete Any Product Results in a `FormatException` ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image43.png))</span></span>

<span data-ttu-id="9ece6-318">O `FormatException` é gerado quando o ObjectDataSource tenta ler no valor de `UnitPrice` original.</span><span class="sxs-lookup"><span data-stu-id="9ece6-318">The `FormatException` is raised when the ObjectDataSource attempts to read in the original `UnitPrice` value.</span></span> <span data-ttu-id="9ece6-319">Como o `ItemTemplate` tem o `UnitPrice` formatado como uma moeda (`<%# Bind("UnitPrice", "{0:C}") %>`), ele inclui um símbolo de moeda, como $19.95.</span><span class="sxs-lookup"><span data-stu-id="9ece6-319">Since the `ItemTemplate` has the `UnitPrice` formatted as a currency (`<%# Bind("UnitPrice", "{0:C}") %>`), it includes a currency symbol, like $19.95.</span></span> <span data-ttu-id="9ece6-320">O `FormatException` ocorre quando o ObjectDataSource tenta converter essa cadeia de caracteres em um `decimal`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-320">The `FormatException` occurs as the ObjectDataSource attempts to convert this string into a `decimal`.</span></span> <span data-ttu-id="9ece6-321">Para contornar esse problema, temos várias opções:</span><span class="sxs-lookup"><span data-stu-id="9ece6-321">To circumvent this problem, we have a number of options:</span></span>

- <span data-ttu-id="9ece6-322">Remova a formatação de moeda da `ItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-322">Remove the currency formatting from the `ItemTemplate`.</span></span> <span data-ttu-id="9ece6-323">Ou seja, em vez de usar `<%# Bind("UnitPrice", "{0:C}") %>`, basta usar `<%# Bind("UnitPrice") %>`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-323">That is, instead of using `<%# Bind("UnitPrice", "{0:C}") %>`, simply use `<%# Bind("UnitPrice") %>`.</span></span> <span data-ttu-id="9ece6-324">A desvantagem disso é que o preço não está mais formatado.</span><span class="sxs-lookup"><span data-stu-id="9ece6-324">The downside of this is that the price is no longer formatted.</span></span>
- <span data-ttu-id="9ece6-325">Exiba o `UnitPrice` formatado como uma moeda na `ItemTemplate`, mas use a palavra-chave `Eval` para fazer isso.</span><span class="sxs-lookup"><span data-stu-id="9ece6-325">Display the `UnitPrice` formatted as a currency in the `ItemTemplate`, but use the `Eval` keyword to accomplish this.</span></span> <span data-ttu-id="9ece6-326">Lembre-se de que `Eval` executa a ligação de dados unidirecional.</span><span class="sxs-lookup"><span data-stu-id="9ece6-326">Recall that `Eval` performs one-way databinding.</span></span> <span data-ttu-id="9ece6-327">Ainda precisamos fornecer o valor `UnitPrice` para os valores originais, portanto, ainda precisaremos de uma instrução DataBinding bidirecional na `ItemTemplate`, mas isso pode ser colocado em um controle da Web de rótulo cuja propriedade `Visible` esteja definida como `false`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-327">We still need to provide the `UnitPrice` value for the original values, so we'll still need a two-way databinding statement in the `ItemTemplate`, but this can be placed in a Label Web control whose `Visible` property is set to `false`.</span></span> <span data-ttu-id="9ece6-328">Poderíamos usar a seguinte marcação no ItemTemplate:</span><span class="sxs-lookup"><span data-stu-id="9ece6-328">We could use the following markup in the ItemTemplate:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample10.aspx)]

- <span data-ttu-id="9ece6-329">Remova a formatação de moeda da `ItemTemplate`, usando `<%# Bind("UnitPrice") %>`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-329">Remove the currency formatting from the `ItemTemplate`, using `<%# Bind("UnitPrice") %>`.</span></span> <span data-ttu-id="9ece6-330">No manipulador de eventos `RowDataBound` do GridView, acesse o controle de rótulo da Web dentro do qual o valor de `UnitPrice` é exibido e defina sua propriedade `Text` como a versão formatada.</span><span class="sxs-lookup"><span data-stu-id="9ece6-330">In the GridView's `RowDataBound` event handler, programmatically access the Label Web control within which the `UnitPrice` value is displayed and set its `Text` property to the formatted version.</span></span>
- <span data-ttu-id="9ece6-331">Deixe o `UnitPrice` formatado como uma moeda.</span><span class="sxs-lookup"><span data-stu-id="9ece6-331">Leave the `UnitPrice` formatted as a currency.</span></span> <span data-ttu-id="9ece6-332">No manipulador de eventos `RowDeleting` do GridView, substitua o valor de `UnitPrice` original existente ($19.95) por um valor decimal real usando `Decimal.Parse`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-332">In the GridView's `RowDeleting` event handler, replace the existing original `UnitPrice` value ($19.95) with an actual decimal value using `Decimal.Parse`.</span></span> <span data-ttu-id="9ece6-333">Vimos como realizar algo semelhante no manipulador de eventos de `RowUpdating` na manipulação de [*exceções de nível de BLL e Dal em um tutorial de página do ASP.net*](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) .</span><span class="sxs-lookup"><span data-stu-id="9ece6-333">We saw how to accomplish something similar in the `RowUpdating` event handler in the [*Handling BLL- and DAL-Level Exceptions in an ASP.NET Page*](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) tutorial.</span></span>

<span data-ttu-id="9ece6-334">Para meu exemplo, optei pela segunda abordagem, adicionando um controle da Web de rótulo oculto cuja propriedade `Text` é uma associação de dados bidirecional ao valor de `UnitPrice` não formatado.</span><span class="sxs-lookup"><span data-stu-id="9ece6-334">For my example I chose to go with the second approach, adding a hidden Label Web control whose `Text` property is two-way data bound to the unformatted `UnitPrice` value.</span></span>

<span data-ttu-id="9ece6-335">Depois de resolver esse problema, tente clicar no botão excluir de qualquer produto novamente.</span><span class="sxs-lookup"><span data-stu-id="9ece6-335">After solving this problem, try clicking the Delete button for any product again.</span></span> <span data-ttu-id="9ece6-336">Desta vez, você obterá um `InvalidOperationException` quando o ObjectDataSource tentar invocar o método `UpdateProduct` da BLL.</span><span class="sxs-lookup"><span data-stu-id="9ece6-336">This time you'll get an `InvalidOperationException` when the ObjectDataSource attempts to invoke the BLL's `UpdateProduct` method.</span></span>

<span data-ttu-id="9ece6-337">[![o ObjectDataSource não pode localizar um método com os parâmetros de entrada que deseja enviar](implementing-optimistic-concurrency-vb/_static/image45.png)](implementing-optimistic-concurrency-vb/_static/image44.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-337">[![The ObjectDataSource Cannot Find a Method with the Input Parameters it Wants to Send](implementing-optimistic-concurrency-vb/_static/image45.png)](implementing-optimistic-concurrency-vb/_static/image44.png)</span></span>

<span data-ttu-id="9ece6-338">**Figura 16**: o ObjectDataSource não pode localizar um método com os parâmetros de entrada que deseja enviar ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image46.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-338">**Figure 16**: The ObjectDataSource Cannot Find a Method with the Input Parameters it Wants to Send ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image46.png))</span></span>

<span data-ttu-id="9ece6-339">Observando a mensagem da exceção, fica claro que o ObjectDataSource deseja invocar um método de `DeleteProduct` de BLL que inclui `original_CategoryName` e `original_SupplierName` parâmetros de entrada.</span><span class="sxs-lookup"><span data-stu-id="9ece6-339">Looking at the exception's message, it's clear that the ObjectDataSource wants to invoke a BLL `DeleteProduct` method that includes `original_CategoryName` and `original_SupplierName` input parameters.</span></span> <span data-ttu-id="9ece6-340">Isso ocorre porque as `ItemTemplate` s para o `CategoryID` e `SupplierID` TemplateFields atualmente contêm instruções BIND de duas vias com os campos de dados `CategoryName` e `SupplierName`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-340">This is because the `ItemTemplate` s for the `CategoryID` and `SupplierID` TemplateFields currently contain two-way Bind statements with the `CategoryName` and `SupplierName` data fields.</span></span> <span data-ttu-id="9ece6-341">Em vez disso, precisamos incluir `Bind` instruções com os campos de dados `CategoryID` e `SupplierID`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-341">Instead, we need to include `Bind` statements with the `CategoryID` and `SupplierID` data fields.</span></span> <span data-ttu-id="9ece6-342">Para fazer isso, substitua as instruções BIND existentes por instruções `Eval` e, em seguida, adicione controles de rótulo ocultos cujas propriedades `Text` estejam associadas aos campos `CategoryID` e `SupplierID` dados usando DataBinding bidirecional, conforme mostrado abaixo:</span><span class="sxs-lookup"><span data-stu-id="9ece6-342">To accomplish this, replace the existing Bind statements with `Eval` statements, and then add hidden Label controls whose `Text` properties are bound to the `CategoryID` and `SupplierID` data fields using two-way databinding, as shown below:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample11.aspx)]

<span data-ttu-id="9ece6-343">Com essas alterações, agora é possível excluir e editar informações do produto com êxito!</span><span class="sxs-lookup"><span data-stu-id="9ece6-343">With these changes, we are now able to successfully delete and edit product information!</span></span> <span data-ttu-id="9ece6-344">Na etapa 5, veremos como verificar se as violações de simultaneidade estão sendo detectadas.</span><span class="sxs-lookup"><span data-stu-id="9ece6-344">In Step 5 we'll look at how to verify that concurrency violations are being detected.</span></span> <span data-ttu-id="9ece6-345">Mas, por enquanto, reserve alguns minutos para tentar atualizar e excluir alguns registros para garantir que a atualização e a exclusão de um único usuário funcione conforme o esperado.</span><span class="sxs-lookup"><span data-stu-id="9ece6-345">But for now, take a few minutes to try updating and deleting a few records to ensure that updating and deleting for a single user works as expected.</span></span>

## <a name="step-5-testing-the-optimistic-concurrency-support"></a><span data-ttu-id="9ece6-346">Etapa 5: testando o suporte à simultaneidade otimista</span><span class="sxs-lookup"><span data-stu-id="9ece6-346">Step 5: Testing the Optimistic Concurrency Support</span></span>

<span data-ttu-id="9ece6-347">Para verificar se as violações de simultaneidade estão sendo detectadas (em vez de resultar em dados sendo substituídos de forma oculta), precisamos abrir duas janelas de navegador nessa página.</span><span class="sxs-lookup"><span data-stu-id="9ece6-347">In order to verify that concurrency violations are being detected (rather than resulting in data being blindly overwritten), we need to open two browser windows to this page.</span></span> <span data-ttu-id="9ece6-348">Em ambas as instâncias do navegador, clique no botão Editar para Chai.</span><span class="sxs-lookup"><span data-stu-id="9ece6-348">In both browser instances, click on the Edit button for Chai.</span></span> <span data-ttu-id="9ece6-349">Em seguida, em apenas um dos navegadores, altere o nome para "Chai chá" e clique em atualizar.</span><span class="sxs-lookup"><span data-stu-id="9ece6-349">Then, in just one of the browsers, change the name to "Chai Tea" and click Update.</span></span> <span data-ttu-id="9ece6-350">A atualização deve ter sucesso e retornar o GridView para seu estado de pré-edição, com "Chai chá" como o novo nome do produto.</span><span class="sxs-lookup"><span data-stu-id="9ece6-350">The update should succeed and return the GridView to its pre-editing state, with "Chai Tea" as the new product name.</span></span>

<span data-ttu-id="9ece6-351">Na outra instância de janela do navegador, no entanto, a caixa de texto nome do produto ainda mostra "Chai".</span><span class="sxs-lookup"><span data-stu-id="9ece6-351">In the other browser window instance, however, the product name TextBox still shows "Chai".</span></span> <span data-ttu-id="9ece6-352">Nessa segunda janela do navegador, atualize o `UnitPrice` para `25.00`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-352">In this second browser window, update the `UnitPrice` to `25.00`.</span></span> <span data-ttu-id="9ece6-353">Sem o suporte de simultaneidade otimista, clicar em atualizar na segunda instância do navegador alteraria o nome do produto de volta para "Chai", substituindo assim as alterações feitas pela primeira instância do navegador.</span><span class="sxs-lookup"><span data-stu-id="9ece6-353">Without optimistic concurrency support, clicking update in the second browser instance would change the product name back to "Chai", thereby overwriting the changes made by the first browser instance.</span></span> <span data-ttu-id="9ece6-354">Com a simultaneidade otimista empregada, no entanto, clicar no botão atualizar na segunda instância do navegador resulta em um [DBConcurrencyException](https://msdn.microsoft.com/library/system.data.dbconcurrencyexception.aspx).</span><span class="sxs-lookup"><span data-stu-id="9ece6-354">With optimistic concurrency employed, however, clicking the Update button in the second browser instance results in a [DBConcurrencyException](https://msdn.microsoft.com/library/system.data.dbconcurrencyexception.aspx).</span></span>

<span data-ttu-id="9ece6-355">[![quando uma violação de simultaneidade é detectada, um DBConcurrencyException é gerado](implementing-optimistic-concurrency-vb/_static/image48.png)](implementing-optimistic-concurrency-vb/_static/image47.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-355">[![When a Concurrency Violation is Detected, a DBConcurrencyException is Thrown](implementing-optimistic-concurrency-vb/_static/image48.png)](implementing-optimistic-concurrency-vb/_static/image47.png)</span></span>

<span data-ttu-id="9ece6-356">**Figura 17**: quando uma violação de simultaneidade é detectada, um `DBConcurrencyException` é gerado ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image49.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-356">**Figure 17**: When a Concurrency Violation is Detected, a `DBConcurrencyException` is Thrown ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image49.png))</span></span>

<span data-ttu-id="9ece6-357">O `DBConcurrencyException` é lançado somente quando o padrão de atualização em lotes da DAL é utilizado.</span><span class="sxs-lookup"><span data-stu-id="9ece6-357">The `DBConcurrencyException` is only thrown when the DAL's batch update pattern is utilized.</span></span> <span data-ttu-id="9ece6-358">O padrão de BD direto não gera uma exceção, ele simplesmente indica que nenhuma linha foi afetada.</span><span class="sxs-lookup"><span data-stu-id="9ece6-358">The DB direct pattern does not raise an exception, it merely indicates that no rows were affected.</span></span> <span data-ttu-id="9ece6-359">Para ilustrar isso, retorne o GridView das instâncias do navegador para o estado anterior à edição.</span><span class="sxs-lookup"><span data-stu-id="9ece6-359">To illustrate this, return both browser instances' GridView to their pre-editing state.</span></span> <span data-ttu-id="9ece6-360">Em seguida, na primeira instância do navegador, clique no botão Editar e altere o nome do produto de "Chai chá" de volta para "Chai" e clique em atualizar.</span><span class="sxs-lookup"><span data-stu-id="9ece6-360">Next, in the first browser instance, click the Edit button and change the product name from "Chai Tea" back to "Chai" and click Update.</span></span> <span data-ttu-id="9ece6-361">Na segunda janela do navegador, clique no botão excluir para Chai.</span><span class="sxs-lookup"><span data-stu-id="9ece6-361">In the second browser window, click the Delete button for Chai.</span></span>

<span data-ttu-id="9ece6-362">Ao clicar em excluir, a página é postada novamente, o GridView invoca o método de `Delete()` do ObjectDataSource e o ObjectDataSource chama o método `DeleteProduct` da classe `ProductsOptimisticConcurrencyBLL`, passando os valores originais.</span><span class="sxs-lookup"><span data-stu-id="9ece6-362">Upon clicking Delete, the page posts back, the GridView invokes the ObjectDataSource's `Delete()` method, and the ObjectDataSource calls down into the `ProductsOptimisticConcurrencyBLL` class's `DeleteProduct` method, passing along the original values.</span></span> <span data-ttu-id="9ece6-363">O valor de `ProductName` original para a segunda instância do navegador é "Chai chá", que não corresponde ao valor de `ProductName` atual no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="9ece6-363">The original `ProductName` value for the second browser instance is "Chai Tea", which doesn't match up with the current `ProductName` value in the database.</span></span> <span data-ttu-id="9ece6-364">Portanto, a instrução `DELETE` emitida para o banco de dados afeta zero linhas, já que não há registro no banco de dados que a cláusula `WHERE` atende.</span><span class="sxs-lookup"><span data-stu-id="9ece6-364">Therefore the `DELETE` statement issued to the database affects zero rows since there's no record in the database that the `WHERE` clause satisfies.</span></span> <span data-ttu-id="9ece6-365">O método `DeleteProduct` retorna `false` e os dados do ObjectDataSource são reassociados ao GridView.</span><span class="sxs-lookup"><span data-stu-id="9ece6-365">The `DeleteProduct` method returns `false` and the ObjectDataSource's data is rebound to the GridView.</span></span>

<span data-ttu-id="9ece6-366">Da perspectiva do usuário final, clicar no botão excluir para o chá de Chai na segunda janela do navegador fez com que a tela fosse flash e, ao voltar, o produto ainda está lá, embora agora esteja listado como "Chai" (a alteração do nome do produto feita pelo primeiro navegador) instância).</span><span class="sxs-lookup"><span data-stu-id="9ece6-366">From the end user's perspective, clicking on the Delete button for Chai Tea in the second browser window caused the screen to flash and, upon coming back, the product is still there, although now it's listed as "Chai" (the product name change made by the first browser instance).</span></span> <span data-ttu-id="9ece6-367">Se o usuário clicar no botão excluir novamente, a exclusão terá sucesso, pois o valor original de `ProductName` do GridView ("Chai") agora corresponde ao valor no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="9ece6-367">If the user clicks the Delete button again, the Delete will succeed, as the GridView's original `ProductName` value ("Chai") now matches up with the value in the database.</span></span>

<span data-ttu-id="9ece6-368">Em ambos os casos, a experiência do usuário está longe de ser a ideal.</span><span class="sxs-lookup"><span data-stu-id="9ece6-368">In both of these cases, the user experience is far from ideal.</span></span> <span data-ttu-id="9ece6-369">Claramente, não queremos mostrar ao usuário os detalhes essenciais da exceção de `DBConcurrencyException` ao usar o padrão de atualização do lote.</span><span class="sxs-lookup"><span data-stu-id="9ece6-369">We clearly don't want to show the user the nitty-gritty details of the `DBConcurrencyException` exception when using the batch update pattern.</span></span> <span data-ttu-id="9ece6-370">E o comportamento ao usar o padrão de DB Direct é um pouco confuso, pois o comando Users falhou, mas não havia nenhuma indicação precisa do porquê.</span><span class="sxs-lookup"><span data-stu-id="9ece6-370">And the behavior when using the DB direct pattern is somewhat confusing as the users command failed, but there was no precise indication of why.</span></span>

<span data-ttu-id="9ece6-371">Para corrigir esses dois problemas, podemos criar controles de rótulo da Web na página que fornecem uma explicação de por que uma atualização ou exclusão falhou.</span><span class="sxs-lookup"><span data-stu-id="9ece6-371">To remedy these two issues, we can create Label Web controls on the page that provide an explanation to why an update or delete failed.</span></span> <span data-ttu-id="9ece6-372">Para o padrão de atualização do lote, podemos determinar se uma exceção `DBConcurrencyException` ocorreu ou não no manipulador de eventos de pós-nível do GridView, exibindo o rótulo de aviso conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="9ece6-372">For the batch update pattern, we can determine whether or not a `DBConcurrencyException` exception occurred in the GridView's post-level event handler, displaying the warning label as needed.</span></span> <span data-ttu-id="9ece6-373">Para o método de banco de dados direto, podemos examinar o valor de retorno do método BLL (que é `true` se uma linha foi afetada, `false` caso contrário) e exibir uma mensagem informativa, conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="9ece6-373">For the DB direct method, we can examine the return value of the BLL method (which is `true` if one row was affected, `false` otherwise) and display an informational message as needed.</span></span>

## <a name="step-6-adding-informational-messages-and-displaying-them-in-the-face-of-a-concurrency-violation"></a><span data-ttu-id="9ece6-374">Etapa 6: adicionar mensagens informativas e exibi-las em face de uma violação de simultaneidade</span><span class="sxs-lookup"><span data-stu-id="9ece6-374">Step 6: Adding Informational Messages and Displaying Them in the Face of a Concurrency Violation</span></span>

<span data-ttu-id="9ece6-375">Quando ocorre uma violação de simultaneidade, o comportamento exibido depende de o padrão de atualização do lote da DAL ou do DB Direct ser usado.</span><span class="sxs-lookup"><span data-stu-id="9ece6-375">When a concurrency violation occurs, the behavior exhibited depends on whether the DAL's batch update or DB direct pattern was used.</span></span> <span data-ttu-id="9ece6-376">Nosso tutorial usa ambos os padrões, com o padrão de atualização do lote que está sendo usado para atualização e o padrão de BD direto usado para exclusão.</span><span class="sxs-lookup"><span data-stu-id="9ece6-376">Our tutorial uses both patterns, with the batch update pattern being used for updating and the DB direct pattern used for deleting.</span></span> <span data-ttu-id="9ece6-377">Para começar, vamos adicionar dois controles de rótulo da Web à nossa página que explicam que uma violação de simultaneidade ocorreu ao tentar excluir ou atualizar dados.</span><span class="sxs-lookup"><span data-stu-id="9ece6-377">To get started, let's add two Label Web controls to our page that explain that a concurrency violation occurred when attempting to delete or update data.</span></span> <span data-ttu-id="9ece6-378">Defina as propriedades `Visible` e `EnableViewState` do controle de rótulo como `false`; Isso fará com que eles sejam ocultados em cada página visitada, exceto para as visitas de página em particular em que sua propriedade `Visible` é definida de forma programática como `true`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-378">Set the Label control's `Visible` and `EnableViewState` properties to `false`; this will cause them to be hidden on each page visit except for those particular page visits where their `Visible` property is programmatically set to `true`.</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-vb/samples/sample12.aspx)]

<span data-ttu-id="9ece6-379">Além de definir suas propriedades `Visible`, `EnabledViewState`e `Text`, também defini a propriedade `CssClass` como `Warning`, o que faz com que o rótulo seja exibido em uma fonte grande, vermelha, itálico e negrito.</span><span class="sxs-lookup"><span data-stu-id="9ece6-379">In addition to setting their `Visible`, `EnabledViewState`, and `Text` properties, I've also set the `CssClass` property to `Warning`, which causes the Label's to be displayed in a large, red, italic, bold font.</span></span> <span data-ttu-id="9ece6-380">Essa classe de `Warning` CSS foi definida e adicionada ao Styles. CSS de volta no tutorial *examinando os eventos associados com inserção, atualização e exclusão* .</span><span class="sxs-lookup"><span data-stu-id="9ece6-380">This CSS `Warning` class was defined and added to Styles.css back in the *Examining the Events Associated with Inserting, Updating, and Deleting* tutorial.</span></span>

<span data-ttu-id="9ece6-381">Depois de adicionar esses rótulos, o designer no Visual Studio deve ser semelhante à figura 18.</span><span class="sxs-lookup"><span data-stu-id="9ece6-381">After adding these Labels, the Designer in Visual Studio should look similar to Figure 18.</span></span>

<span data-ttu-id="9ece6-382">[![dois controles rótulo foram adicionados à página](implementing-optimistic-concurrency-vb/_static/image51.png)](implementing-optimistic-concurrency-vb/_static/image50.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-382">[![Two Label Controls Have Been Added to the Page](implementing-optimistic-concurrency-vb/_static/image51.png)](implementing-optimistic-concurrency-vb/_static/image50.png)</span></span>

<span data-ttu-id="9ece6-383">**Figura 18**: dois controles de rótulo foram adicionados à página ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image52.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-383">**Figure 18**: Two Label Controls Have Been Added to the Page ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image52.png))</span></span>

<span data-ttu-id="9ece6-384">Com esses controles da Web de rótulo em vigor, estamos prontos para examinar como determinar quando ocorreu uma violação de simultaneidade, no ponto em que a propriedade de `Visible` do rótulo apropriada pode ser definida como `true`, exibindo a mensagem informativa.</span><span class="sxs-lookup"><span data-stu-id="9ece6-384">With these Label Web controls in place, we're ready to examine how to determine when a concurrency violation has occurred, at which point the appropriate Label's `Visible` property can be set to `true`, displaying the informational message.</span></span>

## <a name="handling-concurrency-violations-when-updating"></a><span data-ttu-id="9ece6-385">Tratamento de violações de simultaneidade ao atualizar</span><span class="sxs-lookup"><span data-stu-id="9ece6-385">Handling Concurrency Violations When Updating</span></span>

<span data-ttu-id="9ece6-386">Primeiro, vamos examinar como lidar com violações de simultaneidade ao usar o padrão de atualização em lote.</span><span class="sxs-lookup"><span data-stu-id="9ece6-386">Let's first look at how to handle concurrency violations when using the batch update pattern.</span></span> <span data-ttu-id="9ece6-387">Como essas violações com o padrão de atualização do lote causam uma `DBConcurrencyException` exceção a ser lançada, precisamos adicionar código à nossa página ASP.NET para determinar se uma exceção `DBConcurrencyException` ocorreu durante o processo de atualização.</span><span class="sxs-lookup"><span data-stu-id="9ece6-387">Since such violations with the batch update pattern cause a `DBConcurrencyException` exception to be thrown, we need to add code to our ASP.NET page to determine whether a `DBConcurrencyException` exception occurred during the update process.</span></span> <span data-ttu-id="9ece6-388">Nesse caso, devemos exibir uma mensagem para o usuário explicando que suas alterações não foram salvas porque outro usuário modificou os mesmos dados entre quando eles começaram a editar o registro e quando clicaram no botão atualizar.</span><span class="sxs-lookup"><span data-stu-id="9ece6-388">If so, we should display a message to the user explaining that their changes were not saved because another user had modified the same data between when they started editing the record and when they clicked the Update button.</span></span>

<span data-ttu-id="9ece6-389">Como vimos na manipulação de *exceções de nível de BLL e Dal em um* tutorial de página do ASP.net, essas exceções podem ser detectadas e suprimidas nos manipuladores de eventos de nível posterior do controle da Web de dados.</span><span class="sxs-lookup"><span data-stu-id="9ece6-389">As we saw in the *Handling BLL- and DAL-Level Exceptions in an ASP.NET Page* tutorial, such exceptions can be detected and suppressed in the data Web control's post-level event handlers.</span></span> <span data-ttu-id="9ece6-390">Portanto, precisamos criar um manipulador de eventos para o evento `RowUpdated` do GridView que verifica se uma exceção de `DBConcurrencyException` foi gerada.</span><span class="sxs-lookup"><span data-stu-id="9ece6-390">Therefore, we need to create an event handler for the GridView's `RowUpdated` event that checks if a `DBConcurrencyException` exception has been thrown.</span></span> <span data-ttu-id="9ece6-391">Esse manipulador de eventos recebe uma referência a qualquer exceção que foi gerada durante o processo de atualização, conforme mostrado no código do manipulador de eventos abaixo:</span><span class="sxs-lookup"><span data-stu-id="9ece6-391">This event handler is passed a reference to any exception that was raised during the updating process, as shown in the event handler code below:</span></span>

[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample13.vb)]

<span data-ttu-id="9ece6-392">Diante de uma exceção de `DBConcurrencyException`, esse manipulador de eventos exibe o controle de rótulo de `UpdateConflictMessage` e indica que a exceção foi tratada.</span><span class="sxs-lookup"><span data-stu-id="9ece6-392">In the face of a `DBConcurrencyException` exception, this event handler displays the `UpdateConflictMessage` Label control and indicates that the exception has been handled.</span></span> <span data-ttu-id="9ece6-393">Com esse código em vigor, quando ocorre uma violação de simultaneidade durante a atualização de um registro, as alterações do usuário são perdidas, pois elas teriam substituídos as modificações de outro usuário ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="9ece6-393">With this code in place, when a concurrency violation occurs when updating a record, the user's changes are lost, since they would have overwritten another user's modifications at the same time.</span></span> <span data-ttu-id="9ece6-394">Em particular, o GridView é retornado para seu estado de pré-edição e associado aos dados atuais do banco.</span><span class="sxs-lookup"><span data-stu-id="9ece6-394">In particular, the GridView is returned to its pre-editing state and bound to the current database data.</span></span> <span data-ttu-id="9ece6-395">Isso atualizará a linha GridView com as alterações do outro usuário, que não estavam visíveis anteriormente.</span><span class="sxs-lookup"><span data-stu-id="9ece6-395">This will update the GridView row with the other user's changes, which were previously not visible.</span></span> <span data-ttu-id="9ece6-396">Além disso, o controle rótulo de `UpdateConflictMessage` explicará ao usuário o que acabou de acontecer.</span><span class="sxs-lookup"><span data-stu-id="9ece6-396">Additionally, the `UpdateConflictMessage` Label control will explain to the user what just happened.</span></span> <span data-ttu-id="9ece6-397">Essa sequência de eventos é detalhada na Figura 19.</span><span class="sxs-lookup"><span data-stu-id="9ece6-397">This sequence of events is detailed in Figure 19.</span></span>

<span data-ttu-id="9ece6-398">[![as atualizações de um usuário são perdidas na face de uma violação de simultaneidade](implementing-optimistic-concurrency-vb/_static/image54.png)](implementing-optimistic-concurrency-vb/_static/image53.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-398">[![A User s Updates are Lost in the Face of a Concurrency Violation](implementing-optimistic-concurrency-vb/_static/image54.png)](implementing-optimistic-concurrency-vb/_static/image53.png)</span></span>

<span data-ttu-id="9ece6-399">**Figura 19**: as atualizações de um usuário são perdidas na face de uma violação de simultaneidade ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image55.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-399">**Figure 19**: A User s Updates are Lost in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image55.png))</span></span>

> [!NOTE]
> <span data-ttu-id="9ece6-400">Como alternativa, em vez de retornar o GridView para o estado anterior à edição, poderíamos deixar o GridView em seu estado de edição, definindo a propriedade `KeepInEditMode` do objeto de `GridViewUpdatedEventArgs` passado como true.</span><span class="sxs-lookup"><span data-stu-id="9ece6-400">Alternatively, rather than returning the GridView to the pre-editing state, we could leave the GridView in its editing state by setting the `KeepInEditMode` property of the passed-in `GridViewUpdatedEventArgs` object to true.</span></span> <span data-ttu-id="9ece6-401">No entanto, se você usar essa abordagem, certifique-se de associar os dados ao GridView (invocando seu método `DataBind()`) para que os valores do outro usuário sejam carregados na interface de edição.</span><span class="sxs-lookup"><span data-stu-id="9ece6-401">If you take this approach, however, be certain to rebind the data to the GridView (by invoking its `DataBind()` method) so that the other user's values are loaded into the editing interface.</span></span> <span data-ttu-id="9ece6-402">O código disponível para download com este tutorial tem estas duas linhas de código no manipulador de eventos `RowUpdated` comentado; Basta remover os comentários dessas linhas de código para que o GridView permaneça no modo de edição após uma violação de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="9ece6-402">The code available for download with this tutorial has these two lines of code in the `RowUpdated` event handler commented out; simply uncomment these lines of code to have the GridView remain in edit mode after a concurrency violation.</span></span>

## <a name="responding-to-concurrency-violations-when-deleting"></a><span data-ttu-id="9ece6-403">Respondendo a violações de simultaneidade ao excluir</span><span class="sxs-lookup"><span data-stu-id="9ece6-403">Responding to Concurrency Violations When Deleting</span></span>

<span data-ttu-id="9ece6-404">Com o padrão de BD direto, não há nenhuma exceção gerada na face de uma violação de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="9ece6-404">With the DB direct pattern, there is no exception raised in the face of a concurrency violation.</span></span> <span data-ttu-id="9ece6-405">Em vez disso, a instrução Database simplesmente não afeta registros, pois a cláusula WHERE não corresponde a nenhum registro.</span><span class="sxs-lookup"><span data-stu-id="9ece6-405">Instead, the database statement simply affects no records, as the WHERE clause does not match with any record.</span></span> <span data-ttu-id="9ece6-406">Todos os métodos de modificação de dados criados na BLL foram projetados de forma que retornam um valor booliano que indica se eles afetaram precisamente um registro.</span><span class="sxs-lookup"><span data-stu-id="9ece6-406">All of the data modification methods created in the BLL have been designed such that they return a Boolean value indicating whether or not they affected precisely one record.</span></span> <span data-ttu-id="9ece6-407">Portanto, para determinar se uma violação de simultaneidade ocorreu ao excluir um registro, podemos examinar o valor de retorno do método de `DeleteProduct` da BLL.</span><span class="sxs-lookup"><span data-stu-id="9ece6-407">Therefore, to determine if a concurrency violation occurred when deleting a record, we can examine the return value of the BLL's `DeleteProduct` method.</span></span>

<span data-ttu-id="9ece6-408">O valor de retorno para um método BLL pode ser examinado nos manipuladores de eventos de pós-nível do ObjectDataSource por meio da propriedade `ReturnValue` do objeto `ObjectDataSourceStatusEventArgs` passado para o manipulador de eventos.</span><span class="sxs-lookup"><span data-stu-id="9ece6-408">The return value for a BLL method can be examined in the ObjectDataSource's post-level event handlers through the `ReturnValue` property of the `ObjectDataSourceStatusEventArgs` object passed into the event handler.</span></span> <span data-ttu-id="9ece6-409">Como estamos interessados em determinar o valor de retorno do método `DeleteProduct`, precisamos criar um manipulador de eventos para o evento `Deleted` do ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="9ece6-409">Since we are interested in determining the return value from the `DeleteProduct` method, we need to create an event handler for the ObjectDataSource's `Deleted` event.</span></span> <span data-ttu-id="9ece6-410">A propriedade `ReturnValue` é do tipo `object` e pode ser `null` se uma exceção foi gerada e o método foi interrompido antes de poder retornar um valor.</span><span class="sxs-lookup"><span data-stu-id="9ece6-410">The `ReturnValue` property is of type `object` and can be `null` if an exception was raised and the method was interrupted before it could return a value.</span></span> <span data-ttu-id="9ece6-411">Portanto, primeiro devemos garantir que a propriedade `ReturnValue` não seja `null` e seja um valor booliano.</span><span class="sxs-lookup"><span data-stu-id="9ece6-411">Therefore, we should first ensure that the `ReturnValue` property is not `null` and is a Boolean value.</span></span> <span data-ttu-id="9ece6-412">Supondo que essa verificação passe, mostraremos o `DeleteConflictMessage` controle rótulo se o `ReturnValue` for `false`.</span><span class="sxs-lookup"><span data-stu-id="9ece6-412">Assuming this check passes, we show the `DeleteConflictMessage` Label control if the `ReturnValue` is `false`.</span></span> <span data-ttu-id="9ece6-413">Isso pode ser feito usando o seguinte código:</span><span class="sxs-lookup"><span data-stu-id="9ece6-413">This can be accomplished by using the following code:</span></span>

[!code-vb[Main](implementing-optimistic-concurrency-vb/samples/sample14.vb)]

<span data-ttu-id="9ece6-414">Diante de uma violação de simultaneidade, a solicitação de exclusão do usuário é cancelada.</span><span class="sxs-lookup"><span data-stu-id="9ece6-414">In the face of a concurrency violation, the user's delete request is canceled.</span></span> <span data-ttu-id="9ece6-415">O GridView é atualizado, mostrando as alterações que ocorreram para esse registro entre o momento em que o usuário carregou a página e clicou no botão excluir.</span><span class="sxs-lookup"><span data-stu-id="9ece6-415">The GridView is refreshed, showing the changes that occurred for that record between the time the user loaded the page and when he clicked the Delete button.</span></span> <span data-ttu-id="9ece6-416">Quando essa violação ocorre, o rótulo de `DeleteConflictMessage` é mostrado, explicando o que acabou de acontecer (consulte a figura 20).</span><span class="sxs-lookup"><span data-stu-id="9ece6-416">When such a violation transpires, the `DeleteConflictMessage` Label is shown, explaining what just happened (see Figure 20).</span></span>

<span data-ttu-id="9ece6-417">[![uma exclusão de usuário é cancelada diante de uma violação de simultaneidade](implementing-optimistic-concurrency-vb/_static/image57.png)](implementing-optimistic-concurrency-vb/_static/image56.png)</span><span class="sxs-lookup"><span data-stu-id="9ece6-417">[![A User s Delete is Canceled in the Face of a Concurrency Violation](implementing-optimistic-concurrency-vb/_static/image57.png)](implementing-optimistic-concurrency-vb/_static/image56.png)</span></span>

<span data-ttu-id="9ece6-418">**Figura 20**: uma exclusão do usuário é cancelada diante de uma violação de simultaneidade ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-vb/_static/image58.png))</span><span class="sxs-lookup"><span data-stu-id="9ece6-418">**Figure 20**: A User s Delete is Canceled in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-vb/_static/image58.png))</span></span>

## <a name="summary"></a><span data-ttu-id="9ece6-419">Resumo</span><span class="sxs-lookup"><span data-stu-id="9ece6-419">Summary</span></span>

<span data-ttu-id="9ece6-420">Existem oportunidades para violações de simultaneidade em todos os aplicativos que permitem que vários usuários simultâneos atualizem ou excluam dados.</span><span class="sxs-lookup"><span data-stu-id="9ece6-420">Opportunities for concurrency violations exist in every application that allows multiple, concurrent users to update or delete data.</span></span> <span data-ttu-id="9ece6-421">Se essas violações não forem levadas em conta, quando dois usuários atualizarem simultaneamente os mesmos dados que receberem na última gravação "WINS", substituindo as alterações de alterações do outro usuário.</span><span class="sxs-lookup"><span data-stu-id="9ece6-421">If such violations are not accounted for, when two users simultaneously update the same data whoever gets in the last write "wins," overwriting the other user's changes changes.</span></span> <span data-ttu-id="9ece6-422">Como alternativa, os desenvolvedores podem implementar o controle de simultaneidade otimista ou pessimista.</span><span class="sxs-lookup"><span data-stu-id="9ece6-422">Alternatively, developers can implement either optimistic or pessimistic concurrency control.</span></span> <span data-ttu-id="9ece6-423">O controle de simultaneidade otimista pressupõe que as violações de simultaneidade são infrequentes e simplesmente não permite um comando Update ou DELETE que constituiria uma violação de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="9ece6-423">Optimistic concurrency control assumes that concurrency violations are infrequent and simply disallows an update or delete command that would constitute a concurrency violation.</span></span> <span data-ttu-id="9ece6-424">O controle de simultaneidade pessimista pressupõe que as violações de simultaneidade são frequentes e simplesmente rejeitar o comando de atualização ou exclusão de um usuário não é aceitável.</span><span class="sxs-lookup"><span data-stu-id="9ece6-424">Pessimistic concurrency control assumes that concurrency violations are frequent and simply rejecting one user's update or delete command is not acceptable.</span></span> <span data-ttu-id="9ece6-425">Com o controle de simultaneidade pessimista, a atualização de um registro envolve bloqueá-lo, impedindo que outros usuários modifiquem ou excluam o registro enquanto estiverem bloqueados.</span><span class="sxs-lookup"><span data-stu-id="9ece6-425">With pessimistic concurrency control, updating a record involves locking it, thereby preventing any other users from modifying or deleting the record while it is locked.</span></span>

<span data-ttu-id="9ece6-426">O DataSet tipado no .NET fornece a funcionalidade para dar suporte ao controle de simultaneidade otimista.</span><span class="sxs-lookup"><span data-stu-id="9ece6-426">The Typed DataSet in .NET provides functionality for supporting optimistic concurrency control.</span></span> <span data-ttu-id="9ece6-427">Em particular, as instruções `UPDATE` e `DELETE` emitidas para o banco de dados incluem todas as colunas da tabela, garantindo assim que a atualização ou exclusão só ocorrerá se os dados atuais do registro forem correspondentes aos dados originais que o usuário tinha ao executar a atualização ou exclusão.</span><span class="sxs-lookup"><span data-stu-id="9ece6-427">In particular, the `UPDATE` and `DELETE` statements issued to the database include all of the table's columns, thereby ensuring that the update or delete will only occur if the record's current data matches with the original data the user had when performing their update or delete.</span></span> <span data-ttu-id="9ece6-428">Depois que a DAL tiver sido configurada para dar suporte à simultaneidade otimista, os métodos de BLL precisarão ser atualizados.</span><span class="sxs-lookup"><span data-stu-id="9ece6-428">Once the DAL has been configured to support optimistic concurrency, the BLL methods need to be updated.</span></span> <span data-ttu-id="9ece6-429">Além disso, a página ASP.NET que chama para baixo na BLL deve ser configurada de modo que o ObjectDataSource recupere os valores originais de seu controle da Web de dados e os passe para a BLL.</span><span class="sxs-lookup"><span data-stu-id="9ece6-429">Additionally, the ASP.NET page that calls down into the BLL must be configured such that the ObjectDataSource retrieves the original values from its data Web control and passes them down into the BLL.</span></span>

<span data-ttu-id="9ece6-430">Como vimos neste tutorial, implementar o controle de simultaneidade otimista em um aplicativo Web ASP.NET envolve atualizar a DAL e a BLL e adicionar suporte na página ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="9ece6-430">As we saw in this tutorial, implementing optimistic concurrency control in an ASP.NET web application involves updating the DAL and BLL and adding support in the ASP.NET page.</span></span> <span data-ttu-id="9ece6-431">Esse trabalho adicionado ou não é um investimento inteligente de tempo e esforço depende do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="9ece6-431">Whether or not this added work is a wise investment of your time and effort depends on your application.</span></span> <span data-ttu-id="9ece6-432">Se você raramente tiver usuários simultâneos atualizando dados ou se os dados que eles estão atualizando forem diferentes uns dos outros, o controle de simultaneidade não será um problema importante.</span><span class="sxs-lookup"><span data-stu-id="9ece6-432">If you infrequently have concurrent users updating data, or the data they are updating is different from one another, then concurrency control is not a key issue.</span></span> <span data-ttu-id="9ece6-433">No entanto, se você tiver uma rotina de vários usuários em seu site trabalhando com os mesmos dados, o controle de simultaneidade poderá ajudar a impedir que as atualizações ou exclusões de um usuário reescrevam de outra involuntariamente.</span><span class="sxs-lookup"><span data-stu-id="9ece6-433">If, however, you routinely have multiple users on your site working with the same data, concurrency control can help prevent one user's updates or deletes from unwittingly overwriting another's.</span></span>

<span data-ttu-id="9ece6-434">Boa programação!</span><span class="sxs-lookup"><span data-stu-id="9ece6-434">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="9ece6-435">Sobre o autor</span><span class="sxs-lookup"><span data-stu-id="9ece6-435">About the Author</span></span>

<span data-ttu-id="9ece6-436">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), autor de sete livros sobre ASP/ASP. net e fundador da [4guysfromrolla.com](http://www.4guysfromrolla.com), tem trabalhado com tecnologias Web da Microsoft desde 1998.</span><span class="sxs-lookup"><span data-stu-id="9ece6-436">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="9ece6-437">Scott trabalha como consultor, instrutor e escritor independentes.</span><span class="sxs-lookup"><span data-stu-id="9ece6-437">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="9ece6-438">Seu livro mais recente é que a [*Sams ensina a ASP.NET 2,0 em 24 horas*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="9ece6-438">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="9ece6-439">Ele pode ser acessado em [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="9ece6-439">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="9ece6-440">ou por meio de seu blog, que pode ser encontrado em [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="9ece6-440">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="9ece6-441">[Anterior](customizing-the-data-modification-interface-vb.md)
> [Próximo](adding-client-side-confirmation-when-deleting-vb.md)</span><span class="sxs-lookup"><span data-stu-id="9ece6-441">[Previous](customizing-the-data-modification-interface-vb.md)
[Next](adding-client-side-confirmation-when-deleting-vb.md)</span></span>
