---
uid: web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-vb
title: Quebrando modificações de banco de dados em uma transação (VB) | Microsoft Docs
author: rick-anderson
description: Este tutorial é o primeiro de quatro que examina a atualização, a exclusão e a inserção de lotes de dados. Neste tutorial, aprendemos como as transações de banco de dados permitem...
ms.author: riande
ms.date: 06/26/2007
ms.assetid: 7d821db5-6cbb-4b38-af14-198f9155fc82
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-vb
msc.type: authoredcontent
ms.openlocfilehash: dee95ee2789a69aac5aa79b8358e58e3ee99e1b2
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78588686"
---
# <a name="wrapping-database-modifications-within-a-transaction-vb"></a><span data-ttu-id="6fb8b-104">Encapsulamento de modificações de banco de dados em uma transação (VB)</span><span class="sxs-lookup"><span data-stu-id="6fb8b-104">Wrapping Database Modifications within a Transaction (VB)</span></span>

<span data-ttu-id="6fb8b-105">por [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="6fb8b-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="6fb8b-106">[Baixar código](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_VB.zip) ou [baixar PDF](wrapping-database-modifications-within-a-transaction-vb/_static/datatutorial63vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="6fb8b-106">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_VB.zip) or [Download PDF](wrapping-database-modifications-within-a-transaction-vb/_static/datatutorial63vb1.pdf)</span></span>

> <span data-ttu-id="6fb8b-107">Este tutorial é o primeiro de quatro que examina a atualização, a exclusão e a inserção de lotes de dados.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-107">This tutorial is the first of four that looks at updating, deleting, and inserting batches of data.</span></span> <span data-ttu-id="6fb8b-108">Neste tutorial, aprendemos como as transações de banco de dados permitem que as modificações em lote sejam executadas como uma operação atômica, o que garante que todas as etapas tenham êxito ou que todas as etapas falhem.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-108">In this tutorial we learn how database transactions allow batch modifications to be carried out as an atomic operation, which ensures that either all steps succeed or all steps fail.</span></span>

## <a name="introduction"></a><span data-ttu-id="6fb8b-109">Introdução</span><span class="sxs-lookup"><span data-stu-id="6fb8b-109">Introduction</span></span>

<span data-ttu-id="6fb8b-110">Como vimos começando com [uma visão geral do tutorial inserir, atualizar e excluir dados](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md) , o GridView fornece suporte interno para edição e exclusão em nível de linha.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-110">As we saw starting with the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md) tutorial, the GridView provides built-in support for row-level editing and deleting.</span></span> <span data-ttu-id="6fb8b-111">Com alguns cliques do mouse, é possível criar uma interface de modificação de dados rica sem escrever uma linha de código, desde que você tenha conteúdo com edição e exclusão em uma base por linha.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-111">With a few clicks of the mouse it is possible to create a rich data modification interface without writing a line of code, so long as you are content with editing and deleting on a per-row basis.</span></span> <span data-ttu-id="6fb8b-112">No entanto, em determinados cenários, isso é insuficiente e precisamos fornecer aos usuários a capacidade de editar ou excluir um lote de registros.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-112">However, in certain scenarios this is insufficient and we need to provide users with the ability to edit or delete a batch of records.</span></span>

<span data-ttu-id="6fb8b-113">Por exemplo, a maioria dos clientes de email baseados na Web usa uma grade para listar cada mensagem em que cada linha inclui uma caixa de seleção junto com as informações do email s (assunto, remetente e assim por diante).</span><span class="sxs-lookup"><span data-stu-id="6fb8b-113">For example, most web-based email clients use a grid to list each message where each row includes a checkbox along with the email s information (subject, sender, and so forth).</span></span> <span data-ttu-id="6fb8b-114">Essa interface permite que o usuário exclua várias mensagens verificando-as e clicando em um botão excluir mensagens selecionadas.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-114">This interface permits the user to delete multiple messages by checking them and then clicking a Delete Selected Messages button.</span></span> <span data-ttu-id="6fb8b-115">Uma interface de edição em lote é ideal em situações em que os usuários normalmente editam vários registros diferentes.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-115">A batch editing interface is ideal in situations where users commonly edit many different records.</span></span> <span data-ttu-id="6fb8b-116">Em vez de forçar o usuário a clicar em Editar, fazer suas alterações e, em seguida, clicar em atualizar para cada registro que precisa ser modificado, uma interface de edição do lote renderiza cada linha com sua interface de edição.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-116">Rather than forcing the user to click Edit, make their change, and then click Update for each record that needs to be modified, a batch editing interface renders each row with its editing interface.</span></span> <span data-ttu-id="6fb8b-117">O usuário pode modificar rapidamente o conjunto de linhas que precisam ser alteradas e, em seguida, salvar essas alterações clicando em um botão atualizar tudo.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-117">The user can quickly modify the set of rows that need to be changed and then save these changes by clicking an Update All button.</span></span> <span data-ttu-id="6fb8b-118">Neste conjunto de tutoriais, examinaremos como criar interfaces para inserção, edição e exclusão de lotes de dados.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-118">In this set of tutorials we'll examine how to create interfaces for inserting, editing, and deleting batches of data.</span></span>

<span data-ttu-id="6fb8b-119">Ao executar operações em lote, é importante determinar se deve ser possível que algumas das operações no lote tenham êxito enquanto outras falham.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-119">When performing batch operations it s important to determine whether it should be possible for some of the operations in the batch to succeed while others fail.</span></span> <span data-ttu-id="6fb8b-120">Considere uma interface de exclusão de lote – o que deve acontecer se o primeiro registro selecionado for excluído com êxito, mas o segundo falhar, digamos, devido a uma violação de restrição de chave estrangeira?</span><span class="sxs-lookup"><span data-stu-id="6fb8b-120">Consider a batch deleting interface - what should happen if the first selected record is deleted successfully, but the second one fails, say, because of a foreign key constraint violation?</span></span> <span data-ttu-id="6fb8b-121">Se a exclusão de s do primeiro registro for revertida ou for aceitável que o primeiro registro permaneça excluído?</span><span class="sxs-lookup"><span data-stu-id="6fb8b-121">Should the first record s delete be rolled back or is it acceptable for the first record to remain deleted?</span></span>

<span data-ttu-id="6fb8b-122">Se você quiser que a operação em lote seja tratada como uma [operação atômica](http://en.wikipedia.org/wiki/Atomic_operation), uma em que todas as etapas tenham êxito ou todas as etapas falharem, a camada de acesso a dados precisará ser aumentada para incluir suporte para [Transações de banco](http://en.wikipedia.org/wiki/Database_transaction)de dado.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-122">If you want the batch operation to be treated as an [atomic operation](http://en.wikipedia.org/wiki/Atomic_operation), one where either all of the steps succeed or all of the steps fail, then the Data Access Layer needs to be augmented to include support for [database transactions](http://en.wikipedia.org/wiki/Database_transaction).</span></span> <span data-ttu-id="6fb8b-123">As transações de banco de dados garantem atomicidade para o conjunto de instruções `INSERT`, `UPDATE`e `DELETE` executadas sob a abrangência da transação e são um recurso com suporte na maioria dos sistemas de banco de dados modernos.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-123">Database transactions guarantee atomicity for the set of `INSERT`, `UPDATE`, and `DELETE` statements executed under the umbrella of the transaction and are a feature supported by most all modern database systems.</span></span>

<span data-ttu-id="6fb8b-124">Neste tutorial, veremos como estender a DAL para usar transações de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-124">In this tutorial we'll look at how to extend the DAL to use database transactions.</span></span> <span data-ttu-id="6fb8b-125">Os tutoriais subsequentes examinarão a implementação de páginas da Web para inserção, atualização e exclusão de interfaces em lotes.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-125">Subsequent tutorials will examine implementing web pages for batch inserting, updating, and deleting interfaces.</span></span> <span data-ttu-id="6fb8b-126">Vamos começar!</span><span class="sxs-lookup"><span data-stu-id="6fb8b-126">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="6fb8b-127">Ao modificar dados em uma transação em lote, a atomicidade nem sempre é necessária.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-127">When modifying data in a batch transaction, atomicity is not always needed.</span></span> <span data-ttu-id="6fb8b-128">Em alguns cenários, pode ser aceitável ter algumas modificações de dados bem sucedidas e outras no mesmo lote falham, como ao excluir um conjunto de emails de um cliente de email baseado na Web.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-128">In some scenarios, it may be acceptable to have some data modifications succeed and others in the same batch fail, such as when deleting a set of emails from a web-based email client.</span></span> <span data-ttu-id="6fb8b-129">Se houver um erro de banco de dados no centro do processo de exclusão, provavelmente os registros processados sem erros permanecerão excluídos.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-129">If there s a database error midway through the deletion process, it s probably acceptable that those records processed without error remain deleted.</span></span> <span data-ttu-id="6fb8b-130">Nesses casos, a DAL não precisa ser modificada para dar suporte a transações de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-130">In such cases, the DAL does not need to be modified to support database transactions.</span></span> <span data-ttu-id="6fb8b-131">Há outros cenários de operação em lote, no entanto, onde a atomicidade é vital.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-131">There are other batch operation scenarios, however, where atomicity is vital.</span></span> <span data-ttu-id="6fb8b-132">Quando um cliente move seus fundos de uma conta bancária para outra, duas operações devem ser executadas: os fundos devem ser deduzidos da primeira conta e, em seguida, adicionados ao segundo.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-132">When a customer moves her funds from one bank account to another, two operations must be performed: the funds must be deducted from the first account and then added to the second.</span></span> <span data-ttu-id="6fb8b-133">Embora o banco não tenha em mente que a primeira etapa é bem-sucedida, mas a segunda etapa falha, seus clientes poderiam ser aborrecidos.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-133">While the bank may not mind having the first step succeed but the second step fail, its customers would understandably be upset.</span></span> <span data-ttu-id="6fb8b-134">Recomendo que você trabalhe neste tutorial e implemente os aprimoramentos na DAL para dar suporte a transações de banco de dados, mesmo que não planeje usá-las no lote inserindo, atualizando e excluindo interfaces que vamos criar nos três tutoriais a seguir.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-134">I encourage you to work through this tutorial and implement the enhancements to the DAL to support database transactions even if you do not plan on using them in the batch inserting, updating, and deleting interfaces we'll be building in the following three tutorials.</span></span>

## <a name="an-overview-of-transactions"></a><span data-ttu-id="6fb8b-135">Uma visão geral das transações</span><span class="sxs-lookup"><span data-stu-id="6fb8b-135">An Overview of Transactions</span></span>

<span data-ttu-id="6fb8b-136">A maioria dos bancos de dados inclui suporte para *Transações*, que permitem que vários comandos de banco de dados sejam agrupados em uma única unidade lógica de trabalho.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-136">Most databases include support for *transactions*, which enable multiple database commands to be grouped into a single logical unit of work.</span></span> <span data-ttu-id="6fb8b-137">Os comandos de banco de dados que compõem uma transação têm a garantia de serem atômicas, o que significa que todos os comandos falharão ou todos terão êxito.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-137">The database commands that comprise a transaction are guaranteed to be atomic, meaning that either all commands will fail or all will succeed.</span></span>

<span data-ttu-id="6fb8b-138">Em geral, as transações são implementadas por meio de instruções SQL usando o seguinte padrão:</span><span class="sxs-lookup"><span data-stu-id="6fb8b-138">In general, transactions are implemented through SQL statements using the following pattern:</span></span>

1. <span data-ttu-id="6fb8b-139">Indique o início de uma transação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-139">Indicate the start of a transaction.</span></span>
2. <span data-ttu-id="6fb8b-140">Execute as instruções SQL que compõem a transação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-140">Execute the SQL statements that comprise the transaction.</span></span>
3. <span data-ttu-id="6fb8b-141">Se houver um erro em uma das instruções da etapa 2, reverta a transação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-141">If there is an error in one of the statements from Step 2, rollback the transaction.</span></span>
4. <span data-ttu-id="6fb8b-142">Se todas as instruções da etapa 2 forem concluídas sem erros, confirme a transação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-142">If all of the statements from Step 2 complete without error, commit the transaction.</span></span>

<span data-ttu-id="6fb8b-143">As instruções SQL usadas para criar, confirmar e reverter a transação podem ser inseridas manualmente ao gravar scripts SQL ou criar procedimentos armazenados, ou por meio de programação, usando ADO.NET ou as classes no [namespace`System.Transactions`](https://msdn.microsoft.com/library/system.transactions.aspx).</span><span class="sxs-lookup"><span data-stu-id="6fb8b-143">The SQL statements used to create, commit, and roll back the transaction can be entered manually when writing SQL scripts or creating stored procedures, or through programmatic means using either ADO.NET or the classes in the [`System.Transactions` namespace](https://msdn.microsoft.com/library/system.transactions.aspx).</span></span> <span data-ttu-id="6fb8b-144">Neste tutorial, examinaremos apenas o gerenciamento de transações usando ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-144">In this tutorial we will only examine managing transactions using ADO.NET.</span></span> <span data-ttu-id="6fb8b-145">Em um futuro tutorial, veremos como usar procedimentos armazenados na camada de acesso a dados, em que, neste momento, exploraremos as instruções SQL para criar, reverter e confirmar transações.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-145">In a future tutorial we will look at how to use stored procedures in the Data Access Layer, at which time we'll explore the SQL statements for creating, rolling back, and committing transactions.</span></span> <span data-ttu-id="6fb8b-146">Enquanto isso, consulte [Gerenciando transações em SQL Server procedimentos armazenados](http://www.4guysfromrolla.com/webtech/080305-1.shtml) para obter mais informações.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-146">In the meantime, consult [Managing Transactions in SQL Server Stored Procedures](http://www.4guysfromrolla.com/webtech/080305-1.shtml) for more information.</span></span>

> [!NOTE]
> <span data-ttu-id="6fb8b-147">A [classe`TransactionScope`](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) no namespace `System.Transactions` permite que os desenvolvedores envolvam programaticamente uma série de instruções dentro do escopo de uma transação e inclui suporte para transações complexas que envolvem várias fontes, como dois bancos de dados diferentes ou até mesmo tipos heterogêneos de armazenamentos, como um banco de dado Microsoft SQL Server, um Oracle Database e um Web Service.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-147">The [`TransactionScope` class](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) in the `System.Transactions` namespace enables developers to programmatically wrap a series of statements within the scope of a transaction and includes support for complex transactions that involve multiple sources, such as two different databases or even heterogeneous types of data stores, such as a Microsoft SQL Server database, an Oracle database, and a Web service.</span></span> <span data-ttu-id="6fb8b-148">Eu decidi usar as transações de ADO.NET para este tutorial em vez da classe `TransactionScope` porque ADO.NET é mais específico para transações de banco de dados e, em muitos casos, tem muito menos uso intensivo de recursos.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-148">I ve decided to use ADO.NET transactions for this tutorial instead of the `TransactionScope` class because ADO.NET is more specific for database transactions and, in many cases, is far less resource intensive.</span></span> <span data-ttu-id="6fb8b-149">Além disso, em determinados cenários, a classe `TransactionScope` usa o Microsoft Coordenador de Transações Distribuídas (MSDTC).</span><span class="sxs-lookup"><span data-stu-id="6fb8b-149">In addition, under certain scenarios the `TransactionScope` class uses the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="6fb8b-150">A configuração, a implementação e os problemas de desempenho em torno do MSDTC o tornam um tópico bastante especializado e avançado e além do escopo desses tutoriais.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-150">The configuration, implementation, and performance issues surrounding MSDTC makes it a rather specialized and advanced topic and beyond the scope of these tutorials.</span></span>

<span data-ttu-id="6fb8b-151">Ao trabalhar com o provedor SqlClient no ADO.NET, as transações são iniciadas por meio de uma chamada para a [classe`SqlConnection`](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) [`BeginTransaction` método](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), que retorna um [objeto`SqlTransaction`](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span><span class="sxs-lookup"><span data-stu-id="6fb8b-151">When working with the SqlClient provider in ADO.NET, transactions are initiated through a call to the [`SqlConnection` class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), which returns a [`SqlTransaction` object](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span></span> <span data-ttu-id="6fb8b-152">As instruções de modificação de dados que fazem a composição da transação são colocadas dentro de um bloco de `try...catch`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-152">The data modification statements that makeup the transaction are placed within a `try...catch` block.</span></span> <span data-ttu-id="6fb8b-153">Se ocorrer um erro em uma instrução no bloco de `try`, a execução será transferida para o bloco de `catch` em que a transação pode ser revertida por meio do [método`Rollback`](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx)s do objeto `SqlTransaction`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-153">If an error occurs in a statement in the `try` block, execution transfers to the `catch` block where the transaction can be rolled back via the `SqlTransaction` object s [`Rollback` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span></span> <span data-ttu-id="6fb8b-154">Se todas as instruções forem concluídas com êxito, uma chamada para o objeto `SqlTransaction` s [`Commit` o método](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) no final do bloco de `try` confirmará a transação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-154">If all of the statements complete successfully, a call to the `SqlTransaction` object s [`Commit` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) at the end of the `try` block commits the transaction.</span></span> <span data-ttu-id="6fb8b-155">O trecho de código a seguir ilustra esse padrão.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-155">The following code snippet illustrates this pattern.</span></span> <span data-ttu-id="6fb8b-156">Consulte [mantendo a consistência do banco de dados com transações](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) para obter mais sintaxe e exemplos de como usar transações com ADO.net.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-156">See [Maintaining Database Consistency with Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) for additional syntax and examples of using transactions with ADO.NET.</span></span>

[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample1.vb)]

<span data-ttu-id="6fb8b-157">Por padrão, os TableAdapters em um DataSet tipado não usam transações.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-157">By default, the TableAdapters in a Typed DataSet do not use transactions.</span></span> <span data-ttu-id="6fb8b-158">Para fornecer suporte para transações, precisamos aumentar as classes do TableAdapter para incluir métodos adicionais que usam o padrão acima para executar uma série de instruções de modificação de dados dentro do escopo de uma transação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-158">To provide support for transactions we need to augment the TableAdapter classes to include additional methods that use the above pattern to perform a series of data modification statements within the scope of a transaction.</span></span> <span data-ttu-id="6fb8b-159">Na etapa 2, veremos como usar classes parciais para adicionar esses métodos.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-159">In Step 2 we'll see how to use partial classes to add these methods.</span></span>

## <a name="step-1-creating-the-working-with-batched-data-web-pages"></a><span data-ttu-id="6fb8b-160">Etapa 1: criando o trabalho com páginas da Web de dados em lote</span><span class="sxs-lookup"><span data-stu-id="6fb8b-160">Step 1: Creating the Working with Batched Data Web Pages</span></span>

<span data-ttu-id="6fb8b-161">Antes de começarmos a explorar como aumentar a DAL para dar suporte a transações de banco de dados, vamos primeiro reservar um momento para criar as páginas da Web ASP.NET que precisaremos para este tutorial e as três que seguem.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-161">Before we start exploring how to augment the DAL to support database transactions, let s first take a moment to create the ASP.NET web pages that we will need for this tutorial and the three that follow.</span></span> <span data-ttu-id="6fb8b-162">Comece adicionando uma nova pasta chamada `BatchData` e, em seguida, adicione as páginas ASP.NET a seguir, associando cada página à `Site.master` página mestra.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-162">Start by adding a new folder named `BatchData` and then add the following ASP.NET pages, associating each page with the `Site.master` master page.</span></span>

- `Default.aspx`
- `Transactions.aspx`
- `BatchUpdate.aspx`
- `BatchDelete.aspx`
- `BatchInsert.aspx`

![Adicionar as páginas ASP.NET para os tutoriais relacionados ao SqlDataSource](wrapping-database-modifications-within-a-transaction-vb/_static/image1.gif)

<span data-ttu-id="6fb8b-164">**Figura 1**: adicionar as páginas ASP.net para os tutoriais relacionados ao SqlDataSource</span><span class="sxs-lookup"><span data-stu-id="6fb8b-164">**Figure 1**: Add the ASP.NET Pages for the SqlDataSource-Related Tutorials</span></span>

<span data-ttu-id="6fb8b-165">Assim como ocorre com as outras pastas, `Default.aspx` usará o controle de usuário `SectionLevelTutorialListing.ascx` para listar os tutoriais em sua seção.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-165">As with the other folders, `Default.aspx` will use the `SectionLevelTutorialListing.ascx` User Control to list the tutorials within its section.</span></span> <span data-ttu-id="6fb8b-166">Portanto, adicione esse controle de usuário a `Default.aspx` arrastando-o da Gerenciador de Soluções para a página s modo de exibição de Design.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-166">Therefore, add this User Control to `Default.aspx` by dragging it from the Solution Explorer onto the page s Design view.</span></span>

<span data-ttu-id="6fb8b-167">[![adicionar o controle de usuário SectionLevelTutorialListing. ascx a default. aspx](wrapping-database-modifications-within-a-transaction-vb/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="6fb8b-167">[![Add the SectionLevelTutorialListing.ascx User Control to Default.aspx](wrapping-database-modifications-within-a-transaction-vb/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image1.png)</span></span>

<span data-ttu-id="6fb8b-168">**Figura 2**: Adicionar o controle de usuário `SectionLevelTutorialListing.ascx` ao `Default.aspx` ([clique para exibir a imagem em tamanho normal](wrapping-database-modifications-within-a-transaction-vb/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="6fb8b-168">**Figure 2**: Add the `SectionLevelTutorialListing.ascx` User Control to `Default.aspx` ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image2.png))</span></span>

<span data-ttu-id="6fb8b-169">Por fim, adicione essas quatro páginas como entradas ao arquivo de `Web.sitemap`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-169">Lastly, add these four pages as entries to the `Web.sitemap` file.</span></span> <span data-ttu-id="6fb8b-170">Especificamente, adicione a seguinte marcação após a personalização do mapa do site `<siteMapNode>`:</span><span class="sxs-lookup"><span data-stu-id="6fb8b-170">Specifically, add the following markup after the Customizing the Site Map `<siteMapNode>`:</span></span>

[!code-xml[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample2.xml)]

<span data-ttu-id="6fb8b-171">Depois de atualizar `Web.sitemap`, Reserve um momento para exibir o site de tutoriais por meio de um navegador.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-171">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="6fb8b-172">O menu à esquerda agora inclui itens para os tutoriais de trabalho com dados em lote.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-172">The menu on the left now includes items for the working with batched data tutorials.</span></span>

![O mapa do site agora inclui entradas para os tutoriais de trabalho com dados em lote](wrapping-database-modifications-within-a-transaction-vb/_static/image3.gif)

<span data-ttu-id="6fb8b-174">**Figura 3**: o mapa do site agora inclui entradas para os tutoriais de trabalho com dados em lote</span><span class="sxs-lookup"><span data-stu-id="6fb8b-174">**Figure 3**: The Site Map Now Includes Entries for the Working with Batched Data Tutorials</span></span>

## <a name="step-2-updating-the-data-access-layer-to-support-database-transactions"></a><span data-ttu-id="6fb8b-175">Etapa 2: atualizando a camada de acesso a dados para dar suporte a transações de banco de dado</span><span class="sxs-lookup"><span data-stu-id="6fb8b-175">Step 2: Updating the Data Access Layer to Support Database Transactions</span></span>

<span data-ttu-id="6fb8b-176">Como discutimos de volta no primeiro tutorial, [criando uma camada de acesso a dados](../introduction/creating-a-data-access-layer-vb.md), o dataset tipado em nossa Dal é composto por tabelas e TableAdapters.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-176">As we discussed back in the first tutorial, [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md), the Typed DataSet in our DAL is composed of DataTables and TableAdapters.</span></span> <span data-ttu-id="6fb8b-177">As tabelas contêm dados enquanto os TableAdapters fornecem a funcionalidade de leitura de dados do banco de dado para as DataTables, a fim de atualizá-lo com as alterações feitas nas tabelas e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-177">The DataTables hold data while the TableAdapters provide the functionality to read data from the database into the DataTables, to update the database with changes made to the DataTables, and so forth.</span></span> <span data-ttu-id="6fb8b-178">Lembre-se de que os TableAdapters fornecem dois padrões para a atualização de dados, que eu chamei de atualização de lote e de BD-Direct.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-178">Recall that the TableAdapters provide two patterns for updating data, which I referred to as Batch Update and DB-Direct.</span></span> <span data-ttu-id="6fb8b-179">Com o padrão de atualização do lote, o TableAdapter recebe um DataSet, DataTable ou uma coleção de DataRows.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-179">With the Batch Update pattern, the TableAdapter is passed a DataSet, DataTable, or collection of DataRows.</span></span> <span data-ttu-id="6fb8b-180">Esses dados são enumerados e para cada linha inserida, modificada ou excluída, o `InsertCommand`, `UpdateCommand`ou `DeleteCommand` é executado.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-180">This data is enumerated and for each inserted, modified, or deleted row, the `InsertCommand`, `UpdateCommand`, or `DeleteCommand` is executed.</span></span> <span data-ttu-id="6fb8b-181">Com o padrão DB-Direct, o TableAdapter é, em vez disso, passado os valores das colunas necessárias para inserir, atualizar ou excluir um único registro.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-181">With the DB-Direct pattern, the TableAdapter is instead passed the values of the columns necessary for inserting, updating, or deleting a single record.</span></span> <span data-ttu-id="6fb8b-182">O método de padrão direto do BD usa esses valores passados para executar a instrução `InsertCommand`, `UpdateCommand`ou `DeleteCommand` apropriada.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-182">The DB Direct pattern method then uses those passed-in values to execute the appropriate `InsertCommand`, `UpdateCommand`, or `DeleteCommand` statement.</span></span>

<span data-ttu-id="6fb8b-183">Independentemente do padrão de atualização usado, os métodos gerados automaticamente pelos TableAdapters não usam transações.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-183">Regardless of the update pattern used, the TableAdapters auto-generated methods do not use transactions.</span></span> <span data-ttu-id="6fb8b-184">Por padrão, cada INSERT, Update ou DELETE executado pelo TableAdapter é tratado como uma única operação discreta.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-184">By default each insert, update, or delete performed by the TableAdapter is treated as a single discrete operation.</span></span> <span data-ttu-id="6fb8b-185">Por exemplo, imagine que o padrão de BD-Direct é usado por algum código na BLL para inserir dez registros no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-185">For instance, imagine that the DB-Direct pattern is used by some code in the BLL to insert ten records into the database.</span></span> <span data-ttu-id="6fb8b-186">Esse código chamaria o método do TableAdapter s `Insert` dez vezes.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-186">This code would call the TableAdapter s `Insert` method ten times.</span></span> <span data-ttu-id="6fb8b-187">Se as cinco primeiras inserções forem realizadas com sucesso, mas a sexta resultar em uma exceção, os primeiros cinco registros inseridos permanecerão no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-187">If the first five inserts succeed, but the sixth one resulted in an exception, the first five inserted records would remain in the database.</span></span> <span data-ttu-id="6fb8b-188">Da mesma forma, se o padrão de atualização do lote for usado para executar inserções, atualizações e exclusões nas linhas inseridas, modificadas e excluídas em uma DataTable, se as várias modificações forem bem-sucedidas, mas uma versão posterior encontrou um erro, as modificações anteriores que concluído permaneceria no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-188">Similarly, if the Batch Update pattern is used to perform inserts, updates, and deletes to the inserted, modified, and deleted rows in a DataTable, if the first several modifications succeeded but a later one encountered an error, those earlier modifications that completed would remain in the database.</span></span>

<span data-ttu-id="6fb8b-189">Em determinados cenários, queremos garantir a atomicidade em uma série de modificações.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-189">In certain scenarios we want to ensure atomicity across a series of modifications.</span></span> <span data-ttu-id="6fb8b-190">Para fazer isso, devemos estender manualmente o TableAdapter adicionando novos métodos que executam o `InsertCommand`, `UpdateCommand`e `DeleteCommand` s sob a proteção de uma transação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-190">To accomplish this we must manually extend the TableAdapter by adding new methods that execute the `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s under the umbrella of a transaction.</span></span> <span data-ttu-id="6fb8b-191">Ao [criar uma camada de acesso a dados](../introduction/creating-a-data-access-layer-vb.md) , examinamos o uso de [classes parciais](http://en.wikipedia.org/wiki/Partial_type) para estender a funcionalidade das DataTables dentro do dataset tipado.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-191">In [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md) we looked at using [partial classes](http://en.wikipedia.org/wiki/Partial_type) to extend the functionality of the DataTables within the Typed DataSet.</span></span> <span data-ttu-id="6fb8b-192">Essa técnica também pode ser usada com TableAdapters.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-192">This technique can also be used with TableAdapters.</span></span>

<span data-ttu-id="6fb8b-193">O conjunto de `Northwind.xsd` de DataSet tipado está localizado na subpasta `App_Code` Folder s `DAL`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-193">The Typed DataSet `Northwind.xsd` is located in the `App_Code` folder s `DAL` subfolder.</span></span> <span data-ttu-id="6fb8b-194">Crie uma subpasta na pasta `DAL` chamada `TransactionSupport` e adicione um novo arquivo de classe chamado `ProductsTableAdapter.TransactionSupport.vb` (consulte a Figura 4).</span><span class="sxs-lookup"><span data-stu-id="6fb8b-194">Create a subfolder in the `DAL` folder named `TransactionSupport` and add a new class file named `ProductsTableAdapter.TransactionSupport.vb` (see Figure 4).</span></span> <span data-ttu-id="6fb8b-195">Esse arquivo manterá a implementação parcial do `ProductsTableAdapter` que inclui métodos para executar modificações de dados usando uma transação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-195">This file will hold the partial implementation of the `ProductsTableAdapter` that includes methods for performing data modifications using a transaction.</span></span>

![Adicione uma pasta chamada TransactionSupport e um arquivo de classe chamado ProductsTableAdapter. TransactionSupport. vb](wrapping-database-modifications-within-a-transaction-vb/_static/image4.gif)

<span data-ttu-id="6fb8b-197">**Figura 4**: adicionar uma pasta chamada `TransactionSupport` e um arquivo de classe chamado `ProductsTableAdapter.TransactionSupport.vb`</span><span class="sxs-lookup"><span data-stu-id="6fb8b-197">**Figure 4**: Add a Folder Named `TransactionSupport` and a Class File Named `ProductsTableAdapter.TransactionSupport.vb`</span></span>

<span data-ttu-id="6fb8b-198">Digite o seguinte código no arquivo de `ProductsTableAdapter.TransactionSupport.vb`:</span><span class="sxs-lookup"><span data-stu-id="6fb8b-198">Enter the following code into the `ProductsTableAdapter.TransactionSupport.vb` file:</span></span>

[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample3.vb)]

<span data-ttu-id="6fb8b-199">A palavra-chave `Partial` na declaração de classe aqui indica para o compilador que os membros adicionados dentro devem ser adicionados à classe `ProductsTableAdapter` no namespace `NorthwindTableAdapters`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-199">The `Partial` keyword in the class declaration here indicates to the compiler that the members added within are to be added to the `ProductsTableAdapter` class in the `NorthwindTableAdapters` namespace.</span></span> <span data-ttu-id="6fb8b-200">Observe a instrução `Imports System.Data.SqlClient` na parte superior do arquivo.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-200">Note the `Imports System.Data.SqlClient` statement at the top of the file.</span></span> <span data-ttu-id="6fb8b-201">Como o TableAdapter foi configurado para usar o provedor SqlClient, internamente ele usa um [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) objeto para emitir seus comandos para o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-201">Since the TableAdapter was configured to use the SqlClient provider, internally it uses a [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) object to issue its commands to the database.</span></span> <span data-ttu-id="6fb8b-202">Consequentemente, precisamos usar a classe `SqlTransaction` para iniciar a transação e, em seguida, confirmá-la ou revertida-la.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-202">Consequently, we need to use the `SqlTransaction` class to begin the transaction and then to commit it or roll it back.</span></span> <span data-ttu-id="6fb8b-203">Se você estiver usando um armazenamento de dados diferente de Microsoft SQL Server, precisará usar o provedor apropriado.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-203">If you are using a data store other than Microsoft SQL Server, you'll need to use the appropriate provider.</span></span>

<span data-ttu-id="6fb8b-204">Esses métodos fornecem os blocos de construção necessários para iniciar, reverter e confirmar uma transação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-204">These methods provide the building blocks needed to start, rollback, and commit a transaction.</span></span> <span data-ttu-id="6fb8b-205">Elas são marcadas `Public`, permitindo que elas sejam usadas no `ProductsTableAdapter`, de outra classe na DAL ou de outra camada na arquitetura, como a BLL.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-205">They are marked `Public`, enabling them to be used from within the `ProductsTableAdapter`, from another class in the DAL, or from another layer in the architecture, such as the BLL.</span></span> <span data-ttu-id="6fb8b-206">`BeginTransaction` abre o `SqlConnection` interno do TableAdapter (se necessário), inicia a transação e a atribui à propriedade `Transaction` e anexa a transação aos objetos internos `SqlDataAdapter` s `SqlCommand`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-206">`BeginTransaction` opens the TableAdapter s internal `SqlConnection` (if needed), begins the transaction and assigns it to the `Transaction` property, and attaches the transaction to the internal `SqlDataAdapter` s `SqlCommand` objects.</span></span> <span data-ttu-id="6fb8b-207">`CommitTransaction` e `RollbackTransaction` chamar os métodos `Commit` e `Rollback` do objeto `Transaction`, respectivamente, antes de fechar o objeto `Connection` interno.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-207">`CommitTransaction` and `RollbackTransaction` call the `Transaction` object s `Commit` and `Rollback` methods, respectively, before closing the internal `Connection` object.</span></span>

## <a name="step-3-adding-methods-to-update-and-delete-data-under-the-umbrella-of-a-transaction"></a><span data-ttu-id="6fb8b-208">Etapa 3: adicionando métodos para atualizar e excluir dados sob a abrangência de uma transação</span><span class="sxs-lookup"><span data-stu-id="6fb8b-208">Step 3: Adding Methods to Update and Delete Data Under the Umbrella of a Transaction</span></span>

<span data-ttu-id="6fb8b-209">Com esses métodos concluídos, estamos prontos para adicionar métodos a `ProductsDataTable` ou a BLL que executa uma série de comandos sob a proteção de uma transação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-209">With these methods complete, we re ready to add methods to `ProductsDataTable` or the BLL that perform a series of commands under the umbrella of a transaction.</span></span> <span data-ttu-id="6fb8b-210">O método a seguir usa o padrão de atualização do lote para atualizar uma instância de `ProductsDataTable` usando uma transação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-210">The following method uses the Batch Update pattern to update a `ProductsDataTable` instance using a transaction.</span></span> <span data-ttu-id="6fb8b-211">Ele inicia uma transação chamando o método `BeginTransaction` e, em seguida, usa um bloco `Try...Catch` para emitir as instruções de modificação de dados.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-211">It starts a transaction by calling the `BeginTransaction` method and then uses a `Try...Catch` block to issue the data modification statements.</span></span> <span data-ttu-id="6fb8b-212">Se a chamada para o método de `Update` do objeto `Adapter` resultar em uma exceção, a execução será transferida para o bloco de `catch` em que a transação será revertida e a exceção relançada.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-212">If the call to the `Adapter` object s `Update` method results in an exception, execution will transfer to the `catch` block where the transaction will be rolled back and the exception re-thrown.</span></span> <span data-ttu-id="6fb8b-213">Lembre-se de que o método `Update` implementa o padrão de atualização em lote enumerando as linhas do `ProductsDataTable` fornecido e executando os `InsertCommand`, `UpdateCommand`e `DeleteCommand` necessários.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-213">Recall that the `Update` method implements the Batch Update pattern by enumerating the rows of the supplied `ProductsDataTable` and performing the necessary `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s.</span></span> <span data-ttu-id="6fb8b-214">Se qualquer um desses comandos resultar em um erro, a transação será revertida, desfazendo as modificações anteriores feitas durante o tempo de vida de s da transação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-214">If any one of these commands results in an error, the transaction is rolled back, undoing the previous modifications made during the transaction s lifetime.</span></span> <span data-ttu-id="6fb8b-215">Caso a instrução de `Update` seja concluída sem erros, a transação é confirmada em sua totalidade.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-215">Should the `Update` statement complete without error, the transaction is committed in its entirety.</span></span>

[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample4.vb)]

<span data-ttu-id="6fb8b-216">Adicione o método `UpdateWithTransaction` à classe `ProductsTableAdapter` por meio da classe Partial em `ProductsTableAdapter.TransactionSupport.vb`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-216">Add the `UpdateWithTransaction` method to the `ProductsTableAdapter` class through the partial class in `ProductsTableAdapter.TransactionSupport.vb`.</span></span> <span data-ttu-id="6fb8b-217">Como alternativa, esse método pode ser adicionado à classe de `ProductsBLL` da camada de lógica de negócios com algumas pequenas alterações sintáticas.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-217">Alternatively, this method could be added to the Business Logic Layer s `ProductsBLL` class with a few minor syntactical changes.</span></span> <span data-ttu-id="6fb8b-218">Ou seja, a palavra-chave `Me` em `Me.BeginTransaction()`, `Me.CommitTransaction()`e `Me.RollbackTransaction()` precisaria ser substituída por `Adapter` (Lembre-se de que `Adapter` é o nome de uma propriedade em `ProductsBLL` do tipo `ProductsTableAdapter`).</span><span class="sxs-lookup"><span data-stu-id="6fb8b-218">Namely, the keyword `Me` in `Me.BeginTransaction()`, `Me.CommitTransaction()`, and `Me.RollbackTransaction()` would need to be replaced with `Adapter` (recall that `Adapter` is the name of a property in `ProductsBLL` of type `ProductsTableAdapter`).</span></span>

<span data-ttu-id="6fb8b-219">O método `UpdateWithTransaction` usa o padrão de atualização do lote, mas uma série de chamadas de BD-Direct também pode ser usada dentro do escopo de uma transação, como mostra o método a seguir.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-219">The `UpdateWithTransaction` method uses the Batch Update pattern, but a series of DB-Direct calls can also be used within the scope of a transaction, as the following method shows.</span></span> <span data-ttu-id="6fb8b-220">O método `DeleteProductsWithTransaction` aceita como entrada um `List(Of T)` do tipo `Integer`, que são os `ProductID` s a serem excluídos.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-220">The `DeleteProductsWithTransaction` method accepts as input a `List(Of T)` of type `Integer`, which are the `ProductID` s to delete.</span></span> <span data-ttu-id="6fb8b-221">O método inicia a transação por meio de uma chamada para `BeginTransaction` e, em seguida, no bloco de `Try`, itera pela lista fornecida chamando o método de `Delete` de padrões direto de DB para cada valor de `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-221">The method initiates the transaction via a call to `BeginTransaction` and then, in the `Try` block, iterates through the supplied list calling the DB-Direct pattern `Delete` method for each `ProductID` value.</span></span> <span data-ttu-id="6fb8b-222">Se qualquer uma das chamadas para `Delete` falhar, o controle será transferido para o bloco de `Catch` em que a transação é revertida e a exceção é relançada.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-222">If any of the calls to `Delete` fails, control is transferred to the `Catch` block where the transaction is rolled back and the exception re-thrown.</span></span> <span data-ttu-id="6fb8b-223">Se todas as chamadas para `Delete` tiverem sucesso, a transação será confirmada.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-223">If all calls to `Delete` succeed, then transaction is committed.</span></span> <span data-ttu-id="6fb8b-224">Adicione este método à classe `ProductsBLL`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-224">Add this method to the `ProductsBLL` class.</span></span>

[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample5.vb)]

## <a name="applying-transactions-across-multiple-tableadapters"></a><span data-ttu-id="6fb8b-225">Aplicando transações em vários TableAdapters</span><span class="sxs-lookup"><span data-stu-id="6fb8b-225">Applying Transactions Across Multiple TableAdapters</span></span>

<span data-ttu-id="6fb8b-226">O código relacionado à transação examinado neste tutorial permite que várias instruções em relação ao `ProductsTableAdapter` sejam tratadas como uma operação atômica.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-226">The transaction-related code examined in this tutorial allows for multiple statements against the `ProductsTableAdapter` to be treated as an atomic operation.</span></span> <span data-ttu-id="6fb8b-227">Mas e se várias modificações em tabelas de banco de dados diferentes precisarem ser executadas atomicamente?</span><span class="sxs-lookup"><span data-stu-id="6fb8b-227">But what if multiple modifications to different database tables need to be performed atomically?</span></span> <span data-ttu-id="6fb8b-228">Por exemplo, ao excluir uma categoria, primeiro convémos reatribuir seus produtos atuais a alguma outra categoria.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-228">For instance, when deleting a category, we might first want to reassign its current products to some other category.</span></span> <span data-ttu-id="6fb8b-229">Essas duas etapas reatribuindo os produtos e excluindo a categoria devem ser executadas como uma operação atômica.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-229">These two steps reassigning the products and deleting the category should be executed as an atomic operation.</span></span> <span data-ttu-id="6fb8b-230">Mas a `ProductsTableAdapter` inclui apenas métodos para modificar a tabela `Products` e a `CategoriesTableAdapter` inclui apenas métodos para modificar a tabela `Categories`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-230">But the `ProductsTableAdapter` includes only methods for modifying the `Products` table and the `CategoriesTableAdapter` includes only methods for modifying the `Categories` table.</span></span> <span data-ttu-id="6fb8b-231">Então, como uma transação pode abranger ambos os TableAdapters?</span><span class="sxs-lookup"><span data-stu-id="6fb8b-231">So how can a transaction encompass both TableAdapters?</span></span>

<span data-ttu-id="6fb8b-232">Uma opção é adicionar um método ao `CategoriesTableAdapter` chamado `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` e fazer com que esse método chame um procedimento armazenado que reatribui os produtos e exclua a categoria dentro do escopo de uma transação definida no procedimento armazenado.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-232">One option is to add a method to the `CategoriesTableAdapter` named `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` and have that method call a stored procedure that both reassigns the products and deletes the category within the scope of a transaction defined within the stored procedure.</span></span> <span data-ttu-id="6fb8b-233">Veremos como começar, confirmar e reverter transações em procedimentos armazenados em um tutorial futuro.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-233">We'll look at how to begin, commit, and rollback transactions in stored procedures in a future tutorial.</span></span>

<span data-ttu-id="6fb8b-234">Outra opção é criar uma classe auxiliar na DAL que contenha o método `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-234">Another option is to create a helper class in the DAL that contains the `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` method.</span></span> <span data-ttu-id="6fb8b-235">Esse método criaria uma instância do `CategoriesTableAdapter` e o `ProductsTableAdapter` e, em seguida, definiria esses dois TableAdapters `Connection` Propriedades para a mesma instância `SqlConnection`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-235">This method would create an instance of the `CategoriesTableAdapter` and the `ProductsTableAdapter` and then set these two TableAdapters `Connection` properties to the same `SqlConnection` instance.</span></span> <span data-ttu-id="6fb8b-236">Nesse ponto, qualquer um dos dois TableAdapters iniciaria a transação com uma chamada para `BeginTransaction`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-236">At that point, either one of the two TableAdapters would initiate the transaction with a call to `BeginTransaction`.</span></span> <span data-ttu-id="6fb8b-237">Os métodos TableAdapters para reatribuir os produtos e excluir a categoria seriam invocados em um bloco de `Try...Catch` com a transação confirmada ou revertida conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-237">The TableAdapters methods for reassigning the products and deleting the category would be invoked in a `Try...Catch` block with the transaction committed or rolled back as needed.</span></span>

## <a name="step-4-adding-theupdatewithtransactionmethod-to-the-business-logic-layer"></a><span data-ttu-id="6fb8b-238">Etapa 4: adicionando o método de`UpdateWithTransaction`à camada de lógica de negócios</span><span class="sxs-lookup"><span data-stu-id="6fb8b-238">Step 4: Adding the`UpdateWithTransaction`Method to the Business Logic Layer</span></span>

<span data-ttu-id="6fb8b-239">Na etapa 3, adicionamos um método `UpdateWithTransaction` à `ProductsTableAdapter` na DAL.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-239">In Step 3 we added an `UpdateWithTransaction` method to the `ProductsTableAdapter` in the DAL.</span></span> <span data-ttu-id="6fb8b-240">Devemos adicionar um método correspondente à BLL.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-240">We should add a corresponding method to the BLL.</span></span> <span data-ttu-id="6fb8b-241">Embora a camada de apresentação pudesse chamar diretamente para a DAL para invocar o método `UpdateWithTransaction`, esses tutoriais se empenhavam em definir uma arquitetura em camadas que separa a DAL da camada de apresentação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-241">While the Presentation Layer could call directly down to the DAL to invoke the `UpdateWithTransaction` method, these tutorials have strived to define a layered architecture that insulates the DAL from the Presentation Layer.</span></span> <span data-ttu-id="6fb8b-242">Portanto, ele nos convém para continuar essa abordagem.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-242">Therefore, it behooves us to continue this approach.</span></span>

<span data-ttu-id="6fb8b-243">Abra o arquivo de classe `ProductsBLL` e adicione um método chamado `UpdateWithTransaction` que simplesmente chame para o método DAL correspondente.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-243">Open the `ProductsBLL` class file and add a method named `UpdateWithTransaction` that simply calls down to the corresponding DAL method.</span></span> <span data-ttu-id="6fb8b-244">Agora deve haver dois novos métodos no `ProductsBLL`: `UpdateWithTransaction`, que você acabou de adicionar e `DeleteProductsWithTransaction`, que foi adicionado na etapa 3.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-244">There should now be two new methods in `ProductsBLL`: `UpdateWithTransaction`, which you just added, and `DeleteProductsWithTransaction`, which was added in Step 3.</span></span>

[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample6.vb)]

> [!NOTE]
> <span data-ttu-id="6fb8b-245">Esses métodos não incluem o atributo `DataObjectMethodAttribute` atribuído à maioria dos outros métodos na classe `ProductsBLL` porque iremos invocar esses métodos diretamente das classes code-behind de páginas ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-245">These methods do not include the `DataObjectMethodAttribute` attribute assigned to most other methods in the `ProductsBLL` class because we'll be invoking these methods directly from the ASP.NET pages code-behind classes.</span></span> <span data-ttu-id="6fb8b-246">Lembre-se de que `DataObjectMethodAttribute` é usado para sinalizar quais métodos devem aparecer no assistente de configuração de fonte de dados ObjectDataSource s e em qual guia (selecionar, atualizar, inserir ou excluir).</span><span class="sxs-lookup"><span data-stu-id="6fb8b-246">Recall that `DataObjectMethodAttribute` is used to flag what methods should appear in the ObjectDataSource s Configure Data Source wizard and under what tab (SELECT, UPDATE, INSERT, or DELETE).</span></span> <span data-ttu-id="6fb8b-247">Como o GridView não tem suporte interno para edição ou exclusão em lotes, precisaremos invocar esses métodos programaticamente em vez de usar a abordagem declarativa sem código.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-247">Since the GridView lacks any built-in support for batch editing or deleting, we'll have to invoke these methods programmatically rather than use the code-free declarative approach.</span></span>

## <a name="step-5-atomically-updating-database-data-from-the-presentation-layer"></a><span data-ttu-id="6fb8b-248">Etapa 5: Atualizando atomicamente os dados do banco da camada de apresentação</span><span class="sxs-lookup"><span data-stu-id="6fb8b-248">Step 5: Atomically Updating Database Data from the Presentation Layer</span></span>

<span data-ttu-id="6fb8b-249">Para ilustrar o efeito que a transação tem ao atualizar um lote de registros, vamos criar uma interface do usuário que liste todos os produtos em um GridView e inclui um controle da Web de botão que, quando clicado, reatribui os produtos `CategoryID` valores.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-249">To illustrate the effect that the transaction has when updating a batch of records, let s create a user interface that lists all products in a GridView and includes a Button Web control that, when clicked, reassigns the products `CategoryID` values.</span></span> <span data-ttu-id="6fb8b-250">Em particular, a atribuição de categoria irá progredir para que os primeiros produtos recebam um valor de `CategoryID` válido, enquanto outros são atribuídos intencionalmente a um valor de `CategoryID` não existente.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-250">In particular, the category reassignment will progress so that the first several products are assigned a valid `CategoryID` value while others are purposefully assigned a non-existent `CategoryID` value.</span></span> <span data-ttu-id="6fb8b-251">Se tentarmos atualizar o banco de dados com um produto cujo `CategoryID` não corresponde a um `CategoryID`de categoria existente, uma violação de restrição de chave estrangeira ocorrerá e uma exceção será gerada.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-251">If we attempt to update the database with a product whose `CategoryID` does not match an existing category s `CategoryID`, a foreign key constraint violation will occur and an exception will be raised.</span></span> <span data-ttu-id="6fb8b-252">O que veremos neste exemplo é que, ao usar uma transação, a exceção gerada pela violação de restrição de chave estrangeira fará com que as alterações de `CategoryID` válidas anteriores sejam revertidas.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-252">What we'll see in this example is that when using a transaction the exception raised from the foreign key constraint violation will cause the previous valid `CategoryID` changes to be rolled back.</span></span> <span data-ttu-id="6fb8b-253">No entanto, quando você não estiver usando uma transação, as modificações nas categorias iniciais permanecerão.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-253">When not using a transaction, however, the modifications to the initial categories will remain.</span></span>

<span data-ttu-id="6fb8b-254">Comece abrindo a página `Transactions.aspx` na pasta `BatchData` e arraste um GridView da caixa de ferramentas para o designer.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-254">Start by opening the `Transactions.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="6fb8b-255">Defina seu `ID` como `Products` e, em sua marca inteligente, associe-o a um novo ObjectDataSource chamado `ProductsDataSource`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-255">Set its `ID` to `Products` and, from its smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="6fb8b-256">Configure o ObjectDataSource para efetuar pull de seus dados do método de `GetProducts` da classe `ProductsBLL`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-256">Configure the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProducts` method.</span></span> <span data-ttu-id="6fb8b-257">Esse será um GridView somente leitura, portanto, defina as listas suspensas nas guias atualizar, inserir e excluir como (nenhum) e clique em concluir.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-257">This will be a read-only GridView, so set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and click Finish.</span></span>

<span data-ttu-id="6fb8b-258">[![configurar o ObjectDataSource para usar o método GetProducts da classe ProductsBLL](wrapping-database-modifications-within-a-transaction-vb/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="6fb8b-258">[![Configure the ObjectDataSource to Use the ProductsBLL Class s GetProducts Method](wrapping-database-modifications-within-a-transaction-vb/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image3.png)</span></span>

<span data-ttu-id="6fb8b-259">**Figura 5**: configurar o ObjectDataSource para usar o método de `GetProducts` da classe `ProductsBLL` ([clique para exibir a imagem em tamanho normal](wrapping-database-modifications-within-a-transaction-vb/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="6fb8b-259">**Figure 5**: Configure the ObjectDataSource to Use the `ProductsBLL` Class s `GetProducts` Method ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image4.png))</span></span>

<span data-ttu-id="6fb8b-260">[![definir as listas suspensas nas guias atualizar, inserir e excluir para (nenhum)](wrapping-database-modifications-within-a-transaction-vb/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="6fb8b-260">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](wrapping-database-modifications-within-a-transaction-vb/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image5.png)</span></span>

<span data-ttu-id="6fb8b-261">**Figura 6**: definir as listas suspensas nas guias atualizar, inserir e excluir para (nenhum) ([clique para exibir a imagem em tamanho normal](wrapping-database-modifications-within-a-transaction-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="6fb8b-261">**Figure 6**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image6.png))</span></span>

<span data-ttu-id="6fb8b-262">Depois de concluir o assistente para configurar fonte de dados, o Visual Studio criará BoundFields e um CheckBoxField para os campos de dados do produto.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-262">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and a CheckBoxField for the product data fields.</span></span> <span data-ttu-id="6fb8b-263">Remova todos esses campos, exceto `ProductID`, `ProductName`, `CategoryID`e `CategoryName` e renomeie os `ProductName` e `CategoryName` BoundFields `HeaderText` Propriedades para Product e Category, respectivamente.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-263">Remove all of these fields except for `ProductID`, `ProductName`, `CategoryID`, and `CategoryName` and rename the `ProductName` and `CategoryName` BoundFields `HeaderText` properties to Product and Category, respectively.</span></span> <span data-ttu-id="6fb8b-264">Na marca inteligente, marque a opção habilitar paginação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-264">From the smart tag, check the Enable Paging option.</span></span> <span data-ttu-id="6fb8b-265">Depois de fazer essas modificações, a marcação declarativa de GridView e ObjectDataSource s deve ser parecida com a seguinte:</span><span class="sxs-lookup"><span data-stu-id="6fb8b-265">After making these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>

[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample7.aspx)]

<span data-ttu-id="6fb8b-266">Em seguida, adicione os controles da Web de três botões acima do GridView.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-266">Next, add three Button Web controls above the GridView.</span></span> <span data-ttu-id="6fb8b-267">Defina a propriedade de texto s do primeiro botão como atualizar grade, a segunda s para modificar categorias (com transação) e a terceira para modificar categorias (sem transação).</span><span class="sxs-lookup"><span data-stu-id="6fb8b-267">Set the first Button s Text property to Refresh Grid, the second s to Modify Categories (WITH TRANSACTION), and the third one s to Modify Categories (WITHOUT TRANSACTION) .</span></span>

[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample8.aspx)]

<span data-ttu-id="6fb8b-268">Neste ponto, o modo de exibição de Design no Visual Studio deve ser semelhante à captura de tela mostrada na Figura 7.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-268">At this point the Design view in Visual Studio should look similar to the screen shot shown in Figure 7.</span></span>

<span data-ttu-id="6fb8b-269">[![a página contém um controle GridView e três botões da Web](wrapping-database-modifications-within-a-transaction-vb/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="6fb8b-269">[![The Page Contains a GridView and Three Button Web Controls](wrapping-database-modifications-within-a-transaction-vb/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image7.png)</span></span>

<span data-ttu-id="6fb8b-270">**Figura 7**: a página contém um controle GridView e três botões da Web ([clique para exibir a imagem em tamanho normal](wrapping-database-modifications-within-a-transaction-vb/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="6fb8b-270">**Figure 7**: The Page Contains a GridView and Three Button Web Controls ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image8.png))</span></span>

<span data-ttu-id="6fb8b-271">Crie manipuladores de eventos para cada um dos três eventos de `Click` de botão e use o seguinte código:</span><span class="sxs-lookup"><span data-stu-id="6fb8b-271">Create event handlers for each of the three Button s `Click` events and use the following code:</span></span>

[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample9.vb)]

<span data-ttu-id="6fb8b-272">O manipulador de eventos do botão atualizar s `Click` simplesmente reassocia os dados ao GridView chamando o método `Products` GridView `DataBind`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-272">The refresh Button s `Click` event handler simply rebinds the data to the GridView by calling the `Products` GridView s `DataBind` method.</span></span>

<span data-ttu-id="6fb8b-273">O segundo manipulador de eventos reatribui os produtos `CategoryID` s e usa o novo método de transação da BLL para executar as atualizações de banco de dados sob a proteção de uma transação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-273">The second event handler reassigns the products `CategoryID` s and uses the new transaction method from the BLL to perform the database updates under the umbrella of a transaction.</span></span> <span data-ttu-id="6fb8b-274">Observe que cada produto s `CategoryID` é arbitrariamente definido com o mesmo valor que seu `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-274">Note that each product s `CategoryID` is arbitrarily set to the same value as its `ProductID`.</span></span> <span data-ttu-id="6fb8b-275">Isso funcionará bem para os primeiros produtos, pois esses produtos têm `ProductID` valores que acontecem para mapear para os `CategoryID` válidos.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-275">This will work fine for the first few products, since those products have `ProductID` values that happen to map to valid `CategoryID` s.</span></span> <span data-ttu-id="6fb8b-276">Mas depois que a `ProductID` s começar a ficar muito grande, essa sobreposição coincidente de `ProductID` s e `CategoryID` s não se aplicará mais.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-276">But once the `ProductID` s start getting too large, this coincidental overlap of `ProductID` s and `CategoryID` s no longer applies.</span></span>

<span data-ttu-id="6fb8b-277">O terceiro manipulador de eventos de `Click` atualiza os produtos `CategoryID` s da mesma maneira, mas envia a atualização para o banco de dados usando o método de `Update` padrão `ProductsTableAdapter` s.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-277">The third `Click` event handler updates the products `CategoryID` s in the same manner, but sends the update to the database using the `ProductsTableAdapter` s default `Update` method.</span></span> <span data-ttu-id="6fb8b-278">Esse método de `Update` não encapsula a série de comandos em uma transação, portanto, essas alterações são feitas antes que o primeiro erro de violação de restrição de chave estrangeira seja persistido.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-278">This `Update` method does not wrap the series of commands within a transaction, so those changes are made prior to the first encountered foreign key constraint violation error will persist.</span></span>

<span data-ttu-id="6fb8b-279">Para demonstrar esse comportamento, visite esta página por meio de um navegador.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-279">To demonstrate this behavior, visit this page through a browser.</span></span> <span data-ttu-id="6fb8b-280">Inicialmente, você deve ver a primeira página de dados, como mostra a Figura 8.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-280">Initially you should see the first page of data as shown in Figure 8.</span></span> <span data-ttu-id="6fb8b-281">Em seguida, clique no botão modificar categorias (com transação).</span><span class="sxs-lookup"><span data-stu-id="6fb8b-281">Next, click the Modify Categories (WITH TRANSACTION) button.</span></span> <span data-ttu-id="6fb8b-282">Isso causará um postback e tentará atualizar todos os produtos `CategoryID` valores, mas resultará em uma violação de restrição de chave estrangeira (consulte a Figura 9).</span><span class="sxs-lookup"><span data-stu-id="6fb8b-282">This will cause a postback and attempt to update all of the products `CategoryID` values, but will result in a foreign key constraint violation (see Figure 9).</span></span>

<span data-ttu-id="6fb8b-283">[![os produtos são exibidos em um GridView paginável](wrapping-database-modifications-within-a-transaction-vb/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="6fb8b-283">[![The Products are Displayed in a Pageable GridView](wrapping-database-modifications-within-a-transaction-vb/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image9.png)</span></span>

<span data-ttu-id="6fb8b-284">**Figura 8**: os produtos são exibidos em um GridView paginável ([clique para exibir a imagem em tamanho normal](wrapping-database-modifications-within-a-transaction-vb/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="6fb8b-284">**Figure 8**: The Products are Displayed in a Pageable GridView ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image10.png))</span></span>

<span data-ttu-id="6fb8b-285">[![reatribuir as categorias resulta em uma violação de restrição de chave estrangeira](wrapping-database-modifications-within-a-transaction-vb/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="6fb8b-285">[![Reassigning the Categories Results in a Foreign Key Constraint Violation](wrapping-database-modifications-within-a-transaction-vb/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image11.png)</span></span>

<span data-ttu-id="6fb8b-286">**Figura 9**: Reatribuir as categorias resulta em uma violação de restrição de chave estrangeira ([clique para exibir a imagem em tamanho normal](wrapping-database-modifications-within-a-transaction-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="6fb8b-286">**Figure 9**: Reassigning the Categories Results in a Foreign Key Constraint Violation ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image12.png))</span></span>

<span data-ttu-id="6fb8b-287">Agora, pressione o botão voltar do navegador e clique no botão atualizar grade.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-287">Now hit your browser s Back button and then click the Refresh Grid button.</span></span> <span data-ttu-id="6fb8b-288">Ao atualizar os dados, você deve ver exatamente a mesma saída, conforme mostrado na Figura 8.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-288">Upon refreshing the data you should see the exact same output as shown in Figure 8.</span></span> <span data-ttu-id="6fb8b-289">Ou seja, embora alguns dos produtos `CategoryID` s tenham sido alterados para valores válidos e atualizados no banco de dados, eles foram revertidos quando ocorreu a violação da restrição de chave estrangeira.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-289">That is, even though some of the products `CategoryID` s were changed to legal values and updated in the database, they were rolled back when the foreign key constraint violation occurred.</span></span>

<span data-ttu-id="6fb8b-290">Agora, tente clicar no botão modificar categorias (sem transação).</span><span class="sxs-lookup"><span data-stu-id="6fb8b-290">Now try clicking the Modify Categories (WITHOUT TRANSACTION) button.</span></span> <span data-ttu-id="6fb8b-291">Isso resultará no mesmo erro de violação de restrição de chave estrangeira (consulte a Figura 9), mas desta vez os produtos cujos valores de `CategoryID` foram alterados para um valor válido não serão revertidos.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-291">This will result in the same foreign key constraint violation error (see Figure 9), but this time those products whose `CategoryID` values were changed to a legal value will not be rolled back.</span></span> <span data-ttu-id="6fb8b-292">Pressione o botão voltar do navegador e, em seguida, o botão atualizar grade.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-292">Hit your browser s Back button and then the Refresh Grid button.</span></span> <span data-ttu-id="6fb8b-293">Como mostra a Figura 10, os `CategoryID` s dos primeiros oito produtos foram reatribuídos.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-293">As Figure 10 shows, the `CategoryID` s of the first eight products have been reassigned.</span></span> <span data-ttu-id="6fb8b-294">Por exemplo, na Figura 8, Chang tinha um `CategoryID` de 1, mas na Figura 10 ele foi reatribuído para 2.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-294">For example, in Figure 8, Chang had a `CategoryID` of 1, but in Figure 10 it s been reassigned to 2.</span></span>

<span data-ttu-id="6fb8b-295">[![alguns produtos os valores de CategoryID foram atualizados enquanto outros não foram](wrapping-database-modifications-within-a-transaction-vb/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="6fb8b-295">[![Some Products CategoryID Values were Updated While Others Were Not](wrapping-database-modifications-within-a-transaction-vb/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image13.png)</span></span>

<span data-ttu-id="6fb8b-296">**Figura 10**: alguns produtos `CategoryID` valores foram atualizados enquanto outros não eram ([clique para exibir a imagem em tamanho normal](wrapping-database-modifications-within-a-transaction-vb/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="6fb8b-296">**Figure 10**: Some Products `CategoryID` Values were Updated While Others Were Not ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image14.png))</span></span>

## <a name="summary"></a><span data-ttu-id="6fb8b-297">Resumo</span><span class="sxs-lookup"><span data-stu-id="6fb8b-297">Summary</span></span>

<span data-ttu-id="6fb8b-298">Por padrão, os métodos do TableAdapter s não encapsulam as instruções de banco de dados executadas dentro do escopo de uma transação, mas com um pouco de trabalho, podemos adicionar métodos que criarão, confirmarão e reverterão uma transação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-298">By default, the TableAdapter s methods do not wrap the executed database statements within the scope of a transaction, but with a little work we can add methods that will create, commit, and rollback a transaction.</span></span> <span data-ttu-id="6fb8b-299">Neste tutorial, criamos três métodos, na classe `ProductsTableAdapter`: `BeginTransaction`, `CommitTransaction`e `RollbackTransaction`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-299">In this tutorial we created three such methods in the `ProductsTableAdapter` class: `BeginTransaction`, `CommitTransaction`, and `RollbackTransaction`.</span></span> <span data-ttu-id="6fb8b-300">Vimos como usar esses métodos junto com um bloco de `Try...Catch` para fazer uma série de instruções de modificação de dados atômicas.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-300">We saw how to use these methods along with a `Try...Catch` block to make a series of data modification statements atomic.</span></span> <span data-ttu-id="6fb8b-301">Em particular, criamos o método `UpdateWithTransaction` no `ProductsTableAdapter`, que usa o padrão de atualização do lote para executar as modificações necessárias nas linhas de um `ProductsDataTable`fornecido.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-301">In particular, we created the `UpdateWithTransaction` method in the `ProductsTableAdapter`, which uses the Batch Update pattern to perform the necessary modifications to the rows of a supplied `ProductsDataTable`.</span></span> <span data-ttu-id="6fb8b-302">Também adicionamos o método `DeleteProductsWithTransaction` à classe `ProductsBLL` na BLL, que aceita uma `List` de valores de `ProductID` como sua entrada e chama o método de padrão DB-Direct `Delete` para cada `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-302">We also added the `DeleteProductsWithTransaction` method to the `ProductsBLL` class in the BLL, which accepts a `List` of `ProductID` values as its input and calls the DB-Direct pattern method `Delete` for each `ProductID`.</span></span> <span data-ttu-id="6fb8b-303">Os dois métodos começam criando uma transação e, em seguida, executando as instruções de modificação de dados em um bloco de `Try...Catch`.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-303">Both methods start by creating a transaction and then executing the data modification statements within a `Try...Catch` block.</span></span> <span data-ttu-id="6fb8b-304">Se ocorrer uma exceção, a transação será revertida, caso contrário, ela será confirmada.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-304">If an exception occurs, the transaction is rolled back, otherwise it is committed.</span></span>

<span data-ttu-id="6fb8b-305">A etapa 5 ilustra o efeito de atualizações de lote transacionais versus atualizações em lotes que não se desativam para usar uma transação.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-305">Step 5 illustrated the effect of transactional batch updates versus batch updates that neglected to use a transaction.</span></span> <span data-ttu-id="6fb8b-306">Nos próximos três tutoriais, vamos criar a base apresentada neste tutorial e criar interfaces do usuário para executar atualizações, exclusões e inserções em lotes.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-306">In the next three tutorials we will build upon the foundation laid in this tutorial and create user interfaces for performing batch updates, deletes, and inserts.</span></span>

<span data-ttu-id="6fb8b-307">Boa programação!</span><span class="sxs-lookup"><span data-stu-id="6fb8b-307">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="6fb8b-308">Leitura adicional</span><span class="sxs-lookup"><span data-stu-id="6fb8b-308">Further Reading</span></span>

<span data-ttu-id="6fb8b-309">Para obter mais informações sobre os tópicos discutidos neste tutorial, consulte os seguintes recursos:</span><span class="sxs-lookup"><span data-stu-id="6fb8b-309">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="6fb8b-310">Mantendo a consistência do banco de dados com transações</span><span class="sxs-lookup"><span data-stu-id="6fb8b-310">Maintaining Database Consistency with Transactions</span></span>](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)
- [<span data-ttu-id="6fb8b-311">Gerenciando transações em SQL Server procedimentos armazenados</span><span class="sxs-lookup"><span data-stu-id="6fb8b-311">Managing Transactions in SQL Server Stored Procedures</span></span>](http://www.4guysfromrolla.com/webtech/080305-1.shtml)
- [<span data-ttu-id="6fb8b-312">Transações facilitadas: `System.Transactions`</span><span class="sxs-lookup"><span data-stu-id="6fb8b-312">Transactions Made Easy: `System.Transactions`</span></span>](https://blogs.msdn.com/florinlazar/archive/2004/07/23/192239.aspx)
- [<span data-ttu-id="6fb8b-313">TransactionScope e DataAdapters</span><span class="sxs-lookup"><span data-stu-id="6fb8b-313">TransactionScope and DataAdapters</span></span>](http://andyclymer.blogspot.com/2007/01/transactionscope-and-dataadapters.html)
- [<span data-ttu-id="6fb8b-314">Usando transações de Oracle Database no .NET</span><span class="sxs-lookup"><span data-stu-id="6fb8b-314">Using Oracle Database Transactions in .NET</span></span>](http://www.oracle.com/technology/pub/articles/price_dbtrans_dotnet.html)

## <a name="about-the-author"></a><span data-ttu-id="6fb8b-315">Sobre o autor</span><span class="sxs-lookup"><span data-stu-id="6fb8b-315">About the Author</span></span>

<span data-ttu-id="6fb8b-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), autor de sete livros sobre ASP/ASP. net e fundador da [4guysfromrolla.com](http://www.4guysfromrolla.com), tem trabalhado com tecnologias Web da Microsoft desde 1998.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="6fb8b-317">Scott trabalha como consultor, instrutor e escritor independentes.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="6fb8b-318">Seu livro mais recente é que a [*Sams ensina a ASP.NET 2,0 em 24 horas*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="6fb8b-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="6fb8b-319">Ele pode ser acessado em [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="6fb8b-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="6fb8b-320">ou por meio de seu blog, que pode ser encontrado em [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="6fb8b-320">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="6fb8b-321">Agradecimentos especiais a</span><span class="sxs-lookup"><span data-stu-id="6fb8b-321">Special Thanks To</span></span>

<span data-ttu-id="6fb8b-322">Esta série de tutoriais foi revisada por muitos revisores úteis.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-322">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="6fb8b-323">Os revisores potenciais para este tutorial foram Dave Gardner, Hilton Giesenow e Teresa Murphy.</span><span class="sxs-lookup"><span data-stu-id="6fb8b-323">Lead reviewers for this tutorial were Dave Gardner, Hilton Giesenow, and Teresa Murphy.</span></span> <span data-ttu-id="6fb8b-324">Está interessado em revisar meus artigos futuros do MSDN?</span><span class="sxs-lookup"><span data-stu-id="6fb8b-324">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="6fb8b-325">Em caso afirmativo, solte-me uma linha em [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="6fb8b-325">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="6fb8b-326">[Anterior](batch-inserting-cs.md)
> [Próximo](batch-updating-vb.md)</span><span class="sxs-lookup"><span data-stu-id="6fb8b-326">[Previous](batch-inserting-cs.md)
[Next](batch-updating-vb.md)</span></span>
