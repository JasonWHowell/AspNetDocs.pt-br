---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
title: Lidando com a simultaneidade com o Entity Framework 4,0 em um aplicativo Web ASP.NET 4 | Microsoft Docs
author: tdykstra
description: Esta série de tutoriais se baseia no aplicativo Web da Contoso University criado pelo Introdução com a série de tutoriais do Entity Framework 4,0. I...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: a5aa22a6-fb7f-4f41-9c7f-addda151940b
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
msc.type: authoredcontent
ms.openlocfilehash: 3df5f7d9c8fb22e1ea34fe16560bdb9a1309bb56
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 03/06/2020
ms.locfileid: "78632583"
---
# <a name="handling-concurrency-with-the-entity-framework-40-in-an-aspnet-4-web-application"></a><span data-ttu-id="1a9ec-104">Lidando com a simultaneidade com o Entity Framework 4,0 em um aplicativo Web ASP.NET 4</span><span class="sxs-lookup"><span data-stu-id="1a9ec-104">Handling Concurrency with the Entity Framework 4.0 in an ASP.NET 4 Web Application</span></span>

<span data-ttu-id="1a9ec-105">por [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="1a9ec-106">Esta série de tutoriais se baseia no aplicativo Web da Contoso University criado pelo [introdução com a série de tutoriais do Entity Framework 4,0](https://asp.net/entity-framework/tutorials#Getting%20Started) .</span><span class="sxs-lookup"><span data-stu-id="1a9ec-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="1a9ec-107">Se você não concluiu os tutoriais anteriores, como ponto de partida para este tutorial, você pode [baixar o aplicativo](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) que você criou.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="1a9ec-108">Você também pode [baixar o aplicativo](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) que é criado pela série de tutoriais completa.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="1a9ec-109">Se você tiver dúvidas sobre os tutoriais, poderá lançá-los no [Fórum de Entity Framework ASP.net](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="1a9ec-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="1a9ec-110">No tutorial anterior, você aprendeu como classificar e filtrar dados usando o controle de `ObjectDataSource` e o Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-110">In the previous tutorial you learned how to sort and filter data using the `ObjectDataSource` control and the Entity Framework.</span></span> <span data-ttu-id="1a9ec-111">Este tutorial mostra opções para lidar com a simultaneidade em um aplicativo Web ASP.NET que usa o Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-111">This tutorial shows options for handling concurrency in an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="1a9ec-112">Você criará uma nova página da Web dedicada à atualização de atribuições de escritório do instrutor.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-112">You will create a new web page that's dedicated to updating instructor office assignments.</span></span> <span data-ttu-id="1a9ec-113">Você tratará problemas de simultaneidade nessa página e na página departamentos que você criou anteriormente.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-113">You'll handle concurrency issues in that page and in the Departments page that you created earlier.</span></span>

<span data-ttu-id="1a9ec-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span></span>

<span data-ttu-id="1a9ec-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span></span>

## <a name="concurrency-conflicts"></a><span data-ttu-id="1a9ec-116">Conflitos de simultaneidade</span><span class="sxs-lookup"><span data-stu-id="1a9ec-116">Concurrency Conflicts</span></span>

<span data-ttu-id="1a9ec-117">Um conflito de simultaneidade ocorre quando um usuário edita um registro e outro usuário edita o mesmo registro antes que a alteração do primeiro usuário seja gravada no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-117">A concurrency conflict occurs when one user edits a record and another user edits the same record before the first user's change is written to the database.</span></span> <span data-ttu-id="1a9ec-118">Se você não configurar o Entity Framework para detectar tais conflitos, quem atualizará o banco de dados por último substitui as alterações do outro usuário.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-118">If you don't set up the Entity Framework to detect such conflicts, whoever updates the database last overwrites the other user's changes.</span></span> <span data-ttu-id="1a9ec-119">Em muitos aplicativos, esse risco é aceitável e você não precisa configurar o aplicativo para lidar com possíveis conflitos de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-119">In many applications, this risk is acceptable, and you don't have to configure the application to handle possible concurrency conflicts.</span></span> <span data-ttu-id="1a9ec-120">(Se houver poucos usuários, ou poucas atualizações, ou se não for realmente crítico se algumas alterações forem substituídas, o custo da programação para simultaneidade poderá superar o benefício.) Se você não precisar se preocupar com conflitos de simultaneidade, poderá ignorar este tutorial; os dois tutoriais restantes da série não dependem de nada que você crie neste.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-120">(If there are few users, or few updates, or if isn't really critical if some changes are overwritten, the cost of programming for concurrency might outweigh the benefit.) If you don't need to worry about concurrency conflicts, you can skip this tutorial; the remaining two tutorials in the series don't depend on anything you build in this one.</span></span>

### <a name="pessimistic-concurrency-locking"></a><span data-ttu-id="1a9ec-121">Simultaneidade pessimista (bloqueio)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-121">Pessimistic Concurrency (Locking)</span></span>

<span data-ttu-id="1a9ec-122">Se o aplicativo precisar evitar a perda acidental de dados em cenários de simultaneidade, uma maneira de fazer isso será usar bloqueios de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-122">If your application does need to prevent accidental data loss in concurrency scenarios, one way to do that is to use database locks.</span></span> <span data-ttu-id="1a9ec-123">Isso é chamado de *simultaneidade pessimista*.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-123">This is called *pessimistic concurrency*.</span></span> <span data-ttu-id="1a9ec-124">Por exemplo, antes de ler uma linha de um banco de dados, você solicita um bloqueio para o acesso somente leitura ou de atualização.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-124">For example, before you read a row from a database, you request a lock for read-only or for update access.</span></span> <span data-ttu-id="1a9ec-125">Se você bloquear uma linha para o acesso de atualização, nenhum outro usuário terá permissão para bloquear a linha para o acesso somente leitura ou de atualização, porque ele obterá uma cópia dos dados que estão sendo alterados.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-125">If you lock a row for update access, no other users are allowed to lock the row either for read-only or update access, because they would get a copy of data that's in the process of being changed.</span></span> <span data-ttu-id="1a9ec-126">Se você bloquear uma linha para o acesso somente leitura, outros também poderão bloqueá-la para o acesso somente leitura, mas não para atualização.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-126">If you lock a row for read-only access, others can also lock it for read-only access but not for update.</span></span>

<span data-ttu-id="1a9ec-127">O gerenciamento de bloqueios tem algumas desvantagens.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-127">Managing locks has some disadvantages.</span></span> <span data-ttu-id="1a9ec-128">Ele pode ser complexo de ser programado.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-128">It can be complex to program.</span></span> <span data-ttu-id="1a9ec-129">Ele requer recursos de gerenciamento de banco de dados significativos e pode causar problemas de desempenho à medida que o número de usuários de um aplicativo aumenta (ou seja, ele não é bem dimensionado).</span><span class="sxs-lookup"><span data-stu-id="1a9ec-129">It requires significant database management resources, and it can cause performance problems as the number of users of an application increases (that is, it doesn't scale well).</span></span> <span data-ttu-id="1a9ec-130">Por esses motivos, nem todos os sistemas de gerenciamento de banco de dados dão suporte à simultaneidade pessimista.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-130">For these reasons, not all database management systems support pessimistic concurrency.</span></span> <span data-ttu-id="1a9ec-131">O Entity Framework não fornece suporte interno para ele, e este tutorial não mostra como implementá-lo.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-131">The Entity Framework provides no built-in support for it, and this tutorial doesn't show you how to implement it.</span></span>

### <a name="optimistic-concurrency"></a><span data-ttu-id="1a9ec-132">Simultaneidade otimista</span><span class="sxs-lookup"><span data-stu-id="1a9ec-132">Optimistic Concurrency</span></span>

<span data-ttu-id="1a9ec-133">A alternativa à simultaneidade pessimista é a *simultaneidade otimista*.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-133">The alternative to pessimistic concurrency is *optimistic concurrency*.</span></span> <span data-ttu-id="1a9ec-134">Simultaneidade otimista significa permitir que conflitos de simultaneidade ocorram e responder adequadamente se eles ocorrerem.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-134">Optimistic concurrency means allowing concurrency conflicts to happen, and then reacting appropriately if they do.</span></span> <span data-ttu-id="1a9ec-135">Por exemplo, João executa a página *Department. aspx* , clica no link **Editar** para o departamento do histórico e reduz o valor do **orçamento** de $1000000 para $125000.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-135">For example, John runs the *Department.aspx* page, clicks the **Edit** link for the History department, and reduces the **Budget** amount from $1,000,000.00 to $125,000.00.</span></span> <span data-ttu-id="1a9ec-136">(João administra um departamento de concorrentes e deseja liberar dinheiro para seu próprio departamento.)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-136">(John administers a competing department and wants to free up money for his own department.)</span></span>

<span data-ttu-id="1a9ec-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span></span>

<span data-ttu-id="1a9ec-138">Antes de João clicar em **Atualizar**, Jane executa a mesma página, clica no link **Editar** para o departamento do histórico e, em seguida, altera o campo **data de início** de 1/10/2011 para 1/1/1999.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-138">Before John clicks **Update**, Jane runs the same page, clicks the **Edit** link for the History department, and then changes the **Start Date** field from 1/10/2011 to 1/1/1999.</span></span> <span data-ttu-id="1a9ec-139">(Jane administra o departamento de histórico e quer dar mais tempo de ti).</span><span class="sxs-lookup"><span data-stu-id="1a9ec-139">(Jane administers the History department and wants to give it more seniority.)</span></span>

<span data-ttu-id="1a9ec-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span></span>

<span data-ttu-id="1a9ec-141">João clica em **Atualizar** primeiro e Jane clica em **Atualizar**.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-141">John clicks **Update** first, then Jane clicks **Update**.</span></span> <span data-ttu-id="1a9ec-142">O navegador de Jane agora lista o valor de **orçamento** como $1000000, mas isso está incorreto porque o valor foi alterado por joão para $125000.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-142">Jane's browser now lists the **Budget** amount as $1,000,000.00, but this is incorrect because the amount has been changed by John to $125,000.00.</span></span>

<span data-ttu-id="1a9ec-143">Algumas das ações que você pode executar neste cenário incluem o seguinte:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-143">Some of the actions you can take in this scenario include the following:</span></span>

- <span data-ttu-id="1a9ec-144">Controle qual propriedade um usuário modificou e atualize apenas as colunas correspondentes no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-144">You can keep track of which property a user has modified and update only the corresponding columns in the database.</span></span> <span data-ttu-id="1a9ec-145">No cenário de exemplo, nenhum dado é perdido, porque propriedades diferentes foram atualizadas pelos dois usuários.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-145">In the example scenario, no data would be lost, because different properties were updated by the two users.</span></span> <span data-ttu-id="1a9ec-146">Na próxima vez que alguém procurar o departamento de histórico, ele verá 1/1/1999 e $125000.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-146">The next time someone browses the History department, they will see 1/1/1999 and $125,000.00.</span></span> 

    <span data-ttu-id="1a9ec-147">Esse é o comportamento padrão no Entity Framework e pode reduzir substancialmente o número de conflitos que podem resultar em perda de dados.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-147">This is the default behavior in the Entity Framework, and it can substantially reduce the number of conflicts that could result in data loss.</span></span> <span data-ttu-id="1a9ec-148">No entanto, esse comportamento não evita a perda de dados se forem feitas alterações concorrentes na mesma propriedade de uma entidade.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-148">However, this behavior doesn't avoid data loss if competing changes are made to the same property of an entity.</span></span> <span data-ttu-id="1a9ec-149">Além disso, esse comportamento nem sempre é possível; Quando você mapeia procedimentos armazenados para um tipo de entidade, todas as propriedades de uma entidade são atualizadas quando qualquer alteração na entidade é feita no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-149">In addition, this behavior isn't always possible; when you map stored procedures to an entity type, all of an entity's properties are updated when any changes to the entity are made in the database.</span></span>
- <span data-ttu-id="1a9ec-150">Você pode deixar a alteração de Jane substituir a alteração de João.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-150">You can let Jane's change overwrite John's change.</span></span> <span data-ttu-id="1a9ec-151">Depois que Jane clica em **Atualizar**, o valor do **orçamento** volta para $1000000.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-151">After Jane clicks **Update**, the **Budget** amount goes back to $1,000,000.00.</span></span> <span data-ttu-id="1a9ec-152">Isso é chamado de um cenário *O cliente vence* ou *O último vence*.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-152">This is called a *Client Wins* or *Last in Wins* scenario.</span></span> <span data-ttu-id="1a9ec-153">(Os valores do cliente têm precedência sobre o que está no armazenamento de dados.)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-153">(The client's values take precedence over what's in the data store.)</span></span>
- <span data-ttu-id="1a9ec-154">Você pode impedir que a alteração de Jane seja atualizada no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-154">You can prevent Jane's change from being updated in the database.</span></span> <span data-ttu-id="1a9ec-155">Normalmente, você exibiria uma mensagem de erro, mostrará o estado atual dos dados e permitirá que ela reinsira as alterações se ainda quiser fazê-las.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-155">Typically, you would display an error message, show her the current state of the data, and allow her to reenter her changes if she still wants to make them.</span></span> <span data-ttu-id="1a9ec-156">Você pode automatizar ainda mais o processo salvando sua entrada e dando a ela uma oportunidade de reaplicá-la sem precisar reinseri-la.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-156">You could further automate the process by saving her input and giving her an opportunity to reapply it without having to reenter it.</span></span> <span data-ttu-id="1a9ec-157">Isso é chamado de um cenário *O armazenamento vence*.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-157">This is called a *Store Wins* scenario.</span></span> <span data-ttu-id="1a9ec-158">(Os valores do armazenamento de dados têm precedência sobre os valores enviados pelo cliente.)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-158">(The data-store values take precedence over the values submitted by the client.)</span></span>

### <a name="detecting-concurrency-conflicts"></a><span data-ttu-id="1a9ec-159">Detectando conflitos de simultaneidade</span><span class="sxs-lookup"><span data-stu-id="1a9ec-159">Detecting Concurrency Conflicts</span></span>

<span data-ttu-id="1a9ec-160">No Entity Framework, você pode resolver conflitos manipulando `OptimisticConcurrencyException` exceções que o Entity Framework gera.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-160">In the Entity Framework, you can resolve conflicts by handling `OptimisticConcurrencyException` exceptions that the Entity Framework throws.</span></span> <span data-ttu-id="1a9ec-161">Para saber quando gerar essas exceções, o Entity Framework precisa poder detectar conflitos.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-161">In order to know when to throw these exceptions, the Entity Framework must be able to detect conflicts.</span></span> <span data-ttu-id="1a9ec-162">Portanto, é necessário configurar o banco de dados e o modelo de dados de forma adequada.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-162">Therefore, you must configure the database and the data model appropriately.</span></span> <span data-ttu-id="1a9ec-163">Algumas opções para habilitar a detecção de conflitos incluem as seguintes:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-163">Some options for enabling conflict detection include the following:</span></span>

- <span data-ttu-id="1a9ec-164">No banco de dados, inclua uma coluna de tabela que pode ser usada para determinar quando uma linha foi alterada.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-164">In the database, include a table column that can be used to determine when a row has been changed.</span></span> <span data-ttu-id="1a9ec-165">Em seguida, você pode configurar o Entity Framework para incluir essa coluna na cláusula `Where` dos comandos SQL `Update` ou `Delete`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-165">You can then configure the Entity Framework to include that column in the `Where` clause of SQL `Update` or `Delete` commands.</span></span>

    <span data-ttu-id="1a9ec-166">Essa é a finalidade da coluna `Timestamp` na tabela `OfficeAssignment`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-166">That's the purpose of the `Timestamp` column in the `OfficeAssignment` table.</span></span>

    <span data-ttu-id="1a9ec-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span></span>

    <span data-ttu-id="1a9ec-168">O tipo de dados da coluna `Timestamp` também é chamado de `Timestamp`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-168">The data type of the `Timestamp` column is also called `Timestamp`.</span></span> <span data-ttu-id="1a9ec-169">No entanto, a coluna na verdade não contém um valor de data ou hora.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-169">However, the column doesn't actually contain a date or time value.</span></span> <span data-ttu-id="1a9ec-170">Em vez disso, o valor é um número sequencial incrementado cada vez que a linha é atualizada.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-170">Instead, the value is a sequential number that's incremented each time the row is updated.</span></span> <span data-ttu-id="1a9ec-171">Em um comando `Update` ou `Delete`, a cláusula `Where` inclui o valor original `Timestamp`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-171">In an `Update` or `Delete` command, the `Where` clause includes the original `Timestamp` value.</span></span> <span data-ttu-id="1a9ec-172">Se a linha que está sendo atualizada tiver sido alterada por outro usuário, o valor em `Timestamp` será diferente do valor original, portanto, a cláusula `Where` não retornará nenhuma linha para atualizar.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-172">If the row being updated has been changed by another user, the value in `Timestamp` is different than the original value, so the `Where` clause returns no row to update.</span></span> <span data-ttu-id="1a9ec-173">Quando o Entity Framework descobre que nenhuma linha foi atualizada pelo comando `Update` ou `Delete` atual (ou seja, quando o número de linhas afetadas é zero), ele interpreta isso como um conflito de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-173">When the Entity Framework finds that no rows have been updated by the current `Update` or `Delete` command (that is, when the number of affected rows is zero), it interprets that as a concurrency conflict.</span></span>
- <span data-ttu-id="1a9ec-174">Configure o Entity Framework para incluir os valores originais de cada coluna na tabela na cláusula `Where` dos comandos `Update` e `Delete`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-174">Configure the Entity Framework to include the original values of every column in the table in the `Where` clause of `Update` and `Delete` commands.</span></span>

    <span data-ttu-id="1a9ec-175">Como na primeira opção, se qualquer coisa na linha tiver sido alterada desde que a linha foi lida pela primeira vez, a cláusula `Where` não retornará uma linha a ser atualizada, que o Entity Framework interpretará como um conflito de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-175">As in the first option, if anything in the row has changed since the row was first read, the `Where` clause won't return a row to update, which the Entity Framework interprets as a concurrency conflict.</span></span> <span data-ttu-id="1a9ec-176">Esse método é tão eficaz quanto usar um campo de `Timestamp`, mas pode ser ineficiente.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-176">This method is as effective as using a `Timestamp` field, but can be inefficient.</span></span> <span data-ttu-id="1a9ec-177">Para tabelas de banco de dados que têm muitas colunas, isso pode resultar em cláusulas de `Where` muito grandes e em um aplicativo Web, ele pode exigir que você mantenha grandes quantidades de estado.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-177">For database tables that have many columns, it can result in very large `Where` clauses, and in a web application it can require that you maintain large amounts of state.</span></span> <span data-ttu-id="1a9ec-178">Manter grandes quantidades de estado pode afetar o desempenho do aplicativo porque ele requer recursos do servidor (por exemplo, estado de sessão) ou deve ser incluído na própria página da Web (por exemplo, estado de exibição).</span><span class="sxs-lookup"><span data-stu-id="1a9ec-178">Maintaining large amounts of state can affect application performance because it either requires server resources (for example, session state) or must be included in the web page itself (for example, view state).</span></span>

<span data-ttu-id="1a9ec-179">Neste tutorial, você adicionará o tratamento de erros para conflitos de simultaneidade otimista para uma entidade que não tem uma propriedade de rastreamento (a entidade de `Department`) e para uma entidade que tem uma propriedade de rastreamento (a entidade `OfficeAssignment`).</span><span class="sxs-lookup"><span data-stu-id="1a9ec-179">In this tutorial you will add error handling for optimistic concurrency conflicts for an entity that doesn't have a tracking property (the `Department` entity) and for an entity that does have a tracking property (the `OfficeAssignment` entity).</span></span>

## <a name="handling-optimistic-concurrency-without-a-tracking-property"></a><span data-ttu-id="1a9ec-180">Lidando com a simultaneidade otimista sem uma propriedade de controle</span><span class="sxs-lookup"><span data-stu-id="1a9ec-180">Handling Optimistic Concurrency Without a Tracking Property</span></span>

<span data-ttu-id="1a9ec-181">Para implementar a simultaneidade otimista para a entidade `Department`, que não tem uma propriedade Tracking (`Timestamp`), você concluirá as seguintes tarefas:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-181">To implement optimistic concurrency for the `Department` entity, which doesn't have a tracking (`Timestamp`) property, you will complete the following tasks:</span></span>

- <span data-ttu-id="1a9ec-182">Altere o modelo de dados para habilitar o acompanhamento de simultaneidade para entidades de `Department`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-182">Change the data model to enable concurrency tracking for `Department` entities.</span></span>
- <span data-ttu-id="1a9ec-183">Na classe `SchoolRepository`, manipule exceções de simultaneidade no método `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-183">In the `SchoolRepository` class, handle concurrency exceptions in the `SaveChanges` method.</span></span>
- <span data-ttu-id="1a9ec-184">Na página Departments *. aspx* , manipule exceções de simultaneidade exibindo uma mensagem para o usuário aviso de que as alterações tentadas não foram bem-sucedidas.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-184">In the *Departments.aspx* page, handle concurrency exceptions by displaying a message to the user warning that the attempted changes were unsuccessful.</span></span> <span data-ttu-id="1a9ec-185">O usuário pode ver os valores atuais e tentar as alterações novamente se elas ainda forem necessárias.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-185">The user can then see the current values and retry the changes if they are still needed.</span></span>

### <a name="enabling-concurrency-tracking-in-the-data-model"></a><span data-ttu-id="1a9ec-186">Habilitando o controle de simultaneidade no modelo de dados</span><span class="sxs-lookup"><span data-stu-id="1a9ec-186">Enabling Concurrency Tracking in the Data Model</span></span>

<span data-ttu-id="1a9ec-187">No Visual Studio, abra o aplicativo Web da Contoso University com o qual você estava trabalhando no tutorial anterior desta série.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-187">In Visual Studio, open the Contoso University web application that you were working with in the previous tutorial in this series.</span></span>

<span data-ttu-id="1a9ec-188">Abra *SchoolModel. edmx*e, no designer de modelo de dados, clique com o botão direito do mouse na propriedade `Name` na entidade `Department` e clique em **Propriedades**.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-188">Open *SchoolModel.edmx*, and in the data model designer, right-click the `Name` property in the `Department` entity and then click **Properties**.</span></span> <span data-ttu-id="1a9ec-189">Na janela **Propriedades** , altere a propriedade `ConcurrencyMode` para `Fixed`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-189">In the **Properties** window, change the `ConcurrencyMode` property to `Fixed`.</span></span>

<span data-ttu-id="1a9ec-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span></span>

<span data-ttu-id="1a9ec-191">Faça o mesmo para as outras propriedades escalares não primárias (`Budget`, `StartDate`e `Administrator`.) (Você não pode fazer isso para propriedades de navegação.) Isso especifica que sempre que o Entity Framework gera um `Update` ou `Delete` comando SQL para atualizar a entidade `Department` no banco de dados, essas colunas (com valores originais) devem ser incluídas na cláusula `Where`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-191">Do the same for the other non-primary-key scalar properties (`Budget`, `StartDate`, and `Administrator`.) (You can't do this for navigation properties.) This specifies that whenever the Entity Framework generates a `Update` or `Delete` SQL command to update the `Department` entity in the database, these columns (with original values) must be included in the `Where` clause.</span></span> <span data-ttu-id="1a9ec-192">Se nenhuma linha for encontrada quando o comando `Update` ou `Delete` for executado, o Entity Framework gerará uma exceção de simultaneidade otimista.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-192">If no row is found when the `Update` or `Delete` command executes, the Entity Framework will throw an optimistic-concurrency exception.</span></span>

<span data-ttu-id="1a9ec-193">Salve e feche o modelo de dados.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-193">Save and close the data model.</span></span>

### <a name="handling-concurrency-exceptions-in-the-dal"></a><span data-ttu-id="1a9ec-194">Manipulando exceções de simultaneidade na DAL</span><span class="sxs-lookup"><span data-stu-id="1a9ec-194">Handling Concurrency Exceptions in the DAL</span></span>

<span data-ttu-id="1a9ec-195">Abra *SchoolRepository.cs* e adicione a seguinte instrução de `using` para o namespace `System.Data`:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-195">Open *SchoolRepository.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample1.cs)]

<span data-ttu-id="1a9ec-196">Adicione o novo método `SaveChanges` a seguir, que lida com exceções de simultaneidade otimista:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-196">Add the following new `SaveChanges` method, which handles optimistic concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample2.cs)]

<span data-ttu-id="1a9ec-197">Se ocorrer um erro de simultaneidade quando esse método for chamado, os valores de propriedade da entidade na memória serão substituídos pelos valores atualmente no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-197">If a concurrency error occurs when this method is called, the property values of the entity in memory are replaced with the values currently in the database.</span></span> <span data-ttu-id="1a9ec-198">A exceção de simultaneidade é relançada para que a página da Web possa tratá-la.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-198">The concurrency exception is rethrown so that the web page can handle it.</span></span>

<span data-ttu-id="1a9ec-199">Nos métodos `DeleteDepartment` e `UpdateDepartment`, substitua a chamada existente para `context.SaveChanges()` por uma chamada para `SaveChanges()` a fim de invocar o novo método.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-199">In the `DeleteDepartment` and `UpdateDepartment` methods, replace the existing call to `context.SaveChanges()` with a call to `SaveChanges()` in order to invoke the new method.</span></span>

### <a name="handling-concurrency-exceptions-in-the-presentation-layer"></a><span data-ttu-id="1a9ec-200">Manipulando exceções de simultaneidade na camada de apresentação</span><span class="sxs-lookup"><span data-stu-id="1a9ec-200">Handling Concurrency Exceptions in the Presentation Layer</span></span>

<span data-ttu-id="1a9ec-201">Abra Departments *. aspx* e adicione um atributo `OnDeleted="DepartmentsObjectDataSource_Deleted"` ao controle de `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-201">Open *Departments.aspx* and add an `OnDeleted="DepartmentsObjectDataSource_Deleted"` attribute to the `DepartmentsObjectDataSource` control.</span></span> <span data-ttu-id="1a9ec-202">A marca de abertura para o controle agora será semelhante ao exemplo a seguir.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-202">The opening tag for the control will now resemble the following example.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample3.aspx)]

<span data-ttu-id="1a9ec-203">No controle de `DepartmentsGridView`, especifique todas as colunas de tabela no atributo `DataKeyNames`, conforme mostrado no exemplo a seguir.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-203">In the `DepartmentsGridView` control, specify all of the table columns in the `DataKeyNames` attribute, as shown in the following example.</span></span> <span data-ttu-id="1a9ec-204">Observe que isso criará campos de estado de exibição muito grandes, que é um motivo pelo qual usar um campo de controle é geralmente a maneira preferida de rastrear conflitos de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-204">Note that this will create very large view state fields, which is one reason why using a tracking field is generally the preferred way to track concurrency conflicts.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample4.aspx)]

<span data-ttu-id="1a9ec-205">Abra *Departments.aspx.cs* e adicione a seguinte instrução de `using` para o namespace `System.Data`:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-205">Open *Departments.aspx.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample5.cs)]

<span data-ttu-id="1a9ec-206">Adicione o novo método a seguir, que você chamará do `Updated` do controle da fonte de dados e `Deleted` manipuladores de eventos para lidar com exceções de simultaneidade:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-206">Add the following new method, which you will call from the data source control's `Updated` and `Deleted` event handlers for handling concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample6.cs)]

<span data-ttu-id="1a9ec-207">Esse código verifica o tipo de exceção e, se for uma exceção de simultaneidade, o código criará dinamicamente um controle de `CustomValidator` que, por sua vez, exibirá uma mensagem no controle de `ValidationSummary`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-207">This code checks the exception type, and if it's a concurrency exception, the code dynamically creates a `CustomValidator` control that in turn displays a message in the `ValidationSummary` control.</span></span>

<span data-ttu-id="1a9ec-208">Chame o novo método do manipulador de eventos `Updated` que você adicionou anteriormente.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-208">Call the new method from the `Updated` event handler that you added earlier.</span></span> <span data-ttu-id="1a9ec-209">Além disso, crie um novo manipulador de eventos `Deleted` que chama o mesmo método (mas não faz mais nada):</span><span class="sxs-lookup"><span data-stu-id="1a9ec-209">In addition, create a new `Deleted` event handler that calls the same method (but doesn't do anything else):</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample7.cs)]

### <a name="testing-optimistic-concurrency-in-the-departments-page"></a><span data-ttu-id="1a9ec-210">Testando a simultaneidade otimista na página departamentos</span><span class="sxs-lookup"><span data-stu-id="1a9ec-210">Testing Optimistic Concurrency in the Departments Page</span></span>

<span data-ttu-id="1a9ec-211">Execute a página *departamentos. aspx* .</span><span class="sxs-lookup"><span data-stu-id="1a9ec-211">Run the *Departments.aspx* page.</span></span>

<span data-ttu-id="1a9ec-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span></span>

<span data-ttu-id="1a9ec-213">Clique em **Editar** em uma linha e altere o valor na coluna **orçamento** .</span><span class="sxs-lookup"><span data-stu-id="1a9ec-213">Click **Edit** in a row and change the value in the **Budget** column.</span></span> <span data-ttu-id="1a9ec-214">(Lembre-se de que você só pode editar os registros que criou para este tutorial, pois os registros de banco de dados do `School` existentes contêm algum dado inválido.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-214">(Remember that you can only edit records that you've created for this tutorial, because the existing `School` database records contain some invalid data.</span></span> <span data-ttu-id="1a9ec-215">O registro do departamento de economia é seguro para experimentar.)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-215">The record for the Economics department is a safe one to experiment with.)</span></span>

<span data-ttu-id="1a9ec-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span></span>

<span data-ttu-id="1a9ec-217">Abra uma nova janela do navegador e execute a página novamente (Copie a URL da caixa de endereço da primeira janela do navegador para a segunda janela do navegador).</span><span class="sxs-lookup"><span data-stu-id="1a9ec-217">Open a new browser window and run the page again (copy the URL from the first browser window's address box to the second browser window).</span></span>

<span data-ttu-id="1a9ec-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span></span>

<span data-ttu-id="1a9ec-219">Clique em **Editar** na mesma linha que você editou anteriormente e altere o valor de **orçamento** para algo diferente.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-219">Click **Edit** in the same row you edited earlier and change the **Budget** value to something different.</span></span>

<span data-ttu-id="1a9ec-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span></span>

<span data-ttu-id="1a9ec-221">Na segunda janela do navegador, clique em **Atualizar**.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-221">In the second browser window, click **Update**.</span></span> <span data-ttu-id="1a9ec-222">O valor do **orçamento** foi alterado com êxito para esse novo valor.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-222">The **Budget** amount is successfully changed to this new value.</span></span>

<span data-ttu-id="1a9ec-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span></span>

<span data-ttu-id="1a9ec-224">Na primeira janela do navegador, clique em **Atualizar**.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-224">In the first browser window, click **Update**.</span></span> <span data-ttu-id="1a9ec-225">A atualização falha.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-225">The update fails.</span></span> <span data-ttu-id="1a9ec-226">O valor do **orçamento** é exibido novamente usando o valor definido na segunda janela do navegador e você vê uma mensagem de erro.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-226">The **Budget** amount is redisplayed using the value you set in the second browser window, and you see an error message.</span></span>

<span data-ttu-id="1a9ec-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span></span>

## <a name="handling-optimistic-concurrency-using-a-tracking-property"></a><span data-ttu-id="1a9ec-228">Lidando com a simultaneidade otimista usando uma propriedade de controle</span><span class="sxs-lookup"><span data-stu-id="1a9ec-228">Handling Optimistic Concurrency Using a Tracking Property</span></span>

<span data-ttu-id="1a9ec-229">Para lidar com a simultaneidade otimista para uma entidade que tem uma propriedade de rastreamento, você concluirá as seguintes tarefas:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-229">To handle optimistic concurrency for an entity that has a tracking property, you will complete the following tasks:</span></span>

- <span data-ttu-id="1a9ec-230">Adicione procedimentos armazenados ao modelo de dados para gerenciar entidades de `OfficeAssignment`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-230">Add stored procedures to the data model to manage `OfficeAssignment` entities.</span></span> <span data-ttu-id="1a9ec-231">(As propriedades de rastreamento e os procedimentos armazenados não precisam ser usados juntos; eles estão apenas agrupados aqui para ilustração.)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-231">(Tracking properties and stored procedures don't have to be used together; they're just grouped together here for illustration.)</span></span>
- <span data-ttu-id="1a9ec-232">Adicione métodos CRUD à DAL e à BLL para entidades de `OfficeAssignment`, incluindo o código para lidar com exceções de simultaneidade otimistas na DAL.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-232">Add CRUD methods to the DAL and the BLL for `OfficeAssignment` entities, including code to handle optimistic concurrency exceptions in the DAL.</span></span>
- <span data-ttu-id="1a9ec-233">Crie uma página da Web de atribuições do Office.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-233">Create an office-assignments web page.</span></span>
- <span data-ttu-id="1a9ec-234">Teste a simultaneidade otimista na nova página da Web.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-234">Test optimistic concurrency in the new web page.</span></span>

### <a name="adding-officeassignment-stored-procedures-to-the-data-model"></a><span data-ttu-id="1a9ec-235">Adicionando procedimentos armazenados OfficeAssignment ao modelo de dados</span><span class="sxs-lookup"><span data-stu-id="1a9ec-235">Adding OfficeAssignment Stored Procedures to the Data Model</span></span>

<span data-ttu-id="1a9ec-236">Abra o arquivo *SchoolModel. edmx* no designer de modelo, clique com o botão direito do mouse na superfície de design e clique em **atualizar modelo do banco de dados**.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-236">Open the *SchoolModel.edmx* file in the model designer, right-click the design surface, and click **Update Model from Database**.</span></span> <span data-ttu-id="1a9ec-237">Na guia **Adicionar** da caixa de diálogo **escolher seu objeto de banco de dados** , expanda **procedimentos armazenados** e selecione os três `OfficeAssignment` procedimentos armazenados (consulte a captura de tela a seguir) e clique em **concluir**.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-237">In the **Add** tab of the **Choose Your Database Objects** dialog box, expand **Stored Procedures** and select the three `OfficeAssignment` stored procedures (see the following screenshot), and then click **Finish**.</span></span> <span data-ttu-id="1a9ec-238">(Esses procedimentos armazenados já estavam no banco de dados quando você fez o download ou o criou usando um script.)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-238">(These stored procedures were already in the database when you downloaded or created it using a script.)</span></span>

<span data-ttu-id="1a9ec-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span></span>

<span data-ttu-id="1a9ec-240">Clique com o botão direito do mouse na entidade `OfficeAssignment` e selecione **mapeamento de procedimento armazenado**.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-240">Right-click the `OfficeAssignment` entity and select **Stored Procedure Mapping**.</span></span>

<span data-ttu-id="1a9ec-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span></span>

<span data-ttu-id="1a9ec-242">Defina as funções **Insert**, **Update**e **delete** para usar seus procedimentos armazenados correspondentes.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-242">Set the **Insert**, **Update**, and **Delete** functions to use their corresponding stored procedures.</span></span> <span data-ttu-id="1a9ec-243">Para o parâmetro `OrigTimestamp` da função `Update`, defina a **Propriedade** como `Timestamp` e selecione a opção **usar valor original** .</span><span class="sxs-lookup"><span data-stu-id="1a9ec-243">For the `OrigTimestamp` parameter of the `Update` function, set the **Property** to `Timestamp` and select the **Use Original Value** option.</span></span>

<span data-ttu-id="1a9ec-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span></span>

<span data-ttu-id="1a9ec-245">Quando o Entity Framework chama o procedimento armazenado `UpdateOfficeAssignment`, ele passará o valor original da coluna `Timestamp` no parâmetro `OrigTimestamp`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-245">When the Entity Framework calls the `UpdateOfficeAssignment` stored procedure, it will pass the original value of the `Timestamp` column in the `OrigTimestamp` parameter.</span></span> <span data-ttu-id="1a9ec-246">O procedimento armazenado usa esse parâmetro em sua cláusula `Where`:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-246">The stored procedure uses this parameter in its `Where` clause:</span></span>

[!code-sql[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample8.sql)]

<span data-ttu-id="1a9ec-247">O procedimento armazenado também seleciona o novo valor da coluna `Timestamp` após a atualização para que o Entity Framework possa manter a entidade `OfficeAssignment` que está na memória sincronizada com a linha de banco de dados correspondente.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-247">The stored procedure also selects the new value of the `Timestamp` column after the update so that the Entity Framework can keep the `OfficeAssignment` entity that's in memory in sync with the corresponding database row.</span></span>

<span data-ttu-id="1a9ec-248">(Observe que o procedimento armazenado para excluir uma atribuição do Office não tem um parâmetro `OrigTimestamp`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-248">(Note that the stored procedure for deleting an office assignment doesn't have an `OrigTimestamp` parameter.</span></span> <span data-ttu-id="1a9ec-249">Por isso, o Entity Framework não pode verificar se uma entidade está inalterada antes de excluí-la.)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-249">Because of this, the Entity Framework can't verify that an entity is unchanged before deleting it.)</span></span>

<span data-ttu-id="1a9ec-250">Salve e feche o modelo de dados.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-250">Save and close the data model.</span></span>

### <a name="adding-officeassignment-methods-to-the-dal"></a><span data-ttu-id="1a9ec-251">Adicionando métodos OfficeAssignment à DAL</span><span class="sxs-lookup"><span data-stu-id="1a9ec-251">Adding OfficeAssignment Methods to the DAL</span></span>

<span data-ttu-id="1a9ec-252">Abra *ISchoolRepository.cs* e adicione os seguintes métodos CRUD para o conjunto de entidades `OfficeAssignment`:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-252">Open *ISchoolRepository.cs* and add the following CRUD methods for the `OfficeAssignment` entity set:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample9.cs)]

<span data-ttu-id="1a9ec-253">Adicione os novos métodos a seguir a *SchoolRepository.cs*.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-253">Add the following new methods to *SchoolRepository.cs*.</span></span> <span data-ttu-id="1a9ec-254">No método `UpdateOfficeAssignment`, você chama o método `SaveChanges` local em vez de `context.SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-254">In the `UpdateOfficeAssignment` method, you call the local `SaveChanges` method instead of `context.SaveChanges`.</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample10.cs)]

<span data-ttu-id="1a9ec-255">No projeto de teste, abra *MockSchoolRepository.cs* e adicione a seguinte coleção de `OfficeAssignment` e métodos CRUD a ele.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-255">In the test project, open *MockSchoolRepository.cs* and add the following `OfficeAssignment` collection and CRUD methods to it.</span></span> <span data-ttu-id="1a9ec-256">(O repositório de simulação deve implementar a interface do repositório ou a solução não será compilada.)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-256">(The mock repository must implement the repository interface, or the solution won't compile.)</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample11.cs)]

### <a name="adding-officeassignment-methods-to-the-bll"></a><span data-ttu-id="1a9ec-257">Adicionando métodos OfficeAssignment à BLL</span><span class="sxs-lookup"><span data-stu-id="1a9ec-257">Adding OfficeAssignment Methods to the BLL</span></span>

<span data-ttu-id="1a9ec-258">No projeto principal, abra *SchoolBL.cs* e adicione os seguintes métodos CRUD para a entidade `OfficeAssignment` definida como:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-258">In the main project, open *SchoolBL.cs* and add the following CRUD methods for the `OfficeAssignment` entity set to it:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample12.cs)]

## <a name="creating-an-officeassignments-web-page"></a><span data-ttu-id="1a9ec-259">Criando uma página da Web do OfficeAssignments</span><span class="sxs-lookup"><span data-stu-id="1a9ec-259">Creating an OfficeAssignments Web Page</span></span>

<span data-ttu-id="1a9ec-260">Crie uma nova página da Web que usa a página mestra *site. Master* e nomeie-a *OfficeAssignments. aspx*.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-260">Create a new web page that uses the *Site.Master* master page and name it *OfficeAssignments.aspx*.</span></span> <span data-ttu-id="1a9ec-261">Adicione a seguinte marcação ao controle de `Content` chamado `Content2`:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-261">Add the following markup to the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample13.aspx)]

<span data-ttu-id="1a9ec-262">Observe que, no atributo `DataKeyNames`, a marcação Especifica a propriedade `Timestamp`, bem como a chave de registro (`InstructorID`).</span><span class="sxs-lookup"><span data-stu-id="1a9ec-262">Notice that in the `DataKeyNames` attribute, the markup specifies the `Timestamp` property as well as the record key (`InstructorID`).</span></span> <span data-ttu-id="1a9ec-263">Especificar propriedades no atributo `DataKeyNames` faz com que o controle os salve no estado de controle (que é semelhante ao estado de exibição) para que os valores originais estejam disponíveis durante o processamento de postback.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-263">Specifying properties in the `DataKeyNames` attribute causes the control to save them in control state (which is similar to view state) so that the original values are available during postback processing.</span></span>

<span data-ttu-id="1a9ec-264">Se você não salvou o valor `Timestamp`, o Entity Framework não o terá para a cláusula `Where` do comando SQL `Update`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-264">If you didn't save the `Timestamp` value, the Entity Framework would not have it for the `Where` clause of the SQL `Update` command.</span></span> <span data-ttu-id="1a9ec-265">Consequentemente, nada seria encontrado para atualizar.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-265">Consequently nothing would be found to update.</span></span> <span data-ttu-id="1a9ec-266">Como resultado, o Entity Framework geraria uma exceção de simultaneidade otimista sempre que uma entidade de `OfficeAssignment` for atualizada.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-266">As a result, the Entity Framework would throw an optimistic concurrency exception every time an `OfficeAssignment` entity is updated.</span></span>

<span data-ttu-id="1a9ec-267">Abra *OfficeAssignments.aspx.cs* e adicione a seguinte instrução de `using` para a camada de acesso de dados:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-267">Open *OfficeAssignments.aspx.cs* and add the following `using` statement for the data access layer:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample14.cs)]

<span data-ttu-id="1a9ec-268">Adicione o seguinte método `Page_Init`, que habilita a funcionalidade de Dados Dinâmicos.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-268">Add the following `Page_Init` method, which enables Dynamic Data functionality.</span></span> <span data-ttu-id="1a9ec-269">Além disso, adicione o seguinte manipulador para o evento de `Updated` do controle de `ObjectDataSource` para verificar se há erros de simultaneidade:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-269">Also add the following handler for the `ObjectDataSource` control's `Updated` event in order to check for concurrency errors:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample15.cs)]

### <a name="testing-optimistic-concurrency-in-the-officeassignments-page"></a><span data-ttu-id="1a9ec-270">Testando a simultaneidade otimista na página OfficeAssignments</span><span class="sxs-lookup"><span data-stu-id="1a9ec-270">Testing Optimistic Concurrency in the OfficeAssignments Page</span></span>

<span data-ttu-id="1a9ec-271">Execute a página *OfficeAssignments. aspx* .</span><span class="sxs-lookup"><span data-stu-id="1a9ec-271">Run the *OfficeAssignments.aspx* page.</span></span>

<span data-ttu-id="1a9ec-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span></span>

<span data-ttu-id="1a9ec-273">Clique em **Editar** em uma linha e altere o valor na coluna **local** .</span><span class="sxs-lookup"><span data-stu-id="1a9ec-273">Click **Edit** in a row and change the value in the **Location** column.</span></span>

<span data-ttu-id="1a9ec-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span></span>

<span data-ttu-id="1a9ec-275">Abra uma nova janela do navegador e execute a página novamente (Copie a URL da primeira janela do navegador para a segunda janela do navegador).</span><span class="sxs-lookup"><span data-stu-id="1a9ec-275">Open a new browser window and run the page again (copy the URL from the first browser window to the second browser window).</span></span>

<span data-ttu-id="1a9ec-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span></span>

<span data-ttu-id="1a9ec-277">Clique em **Editar** na mesma linha que você editou anteriormente e altere o valor de **local** para algo diferente.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-277">Click **Edit** in the same row you edited earlier and change the **Location** value to something different.</span></span>

<span data-ttu-id="1a9ec-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span></span>

<span data-ttu-id="1a9ec-279">Na segunda janela do navegador, clique em **Atualizar**.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-279">In the second browser window, click **Update**.</span></span>

<span data-ttu-id="1a9ec-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span></span>

<span data-ttu-id="1a9ec-281">Alterne para a primeira janela do navegador e clique em **Atualizar**.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-281">Switch to the first browser window and click **Update**.</span></span>

<span data-ttu-id="1a9ec-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span></span>

<span data-ttu-id="1a9ec-283">Você verá uma mensagem de erro e o valor do **local** foi atualizado para mostrar o valor que você alterou para a segunda janela do navegador.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-283">You see an error message and the **Location** value has been updated to show the value you changed it to in the second browser window.</span></span>

## <a name="handling-concurrency-with-the-entitydatasource-control"></a><span data-ttu-id="1a9ec-284">Manipulando a simultaneidade com o controle EntityDataSource</span><span class="sxs-lookup"><span data-stu-id="1a9ec-284">Handling Concurrency with the EntityDataSource Control</span></span>

<span data-ttu-id="1a9ec-285">O controle de `EntityDataSource` inclui uma lógica interna que reconhece as configurações de simultaneidade no modelo de dados e manipula as operações de atualização e exclusão adequadamente.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-285">The `EntityDataSource` control includes built-in logic that recognizes the concurrency settings in the data model and handles update and delete operations accordingly.</span></span> <span data-ttu-id="1a9ec-286">No entanto, assim como acontece com todas as exceções, você deve manipular `OptimisticConcurrencyException` exceções por conta própria para fornecer uma mensagem de erro amigável.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-286">However, as with all exceptions, you must handle `OptimisticConcurrencyException` exceptions yourself in order to provide a user-friendly error message.</span></span>

<span data-ttu-id="1a9ec-287">Em seguida, você irá configurar a página *courses. aspx* (que usa um controle `EntityDataSource`) para permitir operações de atualização e exclusão e exibir uma mensagem de erro se ocorrer um conflito de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-287">Next, you will configure the *Courses.aspx* page (which uses an `EntityDataSource` control) to allow update and delete operations and to display an error message if a concurrency conflict occurs.</span></span> <span data-ttu-id="1a9ec-288">A entidade `Course` não tem uma coluna de acompanhamento de simultaneidade, portanto, você usará o mesmo método que fez com a entidade `Department`: acompanhe os valores de todas as propriedades que não são de chave.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-288">The `Course` entity doesn't have a concurrency tracking column, so you will use the same method that you did with the `Department` entity: track the values of all non-key properties.</span></span>

<span data-ttu-id="1a9ec-289">Abra o arquivo *SchoolModel. edmx* .</span><span class="sxs-lookup"><span data-stu-id="1a9ec-289">Open the *SchoolModel.edmx* file.</span></span> <span data-ttu-id="1a9ec-290">Para as propriedades não chave da entidade `Course` (`Title`, `Credits`e `DepartmentID`), defina a propriedade modo de **simultaneidade** como `Fixed`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-290">For the non-key properties of the `Course` entity (`Title`, `Credits`, and `DepartmentID`), set the **Concurrency Mode** property to `Fixed`.</span></span> <span data-ttu-id="1a9ec-291">Em seguida, salve e feche o modelo de dados.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-291">Then save and close the data model.</span></span>

<span data-ttu-id="1a9ec-292">Abra a página *cursos. aspx* e faça as seguintes alterações:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-292">Open the *Courses.aspx* page and make the following changes:</span></span>

- <span data-ttu-id="1a9ec-293">No controle `CoursesEntityDataSource`, adicione `EnableUpdate="true"` e `EnableDelete="true"` atributos.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-293">In the `CoursesEntityDataSource` control, add `EnableUpdate="true"` and `EnableDelete="true"` attributes.</span></span> <span data-ttu-id="1a9ec-294">A marca de abertura para esse controle agora é semelhante ao exemplo a seguir:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-294">The opening tag for that control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample16.aspx)]
- <span data-ttu-id="1a9ec-295">No controle `CoursesGridView`, altere o valor do atributo `DataKeyNames` para `"CourseID,Title,Credits,DepartmentID"`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-295">In the `CoursesGridView` control, change the `DataKeyNames` attribute value to `"CourseID,Title,Credits,DepartmentID"`.</span></span> <span data-ttu-id="1a9ec-296">Em seguida, adicione um elemento `CommandField` ao elemento `Columns` que mostra os botões **Editar** e **excluir** (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span><span class="sxs-lookup"><span data-stu-id="1a9ec-296">Then add a `CommandField` element to the `Columns` element that shows **Edit** and **Delete** buttons (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span></span> <span data-ttu-id="1a9ec-297">O controle `GridView` agora é semelhante ao exemplo a seguir:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-297">The `GridView` control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample17.aspx)]

<span data-ttu-id="1a9ec-298">Execute a página e crie uma situação de conflito como fazia antes na página departamentos.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-298">Run the page and create a conflict situation as you did before in the Departments page.</span></span> <span data-ttu-id="1a9ec-299">Execute a página em duas janelas do navegador, clique em **Editar** na mesma linha em cada janela e faça uma alteração diferente em cada uma delas.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-299">Run the page in two browser windows, click **Edit** in the same line in each window, and make a different change in each one.</span></span> <span data-ttu-id="1a9ec-300">Clique em **Atualizar** em uma janela e, em seguida, clique em **Atualizar** na outra janela.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-300">Click **Update** in one window and then click **Update** in the other window.</span></span> <span data-ttu-id="1a9ec-301">Ao clicar em **Atualizar** na segunda vez, você verá a página de erro resultante de uma exceção de simultaneidade sem tratamento.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-301">When you click **Update** the second time, you see the error page that results from an unhandled concurrency exception.</span></span>

<span data-ttu-id="1a9ec-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span></span>

<span data-ttu-id="1a9ec-303">Você lida com esse erro de maneira muito semelhante à forma como você o tratou para o controle de `ObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-303">You handle this error in a manner very similar to how you handled it for the `ObjectDataSource` control.</span></span> <span data-ttu-id="1a9ec-304">Abra a página *cursos. aspx* e, no controle `CoursesEntityDataSource`, especifique os manipuladores para os eventos `Deleted` e `Updated`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-304">Open the *Courses.aspx* page, and in the `CoursesEntityDataSource` control, specify handlers for the `Deleted` and `Updated` events.</span></span> <span data-ttu-id="1a9ec-305">A marca de abertura do controle agora é semelhante ao exemplo a seguir:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-305">The opening tag of the control now resembles the following example:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample18.aspx)]

<span data-ttu-id="1a9ec-306">Antes do controle de `CoursesGridView`, adicione o seguinte controle de `ValidationSummary`:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-306">Before the `CoursesGridView` control, add the following `ValidationSummary` control:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample19.aspx)]

<span data-ttu-id="1a9ec-307">No *courses.aspx.cs*, adicione uma instrução de `using` para o namespace `System.Data`, adicione um método que verifica as exceções de simultaneidade e adicione manipuladores para os manipuladores `Deleted` e `Updated` do controle de `EntityDataSource`.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-307">In *Courses.aspx.cs*, add a `using` statement for the `System.Data` namespace, add a method that checks for concurrency exceptions, and add handlers for the `EntityDataSource` control's `Updated` and `Deleted` handlers.</span></span> <span data-ttu-id="1a9ec-308">O código se parecerá com o seguinte:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-308">The code will look like the following:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample20.cs)]

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample21.cs)]

<span data-ttu-id="1a9ec-309">A única diferença entre esse código e o que você fez para o controle de `ObjectDataSource` é que, nesse caso, a exceção de simultaneidade está na propriedade `Exception` do objeto de argumentos de evento em vez de na propriedade `InnerException` dessa exceção.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-309">The only difference between this code and what you did for the `ObjectDataSource` control is that in this case the concurrency exception is in the `Exception` property of the event arguments object rather than in that exception's `InnerException` property.</span></span>

<span data-ttu-id="1a9ec-310">Execute a página e crie um conflito de simultaneidade novamente.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-310">Run the page and create a concurrency conflict again.</span></span> <span data-ttu-id="1a9ec-311">Desta vez, você verá uma mensagem de erro:</span><span class="sxs-lookup"><span data-stu-id="1a9ec-311">This time you see an error message:</span></span>

<span data-ttu-id="1a9ec-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span></span>

<span data-ttu-id="1a9ec-313">Isso conclui a introdução à manipulação de conflitos de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-313">This completes the introduction to handling concurrency conflicts.</span></span> <span data-ttu-id="1a9ec-314">O próximo tutorial fornecerá orientações sobre como melhorar o desempenho em um aplicativo Web que usa o Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="1a9ec-314">The next tutorial will provide guidance on how to improve performance in a web application that uses the Entity Framework.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="1a9ec-315">[Anterior](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
> [Próximo](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span><span class="sxs-lookup"><span data-stu-id="1a9ec-315">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
[Next](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span></span>
